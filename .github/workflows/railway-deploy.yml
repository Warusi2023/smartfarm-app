name: Deploy SmartFarm Backend to Railway
on:
  push:
    branches: [ "main" ]

concurrency:
  group: railway-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  preflight:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Verify backend path & files
        run: |
          set -e
          BACKEND="backend"
          test -f "$BACKEND/package.json" || (echo "❌ $BACKEND/package.json missing" && exit 2)
          test -f "$BACKEND/server.js"     || (echo "❌ $BACKEND/server.js missing" && exit 3)
          test -f "$BACKEND/package-lock.json" || (echo "❌ $BACKEND/package-lock.json missing (run npm install in backend and commit lockfile)" && exit 4)
          echo "✅ Preflight OK"

  deploy-determined-elegance:
    needs: preflight
    if: ${{ secrets.RAILWAY_TOKEN && secrets.RAILWAY_SERVICE_ID_DETERMINED }}
    runs-on: ubuntu-latest
    defaults: { run: { working-directory: backend } }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 18 }
      - run: node -v && npm -v && pwd && ls -la
      - name: Check lockfile and entry
        run: |
          test -f package-lock.json || (echo "❌ package-lock.json missing in backend" && exit 10)
          test -f server.js || (echo "❌ server.js missing in backend" && exit 11)
      - name: Install
        run: npm ci
      - name: Sanity-run (local)
        run: |
          node server.js &
          S=$!
          sleep 1
          curl -sf http://localhost:3000/api/health || (echo "❌ Local healthcheck failed" && kill $S && exit 12)
          kill $S || true
      - name: Deploy to Railway (determined-elegance)
        uses: railwayapp/action@v1
        with:
          serviceId: ${{ secrets.RAILWAY_SERVICE_ID_DETERMINED }}
          railwayToken: ${{ secrets.RAILWAY_TOKEN }}

  deploy-enchanting-joy:
    needs: preflight
    if: ${{ secrets.RAILWAY_TOKEN && secrets.RAILWAY_SERVICE_ID_ENCHANTING }}
    runs-on: ubuntu-latest
    defaults: { run: { working-directory: backend } }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 18 }
      - run: node -v && npm -v && pwd && ls -la
      - name: Check lockfile and entry
        run: |
          test -f package-lock.json || (echo "❌ package-lock.json missing in backend" && exit 10)
          test -f server.js || (echo "❌ server.js missing in backend" && exit 11)
      - name: Install
        run: npm ci
      - name: Sanity-run (local)
        run: |
          node server.js &
          S=$!
          sleep 1
          curl -sf http://localhost:3000/api/health || (echo "❌ Local healthcheck failed" && kill $S && exit 12)
          kill $S || true
      - name: Deploy to Railway (enchanting-joy)
        uses: railwayapp/action@v1
        with:
          serviceId: ${{ secrets.RAILWAY_SERVICE_ID_ENCHANTING }}
          railwayToken: ${{ secrets.RAILWAY_TOKEN }}