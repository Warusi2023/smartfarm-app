name: SmartFarm CI/CD Pipeline
# Automated deployment: Backend → Railway, Frontend → Netlify

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'

jobs:
  # Job 1: Build and Test
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend-api/package-lock.json
      
      - name: Install backend dependencies
        working-directory: ./backend-api
        run: npm ci
      
      - name: Run backend tests
        working-directory: ./backend-api
        run: npm run test:ci
        continue-on-error: true
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: backend-api/coverage/
      
      - name: Check frontend files
        run: |
          echo "Checking frontend static files..."
          ls -la web-project/public/
          echo "✅ Frontend files present"

  # Job 2: Deploy Backend to Railway
  deploy-backend:
    name: Deploy Backend (Railway)
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to Railway
        uses: bervProject/railway-deploy@main
        with:
          service: ${{ secrets.RAILWAY_SERVICE_NAME || 'smartfarm-backend' }}
          railway_token: ${{ secrets.RAILWAY_TOKEN }}
      
      - name: Wait for Railway deployment
        run: sleep 30
      
      - name: Health check
        run: |
          echo "Checking Railway backend health..."
          HEALTH_URL="${{ secrets.RAILWAY_PUBLIC_URL || 'https://smartfarm-app-production.up.railway.app' }}/api/health"
          echo "Health check URL: $HEALTH_URL"
          
          for i in {1..5}; do
            if curl -f -s "$HEALTH_URL"; then
              echo "✅ Backend is healthy!"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 10s..."
            sleep 10
          done
          
          echo "⚠️  Health check failed, but deployment may still be in progress"
          exit 0

  # Job 3: Deploy Frontend to Netlify
  deploy-frontend:
    name: Deploy Frontend (Netlify)
    needs: deploy-backend
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Prepare frontend files
        run: |
          echo "Preparing frontend for deployment..."
          cd web-project/public
          
          # Create _redirects for Netlify SPA routing
          cat > _redirects << EOF
          # API proxy (optional - direct calls work too)
          /api/*  https://smartfarm-app-production.up.railway.app/api/:splat  200
          
          # SPA fallback
          /*    /index.html   200
          EOF
          
          echo "✅ Frontend prepared"
      
      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v2
        with:
          publish-dir: 'web-project/public'
          production-deploy: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions - ${{ github.sha }}"
          enable-pull-request-comment: true
          enable-commit-comment: true
          enable-commit-status: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
      
      - name: Verify deployment
        run: |
          echo "🎉 Deployment complete!"
          echo "Backend: https://smartfarm-app-production.up.railway.app"
          echo "Frontend: Will be displayed in Netlify deploy comment"

  # Job 4: E2E Tests (Optional - runs after deployment)
  e2e-tests:
    name: E2E Tests
    needs: deploy-frontend
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    continue-on-error: true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install Playwright
        run: |
          npm init -y
          npm install -D @playwright/test
          npx playwright install --with-deps chromium
      
      - name: Run E2E tests
        run: |
          echo "E2E tests would run here"
          echo "Target: ${{ secrets.NETLIFY_SITE_URL || 'https://dulcet-sawine-92d6a8.netlify.app' }}"
          # npx playwright test --project=chromium
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results
          path: test-results/
        continue-on-error: true

  # Job 5: Notify on completion
  notify:
    name: Deployment Summary
    needs: [build-and-test, deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "## 🚀 SmartFarm Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Test | ${{ needs.build-and-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend (Railway) | ${{ needs.deploy-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend (Netlify) | ${{ needs.deploy-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🔗 Links" >> $GITHUB_STEP_SUMMARY
          echo "- Backend API: https://smartfarm-app-production.up.railway.app" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: https://dulcet-sawine-92d6a8.netlify.app" >> $GITHUB_STEP_SUMMARY
