<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farm Dashboard - SmartFarm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/currency-config.js"></script>
    <script src="js/currency-selector.js"></script>
    <style>
        :root {
            --primary-color: #2e7d32;
            --secondary-color: #4caf50;
            --accent-color: #8bc34a;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --info-color: #2196f3;
            --dark-color: #424242;
            --light-color: #f5f5f5;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            min-height: 100vh;
            color: white;
            transition: all 0.3s ease;
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            border-radius: 8px;
            margin: 5px 0;
            transition: all 0.3s ease;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateX(5px);
        }

        .main-content {
            padding: 20px;
        }

        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            margin-bottom: 20px;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .btn-custom {
            background: var(--accent-color);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .btn-custom:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .table-custom {
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }

        .table-custom th {
            background: var(--light-color);
            border: none;
            font-weight: 600;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-active { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-warning { background: #f8d7da; color: #721c24; }
        .status-growing { background: #d4edda; color: #155724; }
        .status-ready { background: #d1ecf1; color: #0c5460; }
        .status-harvested { background: #f8d7da; color: #721c24; }
        .status-healthy { background: #d4edda; color: #155724; }
        .status-sick { background: #f8d7da; color: #721c24; }
        .status-quarantine { background: #fff3cd; color: #856404; }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .navbar-custom {
            background: white !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -250px;
                top: 0;
                width: 250px;
                z-index: 1000;
                transition: left 0.3s ease;
            }

            .sidebar.show {
                left: 0;
            }

            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light navbar-custom">
        <div class="container-fluid">
            <button class="btn btn-outline-primary d-lg-none me-3" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
            <a class="navbar-brand" href="#">
                <i class="fas fa-leaf me-2"></i>SmartFarm Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
                        <div class="user-avatar me-2" id="userAvatar">F</div>
                        <span id="userName">Farmer</span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="editProfile()"><i class="fas fa-user me-2"></i>Profile</a></li>
                        <li><a class="dropdown-item" href="#" onclick="showSettings()"><i class="fas fa-cog me-2"></i>Settings</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-lg-2 col-md-3 sidebar" id="sidebar">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h5>Farm Management</h5>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" onclick="showDashboard()">
                                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showFarmManagement()">
                                <i class="fas fa-tractor me-2"></i>Farm Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showCropManagement(); return false;">
                                <i class="fas fa-seedling me-2"></i>Crop Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showLivestockManagement(); return false;">
                                <i class="fas fa-cow me-2"></i>Livestock
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showInventoryManagement(); return false;">
                                <i class="fas fa-boxes me-2"></i>Inventory
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showAnalytics(); return false;">
                                <i class="fas fa-chart-line me-2"></i>Analytics
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showTasks()">
                                <i class="fas fa-tasks me-2"></i>Tasks
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showReports()">
                                <i class="fas fa-file-alt me-2"></i>Reports
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-lg-10 col-md-9 main-content" id="mainContent">
                <!-- Dashboard Overview -->
                <div id="dashboardView">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Farm Dashboard</h2>
                        <div>
                            <span class="badge bg-success me-2">Online</span>
                            <small class="text-muted">Last updated: <span id="lastUpdated"></span></small>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="row">
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card">
                                <div class="stat-number" id="totalCrops">12</div>
                                <div>Active Crops</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card">
                                <div class="stat-number" id="totalLivestock">45</div>
                                <div>Livestock</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card">
                                <div class="stat-number" id="totalFields">8</div>
                                <div>Fields</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card">
                                <div class="stat-number" id="monthlyYield">2.5</div>
                                <div>Monthly Yield (tons)</div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="dashboard-card">
                                <h5 class="mb-3">Crop Yield Trend</h5>
                                <div class="chart-container">
                                    <canvas id="yieldChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="dashboard-card">
                                <h5 class="mb-3">Field Status</h5>
                                <div class="chart-container">
                                    <canvas id="fieldStatusChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activities -->
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="dashboard-card">
                                <h5 class="mb-3">Recent Activities</h5>
                                <div class="activity-list" id="recentActivities">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="bg-success rounded-circle p-2 me-3">
                                            <i class="fas fa-seedling text-white"></i>
                                        </div>
                                        <div>
                                            <div class="fw-bold">New crop planted</div>
                                            <small class="text-muted">Tomatoes in Field A - 2 hours ago</small>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="bg-info rounded-circle p-2 me-3">
                                            <i class="fas fa-tint text-white"></i>
                                        </div>
                                        <div>
                                            <div class="fw-bold">Irrigation completed</div>
                                            <small class="text-muted">Field B irrigation - 4 hours ago</small>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="bg-warning rounded-circle p-2 me-3">
                                            <i class="fas fa-exclamation-triangle text-white"></i>
                                        </div>
                                        <div>
                                            <div class="fw-bold">Soil moisture alert</div>
                                            <small class="text-muted">Field C needs attention - 6 hours ago</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="dashboard-card">
                                <h5 class="mb-3">Upcoming Tasks</h5>
                                <div class="task-list" id="upcomingTasks">
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
                                        <div>
                                            <div class="fw-bold">Harvest Field A</div>
                                            <small class="text-muted">Due: Tomorrow</small>
                                        </div>
                                        <span class="status-badge status-pending">Pending</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
                                        <div>
                                            <div class="fw-bold">Fertilize Field B</div>
                                            <small class="text-muted">Due: 3 days</small>
                                        </div>
                                        <span class="status-badge status-active">Scheduled</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
                                        <div>
                                            <div class="fw-bold">Check irrigation system</div>
                                            <small class="text-muted">Due: 5 days</small>
                                        </div>
                                        <span class="status-badge status-warning">Overdue</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Other Views (initially hidden) -->
                <div id="farmManagementView" style="display: none;">
                    <h2>Farm Management</h2>
                    <div class="dashboard-card">
                        <h5>Farm Information</h5>
                        <form id="farmForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Farm Name</label>
                                        <input type="text" class="form-control" id="farmName" value="Green Valley Farm">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Location</label>
                                        <input type="text" class="form-control" id="farmLocation" value="Suva, Fiji">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Total Area (hectares)</label>
                                        <input type="number" class="form-control" id="farmArea" value="25.5">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Farm Type</label>
                                        <select class="form-select" id="farmType">
                                            <option value="mixed">Mixed Farming</option>
                                            <option value="crops">Crop Farming</option>
                                            <option value="livestock">Livestock Farming</option>
                                            <option value="dairy">Dairy Farming</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-custom" onclick="saveFarmData()">
                                <i class="fas fa-save me-2"></i>Save Changes
                            </button>
                        </form>
                    </div>
                </div>

                <div id="cropManagementView" style="display: none;">
                    <h2>Crop Management</h2>
                    <div class="dashboard-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Crops</h5>
                            <button class="btn btn-custom" onclick="addNewCrop()">
                                <i class="fas fa-plus me-2"></i>Add Crop
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-custom">
                                <thead>
                                    <tr>
                                        <th>Crop</th>
                                        <th>Field</th>
                                        <th>Planted Date</th>
                                        <th>Status</th>
                                        <th>pH Level</th>
                                        <th>Pest Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="cropsTable">
                                    <tr>
                                        <td>Tomatoes</td>
                                        <td>Field A</td>
                                        <td>2025-01-15</td>
                                        <td><span class="status-badge status-active">Growing</span></td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editCrop(1)">Edit</button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCrop(1)">Delete</button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Capsicum</td>
                                        <td>Field B</td>
                                        <td>2025-01-10</td>
                                        <td><span class="status-badge status-active">Growing</span></td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editCrop(2)">Edit</button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCrop(2)">Delete</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="livestockManagementView" style="display: none;">
                    <h2>Livestock Management</h2>
                    <div class="dashboard-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Livestock</h5>
                            <button class="btn btn-custom" onclick="addNewLivestock()">
                                <i class="fas fa-plus me-2"></i>Add Livestock
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-custom">
                                <thead>
                                    <tr>
                                        <th>Species</th>
                                        <th>Breed</th>
                                        <th>Count</th>
                                        <th>Location</th>
                                        <th>Health Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="livestockTable">
                                    <tr>
                                        <td>Cattle</td>
                                        <td>Holstein</td>
                                        <td>25</td>
                                        <td>Pasture 1</td>
                                        <td><span class="status-badge status-active">Healthy</span></td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editLivestock(1)">Edit</button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteLivestock(1)">Delete</button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Pigs</td>
                                        <td>Large White</td>
                                        <td>15</td>
                                        <td>Pen 2</td>
                                        <td><span class="status-badge status-active">Healthy</span></td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editLivestock(2)">Edit</button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteLivestock(2)">Delete</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="inventoryManagementView" style="display: none;">
                    <h2>Inventory Management</h2>
                    <div class="dashboard-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Inventory Items</h5>
                            <button class="btn btn-custom" onclick="addInventoryItem()">
                                <i class="fas fa-plus me-2"></i>Add Item
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-custom">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Category</th>
                                        <th>Quantity</th>
                                        <th>Unit</th>
                                        <th>Last Updated</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="inventoryTable">
                                    <tr>
                                        <td>Fertilizer NPK</td>
                                        <td>Chemicals</td>
                                        <td>50</td>
                                        <td>kg</td>
                                        <td>2025-01-10</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editInventory(1)">Edit</button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteInventory(1)">Delete</button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Seeds - Tomato</td>
                                        <td>Seeds</td>
                                        <td>100</td>
                                        <td>packets</td>
                                        <td>2025-01-08</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editInventory(2)">Edit</button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteInventory(2)">Delete</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="analyticsView" style="display: none;">
                    <h2>Analytics & Reports</h2>
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="dashboard-card">
                                <h5>Revenue Analysis</h5>
                                <div class="chart-container">
                                    <canvas id="revenueChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="dashboard-card">
                                <h5>Cost Analysis</h5>
                                <div class="chart-container">
                                    <canvas id="costChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tasksView" style="display: none;">
                    <h2>Task Management</h2>
                    <div class="dashboard-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Tasks</h5>
                            <button class="btn btn-custom" onclick="addNewTask()">
                                <i class="fas fa-plus me-2"></i>Add Task
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-custom">
                                <thead>
                                    <tr>
                                        <th>Task</th>
                                        <th>Priority</th>
                                        <th>Due Date</th>
                                        <th>Status</th>
                                        <th>Assigned To</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tasksTable">
                                    <tr>
                                        <td>Harvest Field A</td>
                                        <td><span class="badge bg-danger">High</span></td>
                                        <td>2025-01-20</td>
                                        <td><span class="status-badge status-pending">Pending</span></td>
                                        <td>John Doe</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-success me-1" onclick="completeTask(1)">Complete</button>
                                            <button class="btn btn-sm btn-outline-primary" onclick="editTask(1)">Edit</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="reportsView" style="display: none;">
                    <h2>Reports & Data Export</h2>
                    
                    <!-- Quick Reports -->
                    <div class="dashboard-card mb-4">
                        <h5>Quick Reports</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-chart-bar fa-3x text-primary mb-3"></i>
                                        <h6>Farm Summary</h6>
                                        <p class="small text-muted">Overview of all farm data</p>
                                        <button class="btn btn-outline-primary btn-sm" onclick="generateReport('summary')">Generate</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-seedling fa-3x text-success mb-3"></i>
                                        <h6>Crop Report</h6>
                                        <p class="small text-muted">Detailed crop analysis</p>
                                        <button class="btn btn-outline-success btn-sm" onclick="generateReport('crops')">Generate</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-cow fa-3x text-info mb-3"></i>
                                        <h6>Livestock Report</h6>
                                        <p class="small text-muted">Livestock management data</p>
                                        <button class="btn btn-outline-info btn-sm" onclick="generateReport('livestock')">Generate</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-boxes fa-3x text-warning mb-3"></i>
                                        <h6>Inventory Report</h6>
                                        <p class="small text-muted">Stock and supplies analysis</p>
                                        <button class="btn btn-outline-warning btn-sm" onclick="generateReport('inventory')">Generate</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Data Export -->
                    <div class="dashboard-card mb-4">
                        <h5>Export Data</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-file-csv fa-3x text-success mb-3"></i>
                                        <h6>CSV Export</h6>
                                        <p class="small text-muted">Excel-compatible format</p>
                                        <div class="btn-group-vertical w-100">
                                            <button class="btn btn-outline-success btn-sm" onclick="exportToCSV('all')">All Data</button>
                                            <button class="btn btn-outline-success btn-sm" onclick="exportToCSV('crops')">Crops Only</button>
                                            <button class="btn btn-outline-success btn-sm" onclick="exportToCSV('livestock')">Livestock Only</button>
                                            <button class="btn btn-outline-success btn-sm" onclick="exportToCSV('inventory')">Inventory Only</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-file-pdf fa-3x text-danger mb-3"></i>
                                        <h6>PDF Report</h6>
                                        <p class="small text-muted">Professional formatted report</p>
                                        <div class="btn-group-vertical w-100">
                                            <button class="btn btn-outline-danger btn-sm" onclick="exportToPDF('summary')">Summary Report</button>
                                            <button class="btn btn-outline-danger btn-sm" onclick="exportToPDF('detailed')">Detailed Report</button>
                                            <button class="btn btn-outline-danger btn-sm" onclick="exportToPDF('financial')">Financial Report</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-file-code fa-3x text-info mb-3"></i>
                                        <h6>JSON Export</h6>
                                        <p class="small text-muted">Raw data for integration</p>
                                        <div class="btn-group-vertical w-100">
                                            <button class="btn btn-outline-info btn-sm" onclick="exportToJSON('all')">All Data</button>
                                            <button class="btn btn-outline-info btn-sm" onclick="exportToJSON('backup')">Backup Data</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Reports -->
                    <div class="dashboard-card">
                        <h5>Custom Report Builder</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Report Type</label>
                                    <select class="form-select" id="customReportType">
                                        <option value="summary">Farm Summary</option>
                                        <option value="crops">Crop Analysis</option>
                                        <option value="livestock">Livestock Management</option>
                                        <option value="inventory">Inventory Status</option>
                                        <option value="financial">Financial Overview</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Date Range</label>
                                    <select class="form-select" id="customDateRange">
                                        <option value="current">Current Month</option>
                                        <option value="last3">Last 3 Months</option>
                                        <option value="last6">Last 6 Months</option>
                                        <option value="year">This Year</option>
                                        <option value="all">All Time</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Include Charts</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="includeCharts" checked>
                                        <label class="form-check-label" for="includeCharts">
                                            Include visual charts
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Export Format</label>
                                    <select class="form-select" id="exportFormat">
                                        <option value="pdf">PDF Document</option>
                                        <option value="csv">CSV Spreadsheet</option>
                                        <option value="json">JSON Data</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="generateCustomReport()">
                            <i class="fas fa-file-alt me-2"></i>Generate Custom Report
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Data arrays for crops, livestock, and inventory
        let crops = [];
        let livestock = [];
        let inventory = [];

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            updateLastUpdated();
            setInterval(updateLastUpdated, 60000); // Update every minute
            
            // Initialize URL routing
            initializeURLRouting();
        });

        function initializeDashboard() {
            // Initialize charts
            initializeCharts();
            
            // Check authentication
            checkAuthentication();
            
            // Load initial data
            loadDashboardData();
        }

        function checkAuthentication() {
            const user = localStorage.getItem('smartfarm_user') || sessionStorage.getItem('smartfarm_user');
            const token = localStorage.getItem('smartfarm_token') || sessionStorage.getItem('smartfarm_token');
            
            if (!user) {
                console.log('No user found, redirecting to login');
                window.location.href = 'login.html';
                return;
            }
            
            // Check if session is still valid (for non-remember me users)
            const rememberMe = localStorage.getItem('smartfarm_remember');
            if (!rememberMe) {
                const loginTime = sessionStorage.getItem('smartfarm_loginTime');
                if (loginTime) {
                    const sessionAge = Date.now() - new Date(loginTime).getTime();
                    const maxSessionAge = 24 * 60 * 60 * 1000; // 24 hours
                    if (sessionAge > maxSessionAge) {
                        console.log('Session expired, redirecting to login');
                        sessionStorage.clear();
                        window.location.href = 'login.html';
                        return;
                    }
                }
            }
            
            // Update user info in navbar
            const userName = user.split('@')[0];
            const userNameElement = document.getElementById('userName');
            const userAvatarElement = document.getElementById('userAvatar');
            
            if (userNameElement) {
                userNameElement.textContent = userName;
            }
            if (userAvatarElement) {
                userAvatarElement.textContent = userName.charAt(0).toUpperCase();
            }
            
            console.log('User authenticated:', userName);
        }

        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = now.toLocaleTimeString();
        }

        // Global chart instances
        let yieldChart = null;
        let fieldStatusChart = null;
        let revenueChart = null;
        let costChart = null;

        function initializeCharts() {
            // Yield Chart
            const yieldCtx = document.getElementById('yieldChart').getContext('2d');
            yieldChart = new Chart(yieldCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Yield (tons)',
                        data: [2.1, 2.3, 2.8, 2.5, 2.9, 3.1],
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Field Status Chart
            const fieldCtx = document.getElementById('fieldStatusChart').getContext('2d');
            fieldStatusChart = new Chart(fieldCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Active', 'Harvesting', 'Fallow'],
                    datasets: [{
                        data: [6, 2, 0],
                        backgroundColor: ['#4CAF50', '#FF9800', '#9E9E9E']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function initializeAnalyticsCharts() {
            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart');
            if (revenueCtx) {
                revenueChart = new Chart(revenueCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Crops', 'Livestock', 'Total'],
                        datasets: [{
                            label: 'Revenue (' + (window.currencyManager ? window.currencyManager.getSymbol() : '$') + ')',
                            data: [0, 0, 0],
                            backgroundColor: ['#4CAF50', '#2196F3', '#FF9800']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Cost Chart
            const costCtx = document.getElementById('costChart');
            if (costCtx) {
                costChart = new Chart(costCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Seeds/Feed', 'Equipment', 'Labor', 'Other'],
                        datasets: [{
                            data: [25, 30, 35, 10],
                            backgroundColor: ['#FF5722', '#9C27B0', '#3F51B5', '#607D8B']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        function loadDashboardData() {
            // Load data from API or localStorage
            // This would typically make API calls to your backend
            console.log('Loading dashboard data...');
            
            // Load farm data from localStorage
            loadFarmData();
            
            // Load crops, livestock, and inventory data
            loadCropsData();
            loadLivestockData();
            loadInventoryData();
        }

        function loadFarmData() {
            const savedFarmData = localStorage.getItem('farmData');
            if (savedFarmData) {
                try {
                    const farmData = JSON.parse(savedFarmData);
                    
                    // Update form fields with saved data
                    const farmNameField = document.getElementById('farmName');
                    const farmLocationField = document.getElementById('farmLocation');
                    const farmAreaField = document.getElementById('farmArea');
                    const farmTypeField = document.getElementById('farmType');
                    
                    if (farmNameField) farmNameField.value = farmData.name || 'Green Valley Farm';
                    if (farmLocationField) farmLocationField.value = farmData.location || 'Suva, Fiji';
                    if (farmAreaField) farmAreaField.value = farmData.area || '25.5';
                    if (farmTypeField) farmTypeField.value = farmData.type || 'Mixed Farming';
                    
                    console.log('Farm data loaded from localStorage:', farmData);
                } catch (e) {
                    console.error('Error loading farm data:', e);
                }
            } else {
                console.log('No saved farm data found, using defaults');
            }
        }

        function loadCropsData() {
            const savedCrops = localStorage.getItem('cropsData');
            if (savedCrops) {
                try {
                    crops = JSON.parse(savedCrops);
                    console.log('Crops data loaded from localStorage:', crops);
                } catch (e) {
                    console.error('Error loading crops data:', e);
                    crops = [];
                }
            } else {
                // Initialize with default data
                crops = [
                    { id: 1, name: 'Tomatoes', field: 'Field A', plantedDate: '2025-01-15', status: 'Growing' },
                    { id: 2, name: 'Lettuce', field: 'Field B', plantedDate: '2025-01-10', status: 'Ready' }
                ];
                saveCropsData();
            }
            renderCropsTable();
        }

        function loadLivestockData() {
            const savedLivestock = localStorage.getItem('livestockData');
            if (savedLivestock) {
                try {
                    livestock = JSON.parse(savedLivestock);
                    console.log('Livestock data loaded from localStorage:', livestock);
                } catch (e) {
                    console.error('Error loading livestock data:', e);
                    livestock = [];
                }
            } else {
                // Initialize with default data
                livestock = [
                    { id: 1, type: 'Cattle', breed: 'Holstein', quantity: 25, location: 'Pasture 1', status: 'Healthy' },
                    { id: 2, type: 'Pigs', breed: 'Large White', quantity: 15, location: 'Pen 2', status: 'Healthy' }
                ];
                saveLivestockData();
            }
            renderLivestockTable();
        }

        function loadInventoryData() {
            const savedInventory = localStorage.getItem('inventoryData');
            if (savedInventory) {
                try {
                    inventory = JSON.parse(savedInventory);
                    console.log('Inventory data loaded from localStorage:', inventory);
                } catch (e) {
                    console.error('Error loading inventory data:', e);
                    inventory = [];
                }
            } else {
                // Initialize with default data
                inventory = [
                    { id: 1, name: 'Fertilizer NPK', category: 'Chemicals', quantity: 50, unit: 'kg', lastUpdated: '2025-01-10' },
                    { id: 2, name: 'Seeds - Tomato', category: 'Seeds', quantity: 100, unit: 'packets', lastUpdated: '2025-01-08' }
                ];
                saveInventoryData();
            }
            renderInventoryTable();
        }

        // Navigation functions
        function showDashboard() {
            showView('dashboardView');
            setActiveNav('dashboard');
            updateURL('dashboardView');
        }

        function showFarmManagement() {
            showView('farmManagementView');
            setActiveNav('farm');
            updateURL('farmManagementView');
            // Load fresh farm data when switching to this tab
            loadFarmData();
        }

        function showCropManagement() {
            console.log('Switching to Crop Management...');
            showView('cropManagementView');
            setActiveNav('crop');
            updateURL('cropManagementView');
            // Load fresh crop data when switching to this tab
            loadCropsData();
            console.log('Crops data after loading:', crops);
        }

        function showLivestockManagement() {
            console.log('Switching to Livestock Management...');
            showView('livestockManagementView');
            setActiveNav('livestock');
            updateURL('livestockManagementView');
            // Load fresh livestock data when switching to this tab
            loadLivestockData();
            console.log('Livestock data after loading:', livestock);
        }

        function showInventoryManagement() {
            console.log('Switching to Inventory Management...');
            showView('inventoryManagementView');
            setActiveNav('inventory');
            updateURL('inventoryManagementView');
            // Load fresh inventory data when switching to this tab
            loadInventoryData();
            console.log('Inventory data after loading:', inventory);
        }

        function showAnalytics() {
            showView('analyticsView');
            setActiveNav('analytics');
            updateURL('analyticsView');
            // Initialize analytics charts if not already initialized
            if (!revenueChart || !costChart) {
                initializeAnalyticsCharts();
            }
            // Update charts with current data
            updateAnalyticsCharts();
        }

        function showTasks() {
            showView('tasksView');
            setActiveNav('tasks');
            updateURL('tasksView');
        }

        function showReports() {
            showView('reportsView');
            setActiveNav('reports');
            updateURL('reportsView');
        }

        function showView(viewId) {
            // Hide all views
            const views = ['dashboardView', 'farmManagementView', 'cropManagementView', 
                          'livestockManagementView', 'inventoryManagementView', 
                          'analyticsView', 'tasksView', 'reportsView'];
            views.forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            
            // Show selected view
            document.getElementById(viewId).style.display = 'block';
        }

        function setActiveNav(navItem) {
            // Remove active class from all nav links
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Add active class to clicked nav link
            event.target.classList.add('active');
        }

        // Data management functions
        function saveFarmData() {
            // Get form values
            const farmName = document.getElementById('farmName').value.trim();
            const farmLocation = document.getElementById('farmLocation').value.trim();
            const farmArea = document.getElementById('farmArea').value.trim();
            const farmType = document.getElementById('farmType').value;

            // Basic validation
            if (!farmName) {
                alert('Please enter a farm name.');
                document.getElementById('farmName').focus();
                return;
            }

            if (!farmLocation) {
                alert('Please enter a farm location.');
                document.getElementById('farmLocation').focus();
                return;
            }

            if (!farmArea || isNaN(farmArea) || parseFloat(farmArea) <= 0) {
                alert('Please enter a valid farm area (positive number).');
                document.getElementById('farmArea').focus();
                return;
            }

            if (!farmType) {
                alert('Please select a farm type.');
                document.getElementById('farmType').focus();
                return;
            }

            // Create farm data object
            const farmData = {
                name: farmName,
                location: farmLocation,
                area: parseFloat(farmArea),
                type: farmType,
                lastUpdated: new Date().toISOString()
            };
            
            try {
                // Save to localStorage
                localStorage.setItem('farmData', JSON.stringify(farmData));
                
                // Show success message
                showSuccessMessage('Farm data saved successfully!');
                
                // Log the saved data
                console.log('Farm data saved:', farmData);
                
                // Optional: Send to API if available
                // saveFarmDataToAPI(farmData);
                
            } catch (error) {
                console.error('Error saving farm data:', error);
                alert('Error saving farm data. Please try again.');
            }
        }

        function showSuccessMessage(message) {
            // Create a more elegant success notification
            const notification = document.createElement('div');
            notification.className = 'alert alert-success alert-dismissible fade show';
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            notification.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        function updateAnalyticsCharts() {
            // Calculate revenue from crops and livestock
            let cropRevenue = 0;
            let livestockRevenue = 0;
            
            // Simple revenue calculation based on data
            cropRevenue = crops.length * 250; // $250 per crop type
            livestockRevenue = livestock.reduce((total, animal) => total + (animal.quantity * 50), 0); // $50 per animal
            
            const totalRevenue = cropRevenue + livestockRevenue;
            
            // Update revenue chart
            if (revenueChart) {
                revenueChart.data.datasets[0].data = [cropRevenue, livestockRevenue, totalRevenue];
                revenueChart.update();
            }
            
            // Update field status chart based on crops
            if (fieldStatusChart) {
                const activeCrops = crops.filter(crop => crop.status.toLowerCase() === 'growing').length;
                const readyCrops = crops.filter(crop => crop.status.toLowerCase() === 'ready').length;
                const harvestedCrops = crops.filter(crop => crop.status.toLowerCase() === 'harvested').length;
                
                fieldStatusChart.data.datasets[0].data = [activeCrops, readyCrops, harvestedCrops];
                fieldStatusChart.data.labels = ['Growing', 'Ready', 'Harvested'];
                fieldStatusChart.update();
            }
            
            // Update yield chart with crop data
            if (yieldChart) {
                // Generate yield data based on crops
                const yieldData = [];
                for (let i = 0; i < 6; i++) {
                    yieldData.push(2.0 + (crops.length * 0.1) + (Math.random() * 0.5));
                }
                yieldChart.data.datasets[0].data = yieldData;
                yieldChart.update();
            }
            
            console.log('Analytics charts updated:', { cropRevenue, livestockRevenue, totalRevenue });
        }

        // Save functions for data persistence
        function saveCropsData() {
            localStorage.setItem('cropsData', JSON.stringify(crops));
        }

        function saveLivestockData() {
            localStorage.setItem('livestockData', JSON.stringify(livestock));
        }

        function saveInventoryData() {
            localStorage.setItem('inventoryData', JSON.stringify(inventory));
        }

        // Table rendering functions
        function renderCropsTable() {
            const tbody = document.querySelector('#cropsTable');
            if (!tbody) return;

            tbody.innerHTML = '';
            crops.forEach(crop => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${crop.name}</td>
                    <td>${crop.field || 'Field A'}</td>
                    <td>${crop.plantedDate || new Date().toISOString().split('T')[0]}</td>
                    <td><span class="status-badge status-${crop.status.toLowerCase()}">${crop.status}</span></td>
                    <td>${crop.phLevel ? crop.phLevel : '-'}</td>
                    <td>${crop.pestIssues ? '<span class="text-danger"> Issues</span>' : '<span class="text-success"> Clear</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editCrop(${crop.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info me-1" onclick="showAISuggestions(${crop.id})">
                            <i class="fas fa-brain"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCrop(${crop.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderLivestockTable() {
            const tbody = document.querySelector('#livestockTable');
            if (!tbody) return;

            tbody.innerHTML = '';
            livestock.forEach(animal => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${animal.type}</td>
                    <td>${animal.breed}</td>
                    <td>${animal.quantity}</td>
                    <td>${animal.location}</td>
                    <td><span class="status-badge status-${animal.status.toLowerCase()}">${animal.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editLivestock(${animal.id})">Edit</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteLivestock(${animal.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderInventoryTable() {
            const tbody = document.querySelector('#inventoryTable');
            if (!tbody) return;

            tbody.innerHTML = '';
            inventory.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.category}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unit}</td>
                    <td>${item.lastUpdated || new Date().toISOString().split('T')[0]}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editInventory(${item.id})">Edit</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteInventory(${item.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function addNewCrop() {
            // Create add crop modal with enhanced fields
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add New Crop</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addCropForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="newCropName" class="form-label">Crop Name *</label>
                                            <input type="text" class="form-control" id="newCropName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newCropField" class="form-label">Field Name *</label>
                                            <input type="text" class="form-control" id="newCropField" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newCropArea" class="form-label">Area (hectares)</label>
                                            <input type="number" class="form-control" id="newCropArea" step="0.1">
                                        </div>
                                        <div class="mb-3">
                                            <label for="newCropPlantedDate" class="form-label">Planted Date *</label>
                                            <input type="date" class="form-control" id="newCropPlantedDate" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newCropStatus" class="form-label">Status *</label>
                                            <select class="form-select" id="newCropStatus" required>
                                                <option value="planted">Planted</option>
                                                <option value="growing">Growing</option>
                                                <option value="ready">Ready for Harvest</option>
                                                <option value="harvested">Harvested</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="newCropPH" class="form-label">Soil pH Level</label>
                                            <input type="number" class="form-control" id="newCropPH" min="0" max="14" step="0.1" placeholder="6.5">
                                            <small class="form-text text-muted">Optimal range: 6.0-7.0 for most crops</small>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newCropPestIssues" class="form-label">Pest Issues</label>
                                            <textarea class="form-control" id="newCropPestIssues" rows="3" placeholder="Describe any pest problems observed..."></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newCropNotes" class="form-label">Additional Notes</label>
                                            <textarea class="form-control" id="newCropNotes" rows="2" placeholder="Any additional observations..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveNewCrop()">Add Crop</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function saveNewCrop() {
            const name = document.getElementById('newCropName').value.trim();
            const field = document.getElementById('newCropField').value.trim();
            const area = document.getElementById('newCropArea').value.trim();
            const plantedDate = document.getElementById('newCropPlantedDate').value.trim();
            const status = document.getElementById('newCropStatus').value.trim();
            const phLevel = document.getElementById('newCropPH').value.trim();
            const pestIssues = document.getElementById('newCropPestIssues').value.trim();
            const notes = document.getElementById('newCropNotes').value.trim();

            if (!name || !field || !plantedDate || !status) {
                alert('Please fill in all required fields');
                return;
            }

            const newCrop = {
                id: Date.now(),
                name: name,
                field: field,
                area: area ? parseFloat(area) : null,
                plantedDate: plantedDate,
                status: status,
                phLevel: phLevel ? parseFloat(phLevel) : null,
                pestIssues: pestIssues || null,
                notes: notes || null,
                lastUpdated: new Date().toLocaleDateString()
            };

            crops.push(newCrop);
            console.log('Adding new crop:', newCrop);
            saveCropsData();
            renderCropsTable();
            updateAnalyticsCharts();
            showSuccessMessage('Crop added successfully!');

            // Close modal
            const modal = document.querySelector('.modal');
            if (modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                bsModal.hide();
            }
        }

        function editCrop(id) {
            const crop = crops.find(c => c.id === id);
            if (!crop) {
                alert('Crop not found');
                return;
            }

            // Create edit modal
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Crop</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editCropForm">
                                <div class="mb-3">
                                    <label for="editCropName" class="form-label">Crop Name</label>
                                    <input type="text" class="form-control" id="editCropName" value="${crop.name}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editCropField" class="form-label">Field</label>
                                    <input type="text" class="form-control" id="editCropField" value="${crop.field}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editCropArea" class="form-label">Area (hectares)</label>
                                    <input type="number" class="form-control" id="editCropArea" value="${crop.area || ''}" step="0.1">
                                </div>
                                <div class="mb-3">
                                    <label for="editCropPlantedDate" class="form-label">Planted Date</label>
                                    <input type="date" class="form-control" id="editCropPlantedDate" value="${crop.plantedDate}">
                                </div>
                                <div class="mb-3">
                                    <label for="editCropStatus" class="form-label">Status</label>
                                    <select class="form-select" id="editCropStatus" required>
                                        <option value="growing" ${crop.status.toLowerCase() === 'growing' ? 'selected' : ''}>Growing</option>
                                        <option value="ready" ${crop.status.toLowerCase() === 'ready' ? 'selected' : ''}>Ready for Harvest</option>
                                        <option value="harvested" ${crop.status.toLowerCase() === 'harvested' ? 'selected' : ''}>Harvested</option>
                                        <option value="planted" ${crop.status.toLowerCase() === 'planted' ? 'selected' : ''}>Planted</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="editCropPH" class="form-label">Soil pH Level</label>
                                    <input type="number" class="form-control" id="editCropPH" min="0" max="14" step="0.1" value="${crop.phLevel || ''}" placeholder="6.5">
                                    <small class="form-text text-muted">Optimal range: 6.0-7.0 for most crops</small>
                                </div>
                                <div class="mb-3">
                                    <label for="editCropPestIssues" class="form-label">Pest Issues</label>
                                    <textarea class="form-control" id="editCropPestIssues" rows="3" placeholder="Describe any pest problems observed...">${crop.pestIssues || ''}</textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="editCropNotes" class="form-label">Additional Notes</label>
                                    <textarea class="form-control" id="editCropNotes" rows="2" placeholder="Any additional observations...">${crop.notes || ''}</textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveEditedCrop(${id})">Save Changes</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function saveEditedCrop(id) {
            const name = document.getElementById('editCropName').value.trim();
            const field = document.getElementById('editCropField').value.trim();
            const area = document.getElementById('editCropArea').value.trim();
            const plantedDate = document.getElementById('editCropPlantedDate').value.trim();
            const status = document.getElementById('editCropStatus').value.trim();
            const phLevel = document.getElementById('editCropPH').value.trim();
            const pestIssues = document.getElementById('editCropPestIssues').value.trim();
            const notes = document.getElementById('editCropNotes').value.trim();

            if (!name || !field || !plantedDate || !status) {
                alert('Please fill in all required fields');
                return;
            }

            // Find and update the crop
            const cropIndex = crops.findIndex(c => c.id === id);
            if (cropIndex !== -1) {
                crops[cropIndex] = {
                    ...crops[cropIndex],
                    name: name,
                    field: field,
                    area: area || null,
                    plantedDate: plantedDate,
                    status: status,
                    phLevel: phLevel ? parseFloat(phLevel) : null,
                    pestIssues: pestIssues || null,
                    notes: notes || null,
                    lastUpdated: new Date().toLocaleDateString()
                };

                saveCropsData();
                renderCropsTable();
                updateAnalyticsCharts();
                showSuccessMessage('Crop updated successfully!');

                // Close modal
                const modal = document.querySelector('.modal');
                if (modal) {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    bsModal.hide();
                }
            }
        }

        function deleteCrop(id) {
            if (confirm('Are you sure you want to delete this crop?')) {
                crops = crops.filter(crop => crop.id !== id);
                saveCropsData();
                renderCropsTable();
                showSuccessMessage('Crop deleted successfully!');
            }
        }

        function addNewLivestock() {
            const type = prompt('Enter livestock type (Cattle/Pigs/Chickens/Sheep):');
            if (!type) return;
            
            const breed = prompt('Enter breed:');
            if (!breed) return;
            
            const quantity = prompt('Enter quantity:');
            if (!quantity || isNaN(quantity) || parseInt(quantity) <= 0) {
                alert('Please enter a valid quantity.');
                return;
            }
            
            const location = prompt('Enter location:');
            if (!location) return;
            
            const status = prompt('Enter health status (Healthy/Sick/Quarantine):', 'Healthy');
            if (!status) return;
            
            const newLivestock = {
                id: Date.now(),
                type: type.trim(),
                breed: breed.trim(),
                quantity: parseInt(quantity),
                location: location.trim(),
                status: status.trim()
            };
            
            livestock.push(newLivestock);
            saveLivestockData();
            renderLivestockTable();
            updateAnalyticsCharts(); // Update charts with new data
            showSuccessMessage('Livestock added successfully!');
        }

        function editLivestock(id) {
            const animal = livestock.find(l => l.id === id);
            if (!animal) {
                alert('Livestock record not found');
                return;
            }

            // Create edit modal
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Livestock</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editLivestockForm">
                                <div class="mb-3">
                                    <label for="editLivestockType" class="form-label">Type</label>
                                    <select class="form-select" id="editLivestockType" required>
                                        <option value="cattle" ${animal.type.toLowerCase() === 'cattle' ? 'selected' : ''}>Cattle</option>
                                        <option value="pigs" ${animal.type.toLowerCase() === 'pigs' ? 'selected' : ''}>Pigs</option>
                                        <option value="sheep" ${animal.type.toLowerCase() === 'sheep' ? 'selected' : ''}>Sheep</option>
                                        <option value="goats" ${animal.type.toLowerCase() === 'goats' ? 'selected' : ''}>Goats</option>
                                        <option value="chickens" ${animal.type.toLowerCase() === 'chickens' ? 'selected' : ''}>Chickens</option>
                                        <option value="ducks" ${animal.type.toLowerCase() === 'ducks' ? 'selected' : ''}>Ducks</option>
                                        <option value="other" ${!['cattle', 'pigs', 'sheep', 'goats', 'chickens', 'ducks'].includes(animal.type.toLowerCase()) ? 'selected' : ''}>Other</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="editLivestockBreed" class="form-label">Breed</label>
                                    <input type="text" class="form-control" id="editLivestockBreed" value="${animal.breed}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editLivestockQuantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="editLivestockQuantity" value="${animal.quantity}" min="1" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editLivestockLocation" class="form-label">Location</label>
                                    <input type="text" class="form-control" id="editLivestockLocation" value="${animal.location}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editLivestockStatus" class="form-label">Health Status</label>
                                    <select class="form-select" id="editLivestockStatus" required>
                                        <option value="healthy" ${animal.status.toLowerCase() === 'healthy' ? 'selected' : ''}>Healthy</option>
                                        <option value="sick" ${animal.status.toLowerCase() === 'sick' ? 'selected' : ''}>Sick</option>
                                        <option value="quarantine" ${animal.status.toLowerCase() === 'quarantine' ? 'selected' : ''}>Quarantine</option>
                                        <option value="pregnant" ${animal.status.toLowerCase() === 'pregnant' ? 'selected' : ''}>Pregnant</option>
                                        <option value="breeding" ${animal.status.toLowerCase() === 'breeding' ? 'selected' : ''}>Breeding</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveEditedLivestock(${id})">Save Changes</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function saveEditedLivestock(id) {
            const type = document.getElementById('editLivestockType').value.trim();
            const breed = document.getElementById('editLivestockBreed').value.trim();
            const quantity = parseInt(document.getElementById('editLivestockQuantity').value);
            const location = document.getElementById('editLivestockLocation').value.trim();
            const status = document.getElementById('editLivestockStatus').value.trim();

            if (!type || !breed || !quantity || !location || !status) {
                alert('Please fill in all required fields');
                return;
            }

            if (quantity < 1) {
                alert('Quantity must be at least 1');
                return;
            }

            // Find and update the livestock
            const livestockIndex = livestock.findIndex(l => l.id === id);
            if (livestockIndex !== -1) {
                livestock[livestockIndex] = {
                    ...livestock[livestockIndex],
                    type: type,
                    breed: breed,
                    quantity: quantity,
                    location: location,
                    status: status
                };

                saveLivestockData();
                renderLivestockTable();
                updateAnalyticsCharts();
                showSuccessMessage('Livestock updated successfully!');

                // Close modal
                const modal = document.querySelector('.modal');
                if (modal) {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    bsModal.hide();
                }
            }
        }

        function deleteLivestock(id) {
            if (confirm('Are you sure you want to delete this livestock record?')) {
                livestock = livestock.filter(animal => animal.id !== id);
                saveLivestockData();
                renderLivestockTable();
                showSuccessMessage('Livestock deleted successfully!');
            }
        }

        function addInventoryItem() {
            const name = prompt('Enter item name:');
            if (!name) return;
            
            const category = prompt('Enter category (Seeds/Supplies/Tools/Equipment):');
            if (!category) return;
            
            const quantity = prompt('Enter quantity:');
            if (!quantity || isNaN(quantity) || parseInt(quantity) <= 0) {
                alert('Please enter a valid quantity.');
                return;
            }
            
            const unit = prompt('Enter unit (bags/packets/pieces/liters):');
            if (!unit) return;
            
            const newItem = {
                id: Date.now(),
                name: name.trim(),
                category: category.trim(),
                quantity: parseInt(quantity),
                unit: unit.trim(),
                lastUpdated: new Date().toISOString().split('T')[0]
            };
            
            inventory.push(newItem);
            saveInventoryData();
            renderInventoryTable();
            showSuccessMessage('Inventory item added successfully!');
        }

        function editInventory(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) {
                alert('Inventory item not found');
                return;
            }

            // Create edit modal
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Inventory Item</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editInventoryForm">
                                <div class="mb-3">
                                    <label for="editInventoryName" class="form-label">Item Name</label>
                                    <input type="text" class="form-control" id="editInventoryName" value="${item.name}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editInventoryCategory" class="form-label">Category</label>
                                    <select class="form-select" id="editInventoryCategory" required>
                                        <option value="seeds" ${item.category.toLowerCase() === 'seeds' ? 'selected' : ''}>Seeds</option>
                                        <option value="fertilizers" ${item.category.toLowerCase() === 'fertilizers' ? 'selected' : ''}>Fertilizers</option>
                                        <option value="tools" ${item.category.toLowerCase() === 'tools' ? 'selected' : ''}>Tools</option>
                                        <option value="equipment" ${item.category.toLowerCase() === 'equipment' ? 'selected' : ''}>Equipment</option>
                                        <option value="feed" ${item.category.toLowerCase() === 'feed' ? 'selected' : ''}>Feed</option>
                                        <option value="medicine" ${item.category.toLowerCase() === 'medicine' ? 'selected' : ''}>Medicine</option>
                                        <option value="other" ${!['seeds', 'fertilizers', 'tools', 'equipment', 'feed', 'medicine'].includes(item.category.toLowerCase()) ? 'selected' : ''}>Other</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="editInventoryQuantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="editInventoryQuantity" value="${item.quantity}" min="0" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editInventoryUnit" class="form-label">Unit</label>
                                    <select class="form-select" id="editInventoryUnit" required>
                                        <option value="kg" ${item.unit.toLowerCase() === 'kg' ? 'selected' : ''}>Kilograms (kg)</option>
                                        <option value="liters" ${item.unit.toLowerCase() === 'liters' ? 'selected' : ''}>Liters</option>
                                        <option value="pieces" ${item.unit.toLowerCase() === 'pieces' ? 'selected' : ''}>Pieces</option>
                                        <option value="bags" ${item.unit.toLowerCase() === 'bags' ? 'selected' : ''}>Bags</option>
                                        <option value="boxes" ${item.unit.toLowerCase() === 'boxes' ? 'selected' : ''}>Boxes</option>
                                        <option value="tons" ${item.unit.toLowerCase() === 'tons' ? 'selected' : ''}>Tons</option>
                                        <option value="gallons" ${item.unit.toLowerCase() === 'gallons' ? 'selected' : ''}>Gallons</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="editInventoryStatus" class="form-label">Status</label>
                                    <select class="form-select" id="editInventoryStatus" required>
                                        <option value="in-stock" ${item.status === 'in-stock' ? 'selected' : ''}>In Stock</option>
                                        <option value="low-stock" ${item.status === 'low-stock' ? 'selected' : ''}>Low Stock</option>
                                        <option value="out-of-stock" ${item.status === 'out-of-stock' ? 'selected' : ''}>Out of Stock</option>
                                        <option value="ordered" ${item.status === 'ordered' ? 'selected' : ''}>Ordered</option>
                                        <option value="expired" ${item.status === 'expired' ? 'selected' : ''}>Expired</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveEditedInventory(${id})">Save Changes</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function saveEditedInventory(id) {
            const name = document.getElementById('editInventoryName').value.trim();
            const category = document.getElementById('editInventoryCategory').value.trim();
            const quantity = parseInt(document.getElementById('editInventoryQuantity').value);
            const unit = document.getElementById('editInventoryUnit').value.trim();
            const status = document.getElementById('editInventoryStatus').value.trim();

            if (!name || !category || quantity < 0 || !unit || !status) {
                alert('Please fill in all required fields');
                return;
            }

            // Find and update the inventory item
            const inventoryIndex = inventory.findIndex(i => i.id === id);
            if (inventoryIndex !== -1) {
                inventory[inventoryIndex] = {
                    ...inventory[inventoryIndex],
                    name: name,
                    category: category,
                    quantity: quantity,
                    unit: unit,
                    status: status,
                    lastUpdated: new Date().toLocaleDateString()
                };

                saveInventoryData();
                renderInventoryTable();
                updateAnalyticsCharts();
                showSuccessMessage('Inventory item updated successfully!');

                // Close modal
                const modal = document.querySelector('.modal');
                if (modal) {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    bsModal.hide();
                }
            }
        }

        function deleteInventory(id) {
            if (confirm('Are you sure you want to delete this inventory item?')) {
                inventory = inventory.filter(item => item.id !== id);
                saveInventoryData();
                renderInventoryTable();
                showSuccessMessage('Inventory item deleted successfully!');
            }
        }

        function addNewTask() {
            alert('Add new task functionality will be implemented');
        }

        function editTask(id) {
            alert(`Edit task ${id} functionality will be implemented`);
        }

        function completeTask(id) {
            alert(`Task ${id} marked as complete`);
        }

        function generateReport(type) {
            console.log('Generating report:', type);
            
            switch(type) {
                case 'summary':
                    generateSummaryReport();
                    break;
                case 'crops':
                    generateCropReport();
                    break;
                case 'livestock':
                    generateLivestockReport();
                    break;
                case 'inventory':
                    generateInventoryReport();
                    break;
                default:
                    alert('Report type not implemented yet');
            }
        }

        function generateSummaryReport() {
            const farmData = JSON.parse(localStorage.getItem('farmData') || '{}');
            const cropCount = crops.length;
            const livestockCount = livestock.reduce((total, animal) => total + animal.quantity, 0);
            const inventoryCount = inventory.reduce((total, item) => total + item.quantity, 0);
            
            const report = `
SMARTFARM SUMMARY REPORT
Generated: ${new Date().toLocaleDateString()}

FARM INFORMATION:
- Farm Name: ${farmData.name || 'Not specified'}
- Location: ${farmData.location || 'Not specified'}
- Total Area: ${farmData.area || 'Not specified'} hectares
- Farm Type: ${farmData.type || 'Not specified'}

CROP SUMMARY:
- Total Crop Types: ${cropCount}
- Growing: ${crops.filter(c => c.status.toLowerCase() === 'growing').length}
- Ready for Harvest: ${crops.filter(c => c.status.toLowerCase() === 'ready').length}
- Harvested: ${crops.filter(c => c.status.toLowerCase() === 'harvested').length}

LIVESTOCK SUMMARY:
- Total Animals: ${livestockCount}
- Cattle: ${livestock.filter(l => l.type.toLowerCase() === 'cattle').length}
- Pigs: ${livestock.filter(l => l.type.toLowerCase() === 'pigs').length}
- Other: ${livestock.filter(l => !['cattle', 'pigs'].includes(l.type.toLowerCase())).length}

INVENTORY SUMMARY:
- Total Items: ${inventoryCount}
- Categories: ${[...new Set(inventory.map(i => i.category))].join(', ')}
- Low Stock Items: ${inventory.filter(i => i.status === 'low-stock').length}
            `;
            
            showReportModal('Farm Summary Report', report);
        }

        function generateCropReport() {
            let report = `CROP DETAILED REPORT\nGenerated: ${new Date().toLocaleDateString()}\n\n`;
            
            crops.forEach((crop, index) => {
                report += `${index + 1}. ${crop.name}\n`;
                report += `   Field: ${crop.field}\n`;
                report += `   Planted: ${crop.plantedDate}\n`;
                report += `   Status: ${crop.status}\n\n`;
            });
            
            showReportModal('Crop Report', report);
        }

        function generateLivestockReport() {
            let report = `LIVESTOCK DETAILED REPORT\nGenerated: ${new Date().toLocaleDateString()}\n\n`;
            
            livestock.forEach((animal, index) => {
                report += `${index + 1}. ${animal.type} - ${animal.breed}\n`;
                report += `   Quantity: ${animal.quantity}\n`;
                report += `   Location: ${animal.location}\n`;
                report += `   Health Status: ${animal.status}\n\n`;
            });
            
            showReportModal('Livestock Report', report);
        }

        function generateInventoryReport() {
            let report = `INVENTORY DETAILED REPORT\nGenerated: ${new Date().toLocaleDateString()}\n\n`;
            
            inventory.forEach((item, index) => {
                report += `${index + 1}. ${item.name}\n`;
                report += `   Category: ${item.category}\n`;
                report += `   Quantity: ${item.quantity} ${item.unit}\n`;
                report += `   Last Updated: ${item.lastUpdated}\n\n`;
            });
            
            showReportModal('Inventory Report', report);
        }

        function exportData() {
            exportToCSV('all');
        }

        function showReportModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${title}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <pre style="white-space: pre-wrap; font-family: monospace; max-height: 400px; overflow-y: auto;">${content}</pre>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="exportReportAsText('${title}', \`${content}\`)">Export as Text</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        // CSV Export Functions
        function exportToCSV(type) {
            let csvContent = '';
            let filename = '';
            
            switch(type) {
                case 'all':
                    csvContent = generateAllDataCSV();
                    filename = 'smartfarm-all-data.csv';
                    break;
                case 'crops':
                    csvContent = generateCropsCSV();
                    filename = 'smartfarm-crops.csv';
                    break;
                case 'livestock':
                    csvContent = generateLivestockCSV();
                    filename = 'smartfarm-livestock.csv';
                    break;
                case 'inventory':
                    csvContent = generateInventoryCSV();
                    filename = 'smartfarm-inventory.csv';
                    break;
            }
            
            downloadCSV(csvContent, filename);
        }

        function generateAllDataCSV() {
            let csv = 'Type,Name,Field/Breed,Area/Quantity,Status,Location/Unit,Date\n';
            
            // Add crops
            crops.forEach(crop => {
                csv += `Crop,${crop.name},${crop.field},${crop.area || ''},${crop.status},,${crop.plantedDate}\n`;
            });
            
            // Add livestock
            livestock.forEach(animal => {
                csv += `Livestock,${animal.type},${animal.breed},${animal.quantity},${animal.status},${animal.location},\n`;
            });
            
            // Add inventory
            inventory.forEach(item => {
                csv += `Inventory,${item.name},${item.category},${item.quantity},${item.status || 'in-stock'},${item.unit},${item.lastUpdated}\n`;
            });
            
            return csv;
        }

        function generateCropsCSV() {
            let csv = 'Crop Name,Field,Planted Date,Status\n';
            crops.forEach(crop => {
                csv += `${crop.name},${crop.field},${crop.plantedDate},${crop.status}\n`;
            });
            return csv;
        }

        function generateLivestockCSV() {
            let csv = 'Type,Breed,Quantity,Location,Health Status\n';
            livestock.forEach(animal => {
                csv += `${animal.type},${animal.breed},${animal.quantity},${animal.location},${animal.status}\n`;
            });
            return csv;
        }

        function generateInventoryCSV() {
            let csv = 'Item Name,Category,Quantity,Unit,Last Updated,Status\n';
            inventory.forEach(item => {
                csv += `${item.name},${item.category},${item.quantity},${item.unit},${item.lastUpdated},${item.status || 'in-stock'}\n`;
            });
            return csv;
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccessMessage(`${filename} downloaded successfully!`);
        }

        // PDF Export Functions
        function exportToPDF(type) {
            showSuccessMessage('PDF export functionality requires a PDF library. CSV export is available for now.');
            // For now, we'll export as CSV since PDF generation requires additional libraries
            exportToCSV('all');
        }

        // JSON Export Functions
        function exportToJSON(type) {
            let data = {};
            let filename = '';
            
            switch(type) {
                case 'all':
                    data = {
                        farmData: JSON.parse(localStorage.getItem('farmData') || '{}'),
                        crops: crops,
                        livestock: livestock,
                        inventory: inventory,
                        exportDate: new Date().toISOString()
                    };
                    filename = 'smartfarm-complete-data.json';
                    break;
                case 'backup':
                    data = {
                        farmData: JSON.parse(localStorage.getItem('farmData') || '{}'),
                        crops: crops,
                        livestock: livestock,
                        inventory: inventory,
                        backupDate: new Date().toISOString(),
                        version: '1.0'
                    };
                    filename = 'smartfarm-backup.json';
                    break;
            }
            
            const jsonContent = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccessMessage(`${filename} downloaded successfully!`);
        }

        // Custom Report Builder
        function generateCustomReport() {
            const reportType = document.getElementById('customReportType').value;
            const dateRange = document.getElementById('customDateRange').value;
            const includeCharts = document.getElementById('includeCharts').checked;
            const exportFormat = document.getElementById('exportFormat').value;
            
            showSuccessMessage(`Generating ${reportType} report for ${dateRange}...`);
            
            // For now, generate a summary report
            setTimeout(() => {
                generateReport(reportType);
            }, 1000);
        }

        function exportReportAsText(title, content) {
            const filename = `${title.replace(/\s+/g, '-').toLowerCase()}-${new Date().toISOString().split('T')[0]}.txt`;
            const blob = new Blob([content], { type: 'text/plain' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccessMessage(`${filename} downloaded successfully!`);
        }

        // ===== AI SUGGESTIONS FUNCTIONALITY =====

        function showAISuggestions(cropId) {
            const crop = crops.find(c => c.id === cropId);
            if (!crop) {
                alert('Crop not found');
                return;
            }

            // Show loading state
            const brainIcon = document.querySelector(`button[onclick="showAISuggestions(${cropId})"]`);
            if (brainIcon) {
                brainIcon.disabled = true;
                brainIcon.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }

            // Use setTimeout to prevent UI freezing
            setTimeout(() => {
                try {
                    // Debug: Log crop data
                    console.log('Crop data:', crop);
                    
                    // Validate crop has required properties
                    if (!crop.name) {
                        throw new Error('Crop name is missing');
                    }
                    if (!crop.plantedDate) {
                        throw new Error('Crop planted date is missing');
                    }
                    
                    const suggestions = generateAISuggestions(crop);
                    console.log('Generated suggestions:', suggestions);
                    
                    displayAISuggestionsModal(crop, suggestions);
                } catch (error) {
                    console.error('Error generating AI suggestions:', error);
                    console.error('Error stack:', error.stack);
                    alert('Error generating AI suggestions: ' + error.message);
                } finally {
                    // Restore brain icon
                    if (brainIcon) {
                        brainIcon.disabled = false;
                        brainIcon.innerHTML = '';
                    }
                }
            }, 100);
        }

        function displayAISuggestionsModal(crop, suggestions) {
            // Validate inputs
            if (!crop) {
                throw new Error('Crop data is missing');
            }
            if (!suggestions || !Array.isArray(suggestions)) {
                throw new Error('Suggestions data is invalid');
            }
            
            // Create AI suggestions modal
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-brain me-2"></i>AI Suggestions for ${crop.name}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary"> Crop Information</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>Crop:</strong> ${crop.name}</li>
                                        <li><strong>Field:</strong> ${crop.field}</li>
                                        <li><strong>Status:</strong> ${crop.status}</li>
                                        <li><strong>pH Level:</strong> ${crop.phLevel || 'Not measured'}</li>
                                        <li><strong>Planted:</strong> ${crop.plantedDate}</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-warning"> Pest Issues</h6>
                                    <p>${crop.pestIssues || 'No pest issues reported'}</p>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <div class="ai-suggestions">
                                ${suggestions.map(suggestion => `
                                    <div class="suggestion-card mb-3 p-3 border-start border-4 ${suggestion.type === 'critical' ? 'border-danger bg-light' : suggestion.type === 'warning' ? 'border-warning bg-light' : 'border-success bg-light'}">
                                        <div class="d-flex align-items-start">
                                            <div class="me-3">
                                                ${suggestion.type === 'critical' ? '' : suggestion.type === 'warning' ? '' : ''}
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-2">${suggestion.title}</h6>
                                                <p class="mb-2">${suggestion.description}</p>
                                                <div class="actions mb-3">
                                                    ${suggestion.actions.map(action => `
                                                        <button class="btn btn-sm btn-outline-primary me-2 mb-1" onclick="executeSuggestion('${action}', ${crop.id})">
                                                            ${action}
                                                        </button>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-info" onclick="updateCropFromSuggestions(${crop.id})">
                                <i class="fas fa-sync me-2"></i>Update Crop Data
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            try {
                document.body.appendChild(modal);
                const bsModal = new bootstrap.Modal(modal);
                bsModal.show();
                
                modal.addEventListener('hidden.bs.modal', () => {
                    if (document.body.contains(modal)) {
                        document.body.removeChild(modal);
                    }
                });
            } catch (error) {
                console.error('Error creating AI suggestions modal:', error);
                // Clean up modal if it was partially created
                if (document.body.contains(modal)) {
                    document.body.removeChild(modal);
                }
                throw new Error('Failed to display AI suggestions modal: ' + error.message);
            }
        }

        function generateAISuggestions(crop) {
            console.log('Starting SIMPLE AI suggestions for crop:', crop.name || 'Unknown');
            
            // Simple, bulletproof AI suggestions
            const suggestions = [];
            
            // Basic pH suggestion
            if (crop.phLevel) {
                if (crop.phLevel < 6.0) {
                    suggestions.push({
                        type: 'warning',
                        title: 'Soil pH Too Low',
                        description: `Your soil pH of ${crop.phLevel} is too low. Add lime to increase pH.`,
                        actions: ['Add Lime', 'Test Again']
                    });
                } else if (crop.phLevel > 7.5) {
                    suggestions.push({
                        type: 'warning',
                        title: 'Soil pH Too High',
                        description: `Your soil pH of ${crop.phLevel} is too high. Add sulfur to lower pH.`,
                        actions: ['Add Sulfur', 'Test Again']
                    });
                } else {
                    suggestions.push({
                        type: 'success',
                        title: 'Good Soil pH',
                        description: `Your soil pH of ${crop.phLevel} is in the good range.`,
                        actions: ['Keep Monitoring']
                    });
                }
            } else {
                suggestions.push({
                    type: 'warning',
                    title: 'Test Soil pH',
                    description: 'Please test your soil pH for optimal crop growth.',
                    actions: ['Buy pH Tester', 'Test Soil']
                });
            }
            
            // Basic pest suggestion
            if (crop.pestIssues && crop.pestIssues.trim() !== '') {
                suggestions.push({
                    type: 'critical',
                    title: 'Pest Issues Found',
                    description: `Pest problems reported: ${crop.pestIssues}`,
                    actions: ['Identify Pests', 'Apply Treatment']
                });
            } else {
                suggestions.push({
                    type: 'success',
                    title: 'No Pest Issues',
                    description: 'No pest problems reported for this crop.',
                    actions: ['Keep Monitoring']
                });
            }
            
            // Basic growth stage suggestion
            try {
                const plantedDate = new Date(crop.plantedDate);
                const currentDate = new Date();
                const daysSincePlanted = Math.floor((currentDate - plantedDate) / (1000 * 60 * 60 * 24));
                
                if (daysSincePlanted < 14) {
                    suggestions.push({
                        type: 'warning',
                        title: 'Early Growth',
                        description: `Crop is ${daysSincePlanted} days old. Focus on gentle care.`,
                        actions: ['Light Watering', 'Monitor Daily']
                    });
                } else if (daysSincePlanted < 45) {
                    suggestions.push({
                        type: 'success',
                        title: 'Active Growth',
                        description: `Crop is ${daysSincePlanted} days old. Regular care needed.`,
                        actions: ['Regular Watering', 'Fertilize']
                    });
                } else {
                    suggestions.push({
                        type: 'success',
                        title: 'Mature Stage',
                        description: `Crop is ${daysSincePlanted} days old. Prepare for harvest.`,
                        actions: ['Check Readiness', 'Harvest Planning']
                    });
                }
            } catch (error) {
                console.error('Error calculating growth stage:', error);
                suggestions.push({
                    type: 'warning',
                    title: 'Growth Stage Unknown',
                    description: 'Unable to calculate growth stage. Please check planted date.',
                    actions: ['Check Date', 'Manual Assessment']
                });
            }
            
            console.log('Generated', suggestions.length, 'simple suggestions');
            return suggestions;
        }

        // Weeding recommendation functions - Optimized for performance
        function generateWeedingRecommendations(crop, daysSincePlanted) {
            const suggestions = [];
            const weatherConditions = getWeatherConditions();
            const cropName = (crop.name || '').toLowerCase();
            
            // Determine weeding urgency based on weather
            let weedingUrgency = 'normal';
            if (weatherConditions.temperature > 30 || (weatherConditions.temperature > 25 && weatherConditions.humidity > 60)) {
                weedingUrgency = 'high';
            } else if (weatherConditions.rainfall > 50) {
                weedingUrgency = 'high';
            }
            
            // Single comprehensive weeding suggestion based on growth stage and weather
            let title, description, actions, treatments;
            
            if (daysSincePlanted < 14) {
                title = 'Early Stage Weeding';
                description = `Crop is ${daysSincePlanted} days old. Weeds compete heavily with young plants. Weather: ${weatherConditions.temperature}C, ${weatherConditions.humidity}% humidity.`;
                actions = ['Light Hand Weeding', 'Mulch Application', 'Monitor Daily'];
                treatments = getEarlyStageWeedingTreatments();
            } else if (daysSincePlanted < 45) {
                title = 'Active Growth Weeding';
                description = `Crop is ${daysSincePlanted} days old. Regular weeding crucial. ${weedingUrgency === 'high' ? 'High weed pressure due to weather conditions.' : 'Normal weeding schedule recommended.'}`;
                actions = ['Regular Weeding', 'Mulch Maintenance', 'Hoe Cultivation'];
                treatments = getActiveGrowthWeedingTreatments();
            } else {
                title = 'Mature Stage Weeding';
                description = `Crop is ${daysSincePlanted} days old. Focus on maintaining clean rows and preventing weed seed production.`;
                actions = ['Row Maintenance', 'Seed Prevention', 'Final Cleanup'];
                treatments = getMatureStageWeedingTreatments();
            }
            
            // Add weather-specific actions if needed
            if (weatherConditions.temperature > 25) {
                actions.push('Morning Weeding', 'Extra Mulch');
            }
            if (weatherConditions.humidity > 70) {
                actions.push('Improve Air Circulation');
            }
            if (weatherConditions.rainfall > 30) {
                actions.push('Post-Rain Cultivation');
            }
            
            // Add crop-specific treatment if applicable
            if (cropName.includes('corn') || cropName.includes('maize')) {
                treatments = treatments.concat(getCornWeedingTreatments());
                actions.push('Between-Row Cultivation');
            } else if (cropName.includes('tomato') || cropName.includes('pepper')) {
                treatments = treatments.concat(getVegetableWeedingTreatments());
                actions.push('Careful Hand Weeding');
            }
            
            suggestions.push({
                type: weedingUrgency === 'high' ? 'warning' : 'success',
                title: title,
                description: description,
                actions: actions.slice(0, 5), // Limit to 5 actions to prevent UI overload
                treatments: treatments.slice(0, 3), // Limit to 3 treatments to prevent UI overload
                urgency: weedingUrgency
            });
            
            return suggestions;
        }

        function getCurrentSeason() {
            const month = new Date().getMonth();
            if (month >= 2 && month <= 4) return 'spring';
            if (month >= 5 && month <= 7) return 'summer';
            if (month >= 8 && month <= 10) return 'autumn';
            return 'winter';
        }

        // Cache weather conditions to prevent repeated calculations
        let weatherCache = null;
        let weatherCacheTime = 0;
        
        function getWeatherConditions() {
            const now = Date.now();
            // Cache weather for 5 minutes to prevent repeated calculations
            if (weatherCache && (now - weatherCacheTime) < 300000) {
                return weatherCache;
            }
            
            // Simulate weather conditions (in a real app, this would come from a weather API)
            const currentHour = new Date().getHours();
            const month = new Date().getMonth();
            
            // Simulate seasonal and daily variations
            let baseTemp = 20 + (month * 2); // Seasonal variation
            baseTemp += Math.sin(currentHour * 0.261) * 5; // Daily variation
            
            let humidity = 50 + Math.sin(currentHour * 0.261) * 20;
            // Use deterministic "random" based on date to avoid UI freezing
            let rainfall = ((currentHour * 17 + month * 31) % 100);
            
            weatherCache = {
                temperature: Math.round(baseTemp),
                humidity: Math.round(humidity),
                rainfall: Math.round(rainfall),
                season: getCurrentSeason()
            };
            weatherCacheTime = now;
            
            return weatherCache;
        }

        // Weeding treatment functions
        function getEarlyStageWeedingTreatments() {
            return [
                {
                    name: "Hand Weeding (Gentle)",
                    ingredients: [
                        "Small hand tools (hand hoe, weeder)",
                        "Gloves",
                        "Knee pad or small stool",
                        "Bucket for weeds"
                    ],
                    instructions: [
                        "Weed early in the morning when soil is moist",
                        "Use gentle pulling motion to avoid disturbing crop roots",
                        "Remove weeds when they are small (2-3 inches)",
                        "Focus on weeds within 6 inches of crop plants",
                        "Dispose of weeds away from field to prevent reseeding"
                    ],
                    targets: "Small annual weeds, grass seedlings"
                },
                {
                    name: "Organic Mulch Application",
                    ingredients: [
                        "Straw or hay (2-3 inches thick)",
                        "Newspaper or cardboard (optional base layer)",
                        "Water for settling mulch"
                    ],
                    instructions: [
                        "Lay newspaper/cardboard around plants first",
                        "Apply 2-3 inches of straw mulch",
                        "Keep mulch 2 inches away from plant stems",
                        "Water mulch to settle it in place",
                        "Replenish mulch as it decomposes"
                    ],
                    targets: "Weed seed germination, soil moisture retention"
                },
                {
                    name: "Pre-Emergent Herbicide Application",
                    ingredients: [
                        "Pre-emergent herbicide (Trifluralin, Pendimethalin)",
                        "Spray equipment (backpack or boom sprayer)",
                        "Protective equipment (gloves, goggles, respirator)",
                        "Calibration tools"
                    ],
                    instructions: [
                        "Apply 2-3 days before planting or immediately after",
                        "Calibrate sprayer for uniform coverage",
                        "Apply at recommended rate (check label)",
                        "Ensure soil incorporation if required",
                        "Avoid application before heavy rainfall",
                        "Wear full protective equipment during application"
                    ],
                    targets: "Annual weed seeds before germination",
                    safety: "HIGH - Follow all label instructions and safety precautions"
                }
            ];
        }

        function getActiveGrowthWeedingTreatments() {
            return [
                {
                    name: "Hoe Cultivation",
                    ingredients: [
                        "Sharp garden hoe",
                        "Cultivator or stirrup hoe",
                        "Gloves and protective clothing"
                    ],
                    instructions: [
                        "Cultivate when soil is slightly moist, not wet",
                        "Work between rows, 4-6 inches from crop plants",
                        "Use shallow cultivation (1-2 inches deep)",
                        "Cultivate in one direction to avoid soil compaction",
                        "Repeat every 7-10 days during active growth"
                    ],
                    targets: "Established annual weeds, soil crust breaking"
                },
                {
                    name: "Vinegar Weed Spray",
                    ingredients: [
                        "1 gallon white vinegar (5% acidity)",
                        "1 cup salt",
                        "1 tablespoon liquid dish soap",
                        "Spray bottle or garden sprayer"
                    ],
                    instructions: [
                        "Mix vinegar and salt until salt dissolves",
                        "Add dish soap and mix well",
                        "Apply on sunny day with no rain forecast",
                        "Spray directly on weed leaves",
                        "Avoid contact with crop plants",
                        "Reapply in 3-5 days for stubborn weeds"
                    ],
                    targets: "Broadleaf weeds, young grass weeds"
                },
                {
                    name: "Post-Emergent Herbicide Application",
                    ingredients: [
                        "Post-emergent herbicide (Glyphosate, 2,4-D, Dicamba)",
                        "Selective herbicide for specific crops",
                        "Spray equipment with proper nozzles",
                        "Protective equipment (coveralls, gloves, goggles, respirator)",
                        "Shield or wick applicator for precision"
                    ],
                    instructions: [
                        "Apply when weeds are actively growing (2-4 inches tall)",
                        "Use selective herbicides for broadleaf or grass control",
                        "Apply during calm conditions (wind < 5 mph)",
                        "Use shields to protect crop plants",
                        "Follow label rates and timing restrictions",
                        "Ensure 24-48 hour rain-free period after application"
                    ],
                    targets: "Established broadleaf and grass weeds",
                    safety: "HIGH - Use protective equipment and follow label exactly"
                },
                {
                    name: "Directed Spray Application",
                    ingredients: [
                        "Non-selective herbicide (Glyphosate)",
                        "Directed spray equipment or wick applicator",
                        "Protective equipment and shields",
                        "Calibration tools"
                    ],
                    instructions: [
                        "Apply only to weed foliage, avoid crop contact",
                        "Use low pressure and large droplet size",
                        "Apply when weeds are 2-6 inches tall",
                        "Use shields or wick applicators for precision",
                        "Apply during optimal weather conditions",
                        "Monitor for crop injury symptoms"
                    ],
                    targets: "Weeds between crop rows, spot treatments",
                    safety: "CRITICAL - Precision application required to avoid crop damage"
                }
            ];
        }

        function getMatureStageWeedingTreatments() {
            return [
                {
                    name: "Final Weeding and Mulching",
                    ingredients: [
                        "Heavy mulch (straw, wood chips)",
                        "Hand tools for spot weeding",
                        "Weed barrier fabric (optional)"
                    ],
                    instructions: [
                        "Remove any remaining large weeds by hand",
                        "Apply heavy mulch layer (4-6 inches)",
                        "Install weed barrier fabric between rows if needed",
                        "Focus on preventing weed seed production",
                        "Maintain clean harvest paths"
                    ],
                    targets: "Mature weeds, weed seed prevention"
                }
            ];
        }

        function getHotWeatherWeedingTreatments() {
            return [
                {
                    name: "Morning Weeding Schedule",
                    ingredients: [
                        "Early morning timing (6-8 AM)",
                        "Extra mulch materials",
                        "Shade cloth or row covers"
                    ],
                    instructions: [
                        "Weed early morning to avoid heat stress",
                        "Apply extra mulch to reduce soil temperature",
                        "Use shade cloth over sensitive crops",
                        "Increase watering frequency",
                        "Consider drip irrigation to reduce humidity"
                    ],
                    targets: "Heat-stressed weeds, soil cooling"
                },
                {
                    name: "Hot Weather Herbicide Application",
                    ingredients: [
                        "Systemic herbicide (Glyphosate)",
                        "Early morning application timing",
                        "Protective equipment for hot conditions",
                        "Extra water for mixing and cleanup"
                    ],
                    instructions: [
                        "Apply early morning (6-8 AM) before temperatures exceed 85F",
                        "Increase water volume to reduce herbicide concentration",
                        "Use larger droplet sizes to minimize drift",
                        "Wear lightweight protective equipment",
                        "Take frequent breaks and stay hydrated",
                        "Monitor for herbicide volatility in extreme heat"
                    ],
                    targets: "Heat-stressed weeds, reduced herbicide effectiveness",
                    safety: "HIGH - Extreme heat increases herbicide volatility and drift risk"
                }
            ];
        }

        function getHighHumidityWeedingTreatments() {
            return [
                {
                    name: "Humidity Control Weeding",
                    ingredients: [
                        "Air circulation fans (if in greenhouse)",
                        "Drip irrigation system",
                        "Extra mulch for moisture control"
                    ],
                    instructions: [
                        "Improve air circulation around plants",
                        "Switch to drip irrigation to reduce humidity",
                        "Apply mulch to prevent soil moisture evaporation",
                        "Weed more frequently during humid periods",
                        "Consider spacing plants further apart"
                    ],
                    targets: "Humidity-promoted weed growth"
                }
            ];
        }

        function getPostRainWeedingTreatments() {
            return [
                {
                    name: "Post-Rain Cultivation",
                    ingredients: [
                        "Cultivation tools",
                        "Fresh mulch materials",
                        "Soil amendments if needed"
                    ],
                    instructions: [
                        "Wait until soil is workable (not too wet)",
                        "Cultivate soil to disrupt weed germination",
                        "Apply fresh mulch immediately after cultivation",
                        "Check for soil compaction and aerate if needed",
                        "Monitor for new weed growth in following days"
                    ],
                    targets: "Post-rain weed germination, soil aeration"
                }
            ];
        }

        function getCornWeedingTreatments() {
            return [
                {
                    name: "Corn Row Cultivation",
                    ingredients: [
                        "Row crop cultivator or hoe",
                        "Pre-emergent herbicide (optional)",
                        "Hand tools for close weeding"
                    ],
                    instructions: [
                        "Cultivate between rows when corn is 4-6 inches tall",
                        "Use shields to protect corn plants from soil",
                        "Apply pre-emergent herbicide if using",
                        "Hand weed within 6 inches of corn plants",
                        "Repeat cultivation every 10-14 days until corn is 3 feet tall"
                    ],
                    targets: "Annual weeds, grass competition in corn"
                },
                {
                    name: "Corn Selective Herbicide Program",
                    ingredients: [
                        "Atrazine + S-metolachlor (pre-emergent)",
                        "Nicosulfuron + Mesotrione (post-emergent)",
                        "Spray equipment with corn shields",
                        "Protective equipment and calibration tools"
                    ],
                    instructions: [
                        "Apply pre-emergent within 3 days of planting",
                        "Apply post-emergent when corn is 4-12 inches tall",
                        "Use proper spray shields to protect corn plants",
                        "Follow label rates and timing restrictions",
                        "Monitor for crop injury and weed control",
                        "Apply during optimal weather conditions"
                    ],
                    targets: "Annual broadleaf and grass weeds in corn",
                    safety: "HIGH - Corn-specific herbicides with proper application"
                }
            ];
        }

        function getVegetableWeedingTreatments() {
            return [
                {
                    name: "Vegetable Care Weeding",
                    ingredients: [
                        "Small hand tools",
                        "Straw mulch",
                        "Organic weed control spray"
                    ],
                    instructions: [
                        "Hand weed carefully to avoid damaging vegetable roots",
                        "Apply thick straw mulch around plants",
                        "Use organic sprays only as last resort",
                        "Weed regularly to prevent competition",
                        "Support plants with stakes or cages to improve access"
                    ],
                    targets: "Vegetable garden weeds, shallow root protection"
                },
                {
                    name: "Vegetable Herbicide Program",
                    ingredients: [
                        "DCPA (Dacthal) - pre-emergent for vegetables",
                        "Clethodim - post-emergent for grass control",
                        "Spray equipment with fine nozzles",
                        "Protective equipment and calibration tools"
                    ],
                    instructions: [
                        "Apply DCPA before vegetable emergence",
                        "Use Clethodim for grass control in established crops",
                        "Apply at recommended rates for specific vegetables",
                        "Use proper spray shields and timing",
                        "Follow pre-harvest intervals (PHI) on labels",
                        "Monitor for crop tolerance and weed control"
                    ],
                    targets: "Grass weeds in vegetable crops",
                    safety: "MODERATE - Follow vegetable-specific label instructions"
                }
            ];
        }

        // Treatment recipe functions
        function getPestTreatments(pestText) {
            const treatments = [];
            
            if ((pestText && pestText.includes('aphid')) || (pestText && pestText.includes('bug'))) {
                treatments.push({
                    name: "Neem Oil Spray",
                    ingredients: [
                        "2 teaspoons neem oil (cold-pressed)",
                        "1 teaspoon liquid dish soap (unscented)",
                        "1 gallon warm water",
                        "1 teaspoon baking soda (optional)"
                    ],
                    instructions: [
                        "Mix neem oil and dish soap in small container",
                        "Add to 1 gallon of warm water",
                        "Stir well and pour into spray bottle",
                        "Shake before each use",
                        "Apply early morning or evening"
                    ],
                    targets: "Aphids, whiteflies, spider mites, thrips, mealybugs"
                });
                
                treatments.push({
                    name: "Insecticidal Soap Spray",
                    ingredients: [
                        "2 tablespoons liquid dish soap (unscented, biodegradable)",
                        "1 gallon water",
                        "1 teaspoon vegetable oil (optional)"
                    ],
                    instructions: [
                        "Mix soap with water in spray bottle",
                        "Add vegetable oil if desired",
                        "Shake well before use",
                        "Apply directly to pests",
                        "Reapply every 3-7 days"
                    ],
                    targets: "Aphids, spider mites, whiteflies, mealybugs, thrips"
                });
            }
            
            return treatments;
        }

        function getInsectTreatments() {
            return [
                {
                    name: "Garlic Spray (Natural Repellent)",
                    ingredients: [
                        "10-12 garlic cloves",
                        "1 tablespoon liquid dish soap",
                        "1 tablespoon mineral oil",
                        "1 quart water",
                        "1 tablespoon cayenne pepper (optional)"
                    ],
                    instructions: [
                        "Blend garlic cloves with 1 cup water",
                        "Let steep for 24 hours",
                        "Strain through cheesecloth",
                        "Mix with remaining water, soap, and oil",
                        "Add cayenne pepper for extra potency",
                        "Store in refrigerator for up to 1 week"
                    ],
                    targets: "Aphids, cabbage worms, Japanese beetles, repels many insects"
                },
                {
                    name: "Hot Pepper Spray",
                    ingredients: [
                        "6-10 hot peppers (jalapeo, habanero, or cayenne)",
                        "2 tablespoons liquid dish soap",
                        "1 tablespoon vegetable oil",
                        "1 quart water",
                        "1 tablespoon cayenne powder (optional)"
                    ],
                    instructions: [
                        "Blend peppers with 1 cup water",
                        "Let steep for 24 hours",
                        "Strain through cheesecloth",
                        "Mix with remaining ingredients",
                        "Wear gloves when handling",
                        "Test on small area first"
                    ],
                    targets: "Aphids, caterpillars, beetles, repels rabbits and deer"
                }
            ];
        }

        function getFungalTreatments() {
            return [
                {
                    name: "Baking Soda Fungicide",
                    ingredients: [
                        "1 tablespoon baking soda",
                        "1 teaspoon liquid dish soap",
                        "1 gallon water",
                        "2 tablespoons vegetable oil (optional)"
                    ],
                    instructions: [
                        "Mix all ingredients in spray bottle",
                        "Shake well before use",
                        "Apply every 7-10 days",
                        "Avoid applying in hot sun",
                        "Test on small area first"
                    ],
                    targets: "Powdery mildew, black spot, rust, anthracnose"
                },
                {
                    name: "Milk Spray (Fungal Prevention)",
                    ingredients: [
                        "1 part milk (whole or skim)",
                        "9 parts water",
                        "1 teaspoon baking soda (optional)"
                    ],
                    instructions: [
                        "Mix milk with water",
                        "Add baking soda if desired",
                        "Apply every 7-10 days",
                        "Use in morning",
                        "Avoid applying in hot sun"
                    ],
                    targets: "Powdery mildew, mosaic viruses"
                }
            ];
        }

        function getSlugTreatments() {
            return [
                {
                    name: "Beer Trap",
                    ingredients: [
                        "1 cup beer (cheap beer works best)",
                        "Shallow container (yogurt cup, tuna can)",
                        "1 tablespoon sugar (optional)"
                    ],
                    instructions: [
                        "Pour beer into shallow container",
                        "Add sugar if desired",
                        "Bury container so rim is level with soil",
                        "Replace beer every 2-3 days",
                        "Place multiple traps around garden"
                    ],
                    targets: "Slugs, snails, earwigs"
                },
                {
                    name: "Diatomaceous Earth Dust",
                    ingredients: [
                        "Food-grade diatomaceous earth",
                        "Dust applicator or shaker",
                        "Protective mask (for application)"
                    ],
                    instructions: [
                        "Apply dry powder to plant surfaces",
                        "Focus on undersides of leaves",
                        "Reapply after rain or watering",
                        "Use protective equipment",
                        "Avoid breathing dust"
                    ],
                    targets: "Ants, beetles, caterpillars, slugs, soft-bodied insects"
                }
            ];
        }

        function getCaterpillarTreatments() {
            return [
                {
                    name: "Bt (Bacillus Thuringiensis) Spray",
                    ingredients: [
                        "1-2 teaspoons Bt powder",
                        "1 gallon water",
                        "1 teaspoon liquid dish soap",
                        "Spray bottle"
                    ],
                    instructions: [
                        "Mix Bt powder with small amount of water",
                        "Add to remaining water in spray bottle",
                        "Add dish soap for better adhesion",
                        "Apply to leaves where caterpillars feed",
                        "Reapply every 7-10 days or after rain"
                    ],
                    targets: "Caterpillars, cabbage worms, tomato hornworms"
                },
                {
                    name: "Hand Picking Method",
                    ingredients: [
                        "Bucket of soapy water",
                        "Gloves (optional)",
                        "Flashlight (for night picking)"
                    ],
                    instructions: [
                        "Inspect plants daily for caterpillars",
                        "Wear gloves if handling stinging caterpillars",
                        "Drop caterpillars into soapy water",
                        "Check undersides of leaves",
                        "Best done early morning or evening"
                    ],
                    targets: "Large caterpillars, hornworms, cabbage worms"
                }
            ];
        }

        function getMiteTreatments() {
            return [
                {
                    name: "Water Spray Treatment",
                    ingredients: [
                        "Strong water stream (hose or spray bottle)",
                        "Water",
                        "1 teaspoon liquid dish soap (optional)"
                    ],
                    instructions: [
                        "Use strong water stream to dislodge mites",
                        "Focus on undersides of leaves",
                        "Apply every 2-3 days",
                        "Increase humidity around plants",
                        "Remove heavily infested leaves"
                    ],
                    targets: "Spider mites, aphids, small insects"
                },
                {
                    name: "Essential Oil Spray",
                    ingredients: [
                        "10 drops peppermint oil",
                        "10 drops eucalyptus oil",
                        "5 drops tea tree oil",
                        "1 tablespoon liquid dish soap",
                        "1 gallon water"
                    ],
                    instructions: [
                        "Mix essential oils with soap",
                        "Add to water gradually",
                        "Shake well before use",
                        "Apply early morning or evening",
                        "Store in cool place"
                    ],
                    targets: "Spider mites, aphids, ants, repels many insects"
                }
            ];
        }

        function getPreventiveTreatments() {
            return [
                {
                    name: "General Preventive Spray",
                    ingredients: [
                        "1 tablespoon liquid dish soap",
                        "1 tablespoon vegetable oil",
                        "1 gallon water",
                        "1 teaspoon baking soda (optional)"
                    ],
                    instructions: [
                        "Mix soap and oil in small container",
                        "Add to water gradually",
                        "Add baking soda for fungal prevention",
                        "Apply every 2 weeks",
                        "Shake well before each use"
                    ],
                    targets: "General pest prevention, fungal prevention"
                },
                {
                    name: "Companion Planting Guide",
                    ingredients: [
                        "Marigold seeds",
                        "Garlic bulbs",
                        "Chive plants",
                        "Basil plants"
                    ],
                    instructions: [
                        "Plant marigolds around vegetable beds",
                        "Interplant garlic and chives",
                        "Add basil near tomatoes",
                        "Rotate companion plants annually",
                        "Maintain good spacing for air circulation"
                    ],
                    targets: "Natural pest repellent, beneficial insect attraction"
                }
            ];
        }

        function executeSuggestion(action, cropId) {
            showSuccessMessage(`Executing: ${action}`);
            
            // Here you could implement specific actions
            switch(action) {
                case 'Test Soil pH':
                    showSuccessMessage('Soil pH testing kit recommended. Test multiple locations in the field.');
                    break;
                case 'Add Lime':
                    showSuccessMessage('Apply 50-100 lbs of lime per 1000 sq ft for acidic soil correction.');
                    break;
                case 'Apply Treatment':
                    showSuccessMessage('Consult with agricultural expert for appropriate treatment recommendations.');
                    break;
                case 'Monitor Regularly':
                    showSuccessMessage('Set up regular monitoring schedule for optimal crop health.');
                    break;
                default:
                    showSuccessMessage(`Action "${action}" logged for implementation.`);
            }
        }

        function updateCropFromSuggestions(cropId) {
            const crop = crops.find(c => c.id === cropId);
            if (crop) {
                // Update last updated timestamp
                crop.lastUpdated = new Date().toLocaleDateString();
                saveCropsData();
                renderCropsTable();
                showSuccessMessage('Crop data updated with AI suggestions!');
            }
        }

        // ===== URL ROUTING AND STATE PERSISTENCE =====

        function initializeURLRouting() {
            // Check if there's a hash in the URL
            const hash = window.location.hash.substring(1);
            
            if (hash) {
                // Navigate to the specified view
                navigateToView(hash);
            } else {
                // Check localStorage for last viewed page
                const lastView = localStorage.getItem('smartfarm_lastView');
                if (lastView && lastView !== 'dashboardView') {
                    navigateToView(lastView);
                } else {
                    // Default to dashboard
                    showDashboard();
                }
            }
            
            // Listen for hash changes
            window.addEventListener('hashchange', function() {
                const newHash = window.location.hash.substring(1);
                navigateToView(newHash);
            });
        }

        function navigateToView(viewName) {
            // Update URL hash
            window.location.hash = viewName;
            
            // Save current view to localStorage
            localStorage.setItem('smartfarm_lastView', viewName);
            
            // Navigate to the appropriate view
            switch(viewName) {
                case 'farmManagementView':
                    showFarmManagement();
                    break;
                case 'cropManagementView':
                    showCropManagement();
                    break;
                case 'livestockManagementView':
                    showLivestockManagement();
                    break;
                case 'inventoryManagementView':
                    showInventoryManagement();
                    break;
                case 'analyticsView':
                    showAnalytics();
                    break;
                case 'reportsView':
                    showReports();
                    break;
                case 'tasksView':
                    showTasks();
                    break;
                default:
                    showDashboard();
            }
        }

        function updateURL(viewName) {
            window.location.hash = viewName;
            localStorage.setItem('smartfarm_lastView', viewName);
        }

        // User functions
        function editProfile() {
            alert('Edit profile functionality will be implemented');
        }

        function showSettings() {
            alert('Settings functionality will be implemented');
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('smartfarm_user');
                sessionStorage.removeItem('smartfarm_user');
                window.location.href = 'login.html';
            }
        }

        // Mobile sidebar toggle
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('show');
        });
    </script>
</body>
</html>
