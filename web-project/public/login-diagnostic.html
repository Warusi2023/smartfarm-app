<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartFarm Login Diagnostic Tool</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f8f9fa;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        .section { 
            background: white; 
            margin: 20px 0; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            cursor: pointer; 
            border: none; 
            border-radius: 4px;
            font-weight: bold;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        pre { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 4px; 
            overflow-x: auto; 
            border: 1px solid #dee2e6;
        }
        .test-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
        }
        .test-item { 
            border: 1px solid #dee2e6; 
            padding: 15px; 
            border-radius: 4px; 
        }
        .progress { 
            width: 100%; 
            height: 20px; 
            background: #e9ecef; 
            border-radius: 10px; 
            overflow: hidden; 
            margin: 10px 0;
        }
        .progress-bar { 
            height: 100%; 
            background: #007bff; 
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß SmartFarm Login Diagnostic Tool</h1>
        <p>This tool helps diagnose and fix login issues in the SmartFarm application.</p>

        <!-- Overall Status -->
        <div class="section">
            <h2>üìä Overall Status</h2>
            <div id="overallStatus" class="status info">
                <strong>Status:</strong> Running diagnostics...
            </div>
            <div class="progress">
                <div id="progressBar" class="progress-bar" style="width: 0%"></div>
            </div>
            <div id="progressText">Starting diagnostics...</div>
        </div>

        <!-- Environment Check -->
        <div class="section">
            <h2>üåç Environment Check</h2>
            <div class="test-grid">
                <div class="test-item">
                    <h4>Frontend Environment</h4>
                    <div id="frontendEnv"></div>
                    <button class="btn-primary" onclick="checkFrontendEnvironment()">Check Frontend</button>
                </div>
                <div class="test-item">
                    <h4>Backend Environment</h4>
                    <div id="backendEnv"></div>
                    <button class="btn-primary" onclick="checkBackendEnvironment()">Check Backend</button>
                </div>
            </div>
        </div>

        <!-- CORS Testing -->
        <div class="section">
            <h2>üåê CORS Testing</h2>
            <div class="test-grid">
                <div class="test-item">
                    <h4>CORS Configuration</h4>
                    <div id="corsConfig"></div>
                    <button class="btn-warning" onclick="testCORS()">Test CORS</button>
                </div>
                <div class="test-item">
                    <h4>Network Connectivity</h4>
                    <div id="networkTest"></div>
                    <button class="btn-primary" onclick="testNetwork()">Test Network</button>
                </div>
            </div>
        </div>

        <!-- Authentication Testing -->
        <div class="section">
            <h2>üîê Authentication Testing</h2>
            <div class="test-grid">
                <div class="test-item">
                    <h4>Login API Test</h4>
                    <div id="loginTest"></div>
                    <button class="btn-success" onclick="testLoginAPI()">Test Login API</button>
                </div>
                <div class="test-item">
                    <h4>Session Management</h4>
                    <div id="sessionTest"></div>
                    <button class="btn-primary" onclick="testSession()">Test Session</button>
                </div>
            </div>
        </div>

        <!-- Demo Mode Analysis -->
        <div class="section">
            <h2>üé≠ Demo Mode Analysis</h2>
            <div id="demoModeAnalysis"></div>
            <button class="btn-danger" onclick="analyzeDemoMode()">Analyze Demo Mode</button>
        </div>

        <!-- Fix Recommendations -->
        <div class="section">
            <h2>üí° Fix Recommendations</h2>
            <div id="fixRecommendations"></div>
            <button class="btn-success" onclick="generateRecommendations()">Generate Recommendations</button>
        </div>

        <!-- Manual Fix Actions -->
        <div class="section">
            <h2>üõ†Ô∏è Manual Fix Actions</h2>
            <div class="test-grid">
                <div class="test-item">
                    <h4>Clear Local Storage</h4>
                    <p>Clear all local storage data that might be causing issues.</p>
                    <button class="btn-warning" onclick="clearLocalStorage()">Clear Storage</button>
                </div>
                <div class="test-item">
                    <h4>Reset Authentication</h4>
                    <p>Reset authentication state and force re-login.</p>
                    <button class="btn-danger" onclick="resetAuthentication()">Reset Auth</button>
                </div>
                <div class="test-item">
                    <h4>Test Real Login</h4>
                    <p>Test with actual credentials (demo mode disabled).</p>
                    <button class="btn-success" onclick="testRealLogin()">Test Real Login</button>
                </div>
            </div>
        </div>

        <!-- Debug Information -->
        <div class="section">
            <h2>üêõ Debug Information</h2>
            <button class="btn-primary" onclick="collectDebugInfo()">Collect Debug Info</button>
            <pre id="debugInfo" style="display: none;"></pre>
        </div>
    </div>

    <script>
        let testResults = {};
        let currentProgress = 0;
        const totalTests = 8;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateProgress(0, 'Initializing diagnostic tool...');
            setTimeout(() => {
                runAllDiagnostics();
            }, 1000);
        });

        function updateProgress(percent, text) {
            currentProgress = percent;
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        async function runAllDiagnostics() {
            try {
                updateProgress(10, 'Checking frontend environment...');
                await checkFrontendEnvironment();
                
                updateProgress(20, 'Checking backend environment...');
                await checkBackendEnvironment();
                
                updateProgress(30, 'Testing CORS configuration...');
                await testCORS();
                
                updateProgress(40, 'Testing network connectivity...');
                await testNetwork();
                
                updateProgress(50, 'Testing login API...');
                await testLoginAPI();
                
                updateProgress(60, 'Testing session management...');
                await testSession();
                
                updateProgress(70, 'Analyzing demo mode...');
                await analyzeDemoMode();
                
                updateProgress(80, 'Generating recommendations...');
                await generateRecommendations();
                
                updateProgress(100, 'Diagnostics complete!');
                
                // Update overall status
                const hasErrors = Object.values(testResults).some(result => result.status === 'error');
                const hasWarnings = Object.values(testResults).some(result => result.status === 'warning');
                
                let overallStatus = 'success';
                let overallText = 'All systems operational!';
                
                if (hasErrors) {
                    overallStatus = 'error';
                    overallText = 'Critical issues found - see recommendations below';
                } else if (hasWarnings) {
                    overallStatus = 'warning';
                    overallText = 'Some warnings found - review recommendations';
                }
                
                document.getElementById('overallStatus').className = `status ${overallStatus}`;
                document.getElementById('overallStatus').innerHTML = `<strong>Status:</strong> ${overallText}`;
                
            } catch (error) {
                updateProgress(0, 'Diagnostics failed');
                console.error('Diagnostic error:', error);
            }
        }

        async function checkFrontendEnvironment() {
            const result = {
                url: window.location.href,
                hostname: window.location.hostname,
                protocol: window.location.protocol,
                userAgent: navigator.userAgent,
                localStorage: !!window.localStorage,
                sessionStorage: !!window.sessionStorage,
                fetch: !!window.fetch,
                smartfarmConfig: !!window.SmartFarmConfig,
                smartfarmEnvironment: !!window.SmartFarmEnvironment,
                smartfarmLogger: !!window.SmartFarmLogger,
                smartfarmAPI: !!window.SmartFarmAPI
            };

            testResults.frontendEnv = result;
            
            let status = 'success';
            let message = 'Frontend environment is properly configured';
            
            if (!result.fetch) {
                status = 'error';
                message = 'Fetch API not available';
            } else if (!result.localStorage) {
                status = 'warning';
                message = 'LocalStorage not available';
            }

            document.getElementById('frontendEnv').innerHTML = `
                <div class="status ${status}">
                    <strong>${message}</strong><br>
                    URL: ${result.url}<br>
                    SmartFarm Config: ${result.smartfarmConfig ? '‚úÖ' : '‚ùå'}<br>
                    SmartFarm Environment: ${result.smartfarmEnvironment ? '‚úÖ' : '‚ùå'}<br>
                    SmartFarm Logger: ${result.smartfarmLogger ? '‚úÖ' : '‚ùå'}<br>
                    SmartFarm API: ${result.smartfarmAPI ? '‚úÖ' : '‚ùå'}
                </div>
            `;
        }

        async function checkBackendEnvironment() {
            try {
                const response = await fetch('https://smartfarm-app-production.up.railway.app/api/health', {
                    method: 'GET',
                    mode: 'cors',
                    timeout: 5000
                });

                if (response.ok) {
                    const data = await response.json();
                    testResults.backendEnv = { status: 'success', data };
                    
                    document.getElementById('backendEnv').innerHTML = `
                        <div class="status success">
                            <strong>Backend is healthy!</strong><br>
                            Status: ${data.status || 'OK'}<br>
                            Timestamp: ${data.timestamp || 'N/A'}
                        </div>
                    `;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                testResults.backendEnv = { status: 'error', error: error.message };
                
                document.getElementById('backendEnv').innerHTML = `
                    <div class="status error">
                        <strong>Backend connection failed!</strong><br>
                        Error: ${error.message}<br>
                        This is likely a CORS issue.
                    </div>
                `;
            }
        }

        async function testCORS() {
            try {
                const response = await fetch('https://smartfarm-app-production.up.railway.app/api/auth/login', {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'test'
                    })
                });

                // Even if login fails, if we get a response, CORS is working
                testResults.cors = { status: 'success' };
                
                document.getElementById('corsConfig').innerHTML = `
                    <div class="status success">
                        <strong>CORS is properly configured!</strong><br>
                        Backend is accessible from frontend.
                    </div>
                `;
            } catch (error) {
                testResults.cors = { status: 'error', error: error.message };
                
                let message = 'CORS configuration issue detected';
                if (error.message.includes('CORS')) {
                    message = 'CORS policy blocking requests';
                } else if (error.message.includes('Failed to fetch')) {
                    message = 'Network request failed - likely CORS issue';
                }
                
                document.getElementById('corsConfig').innerHTML = `
                    <div class="status error">
                        <strong>${message}</strong><br>
                        Error: ${error.message}<br>
                        <strong>Action Required:</strong> Update Railway CORS_ORIGIN variable
                    </div>
                `;
            }
        }

        async function testNetwork() {
            try {
                const startTime = Date.now();
                const response = await fetch('https://smartfarm-app-production.up.railway.app/api/health', {
                    method: 'GET',
                    mode: 'cors'
                });
                const endTime = Date.now();
                const latency = endTime - startTime;

                if (response.ok) {
                    testResults.network = { status: 'success', latency };
                    
                    document.getElementById('networkTest').innerHTML = `
                        <div class="status success">
                            <strong>Network connectivity is good!</strong><br>
                            Latency: ${latency}ms<br>
                            Status: ${response.status}
                        </div>
                    `;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                testResults.network = { status: 'error', error: error.message };
                
                document.getElementById('networkTest').innerHTML = `
                    <div class="status error">
                        <strong>Network connectivity issues!</strong><br>
                        Error: ${error.message}
                    </div>
                `;
            }
        }

        async function testLoginAPI() {
            try {
                const response = await fetch('https://smartfarm-app-production.up.railway.app/api/auth/login', {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'demo@smartfarm.com',
                        password: 'demo123'
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.token) {
                    testResults.loginAPI = { status: 'success', hasToken: true };
                    
                    document.getElementById('loginTest').innerHTML = `
                        <div class="status success">
                            <strong>Login API is working!</strong><br>
                            Demo credentials accepted<br>
                            Token received: ${data.token ? 'Yes' : 'No'}
                        </div>
                    `;
                } else {
                    testResults.loginAPI = { status: 'warning', message: data.message };
                    
                    document.getElementById('loginTest').innerHTML = `
                        <div class="status warning">
                            <strong>Login API responded but credentials rejected</strong><br>
                            Message: ${data.message || 'Unknown error'}<br>
                            This is normal for invalid credentials.
                        </div>
                    `;
                }
            } catch (error) {
                testResults.loginAPI = { status: 'error', error: error.message };
                
                document.getElementById('loginTest').innerHTML = `
                    <div class="status error">
                        <strong>Login API failed!</strong><br>
                        Error: ${error.message}<br>
                        This prevents real authentication.
                    </div>
                `;
            }
        }

        async function testSession() {
            const sessionData = {
                localStorage: localStorage.getItem('smartfarm_user'),
                sessionStorage: sessionStorage.getItem('smartfarm_user'),
                token: localStorage.getItem('smartfarm_token') || sessionStorage.getItem('smartfarm_token'),
                isDemo: localStorage.getItem('smartfarm_demo_mode') === 'true'
            };

            testResults.session = sessionData;
            
            let status = 'info';
            let message = 'Session data found';
            
            if (sessionData.isDemo) {
                status = 'warning';
                message = 'Currently in demo mode';
            } else if (!sessionData.token) {
                status = 'warning';
                message = 'No authentication token found';
            } else {
                status = 'success';
                message = 'Valid session data found';
            }
            
            document.getElementById('sessionTest').innerHTML = `
                <div class="status ${status}">
                    <strong>${message}</strong><br>
                    Demo Mode: ${sessionData.isDemo ? 'Yes' : 'No'}<br>
                    Token: ${sessionData.token ? 'Present' : 'Missing'}<br>
                    User Data: ${sessionData.localStorage ? 'Present' : 'Missing'}
                </div>
            `;
        }

        async function analyzeDemoMode() {
            const demoModeReasons = [];
            
            // Check if demo mode is explicitly set
            if (localStorage.getItem('smartfarm_demo_mode') === 'true') {
                demoModeReasons.push('Demo mode explicitly enabled in localStorage');
            }
            
            // Check if CORS is blocking
            if (testResults.cors && testResults.cors.status === 'error') {
                demoModeReasons.push('CORS configuration blocking backend access');
            }
            
            // Check if login API is failing
            if (testResults.loginAPI && testResults.loginAPI.status === 'error') {
                demoModeReasons.push('Login API is not accessible');
            }
            
            // Check if no valid token exists
            const token = localStorage.getItem('smartfarm_token') || sessionStorage.getItem('smartfarm_token');
            if (!token) {
                demoModeReasons.push('No valid authentication token found');
            }
            
            testResults.demoMode = { reasons: demoModeReasons };
            
            let status = 'success';
            let message = 'Not in demo mode';
            
            if (demoModeReasons.length > 0) {
                status = 'warning';
                message = `Demo mode active due to: ${demoModeReasons.length} reason(s)`;
            }
            
            document.getElementById('demoModeAnalysis').innerHTML = `
                <div class="status ${status}">
                    <strong>${message}</strong><br>
                    ${demoModeReasons.length > 0 ? 'Reasons:<br>' + demoModeReasons.map(reason => `‚Ä¢ ${reason}`).join('<br>') : 'All authentication systems working properly.'}
                </div>
            `;
        }

        async function generateRecommendations() {
            const recommendations = [];
            
            // CORS recommendations
            if (testResults.cors && testResults.cors.status === 'error') {
                recommendations.push({
                    priority: 'HIGH',
                    title: 'Fix CORS Configuration',
                    description: 'Update Railway CORS_ORIGIN environment variable to include your production domain',
                    action: 'Go to Railway Dashboard ‚Üí Variables ‚Üí CORS_ORIGIN ‚Üí Add: https://www.smartfarm-app.com,https://smartfarm-app.com'
                });
            }
            
            // Login API recommendations
            if (testResults.loginAPI && testResults.loginAPI.status === 'error') {
                recommendations.push({
                    priority: 'HIGH',
                    title: 'Fix Login API Access',
                    description: 'Ensure the login API endpoint is accessible and responding correctly',
                    action: 'Check Railway deployment status and logs'
                });
            }
            
            // Demo mode recommendations
            if (testResults.demoMode && testResults.demoMode.reasons.length > 0) {
                recommendations.push({
                    priority: 'MEDIUM',
                    title: 'Exit Demo Mode',
                    description: 'Clear demo mode settings and attempt real authentication',
                    action: 'Use the "Reset Authentication" button below'
                });
            }
            
            // Session recommendations
            if (testResults.session && testResults.session.isDemo) {
                recommendations.push({
                    priority: 'MEDIUM',
                    title: 'Clear Demo Session',
                    description: 'Remove demo mode from localStorage and attempt real login',
                    action: 'Use the "Clear Local Storage" button below'
                });
            }
            
            testResults.recommendations = recommendations;
            
            let html = '<div class="status info"><strong>Recommendations Generated</strong></div>';
            
            if (recommendations.length === 0) {
                html += '<div class="status success">No issues found - system is working correctly!</div>';
            } else {
                recommendations.forEach((rec, index) => {
                    const priorityClass = rec.priority === 'HIGH' ? 'error' : rec.priority === 'MEDIUM' ? 'warning' : 'info';
                    html += `
                        <div class="status ${priorityClass}" style="margin: 10px 0;">
                            <strong>${rec.priority} Priority: ${rec.title}</strong><br>
                            ${rec.description}<br>
                            <strong>Action:</strong> ${rec.action}
                        </div>
                    `;
                });
            }
            
            document.getElementById('fixRecommendations').innerHTML = html;
        }

        function clearLocalStorage() {
            try {
                localStorage.removeItem('smartfarm_user');
                localStorage.removeItem('smartfarm_token');
                localStorage.removeItem('smartfarm_demo_mode');
                sessionStorage.removeItem('smartfarm_user');
                sessionStorage.removeItem('smartfarm_token');
                
                alert('Local storage cleared successfully! Please refresh the page and try logging in again.');
            } catch (error) {
                alert('Error clearing local storage: ' + error.message);
            }
        }

        function resetAuthentication() {
            try {
                // Clear all authentication data
                clearLocalStorage();
                
                // Force page reload
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
                
                alert('Authentication reset! Page will reload in 1 second.');
            } catch (error) {
                alert('Error resetting authentication: ' + error.message);
            }
        }

        async function testRealLogin() {
            const email = prompt('Enter your email:');
            const password = prompt('Enter your password:');
            
            if (!email || !password) {
                alert('Email and password are required');
                return;
            }
            
            try {
                const response = await fetch('https://smartfarm-app-production.up.railway.app/api/auth/login', {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.token) {
                    // Store the token
                    localStorage.setItem('smartfarm_token', data.token);
                    localStorage.setItem('smartfarm_user', JSON.stringify(data.user));
                    localStorage.removeItem('smartfarm_demo_mode');
                    
                    alert('Login successful! You are now authenticated.');
                    window.location.href = '/dashboard.html';
                } else {
                    alert('Login failed: ' + (data.message || 'Invalid credentials'));
                }
            } catch (error) {
                alert('Login error: ' + error.message);
            }
        }

        function collectDebugInfo() {
            const debugInfo = {
                timestamp: new Date().toISOString(),
                url: window.location.href,
                userAgent: navigator.userAgent,
                testResults: testResults,
                localStorage: {
                    smartfarm_user: localStorage.getItem('smartfarm_user'),
                    smartfarm_token: localStorage.getItem('smartfarm_token'),
                    smartfarm_demo_mode: localStorage.getItem('smartfarm_demo_mode')
                },
                sessionStorage: {
                    smartfarm_user: sessionStorage.getItem('smartfarm_user'),
                    smartfarm_token: sessionStorage.getItem('smartfarm_token')
                },
                environment: {
                    smartfarmConfig: !!window.SmartFarmConfig,
                    smartfarmEnvironment: !!window.SmartFarmEnvironment,
                    smartfarmLogger: !!window.SmartFarmLogger,
                    smartfarmAPI: !!window.SmartFarmAPI
                }
            };
            
            const debugElement = document.getElementById('debugInfo');
            debugElement.textContent = JSON.stringify(debugInfo, null, 2);
            debugElement.style.display = 'block';
            
            // Copy to clipboard
            navigator.clipboard.writeText(JSON.stringify(debugInfo, null, 2)).then(() => {
                alert('Debug information copied to clipboard!');
            }).catch(() => {
                alert('Debug information displayed above. Please copy manually.');
            });
        }
    </script>
</body>
</html>
