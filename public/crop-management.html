<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crop Management - SmartFarm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2e7d32;
            --secondary-color: #4caf50;
            --accent-color: #8bc34a;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --info-color: #2196f3;
            --dark-color: #424242;
            --light-color: #f5f5f5;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Navigation Bar */
        .navbar-custom {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .navbar-custom .navbar-brand,
        .navbar-custom .nav-link {
            color: white !important;
        }

        .navbar-custom .nav-link:hover {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        .main-content {
            margin-top: 20px;
        }

        .page-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 40px 0;
            margin-bottom: 30px;
        }

        .card-custom {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .btn-custom {
            background: var(--accent-color);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .btn-custom:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .table-custom {
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }

        .table-custom th {
            background: var(--light-color);
            border: none;
            font-weight: 600;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-planted { background: #d4edda; color: #155724; }
        .status-growing { background: #cce5ff; color: #004085; }
        .status-flowering { background: #fff3cd; color: #856404; }
        .status-fruiting { background: #f8d7da; color: #721c24; }
        .status-harvesting { background: #e2e3e5; color: #383d41; }
        .status-completed { background: #d1ecf1; color: #0c5460; }

        .ai-maturity {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 4px solid #2196f3;
            padding: 8px 12px;
            border-radius: 6px;
            margin: 5px 0;
        }

        .ai-maturity .ai-icon {
            color: #1976d2;
            margin-right: 8px;
        }

        .maturity-date {
            font-weight: 600;
            color: #1976d2;
        }

        .crop-card {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .crop-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.15);
        }

        .crop-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
        }

        .progress-custom {
            height: 8px;
            border-radius: 4px;
            background-color: #e9ecef;
        }

        .progress-bar-custom {
            background: linear-gradient(90deg, var(--accent-color), var(--secondary-color));
            border-radius: 4px;
        }

        .modal-custom .modal-content {
            border-radius: 15px;
            border: none;
        }

        .form-control-custom {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }

        .form-control-custom:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(46, 125, 50, 0.25);
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <i class="fas fa-seedling me-2"></i>SmartFarm
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="crop-management.html">
                            <i class="fas fa-seedling me-1"></i>Crop Management
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="livestock-management.html">
                            <i class="fas fa-cow me-1"></i>Livestock
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="inventory-management.html">
                            <i class="fas fa-boxes me-1"></i>Inventory
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="analytics-dashboard.html">
                            <i class="fas fa-chart-line me-1"></i>Analytics
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="login.html">
                            <i class="fas fa-sign-out-alt me-1"></i>Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <a href="dashboard.html" class="back-btn me-3">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                    <h1 class="mb-0">Crop Management</h1>
                    <p class="mb-0 mt-2">Manage your crops, track growth, and optimize yields</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light btn-lg" data-bs-toggle="modal" data-bs-target="#addCropModal" onclick="console.log('Add New Crop button clicked')">
                        <i class="fas fa-plus me-2"></i>Add New Crop
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container main-content">
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="card-custom text-center">
                    <h3 class="text-primary mb-2" id="totalCrops">0</h3>
                    <p class="mb-0">Total Crops</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card-custom text-center">
                    <h3 class="text-success mb-2" id="activeCrops">0</h3>
                    <p class="mb-0">Active Crops</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card-custom text-center">
                    <h3 class="text-warning mb-2" id="readyHarvest">0</h3>
                    <p class="mb-0">Ready for Harvest</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card-custom text-center">
                    <h3 class="text-info mb-2" id="totalYield">0</h3>
                    <p class="mb-0">Total Yield (kg)</p>
                </div>
            </div>
        </div>

        <!-- Filter and Search -->
        <div class="card-custom">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search crops...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="planted">Planted</option>
                        <option value="growing">Growing</option>
                        <option value="flowering">Flowering</option>
                        <option value="fruiting">Fruiting</option>
                        <option value="harvesting">Harvesting</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="fieldFilter">
                        <option value="">All Fields</option>
                        <option value="Field A">Field A</option>
                        <option value="Field B">Field B</option>
                        <option value="Field C">Field C</option>
                        <option value="Greenhouse 1">Greenhouse 1</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-custom w-100" onclick="applyFilters()">
                        <i class="fas fa-filter me-2"></i>Filter
                    </button>
                </div>
            </div>
        </div>

        <!-- Crops Grid -->
        <div class="row" id="cropsContainer">
            <!-- Crop cards will be dynamically loaded here -->
        </div>

        <!-- No crops message -->
        <div id="noCropsMessage" class="text-center py-5" style="display: none;">
            <i class="fas fa-seedling fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No crops found</h4>
            <p class="text-muted">Start by adding your first crop to begin tracking and managing your farm.</p>
            <button class="btn btn-custom" data-bs-toggle="modal" data-bs-target="#addCropModal">
                <i class="fas fa-plus me-2"></i>Add Your First Crop
            </button>
        </div>
    </div>

    <!-- Add Crop Modal -->
    <div class="modal fade modal-custom" id="addCropModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Crop</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addCropForm">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Crop Name</label>
                                    <input type="text" class="form-control form-control-custom" id="cropName" required list="catalog-plants-list" data-catalog-search data-catalog-group="plants">
                                    <datalist id="catalog-plants-list"></datalist>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div id="cropNameInsights" class="alert alert-info d-none mb-3"></div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Variety</label>
                                    <input type="text" class="form-control form-control-custom" id="cropVariety" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Field/Location</label>
                                    <select class="form-select form-control-custom" id="cropField" required>
                                        <option value="">Select Field</option>
                                        <option value="Field A">Field A</option>
                                        <option value="Field B">Field B</option>
                                        <option value="Field C">Field C</option>
                                        <option value="Greenhouse 1">Greenhouse 1</option>
                                        <option value="Greenhouse 2">Greenhouse 2</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Planting Date</label>
                                    <input type="date" class="form-control form-control-custom" id="plantingDate" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Expected Harvest Date</label>
                                    <input type="date" class="form-control form-control-custom" id="harvestDate">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Area (hectares)</label>
                                    <input type="number" class="form-control form-control-custom" id="cropArea" step="0.1" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Lifecycle Stage</label>
                                    <input type="text" class="form-control form-control-custom" id="cropStatus" readonly style="background-color: #e9ecef; cursor: not-allowed;">
                                    <small class="text-muted"><i class="fas fa-info-circle me-1"></i>Auto-calculated based on planting date</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Seed Supplier</label>
                                    <input type="text" class="form-control form-control-custom" id="seedSupplier">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Initial Investment (FJD)</label>
                                    <input type="number" class="form-control form-control-custom" id="initialInvestment" step="0.01">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control form-control-custom" id="cropNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-custom" onclick="console.log('Save Crop button clicked'); saveNewCrop();">
                        <i class="fas fa-save me-2"></i>Save Crop
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Crop Modal -->
    <div class="modal fade modal-custom" id="editCropModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Crop</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editCropForm">
                        <input type="hidden" id="editCropId">
                        <!-- Same form fields as add crop modal -->
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Crop Name</label>
                                    <input type="text" class="form-control form-control-custom" id="editCropName" required list="catalog-plants-list" data-catalog-search data-catalog-group="plants">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div id="editCropNameInsights" class="alert alert-info d-none mb-3"></div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Variety</label>
                                    <input type="text" class="form-control form-control-custom" id="editCropVariety" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Field/Location</label>
                                    <select class="form-select form-control-custom" id="editCropField" required>
                                        <option value="">Select Field</option>
                                        <option value="Field A">Field A</option>
                                        <option value="Field B">Field B</option>
                                        <option value="Field C">Field C</option>
                                        <option value="Greenhouse 1">Greenhouse 1</option>
                                        <option value="Greenhouse 2">Greenhouse 2</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Lifecycle Stage</label>
                                    <input type="text" class="form-control form-control-custom" id="editCropStatus" readonly style="background-color: #e9ecef; cursor: not-allowed;">
                                    <small class="text-muted"><i class="fas fa-info-circle me-1"></i>Auto-calculated based on planting date</small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Planting Date</label>
                                    <input type="date" class="form-control form-control-custom" id="editPlantingDate" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Expected Harvest Date</label>
                                    <input type="date" class="form-control form-control-custom" id="editHarvestDate">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Area (hectares)</label>
                                    <input type="number" class="form-control form-control-custom" id="editCropArea" step="0.1" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Current Yield (kg)</label>
                                    <input type="number" class="form-control form-control-custom" id="editCropYield" step="0.1">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control form-control-custom" id="editCropNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-custom" onclick="updateCrop()">
                        <i class="fas fa-save me-2"></i>Update Crop
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Include AI advisory database -->
    <script src="js/ai-advisory-database.js"></script>
    <!-- Include config -->
    <script src="js/config.js"></script>
    
    <script>
        // Sample crops data
        let crops = [
            {
                id: 1,
                name: "Tomatoes",
                variety: "Cherry",
                field: "Field A",
                status: "growing",
                plantingDate: "2025-01-10",
                harvestDate: "2025-03-15",
                maturityDate: "2025-03-20", // AI calculated
                area: 0.5,
                yield: 0,
                notes: "Planted in greenhouse for better control"
            },
            {
                id: 2,
                name: "Capsicum",
                variety: "California Wonder",
                field: "Field B",
                status: "flowering",
                plantingDate: "2025-01-05",
                harvestDate: "2025-03-10",
                maturityDate: "2025-03-15", // AI calculated
                area: 0.8,
                yield: 0,
                notes: "Organic farming methods"
            },
            {
                id: 3,
                name: "Lettuce",
                variety: "Romaine",
                field: "Greenhouse 1",
                status: "harvesting",
                plantingDate: "2024-12-20",
                harvestDate: "2025-01-20",
                maturityDate: "2025-01-25", // AI calculated
                area: 0.3,
                yield: 45.5,
                notes: "Hydroponic system"
            },
            {
                id: 4,
                name: "Kava",
                variety: "Noble Kava",
                field: "Medicinal Garden",
                status: "growing",
                plantingDate: "2022-01-15",
                harvestDate: "2025-01-15",
                maturityDate: "2025-01-15", // AI calculated (3 years)
                area: 0.2,
                yield: 0,
                notes: "Traditional Pacific Island medicinal plant, requires 3-year growth cycle"
            }
        ];

        const catalogGrowthData = {
            map: new Map(),
            loaded: false,
            promise: null
        };

        let lastAIMaturityContext = null;

        async function preloadCatalogGrowthData() {
            if (catalogGrowthData.loaded) {
                return catalogGrowthData.map;
            }

            if (!catalogGrowthData.promise) {
                catalogGrowthData.promise = fetch('/api/catalog?group=plants&limit=2000', { headers: { Accept: 'application/json' } })
                    .then(async response => {
                        if (!response.ok) {
                            throw new Error(`Catalog preload failed (${response.status})`);
                        }
                        const contentType = response.headers.get('content-type') || '';
                        if (!contentType.includes('application/json')) {
                            const preview = await response.text();
                            throw new Error(
                                `Catalog preload returned non-JSON response (content-type: ${contentType || 'unknown'})\nPreview: ${preview.slice(
                                    0,
                                    120
                                )}`
                            );
                        }
                        return response.json();
                    })
                    .then(data => {
                        const map = new Map();
                        (data.items || []).forEach(item => {
                            if (!item || !item.name) return;
                            const primaryKey = item.name.toLowerCase();
                            map.set(primaryKey, item);
                            if (Array.isArray(item.aliases)) {
                                item.aliases.forEach(alias => {
                                    if (alias) {
                                        map.set(alias.toLowerCase(), item);
                                    }
                                });
                            }
                        });
                        catalogGrowthData.map = map;
                        catalogGrowthData.loaded = true;
                        return map;
                    })
                    .catch(error => {
                        console.error('Failed to preload plant catalog data:', error);
                        catalogGrowthData.loaded = true;
                        return catalogGrowthData.map;
                    });
            }

            return catalogGrowthData.promise;
        }

        function getCatalogPlantRecord(name) {
            if (!name) return null;
            const key = name.toLowerCase();
            return catalogGrowthData.map.get(key) || null;
        }

        // Save crops to localStorage
        function saveCropsToStorage() {
            try {
                localStorage.setItem('smartfarm_crops', JSON.stringify(crops));
                console.log('Crops saved to localStorage');
            } catch (error) {
                console.error('Error saving crops to localStorage:', error);
            }
        }

        // Load crops from localStorage
        function loadCropsFromStorage() {
            try {
                const savedCrops = localStorage.getItem('smartfarm_crops');
                if (savedCrops) {
                    crops = JSON.parse(savedCrops);
                    console.log('Crops loaded from localStorage:', crops.length);
                    return true;
                }
            } catch (error) {
                console.error('Error loading crops from localStorage:', error);
            }
            return false;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            await preloadCatalogGrowthData();

            // Check authentication first
            checkAuthentication();
            
            // Try to load crops from localStorage
            const loaded = loadCropsFromStorage();
            if (!loaded) {
                console.log('No saved crops found, using default crops');
            }
            
            loadCrops();
            updateStatistics();
            setupEventListeners();
            calculateAndDisplayMaturityDate();
        });

        function setupEventListeners() {
            // Add event listener for planting date input to calculate maturity date and status
            const plantingDateInput = document.getElementById('plantingDate');
            if (plantingDateInput) {
                plantingDateInput.addEventListener('change', function() {
                    calculateAndDisplayMaturityDate();
                    updateLifecycleStage();
                });
            }
            
            // Add event listener for crop name input to recalculate when crop changes
            const cropNameInput = document.getElementById('cropName');
            if (cropNameInput) {
                cropNameInput.addEventListener('change', function() {
                    calculateAndDisplayMaturityDate();
                    updateLifecycleStage();
                });
            }
            
            // Add event listener for harvest date input
            const harvestDateInput = document.getElementById('harvestDate');
            if (harvestDateInput) {
                harvestDateInput.addEventListener('change', function() {
                    updateLifecycleStage();
                });
            }
        }

        // Update lifecycle stage display
        function updateLifecycleStage() {
            const plantingDate = document.getElementById('plantingDate')?.value;
            const harvestDate = document.getElementById('harvestDate')?.value;
            const cropName = document.getElementById('cropName')?.value;
            
            if (plantingDate) {
                // Calculate maturity date if we have crop name
                let maturityDate = harvestDate;
                if (!maturityDate && cropName) {
                    const tempCrop = {
                        name: cropName,
                        plantingDate: plantingDate
                    };
                    maturityDate = calculateMaturityDate(tempCrop);
                }
                
                const status = calculateLifecycleStage(plantingDate, maturityDate);
                const statusInput = document.getElementById('cropStatus');
                if (statusInput) {
                    statusInput.value = status;
                }
            } else {
                const statusInput = document.getElementById('cropStatus');
                if (statusInput) {
                    statusInput.value = '';
                }
            }
        }

        function calculateAndDisplayMaturityDate() {
            const cropName = document.getElementById('cropName').value;
            const variety = document.getElementById('cropVariety').value;
            const field = document.getElementById('cropField').value;
            const plantingDate = document.getElementById('plantingDate').value;
            const area = parseFloat(document.getElementById('cropArea').value) || 0.5;
            
            if (cropName && plantingDate) {
                // Create temporary crop object for AI calculation
                const tempCrop = {
                    name: cropName,
                    variety: variety,
                    field: field,
                    plantingDate: plantingDate,
                    area: area
                };
                
                // Calculate AI maturity date
                const aiMaturityDate = calculateMaturityDate(tempCrop);
                
                // Update the harvest date field with AI calculated date
                const harvestDateInput = document.getElementById('harvestDate');
                if (harvestDateInput) {
                    harvestDateInput.value = aiMaturityDate;
                }
                
                // Update lifecycle stage
                updateLifecycleStage();
                
                // Show AI calculation info
                showAICalculationInfo(tempCrop, aiMaturityDate);
            }
        }

        function showAICalculationInfo(crop, maturityDate) {
            // Remove existing AI info if any
            const existingInfo = document.getElementById('aiCalculationInfo');
            if (existingInfo) {
                existingInfo.remove();
            }
            
            // Create AI calculation info element
            const aiInfo = document.createElement('div');
            aiInfo.id = 'aiCalculationInfo';
            aiInfo.className = 'alert alert-info mt-2';
            const context = lastAIMaturityContext;
            let extraInfo = '';

            if (context?.source === 'catalog' && context.catalogItem) {
                const parts = [];
                if (context.catalogItem.growthDurationDays) {
                    parts.push(`Catalog growth window: ${context.catalogItem.growthDurationDays} days`);
                }
                if (context.catalogItem.postPollinationMaturityDays) {
                    parts.push(`Post-pollination maturity: ${context.catalogItem.postPollinationMaturityDays} days`);
                }
                if (Array.isArray(context.catalogItem.regions) && context.catalogItem.regions.length) {
                    const regionSample = context.catalogItem.regions.slice(0, 3).join(', ');
                    parts.push(`Regions: ${regionSample}${context.catalogItem.regions.length > 3 ? '…' : ''}`);
                }
                if (parts.length) {
                    extraInfo = `<div class="mt-2 small text-muted">${parts.join(' • ')}</div>`;
                }
            } else if (context?.source === 'fallback') {
                extraInfo = `<div class="mt-2 small text-muted">Using generic estimate — enrich catalog data for more precise guidance.</div>`;
            }

            aiInfo.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-robot me-2"></i>
                    <div>
                        <strong>AI Prediction:</strong> Based on ${crop.name} (${crop.variety || 'standard variety'}) planted on ${formatDate(crop.plantingDate)}, 
                        the optimal maturity date is <strong>${formatDate(maturityDate)}</strong>
                        ${crop.field && crop.field.toLowerCase().includes('greenhouse') ? ' (Greenhouse: 10% faster growth)' : ''}
                        ${crop.field && crop.field.toLowerCase().includes('hydroponic') ? ' (Hydroponic: 15% faster growth)' : ''}
                    </div>
                </div>
                ${extraInfo}
            `;
            
            // Insert after the harvest date field
            const harvestDateField = document.getElementById('harvestDate').closest('.mb-3');
            harvestDateField.appendChild(aiInfo);
        }

        function checkAuthentication() {
            const user = localStorage.getItem('smartfarm_user') || sessionStorage.getItem('smartfarm_user');
            const token = localStorage.getItem('smartfarm_token') || sessionStorage.getItem('smartfarm_token');
            
            if (!user) {
                console.log('No user found, redirecting to login');
                window.location.href = 'login.html';
                return;
            }
            
            // Check if session is still valid (for non-remember me users)
            const rememberMe = localStorage.getItem('smartfarm_remember');
            if (!rememberMe) {
                const loginTime = sessionStorage.getItem('smartfarm_loginTime');
                if (loginTime) {
                    const sessionAge = Date.now() - new Date(loginTime).getTime();
                    const maxSessionAge = 24 * 60 * 60 * 1000; // 24 hours
                    if (sessionAge > maxSessionAge) {
                        console.log('Session expired, redirecting to login');
                        sessionStorage.clear();
                        window.location.href = 'login.html';
                        return;
                    }
                }
            }
            
            console.log('User authenticated for crop management:', user);
        }

        function loadCrops() {
            const container = document.getElementById('cropsContainer');
            const noCropsMessage = document.getElementById('noCropsMessage');
            
            if (crops.length === 0) {
                container.innerHTML = '';
                noCropsMessage.style.display = 'block';
                return;
            }
            
            // Auto-update lifecycle stage for all crops based on current date
            crops.forEach(crop => {
                if (crop.plantingDate) {
                    const currentStatus = calculateLifecycleStage(crop.plantingDate, crop.maturityDate || crop.harvestDate);
                    crop.status = currentStatus.toLowerCase();
                }
            });
            
            // Save updated statuses
            saveCropsToStorage();
            
            noCropsMessage.style.display = 'none';
            container.innerHTML = '';
            
            crops.forEach(crop => {
                const cropCard = createCropCard(crop);
                container.appendChild(cropCard);
            });
        }

        function createCropCard(crop) {
            const col = document.createElement('div');
            col.className = 'col-lg-4 col-md-6 mb-4';
            
            const progress = calculateProgress(crop);
            const statusClass = getStatusClass(crop.status);
            const statusText = getStatusText(crop.status);
            
            col.innerHTML = `
                <div class="crop-card">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h5 class="mb-1">${crop.name}</h5>
                            <p class="text-muted mb-0">${crop.variety}</p>
                        </div>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <small class="text-muted">Field:</small>
                            <div class="fw-bold">${crop.field}</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Area:</small>
                            <div class="fw-bold">${crop.area} ha</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted">Growth Progress</small>
                            <small class="fw-bold">${progress}%</small>
                        </div>
                        <div class="progress progress-custom">
                            <div class="progress-bar progress-bar-custom" style="width: ${progress}%"></div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-4">
                            <small class="text-muted">Planted:</small>
                            <div class="fw-bold">${formatDate(crop.plantingDate)}</div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Yield:</small>
                            <div class="fw-bold">${crop.yield} kg</div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Harvest:</small>
                            <div class="fw-bold">${formatDate(crop.harvestDate)}</div>
                        </div>
                    </div>
                    
                    <div class="ai-maturity">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-robot ai-icon"></i>
                            <div>
                                <small class="text-muted">AI Predicted Maturity:</small>
                                <div class="maturity-date">${formatDate(crop.maturityDate || calculateMaturityDate(crop))}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary flex-fill" onclick="editCrop(${crop.id})">
                            <i class="fas fa-edit me-1"></i>Edit
                        </button>
                        <button class="btn btn-sm btn-outline-success flex-fill" onclick="addYield(${crop.id})">
                            <i class="fas fa-plus me-1"></i>Add Yield
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="getAICropAdvice(${crop.id})" title="Get AI Nutrition Advice">
                            <i class="fas fa-robot"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCrop(${crop.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            return col;
        }

        function calculateProgress(crop) {
            const planted = new Date(crop.plantingDate);
            const harvest = new Date(crop.harvestDate);
            const now = new Date();
            
            const totalDays = (harvest - planted) / (1000 * 60 * 60 * 24);
            const daysPassed = (now - planted) / (1000 * 60 * 60 * 24);
            
            const progress = Math.min(Math.max((daysPassed / totalDays) * 100, 0), 100);
            return Math.round(progress);
        }

        // AI-powered maturity date calculation
        // Calculate lifecycle stage based on planting date and maturity date
        function calculateLifecycleStage(plantingDate, maturityDate) {
            if (!plantingDate) {
                return 'Planted';
            }
            
            const today = new Date();
            const planted = new Date(plantingDate);
            const maturity = maturityDate ? new Date(maturityDate) : null;
            const daysSincePlanting = Math.floor((today - planted) / (1000 * 60 * 60 * 24));
            
            // If maturity date is provided, use it for calculation
            if (maturity) {
                const daysToMaturity = Math.floor((maturity - planted) / (1000 * 60 * 60 * 24));
                
                if (daysSincePlanting < 0) {
                    return 'Planted';
                } else if (daysSincePlanting < daysToMaturity * 0.15) {
                    return 'Planted';
                } else if (daysSincePlanting < daysToMaturity * 0.3) {
                    return 'Growing';
                } else if (daysSincePlanting < daysToMaturity * 0.5) {
                    return 'Flowering';
                } else if (daysSincePlanting < daysToMaturity * 0.7) {
                    return 'Fruiting';
                } else if (daysSincePlanting < daysToMaturity * 0.9) {
                    return 'Harvesting';
                } else if (daysSincePlanting >= daysToMaturity) {
                    return 'Completed';
                } else {
                    return 'Harvesting';
                }
            } else {
                // Generic calculation based on days since planting
                if (daysSincePlanting < 0) {
                    return 'Planted';
                } else if (daysSincePlanting < 7) {
                    return 'Planted';
                } else if (daysSincePlanting < 30) {
                    return 'Growing';
                } else if (daysSincePlanting < 60) {
                    return 'Flowering';
                } else if (daysSincePlanting < 90) {
                    return 'Fruiting';
                } else if (daysSincePlanting < 120) {
                    return 'Harvesting';
                } else {
                    return 'Completed';
                }
            }
        }

        function calculateMaturityDate(crop) {
            const normalizedCropName = (crop.name || '').trim().toLowerCase();
            const catalogRecord = getCatalogPlantRecord(normalizedCropName);
            let catalogBaseDays = null;

            if (catalogRecord) {
                const numericDuration = Number(catalogRecord.growthDurationDays);
                if (!Number.isNaN(numericDuration) && numericDuration > 0) {
                    catalogBaseDays = numericDuration;
                } else if (typeof catalogRecord.growthDuration === 'string') {
                    const match = catalogRecord.growthDuration.match(/(\d+)/);
                    if (match) {
                        const parsed = Number(match[1]);
                        if (!Number.isNaN(parsed) && parsed > 0) {
                            catalogBaseDays = parsed;
                        }
                    }
                }
            }

            const cropDatabase = {
                // Vegetables (harvest times based on global agricultural standards)
                'tomatoes': { baseDays: 75, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 60-90 days
                'cherry tomatoes': { baseDays: 65, varietyMultiplier: 0.9, seasonAdjustment: 0 }, // 55-70 days
                'beefsteak tomatoes': { baseDays: 85, varietyMultiplier: 1.1, seasonAdjustment: 0 }, // 75-95 days
                'peppers': { baseDays: 70, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 60-90 days
                'bell peppers': { baseDays: 75, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 60-90 days
                'chili peppers': { baseDays: 80, varietyMultiplier: 1.1, seasonAdjustment: 0 }, // 70-100 days
                'lettuce': { baseDays: 45, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 30-60 days
                'romaine lettuce': { baseDays: 50, varietyMultiplier: 1.1, seasonAdjustment: 0 }, // 40-65 days
                'spinach': { baseDays: 40, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 25-40 days
                'cucumbers': { baseDays: 55, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 50-70 days
                'carrots': { baseDays: 75, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 70-80 days
                'onions': { baseDays: 130, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 100-175 days for full bulbs
                'potatoes': { baseDays: 90, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 70-120 days
                'cabbage': { baseDays: 90, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 70-120 days
                'broccoli': { baseDays: 60, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 50-85 days
                'cauliflower': { baseDays: 70, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 55-85 days
                'eggplant': { baseDays: 85, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 75-90 days
                'okra': { baseDays: 55, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 50-65 days
                'zucchini': { baseDays: 50, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 45-55 days
                'kale': { baseDays: 55, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 50-65 days
                'celery': { baseDays: 120, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 100-130 days
                'asparagus': { baseDays: 730, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 2-3 years first harvest
                
                // Fruits
                'strawberries': { baseDays: 30, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 28-35 days from transplant
                'watermelons': { baseDays: 85, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 70-100 days
                'cantaloupes': { baseDays: 80, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 65-90 days
                'pumpkins': { baseDays: 100, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 90-120 days
                'squash': { baseDays: 60, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 50-65 days (summer)
                'winter squash': { baseDays: 100, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 80-110 days
                'bananas': { baseDays: 300, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 9-12 months
                'pineapple': { baseDays: 540, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 18-24 months
                'papaya': { baseDays: 240, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 6-9 months
                'mango': { baseDays: 120, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 3-5 months from flowering
                
                // Grains
                'corn': { baseDays: 90, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 60-100 days
                'wheat': { baseDays: 120, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 90-150 days
                'rice': { baseDays: 120, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 105-150 days
                'barley': { baseDays: 100, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 70-90 days spring, 100-120 winter
                'oats': { baseDays: 90, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 60-100 days
                'sorghum': { baseDays: 100, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 90-120 days
                'millet': { baseDays: 70, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 60-90 days
                
                // Legumes
                'beans': { baseDays: 60, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 50-70 days
                'green beans': { baseDays: 55, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 50-60 days
                'peas': { baseDays: 60, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 50-70 days
                'lentils': { baseDays: 100, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 80-110 days
                'chickpeas': { baseDays: 100, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 90-120 days
                'soybeans': { baseDays: 100, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 90-120 days
                'peanuts': { baseDays: 120, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 100-130 days
                'black beans': { baseDays: 90, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 80-100 days
                'lima beans': { baseDays: 75, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 65-85 days
                
                // Herbs and Spices
                'basil': { baseDays: 30, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 25-35 days
                'cilantro': { baseDays: 25, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 20-30 days
                'parsley': { baseDays: 70, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 60-80 days
                'oregano': { baseDays: 40, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 35-45 days
                'thyme': { baseDays: 45, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 40-50 days
                'mint': { baseDays: 30, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 25-35 days
                'rosemary': { baseDays: 90, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 75-100 days
                'sage': { baseDays: 75, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 60-90 days
                'dill': { baseDays: 40, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 35-45 days
                'chives': { baseDays: 30, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 25-35 days
                
                // Medicinal Plants
                'kava': { baseDays: 1095, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 3-4 years
                'aloe vera': { baseDays: 365, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 1-2 years
                'ginger': { baseDays: 240, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 8-10 months
                'turmeric': { baseDays: 270, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 9-10 months
                'lavender': { baseDays: 180, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 6-8 months
                'ginseng': { baseDays: 2190, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 6+ years
                
                // Root Vegetables
                'radishes': { baseDays: 30, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 25-35 days
                'beets': { baseDays: 60, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 50-70 days
                'turnips': { baseDays: 50, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 45-60 days
                'sweet potatoes': { baseDays: 120, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 100-140 days
                'cassava': { baseDays: 365, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 10-12 months
                'taro': { baseDays: 270, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 8-12 months
                'yam': { baseDays: 240, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 7-10 months
                'garlic': { baseDays: 240, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 8-9 months
                'shallots': { baseDays: 100, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 90-120 days
                
                // Other Common Crops
                'cotton': { baseDays: 150, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 120-180 days
                'sugarcane': { baseDays: 365, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 12-18 months
                'sunflower': { baseDays: 90, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 80-120 days
                'flax': { baseDays: 100, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 90-110 days
                'sesame': { baseDays: 90, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 80-100 days
                'quinoa': { baseDays: 120, varietyMultiplier: 1.0, seasonAdjustment: 0 }, // 90-150 days
            };

            const cropName = normalizedCropName;
            const variety = crop.variety ? crop.variety.toLowerCase() : '';

            let cropData = null;
            if (catalogBaseDays) {
                cropData = { baseDays: catalogBaseDays, varietyMultiplier: 1.0, seasonAdjustment: 0 };
            } else {
                cropData = cropDatabase[cropName];
            }
            
            // Try to find by variety if crop name doesn't match
            if (!cropData) {
                for (const [key, data] of Object.entries(cropDatabase)) {
                    if (variety.includes(key) || key.includes(variety)) {
                        cropData = data;
                        break;
                    }
                }
            }
            
            // Default to 60 days if no match found
            if (!cropData) {
                cropData = { baseDays: 60, varietyMultiplier: 1.0, seasonAdjustment: 0 };
            }

            lastAIMaturityContext = {
                source: catalogBaseDays ? 'catalog' : (cropDatabase[cropName] ? 'heuristic' : 'fallback'),
                baseDays: cropData.baseDays,
                catalogItem: catalogRecord
            };

            // Calculate maturity days with AI adjustments
            let maturityDays = cropData.baseDays * cropData.varietyMultiplier;
            
            // Apply seasonal adjustments based on planting month
            const plantingDate = new Date(crop.plantingDate);
            const month = plantingDate.getMonth() + 1; // 1-12
            
            // Seasonal adjustments (Fiji climate)
            if (month >= 11 || month <= 3) { // Summer (Nov-Mar)
                maturityDays *= 0.95; // Slightly faster growth
            } else if (month >= 4 && month <= 6) { // Autumn (Apr-Jun)
                maturityDays *= 1.05; // Slightly slower growth
            } else if (month >= 7 && month <= 10) { // Winter/Spring (Jul-Oct)
                maturityDays *= 1.1; // Slower growth due to cooler weather
            }
            
            // Apply field type adjustments
            if (crop.field && crop.field.toLowerCase().includes('greenhouse')) {
                maturityDays *= 0.9; // 10% faster in greenhouse
            } else if (crop.field && crop.field.toLowerCase().includes('hydroponic')) {
                maturityDays *= 0.85; // 15% faster in hydroponic
            }
            
            // Apply area-based adjustments (larger areas might have different conditions)
            if (crop.area > 1) {
                maturityDays *= 1.05; // Slightly longer for larger areas
            } else if (crop.area < 0.2) {
                maturityDays *= 0.95; // Slightly faster for smaller areas
            }
            
            // Round to nearest day
            maturityDays = Math.round(maturityDays);
            
            // Calculate maturity date
            const plantedDate = new Date(crop.plantingDate);
            const maturityDate = new Date(plantedDate.getTime() + (maturityDays * 24 * 60 * 60 * 1000));
            
            return maturityDate.toISOString().split('T')[0];
        }

        function getStatusClass(status) {
            const classes = {
                'planted': 'status-planted',
                'growing': 'status-growing',
                'flowering': 'status-flowering',
                'fruiting': 'status-fruiting',
                'harvesting': 'status-harvesting',
                'completed': 'status-completed'
            };
            return classes[status] || 'status-planted';
        }

        function getStatusText(status) {
            return status.charAt(0).toUpperCase() + status.slice(1);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }

        function updateStatistics() {
            document.getElementById('totalCrops').textContent = crops.length;
            document.getElementById('activeCrops').textContent = crops.filter(c => c.status !== 'completed').length;
            document.getElementById('readyHarvest').textContent = crops.filter(c => c.status === 'harvesting').length;
            document.getElementById('totalYield').textContent = crops.reduce((sum, c) => sum + c.yield, 0).toFixed(1);
        }

        function saveNewCrop() {
            try {
                console.log('saveNewCrop function called');
                
                // Get form values
                const cropName = document.getElementById('cropName').value;
                const variety = document.getElementById('cropVariety').value;
                const field = document.getElementById('cropField').value;
                const plantingDate = document.getElementById('plantingDate').value;
                const area = parseFloat(document.getElementById('cropArea').value) || 0;
                
                console.log('Form values:', { cropName, variety, field, plantingDate, area });
                
                // Validate required fields
                if (!cropName || !field || !plantingDate) {
                    showAlert('Please fill in all required fields (Crop Name, Field Name, and Planting Date).', 'error');
                    return;
                }
                
                // Create temporary crop object for AI calculation
                const tempCrop = {
                    name: cropName,
                    variety: variety,
                    field: field,
                    plantingDate: plantingDate,
                    area: area
                };
                
            // Calculate AI maturity date
            const aiMaturityDate = calculateMaturityDate(tempCrop);
            console.log('AI maturity date calculated:', aiMaturityDate);
            
            // Auto-calculate lifecycle stage
            const calculatedStatus = calculateLifecycleStage(plantingDate, aiMaturityDate);
            console.log('Lifecycle stage calculated:', calculatedStatus);
            
            const cropData = {
                id: Date.now(),
                name: cropName,
                variety: variety,
                field: field,
                status: calculatedStatus.toLowerCase(), // Use auto-calculated status
                plantingDate: plantingDate,
                harvestDate: document.getElementById('harvestDate').value || aiMaturityDate,
                maturityDate: aiMaturityDate, // Store AI calculated maturity date
                area: area,
                yield: 0,
                notes: document.getElementById('cropNotes').value
            };
                
                console.log('Crop data to save:', cropData);
                
                // Ensure crops array exists
                if (!crops) {
                    crops = [];
                }
                
                crops.push(cropData);
                
                // Save to localStorage
                saveCropsToStorage();
                
                loadCrops();
                updateStatistics();
                
                // Close modal and reset form
                const modal = bootstrap.Modal.getInstance(document.getElementById('addCropModal'));
                if (modal) {
                    modal.hide();
                }
                document.getElementById('addCropForm').reset();
                
                // Show success message
                showAlert('Crop added successfully!', 'success');
                console.log('Crop added successfully');
                
            } catch (error) {
                console.error('Error in saveNewCrop:', error);
                showAlert('Error adding crop: ' + error.message, 'error');
            }
        }

        function editCrop(id) {
            const crop = crops.find(c => c.id === id);
            if (!crop) return;
            
            // Populate edit form
            document.getElementById('editCropId').value = crop.id;
            document.getElementById('editCropName').value = crop.name;
            document.getElementById('editCropVariety').value = crop.variety;
            document.getElementById('editCropField').value = crop.field;
            document.getElementById('editPlantingDate').value = crop.plantingDate;
            document.getElementById('editHarvestDate').value = crop.harvestDate;
            document.getElementById('editCropArea').value = crop.area;
            document.getElementById('editCropYield').value = crop.yield;
            document.getElementById('editCropNotes').value = crop.notes;
            
            // Calculate and display auto-calculated lifecycle stage
            const calculatedStatus = calculateLifecycleStage(crop.plantingDate, crop.maturityDate || crop.harvestDate);
            document.getElementById('editCropStatus').value = calculatedStatus;
            
            // Show modal
            new bootstrap.Modal(document.getElementById('editCropModal')).show();
        }

        function updateCrop() {
            const id = parseInt(document.getElementById('editCropId').value);
            const cropIndex = crops.findIndex(c => c.id === id);
            
            if (cropIndex === -1) return;
            
            const cropName = document.getElementById('editCropName').value;
            const variety = document.getElementById('editCropVariety').value;
            const field = document.getElementById('editCropField').value;
            const plantingDate = document.getElementById('editPlantingDate').value;
            const area = parseFloat(document.getElementById('editCropArea').value);
            
            // Create temporary crop object for AI calculation
            const tempCrop = {
                name: cropName,
                variety: variety,
                field: field,
                plantingDate: plantingDate,
                area: area
            };
            
            // Calculate AI maturity date
            const aiMaturityDate = calculateMaturityDate(tempCrop);
            
            // Auto-calculate lifecycle stage
            const calculatedStatus = calculateLifecycleStage(plantingDate, aiMaturityDate);
            
            crops[cropIndex] = {
                ...crops[cropIndex],
                name: cropName,
                variety: variety,
                field: field,
                status: calculatedStatus.toLowerCase(), // Use auto-calculated status
                plantingDate: plantingDate,
                harvestDate: document.getElementById('editHarvestDate').value || aiMaturityDate,
                maturityDate: aiMaturityDate, // Update AI calculated maturity date
                area: area,
                yield: parseFloat(document.getElementById('editCropYield').value) || 0,
                notes: document.getElementById('editCropNotes').value
            };
            
            // Save to localStorage
            saveCropsToStorage();
            
            loadCrops();
            updateStatistics();
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('editCropModal')).hide();
            
            // Show success message
            showAlert('Crop updated successfully! AI has recalculated the maturity date.', 'success');
        }

        function deleteCrop(id) {
            if (confirm('Are you sure you want to delete this crop? This action cannot be undone.')) {
                crops = crops.filter(c => c.id !== id);
                
                // Save to localStorage
                saveCropsToStorage();
                
                loadCrops();
                updateStatistics();
                showAlert('Crop deleted successfully!', 'success');
            }
        }

        function addYield(id) {
            const yieldAmount = prompt('Enter yield amount (kg):');
            if (yieldAmount && !isNaN(yieldAmount)) {
                const cropIndex = crops.findIndex(c => c.id === id);
                if (cropIndex !== -1) {
                    crops[cropIndex].yield += parseFloat(yieldAmount);
                    
                    // Save to localStorage
                    saveCropsToStorage();
                    
                    loadCrops();
                    updateStatistics();
                    showAlert(`Added ${yieldAmount} kg to yield!`, 'success');
                }
            }
        }

        async function getAICropAdvice(cropId) {
            try {
                const crop = crops.find(c => c.id === cropId);
                if (!crop) {
                    showAlert('Crop not found!', 'error');
                    return;
                }

                // Show loading message
                showAlert('Getting AI nutrition advice...', 'info');

                // Get AI recommendations
                const response = await fetch(window.SmartFarmConfig.getApiUrl(`/api/ai-advisory/crop-nutrition/${cropId}`));
                if (!response.ok) {
                    throw new Error('Failed to get AI recommendations');
                }

                const data = await response.json();
                const recommendations = data.data;

                // Show AI advice modal
                showAIAdviceModal(crop, recommendations);
            } catch (error) {
                console.error('Error getting AI crop advice:', error);
                showAlert('Failed to get AI advice. Please try again.', 'error');
            }
        }

        function showAIAdviceModal(crop, recommendations) {
            const modalHtml = `
                <div class="modal fade" id="aiAdviceModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-robot me-2"></i>AI Nutrition Advice for ${crop.name}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Crop Information</h6>
                                        <p><strong>Variety:</strong> ${crop.variety}</p>
                                        <p><strong>Growth Stage:</strong> ${recommendations.growthStage.replace('_', ' ').toUpperCase()}</p>
                                        <p><strong>Planting Date:</strong> ${formatDate(crop.plantingDate)}</p>
                                        <p><strong>Field Type:</strong> ${crop.field}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>AI Recommendations</h6>
                                        ${Object.entries(recommendations.recommendations).map(([type, details]) => `
                                            <div class="card mb-3">
                                                <div class="card-header">
                                                    <h6 class="mb-0">${type.toUpperCase()}</h6>
                                                </div>
                                                <div class="card-body">
                                                    <p><strong>Timing:</strong> ${details.timing}</p>
                                                    <p><strong>Amount:</strong> ${details.amount}</p>
                                                    <p><strong>Method:</strong> ${details.method}</p>
                                                    <p><strong>Conditions:</strong> ${details.conditions}</p>
                                                    <p><strong>Notes:</strong> ${details.notes}</p>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="applyAIRecommendations(${crop.id})">Apply Recommendations</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('aiAdviceModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add new modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('aiAdviceModal'));
            modal.show();
        }

        function applyAIRecommendations(cropId) {
            showAlert('AI recommendations applied! Consider scheduling fertilizer application.', 'success');
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('aiAdviceModal'));
            if (modal) {
                modal.hide();
            }
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const fieldFilter = document.getElementById('fieldFilter').value;
            
            let filteredCrops = crops;
            
            if (searchTerm) {
                filteredCrops = filteredCrops.filter(crop => 
                    crop.name.toLowerCase().includes(searchTerm) ||
                    crop.variety.toLowerCase().includes(searchTerm)
                );
            }
            
            if (statusFilter) {
                filteredCrops = filteredCrops.filter(crop => crop.status === statusFilter);
            }
            
            if (fieldFilter) {
                filteredCrops = filteredCrops.filter(crop => crop.field === fieldFilter);
            }
            
            // Update display with filtered crops
            const container = document.getElementById('cropsContainer');
            const noCropsMessage = document.getElementById('noCropsMessage');
            
            if (filteredCrops.length === 0) {
                container.innerHTML = '';
                noCropsMessage.style.display = 'block';
                return;
            }
            
            noCropsMessage.style.display = 'none';
            container.innerHTML = '';
            
            filteredCrops.forEach(crop => {
                const cropCard = createCropCard(crop);
                container.appendChild(cropCard);
            });
        }

        function showAlert(message, type) {
            // Create and show alert
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('statusFilter').addEventListener('change', applyFilters);
        document.getElementById('fieldFilter').addEventListener('change', applyFilters);
    </script>
    <script src="/js/catalog-picker.js"></script>
    <script src="/js/catalog-popovers.js"></script>
    <script>
        async function updateCropInsight(inputId, panelId) {
            const input = document.getElementById(inputId);
            const panel = document.getElementById(panelId);
            if (!input || !panel) return;

            const name = input.value.trim();
            if (!name) {
                panel.classList.add('d-none');
                panel.innerHTML = '';
                return;
            }

            try {
                const params = new URLSearchParams({ group: 'plants', q: name, limit: 1 });
                const response = await fetch(`/api/recommend?${params.toString()}`);
                if (!response.ok) throw new Error('Failed to fetch recommendations');
                const data = await response.json();
                const item = (data.results || [])[0];
                if (!item) return;

                const info = [];
                if (item.plan.estimatedYieldKg) info.push(`<div><strong>Projected Yield:</strong> ${item.plan.estimatedYieldKg.toLocaleString()} kg</div>`);
                if (item.plan.estimatedValueFJD) info.push(`<div><strong>Projected Value:</strong> FJD ${item.plan.estimatedValueFJD.toLocaleString()}</div>`);
                if (item.plan.timelineDays) info.push(`<div><strong>Growth Duration:</strong> ${item.plan.timelineDays} days</div>`);
                if (item.plan.inputs.fertilizerOrFeed) info.push(`<div><strong>Input Tip:</strong> ${item.plan.inputs.fertilizerOrFeed}</div>`);
                if (item.plan.warnings && item.plan.warnings.length) info.push(`<div><strong>Risks:</strong> ${item.plan.warnings.slice(0,2).join(', ')}</div>`);

                if (!info.length) {
                    panel.classList.add('d-none');
                    panel.innerHTML = '';
                    return;
                }

                panel.innerHTML = info.join('');
                panel.classList.remove('d-none');
            } catch (error) {
                console.error('Failed to load crop insight:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const cropInput = document.getElementById('cropName');
            const editCropInput = document.getElementById('editCropName');

            if (cropInput) {
                cropInput.addEventListener('change', () => updateCropInsight('cropName', 'cropNameInsights'));
                cropInput.addEventListener('blur', () => updateCropInsight('cropName', 'cropNameInsights'));
            }

            if (editCropInput) {
                editCropInput.addEventListener('change', () => updateCropInsight('editCropName', 'editCropNameInsights'));
                editCropInput.addEventListener('blur', () => updateCropInsight('editCropName', 'editCropNameInsights'));
            }
        });
    </script>
</body>
</html>
