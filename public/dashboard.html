<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Permissions-Policy" content="geolocation=(self)">
    <title>Farm Dashboard - SmartFarm</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="images/favicon/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="64x64" href="images/favicon/favicon-64x64.png">
    <link rel="apple-touch-icon" sizes="180x180" href="images/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="images/favicon/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="images/favicon/android-chrome-512x512.png">
    <link rel="manifest" href="images/favicon/site.webmanifest">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        // Aggressive error suppression - must run before any other scripts
        (function() {
            const originalConsoleError = console.error;
            const suppressedPatterns = [
                // SVG and framework errors
                /Error: <svg> attribute viewBox/,
                /Expected number.*viewBox/,
                /viewBox.*\d+%/,
                /framework-.*\.js.*Error/,
                // CORS errors
                /CORS.*blocked/,
                /Cross-Origin.*blocked/,
                /Access-Control-Allow-Origin/,
                /CORS requesting origin/,
                // Network errors
                /Failed to fetch/,
                /NetworkError/,
                /ERR_FAILED/,
                /ERR_CONNECTION_REFUSED/,
                // API errors
                /502.*Bad Gateway/,
                /Application failed to respond/,
                /Server temporarily unavailable/,
                // QR Code errors
                /All QR Code library sources failed/,
                /QR Code library sources failed/,
                /QR system with fallback/,
                /Traceability viewer ready/,
                // ErrorBoundary duplicate declaration (not used in dashboard)
                /Identifier 'ErrorBoundary' has already been declared/,
                /ErrorBoundary.*already been declared/,
                // Preload warnings
                /Resource was preloaded but not used/,
                /preloaded but not used/,
                // Generic errors to reduce noise
                /ResizeObserver.*loop/,
                /Script error/,
                /Non-Error promise rejection/,
                // Dashboard-specific errors
                /Cannot read property.*of null/,
                /Cannot read property.*of undefined/,
                /Cannot set property.*of null/,
                /Cannot set property.*of undefined/,
                /Element not found/,
                /Failed to execute.*on.*null/,
                // API timeout errors
                /Request timeout/,
                /Connection timeout/,
                /Network request failed/
            ];
            
            console.error = function(...args) {
                const message = args.join(' ');
                if (suppressedPatterns.some(pattern => pattern.test(message))) {
                    return; // Suppress known non-critical errors
                }
                originalConsoleError.apply(console, args);
            };
        })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- QR Code Library - Hosted locally for reliability -->
    <script src="js/qrcode.min.js"></script>
    <script>
        // Verify QR Code library loaded successfully
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof QRCode !== 'undefined') {
                console.log('‚úÖ QR Code library loaded successfully from local file');
            } else {
                console.error('‚ùå QR Code library failed to load from local file');
                // Show user-friendly error
                setTimeout(() => {
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'alert alert-warning alert-dismissible fade show';
                    errorMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                    errorMsg.innerHTML = `
                        <strong>‚ö†Ô∏è QR Code Library Missing</strong><br>
                        The QR code library file (js/qrcode.min.js) is missing or not accessible.<br>
                        Please ensure the file exists in the /js/ directory.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(errorMsg);
                }, 1000);
            }
        });
    </script>
    <script src="js/aggressive-server-fix.js"></script>
    <script src="js/emergency-error-disable.js"></script>
    <script src="js/continuous-error-suppression.js"></script>
    <script src="js/server-connectivity-fix.js"></script>
    <script src="js/navigation-dropdown.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="js/currency-config.js"></script>
    <script src="js/currency-selector.js"></script>
    <script src="js/weather-service.js"></script>
    <script src="js/location-selector.js"></script>
    <script src="js/accessibility-helpers.js"></script>
    <script src="js/button-handlers.js"></script>
    <script src="js/user-roles.js"></script>
    <script src="js/log.js"></script>
    <script src="js/error-boundary.js"></script>
    <script src="js/api-url-fix.js"></script>
    <script src="js/api-config.js"></script>
    <script src="js/api-service.js"></script>
    <script>
        // Ensure API service is properly initialized
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof window.SmartFarmAPI === 'undefined') {
                console.warn('‚ö†Ô∏è SmartFarmAPI not initialized, retrying...');
                // Retry initialization after a short delay
                setTimeout(() => {
                    if (typeof window.SmartFarmAPI === 'undefined') {
                        console.error('‚ùå SmartFarmAPI failed to initialize');
                        // Create a fallback API service
                        window.SmartFarmAPI = {
                            isBackendAvailable: () => false,
                            getFarms: () => Promise.resolve({ success: false, error: 'API not available' }),
                            getCrops: () => Promise.resolve({ success: false, error: 'API not available' }),
                            getLivestock: () => Promise.resolve({ success: false, error: 'API not available' })
                        };
                    } else {
                        console.log('‚úÖ SmartFarmAPI initialized successfully');
                    }
                }, 1000);
            } else {
                console.log('‚úÖ SmartFarmAPI initialized successfully');
            }
        });
    </script>
    <script src="js/performance-optimizer.js"></script>
    <script src="js/accessibility-enhancer.js"></script>
    <script src="js/modal-accessibility.js"></script>
    <script src="js/ai-seed-predictor.js"></script>
    <script src="js/intelligent-weeding.js"></script>
    <script src="js/competitive-features.js"></script>
    <script src="js/identification-diagnosis.js"></script>
    <script src="js/supply-chain-tracker.js"></script>
    <script src="js/error-reducer.js"></script>
    <script src="js/offline-mode.js"></script>
    <script src="js/ui-hardening.js"></script>
    <style>
        :root {
            --primary-color: #2e7d32;
            --secondary-color: #4caf50;
            --accent-color: #8bc34a;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --info-color: #2196f3;
            --dark-color: #424242;
            --light-color: #f5f5f5;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            min-height: 100vh;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            border-radius: 8px;
            margin: 5px 0;
            transition: all 0.3s ease;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .sidebar .nav-link.active {
            background: rgba(255, 255, 255, 0.3);
            border-left: 3px solid #fff;
            font-weight: 600;
        }

        /* Smooth view transitions */
        .main-content > div {
            transition: opacity 0.3s ease-in-out;
        }

        .main-content > div[style*="display: none"] {
            opacity: 0;
        }

        .main-content > div[style*="display: block"] {
            opacity: 1;
        }

        /* Page Header Styles */
        .page-header {
            background: linear-gradient(135deg, #2e7d32, #4caf50);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .page-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 0.5rem 0 0 0;
        }

        /* Statistics Cards */
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            height: 100%;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            color: white;
            font-size: 1.5rem;
        }

        .stat-content {
            flex: 1;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            color: #333;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Filter Section */
        .filter-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .search-box {
            position: relative;
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .search-box input {
            padding-left: 40px;
        }

        /* Crop Cards */
        .crops-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .crop-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid #f0f0f0;
        }

        .crop-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .crop-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .crop-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
            color: #333;
        }

        .crop-variety {
            font-size: 0.9rem;
            color: #666;
            margin: 0.25rem 0 0 0;
        }

        .crop-details {
            margin-bottom: 1rem;
        }

        .detail-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #555;
        }

        .detail-row i {
            width: 16px;
            margin-right: 0.5rem;
            color: #4caf50;
        }

        .progress-section {
            margin-bottom: 1rem;
        }

        .progress-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .progress {
            height: 8px;
            border-radius: 4px;
            background: #f0f0f0;
            overflow: hidden;
        }

        .progress-bar {
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.8rem;
            color: #666;
            float: right;
            margin-top: 0.25rem;
        }

        .ai-prediction {
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }

        .ai-prediction i {
            margin-right: 0.5rem;
        }

        .crop-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .crop-actions .btn {
            flex: 1;
            min-width: 0;
        }

        /* Livestock Cards */
        .livestock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .livestock-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid #f0f0f0;
        }

        .livestock-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        /* Pets Cards */
        .pets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .pets-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid #f0f0f0;
        }

        .pets-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .livestock-header, .pets-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .livestock-name, .pets-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
            color: #333;
        }

        .livestock-breed, .pets-breed {
            font-size: 0.9rem;
            color: #666;
            margin: 0.25rem 0 0 0;
        }

        .status-badge-top {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.status-healthy {
            background: #4caf50;
        }

        .status-dot.status-pregnant {
            background: #ff9800;
        }

        .status-dot.status-sick {
            background: #f44336;
        }

        .livestock-details, .pets-details {
            margin-bottom: 1rem;
        }

        .livestock-actions, .pets-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .livestock-actions .btn, .pets-actions .btn {
            flex: 1;
            min-width: 0;
        }

        /* Status Badges */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.status-growing {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status-badge.status-flowering {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-badge.status-harvesting {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .status-badge.status-healthy {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status-badge.status-pregnant {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-badge.status-sick {
            background: #ffebee;
            color: #c62828;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .page-header {
                padding: 1.5rem;
            }

            .page-title {
                font-size: 2rem;
            }

            .crops-grid,
            .livestock-grid,
            .pets-grid {
                grid-template-columns: 1fr;
            }

            .crop-actions,
            .livestock-actions,
            .pets-actions {
                flex-direction: column;
            }

            .stat-card {
                flex-direction: column;
                text-align: center;
            }

            .stat-icon {
                margin-right: 0;
                margin-bottom: 1rem;
            }
        }

        .main-content {
            padding: 20px;
        }

        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            margin-bottom: 20px;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .btn-custom {
            background: var(--accent-color);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .btn-custom:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .table-custom {
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }

        .table-custom th {
            background: var(--light-color);
            border: none;
            font-weight: 600;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-active { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-warning { background: #f8d7da; color: #721c24; }
        .status-growing { background: #d4edda; color: #155724; }
        .status-ready { background: #d1ecf1; color: #0c5460; }
        .status-harvested { background: #f8d7da; color: #721c24; }
        .status-healthy { background: #d4edda; color: #155724; }
        .status-sick { background: #f8d7da; color: #721c24; }
        .status-quarantine { background: #fff3cd; color: #856404; }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        /* Competitive Features Styles */
        .weather-current {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .weather-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .weather-temp {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .weather-desc {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .weather-details {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .weather-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .weather-item i {
            color: #007bff;
            width: 16px;
        }

        .weather-alerts {
            margin-top: 10px;
        }

        .weather-alert {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .clickable-alert {
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .clickable-alert:hover {
            transform: translateX(5px);
            border-left-color: #ffc107;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Weeding Task Cards */
        .weeding-task-card {
            transition: all 0.3s ease;
            border-left: 4px solid;
        }

        .weeding-task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .task-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .metric-item {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            padding: 4px 0;
        }

        .metric-item i {
            width: 16px;
            margin-right: 8px;
        }

        .task-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .task-actions .btn {
            flex: 1;
            min-width: 80px;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .financial-metrics {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 500;
        }

        .metric-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #212529;
        }

        .metric-value.profit {
            color: #28a745;
        }

        .metric-value.profit.negative {
            color: #dc3545;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .analytics-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .analytics-icon {
            font-size: 2rem;
            width: 50px;
            text-align: center;
        }

        .analytics-content {
            flex: 1;
        }

        .analytics-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .analytics-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #212529;
            margin-bottom: 3px;
        }

        .analytics-trend {
            font-size: 0.75rem;
            font-weight: 500;
        }

        .trend-up {
            color: #28a745;
        }

        .trend-down {
            color: #dc3545;
        }

        .trend-stable {
            color: #6c757d;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .pesticide-stats {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .stat-icon {
            font-size: 1.5rem;
            width: 40px;
            text-align: center;
        }

        .stat-content {
            flex: 1;
        }

        .stat-number {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 2px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-item i {
            width: 20px;
            text-align: center;
        }

        .activity-item span {
            flex: 1;
            font-size: 0.9rem;
        }

        .activity-item small {
            color: #6c757d;
        }

        /* Identification & Diagnosis Styles */
        .identification-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            height: 100%;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .identification-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .identification-card .card-icon {
            margin-bottom: 20px;
        }

        .identification-card .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .identification-card .card-text {
            color: #6c757d;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        /* Analysis Results Styles */
        .analysis-result {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
        }

        .treatment-section, .prevention-section {
            margin: 20px 0;
        }

        .treatment-list, .prevention-list {
            padding-left: 20px;
        }

        .treatment-list li, .prevention-list li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .disease-list, .health-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .disease-item, .health-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .disease-item strong, .health-item strong {
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .disease-item p, .health-item p {
            color: #6c757d;
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .prevention-tips {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }

        .tip-item {
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
        }

        .tip-item:last-child {
            border-bottom: none;
        }

        .navbar-custom {
            background: white !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -250px;
                top: 0;
                width: 250px;
                z-index: 1000;
                transition: left 0.3s ease;
            }

            .sidebar.show {
                left: 0;
            }

            .main-content {
                margin-left: 0;
            }
        }

        /* Identification & Diagnosis Center Styles */
        .identification-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            height: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .identification-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #28a745;
        }

        .card-icon {
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .card-text {
            color: #666;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .analysis-result {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }

        .analysis-result h6 {
            color: #333;
            margin-bottom: 10px;
        }

        .analysis-result ul {
            margin-bottom: 0;
        }

        .analysis-result li {
            margin-bottom: 5px;
        }

        /* Ads Styles */
        .sidebar-ads {
            padding: 15px;
            margin-top: 20px;
        }

        .sidebar-ads .ad-placeholder {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            margin-bottom: 15px;
        }

        .sidebar-ads .affiliate-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: transform 0.2s ease;
        }

        .sidebar-ads .affiliate-card:hover {
            transform: translateY(-2px);
        }

        .sidebar-ads .affiliate-card img {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }

        .sidebar-ads .affiliate-card .card-content {
            padding: 10px;
            color: #333;
        }

        .sidebar-ads .affiliate-card .card-title {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .sidebar-ads .affiliate-card .card-price {
            font-size: 11px;
            color: #28a745;
            font-weight: 600;
        }

        /* Status Indicator */
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ffc107;
            animation: pulse 2s infinite;
        }

        .status-indicator.online {
            background: #28a745;
        }

        .status-indicator.offline {
            background: #dc3545;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .content-ad {
            margin: 20px 0;
            text-align: center;
        }

        .content-ad .ad-placeholder {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            color: #6c757d;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light navbar-custom">
        <div class="container-fluid">
            <button class="btn btn-outline-primary d-lg-none me-3" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
            <a class="navbar-brand" href="#">
                <img src="images/logo/logo.png" alt="SmartFarm Logo" style="height: 30px; width: auto; margin-right: 8px;">SmartFarm Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <button class="btn btn-outline-info me-3" onclick="locationSelector.show()" title="Change Location">
                    <i class="fas fa-map-marker-alt me-2"></i>
                    <span id="currentLocationDisplay">Loading...</span>
                </button>
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
                        <div class="user-avatar me-2" id="userAvatar">F</div>
                        <span id="userName">Farmer</span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="editProfile()"><i class="fas fa-user me-2"></i>Profile</a></li>
                        <li><a class="dropdown-item" href="#" onclick="showSettings()"><i class="fas fa-cog me-2"></i>Settings</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                    </ul>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-lightbulb me-2"></i>SmartFarm Insights</span>
                            <button class="btn btn-sm btn-light" onclick="refreshSmartFarmInsights()">
                                <i class="fas fa-sync-alt me-1"></i>Refresh
                            </button>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-3">Personalized recommendations based on your farm profile and current goals.</p>
                            <div id="smartFarmInsights" class="row gy-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-lg-2 col-md-3 sidebar" id="sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" onclick="showDashboard()">
                                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showFarmManagement()">
                                <i class="fas fa-tractor me-2"></i>Farm Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showCropManagement(); return false;">
                                <i class="fas fa-seedling me-2"></i>Crop Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="watering-management.html">
                                <i class="fas fa-tint me-2"></i>Watering Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="farm-locator.html">
                                <i class="fas fa-map-marker-alt me-2"></i>Farm Locator
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="geofencing-setup.html">
                                <i class="fas fa-map-marked-alt me-2"></i>Geofencing Setup
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="ai-advisory.html">
                                <i class="fas fa-robot me-2"></i>AI Advisory
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="farm-to-table.html">
                                <i class="fas fa-store me-2"></i>Farm to Table
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="subscription-management.html">
                                <i class="fas fa-credit-card me-2"></i>Subscription
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showLivestockManagement(); return false;">
                                <i class="fas fa-cow me-2"></i>Livestock
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showPetsManagement(); return false;">
                                <i class="fas fa-paw me-2"></i>Pets
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showInventoryManagement(); return false;">
                                <i class="fas fa-boxes me-2"></i>Inventory
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showAnalytics(); return false;">
                                <i class="fas fa-chart-line me-2"></i>Analytics
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showTasks()">
                                <i class="fas fa-tasks me-2"></i>Tasks
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showReports()">
                                <i class="fas fa-file-alt me-2"></i>Reports
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="user-management.html">
                                <i class="fas fa-users-cog me-2"></i>User Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="ai-predictions.html">
                                <i class="fas fa-brain me-2"></i>AI Predictions
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="weeding-management.html">
                                <i class="fas fa-seedling me-2"></i>Weeding
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="pesticide-management.html">
                                <i class="fas fa-bug me-2"></i>Pesticides
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="supply-chain.html">
                                <i class="fas fa-truck me-2"></i>Supply Chain
                            </a>
                        </li>
                        <li class="nav-item debug-features">
                            <a class="nav-link" href="ads-testing.html">
                                <i class="fas fa-bug me-2"></i>Ads Testing
                                <span class="role-badge badge bg-warning text-dark">Owner Only</span>
                            </a>
                        </li>
                        <li class="nav-item analytics-features">
                            <a class="nav-link" href="ads-analytics.html">
                                <i class="fas fa-chart-line me-2"></i>Ads Analytics
                                <span class="role-badge badge bg-danger">Admin+</span>
                            </a>
                        </li>
                        <li class="nav-item debug-features">
                            <a class="nav-link" href="button-debugger.html">
                                <i class="fas fa-bug me-2"></i>Button Debugger
                                <span class="role-badge badge bg-warning text-dark">Owner Only</span>
                            </a>
                        </li>
                        <li class="nav-item debug-features">
                            <a class="nav-link" href="role-management.html">
                                <i class="fas fa-shield-alt me-2"></i>Role Management
                                <span class="role-badge badge bg-warning text-dark">Owner Only</span>
                            </a>
                        </li>
                    </ul>
                    
                    <!-- Quick Actions -->
                    <div class="mt-4">
                        <h6 class="text-white-50 mb-3">Quick Actions</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-light btn-sm" onclick="addNewCrop()">
                                <i class="fas fa-plus me-1"></i>Add Crop
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="addNewLivestock()">
                                <i class="fas fa-plus me-1"></i>Add Livestock
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="showDashboardFeedMixCalculator()">
                                <i class="fas fa-calculator me-1"></i>Feed Mix
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="createTask()">
                                <i class="fas fa-plus me-1"></i>Create Task
                            </button>
                        </div>
                    </div>
                    
                    <!-- System Status -->
                    <div class="mt-4">
                        <div class="card bg-transparent border-light">
                            <div class="card-body p-2">
                                <small class="text-white-50">System Status</small>
                                <div class="d-flex align-items-center">
                                    <div class="status-indicator me-2" id="systemStatus"></div>
                                    <small class="text-white" id="statusText">Checking...</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ads Section -->
                    <div class="sidebar-ads mt-4" id="sidebarAds">
                        <!-- Ads will be inserted here by JavaScript -->
                    </div>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-lg-10 col-md-9 main-content" id="mainContent">
                <!-- Dashboard Overview -->
                <div id="dashboardView">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Farm Dashboard</h2>
                        <div>
                            <span class="badge bg-success me-2">Online</span>
                            <small class="text-muted">Last updated: <span id="lastUpdated"></span></small>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="row">
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card">
                                <div class="stat-number" id="totalCrops">12</div>
                                <div>Active Crops</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card">
                                <div class="stat-number" id="totalLivestock">45</div>
                                <div>Livestock</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card">
                                <div class="stat-number" id="totalFields">8</div>
                                <div>Fields</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card">
                                <div class="stat-number" id="monthlyYield">2.5</div>
                                <div>Monthly Yield (tons)</div>
                            </div>
                        </div>
                    </div>

                    <!-- Competitive Features Row -->
                    <div class="row">
                        <div class="col-lg-4">
                            <div class="dashboard-card">
                                <h5 class="mb-3">üå§Ô∏è Weather & Alerts</h5>
                                <div id="weatherWidget">
                                    <div class="weather-current">
                                        <div class="weather-icon">üå§Ô∏è</div>
                                        <div class="weather-temp">Loading...</div>
                                        <div class="weather-desc">Fetching weather data...</div>
                                    </div>
                                    <div class="weather-details">
                                        <div class="weather-item">
                                            <i class="fas fa-tint"></i>
                                            <span>Humidity: <span id="humidity">--</span>%</span>
                                        </div>
                                        <div class="weather-item">
                                            <i class="fas fa-wind"></i>
                                            <span>Wind: <span id="windSpeed">--</span> km/h</span>
                                        </div>
                                        <div class="weather-item">
                                            <i class="fas fa-cloud-rain"></i>
                                            <span>Rain: <span id="rainfall">--</span>mm</span>
                                        </div>
                                    </div>
                                    <div class="weather-alerts" id="weatherAlerts">
                                        <!-- Weather alerts will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="dashboard-card">
                                <h5 class="mb-3">üí∞ Financial Overview</h5>
                                <div class="financial-metrics">
                                    <div class="metric-row">
                                        <div class="metric-label">Monthly Revenue</div>
                                        <div class="metric-value" id="monthlyRevenue">$0</div>
                                    </div>
                                    <div class="metric-row">
                                        <div class="metric-label">Monthly Costs</div>
                                        <div class="metric-value" id="monthlyCosts">$0</div>
                                    </div>
                                    <div class="metric-row">
                                        <div class="metric-label">Net Profit</div>
                                        <div class="metric-value profit" id="netProfit">$0</div>
                                    </div>
                                    <div class="metric-row">
                                        <div class="metric-label">ROI This Month</div>
                                        <div class="metric-value" id="monthlyROI">0%</div>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="showFinancialDetails()">
                                    <i class="fas fa-chart-line me-1"></i>View Details
                                </button>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="dashboard-card">
                                <h5 class="mb-3">üîó QR Code Traceability Generator</h5>
                                <div class="qr-generator-container">
                                    <div class="mb-3">
                                        <label for="productSelect" class="form-label">Select Product</label>
                                        <select class="form-select" id="productSelect">
                                            <option value="">Choose a product...</option>
                                            <option value="PROD001">Organic Tomatoes (BATCH2024001)</option>
                                            <option value="PROD002">Fresh Lettuce (BATCH2024002)</option>
                                            <option value="PROD003">Organic Carrots (BATCH2024003)</option>
                                            <option value="PROD004">Free-Range Eggs (BATCH2024004)</option>
                                            <option value="PROD005">Organic Milk (BATCH2024005)</option>
                                        </select>
                                    </div>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary" onclick="generateQRCode()">
                                            <i class="fas fa-qrcode me-2"></i>Generate QR Code
                                        </button>
                                        <button class="btn btn-success" onclick="addNewProduct()">
                                            <i class="fas fa-plus me-2"></i>New Product
                                        </button>
                                        <button class="btn btn-info" onclick="showQRCodeOptions()">
                                            <i class="fas fa-cog me-2"></i>QR Options
                                        </button>
                                    </div>
                                    <div id="qrCodeDisplay" class="mt-3 text-center">
                                        <!-- QR code will be displayed here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Analytics Row -->
                    <div class="row mt-4">
                        <div class="col-lg-6">
                            <div class="dashboard-card">
                                <h5 class="mb-3">üìä Performance Analytics</h5>
                                <div class="analytics-grid">
                                    <div class="analytics-item">
                                        <div class="analytics-icon">üå±</div>
                                        <div class="analytics-content">
                                            <div class="analytics-label">Crop Yield Efficiency</div>
                                            <div class="analytics-value" id="cropEfficiency">0%</div>
                                            <div class="analytics-trend" id="cropTrend">--</div>
                                        </div>
                                    </div>
                                    <div class="analytics-item">
                                        <div class="analytics-icon">üêÑ</div>
                                        <div class="analytics-content">
                                            <div class="analytics-label">Livestock Health Score</div>
                                            <div class="analytics-value" id="livestockHealth">0%</div>
                                            <div class="analytics-trend" id="livestockTrend">--</div>
                                        </div>
                                    </div>
                                    <div class="analytics-item">
                                        <div class="analytics-icon">üåç</div>
                                        <div class="analytics-content">
                                            <div class="analytics-label">Sustainability Score</div>
                                            <div class="analytics-value" id="sustainabilityScore">0%</div>
                                            <div class="analytics-trend" id="sustainabilityTrend">--</div>
                                        </div>
                                    </div>
                                    <div class="analytics-item">
                                        <div class="analytics-icon">üí∞</div>
                                        <div class="analytics-content">
                                            <div class="analytics-label">Cost Efficiency</div>
                                            <div class="analytics-value" id="costEfficiency">0%</div>
                                            <div class="analytics-trend" id="costTrend">--</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="dashboard-card">
                                <h5 class="mb-3">üìà Recent Activity</h5>
                                <div class="activity-list">
                                    <div class="activity-item">
                                        <i class="fas fa-plus-circle text-success"></i>
                                        <span>Added new crop: Tomatoes</span>
                                        <small class="text-muted">2 hours ago</small>
                                    </div>
                                    <div class="activity-item">
                                        <i class="fas fa-edit text-primary"></i>
                                        <span>Updated livestock records</span>
                                        <small class="text-muted">1 day ago</small>
                                    </div>
                                    <div class="activity-item">
                                        <i class="fas fa-chart-line text-info"></i>
                                        <span>Generated monthly report</span>
                                        <small class="text-muted">3 days ago</small>
                                    </div>
                                    <div class="activity-item">
                                        <i class="fas fa-cloud-rain text-warning"></i>
                                        <span>Weather alert: Heavy rain expected</span>
                                        <small class="text-muted">4 hours ago</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="row mt-4">
                        <div class="col-lg-8">
                            <div class="dashboard-card">
                                <h5 class="mb-3">Crop Yield Trend</h5>
                                <div class="chart-container">
                                    <canvas id="yieldChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="dashboard-card">
                                <h5 class="mb-3">Field Status</h5>
                                <div class="chart-container">
                                    <canvas id="fieldStatusChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Identification & Diagnosis Center -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="dashboard-card">
                                <h5 class="mb-3">
                                    <i class="fas fa-microscope me-2"></i>üîç Identification & Diagnosis Center
                                </h5>
                                <p class="text-muted mb-4">Get professional help identifying crop diseases, pest issues, and livestock health problems</p>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="identification-card">
                                            <div class="card-icon">
                                                <i class="fas fa-seedling fa-3x text-success"></i>
                                            </div>
                                            <h6 class="card-title">Crop Identification</h6>
                                            <p class="card-text">Identify crop diseases, pests, and nutrient deficiencies with AI-powered analysis</p>
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-success" onclick="startCropIdentification()">
                                                    <i class="fas fa-search me-2"></i>Identify Crop Issues
                                                </button>
                                                <button class="btn btn-outline-success" onclick="showCropDiseaseGuide()">
                                                    <i class="fas fa-book me-2"></i>Disease Guide
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="identification-card">
                                            <div class="card-icon">
                                                <i class="fas fa-cow fa-3x text-info"></i>
                                            </div>
                                            <h6 class="card-title">Livestock Diagnosis</h6>
                                            <p class="card-text">Diagnose livestock health issues and get treatment recommendations from experts</p>
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-info" onclick="startLivestockDiagnosis()">
                                                    <i class="fas fa-stethoscope me-2"></i>Diagnose Livestock
                                                </button>
                                                <button class="btn btn-outline-info" onclick="showLivestockHealthGuide()">
                                                    <i class="fas fa-heartbeat me-2"></i>Health Guide
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activities -->
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="dashboard-card">
                                <h5 class="mb-3">Recent Activities</h5>
                                <div class="activity-list" id="recentActivities">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="bg-success rounded-circle p-2 me-3">
                                            <i class="fas fa-seedling text-white"></i>
                                        </div>
                                        <div>
                                            <div class="fw-bold">New crop planted</div>
                                            <small class="text-muted">Tomatoes in Field A - 2 hours ago</small>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="bg-info rounded-circle p-2 me-3">
                                            <i class="fas fa-tint text-white"></i>
                                        </div>
                                        <div>
                                            <div class="fw-bold">Irrigation completed</div>
                                            <small class="text-muted">Field B irrigation - 4 hours ago</small>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="bg-warning rounded-circle p-2 me-3">
                                            <i class="fas fa-exclamation-triangle text-white"></i>
                                        </div>
                                        <div>
                                            <div class="fw-bold">Soil moisture alert</div>
                                            <small class="text-muted">Field C needs attention - 6 hours ago</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="dashboard-card">
                                <h5 class="mb-3">Upcoming Tasks</h5>
                                <div class="task-list" id="upcomingTasks">
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
                                        <div>
                                            <div class="fw-bold">Harvest Field A</div>
                                            <small class="text-muted">Due: Tomorrow</small>
                                        </div>
                                        <span class="status-badge status-pending">Pending</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
                                        <div>
                                            <div class="fw-bold">Fertilize Field B</div>
                                            <small class="text-muted">Due: 3 days</small>
                                        </div>
                                        <span class="status-badge status-active">Scheduled</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
                                        <div>
                                            <div class="fw-bold">Check irrigation system</div>
                                            <small class="text-muted">Due: 5 days</small>
                                        </div>
                                        <span class="status-badge status-warning">Overdue</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Other Views (initially hidden) -->
                <div id="farmManagementView" style="display: none;">
                    <h2>Farm Management</h2>
                    <div class="dashboard-card">
                        <h5>Farm Information</h5>
                        <form id="farmForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Farm Name</label>
                                        <input type="text" class="form-control" id="farmName" value="Green Valley Farm">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Location</label>
                                        <input type="text" class="form-control" id="farmLocation" value="Sydney, Australia">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Total Area (hectares)</label>
                                        <input type="number" class="form-control" id="farmArea" value="25.5">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Farm Type</label>
                                        <select class="form-select" id="farmType">
                                            <option value="mixed">Mixed Farming</option>
                                            <option value="crops">Crop Farming</option>
                                            <option value="livestock">Livestock Farming</option>
                                            <option value="dairy">Dairy Farming</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-custom" onclick="saveFarmData()">
                                <i class="fas fa-save me-2"></i>Save Changes
                            </button>
                        </form>
                    </div>
                </div>

                <div id="cropManagementView" style="display: none;">
                    <!-- Page Header -->
                    <div class="page-header mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h1 class="page-title">Crop Management</h1>
                                <p class="page-subtitle">Manage your crops, track growth, and optimize yields</p>
                            </div>
                            <button class="btn btn-custom btn-lg" onclick="addNewCrop()">
                                <i class="fas fa-plus me-2"></i>Add New Crop
                            </button>
                        </div>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="row mb-4">
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon bg-primary">
                                    <i class="fas fa-seedling"></i>
                                </div>
                                <div class="stat-content">
                                    <h3 class="stat-number" id="cropManagementTotalCrops">0</h3>
                                    <p class="stat-label">Total Crops</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon bg-info">
                                    <i class="fas fa-tractor"></i>
                                </div>
                                <div class="stat-content">
                                    <h3 class="stat-number" id="farm-count">0</h3>
                                    <p class="stat-label">Total Farms</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon bg-success">
                                    <i class="fas fa-leaf"></i>
                                </div>
                                <div class="stat-content">
                                    <h3 class="stat-number" id="activeCrops">0</h3>
                                    <p class="stat-label">Active Crops</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon bg-warning">
                                    <i class="fas fa-harvest"></i>
                                </div>
                                <div class="stat-content">
                                    <h3 class="stat-number" id="readyForHarvest">0</h3>
                                    <p class="stat-label">Ready for Harvest</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon bg-info">
                                    <i class="fas fa-weight"></i>
                                </div>
                                <div class="stat-content">
                                    <h3 class="stat-number" id="totalYield">0</h3>
                                    <p class="stat-label">Total Yield (kg)</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filter and Search -->
                    <div class="filter-section mb-4">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="cropSearch" placeholder="Search crops..." class="form-control" aria-label="Search crops">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="cropStatusFilter">
                                    <option value="">All Status</option>
                                    <option value="planted">Planted</option>
                                    <option value="growing">Growing</option>
                                    <option value="flowering">Flowering</option>
                                    <option value="harvesting">Harvesting</option>
                                    <option value="harvested">Harvested</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="fieldFilter">
                                    <option value="">All Fields</option>
                                    <option value="Field A">Field A</option>
                                    <option value="Field B">Field B</option>
                                    <option value="Greenhouse 1">Greenhouse 1</option>
                                    <option value="Medicinal Garden">Medicinal Garden</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-primary w-100" onclick="filterCrops()">
                                    <i class="fas fa-filter me-1"></i>Filter
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Crops Grid -->
                    <div class="crops-grid" id="cropsGrid">
                        <!-- Sample crop cards for demonstration -->
                        <div class="crop-card">
                            <div class="crop-header">
                                <div class="crop-info">
                                    <h5 class="crop-name">Tomatoes</h5>
                                    <p class="crop-variety">Cherry</p>
                                </div>
                                <span class="status-badge status-growing">Growing</span>
                            </div>
                            <div class="crop-details">
                                <div class="detail-row">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>Field: Field A</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-ruler"></i>
                                    <span>Area: 0.5 ha</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>Planted: 10/01/2025</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-weight"></i>
                                    <span>Yield: 0 kg</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-harvest"></i>
                                    <span>Harvest: 15/03/2025</span>
                                </div>
                            </div>
                            <div class="progress-section">
                                <div class="progress-label">Growth Progress</div>
                                <div class="progress">
                                    <div class="progress-bar bg-success" style="width: 100%"></div>
                                </div>
                                <span class="progress-text">100%</span>
                            </div>
                            <div class="ai-prediction">
                                <i class="fas fa-robot"></i>
                                <span>AI Predicted Maturity: 20/03/2025</span>
                            </div>
                            <div class="crop-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="editCrop(1)">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-success" onclick="addYield(1)">
                                    <i class="fas fa-plus"></i> Add Yield
                                </button>
                                <button class="btn btn-sm btn-info" onclick="viewCropDetails(1)">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteCrop(1)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <div class="crop-card">
                            <div class="crop-header">
                                <div class="crop-info">
                                    <h5 class="crop-name">Capsicum</h5>
                                    <p class="crop-variety">California Wonder</p>
                                </div>
                                <span class="status-badge status-flowering">Flowering</span>
                            </div>
                            <div class="crop-details">
                                <div class="detail-row">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>Field: Field B</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-ruler"></i>
                                    <span>Area: 0.8 ha</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>Planted: 05/01/2025</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-weight"></i>
                                    <span>Yield: 0 kg</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-harvest"></i>
                                    <span>Harvest: 10/03/2025</span>
                                </div>
                            </div>
                            <div class="progress-section">
                                <div class="progress-label">Growth Progress</div>
                                <div class="progress">
                                    <div class="progress-bar bg-warning" style="width: 75%"></div>
                                </div>
                                <span class="progress-text">75%</span>
                            </div>
                            <div class="ai-prediction">
                                <i class="fas fa-robot"></i>
                                <span>AI Predicted Maturity: 15/03/2025</span>
                            </div>
                            <div class="crop-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="editCrop(2)">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-success" onclick="addYield(2)">
                                    <i class="fas fa-plus"></i> Add Yield
                                </button>
                                <button class="btn btn-sm btn-info" onclick="viewCropDetails(2)">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteCrop(2)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <div class="crop-card">
                            <div class="crop-header">
                                <div class="crop-info">
                                    <h5 class="crop-name">Lettuce</h5>
                                    <p class="crop-variety">Romaine</p>
                                </div>
                                <span class="status-badge status-harvesting">Harvesting</span>
                            </div>
                            <div class="crop-details">
                                <div class="detail-row">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>Field: Greenhouse 1</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-ruler"></i>
                                    <span>Area: 0.3 ha</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>Planted: 20/12/2024</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-weight"></i>
                                    <span>Yield: 45.5 kg</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-harvest"></i>
                                    <span>Harvest: 20/01/2025</span>
                                </div>
                            </div>
                            <div class="progress-section">
                                <div class="progress-label">Growth Progress</div>
                                <div class="progress">
                                    <div class="progress-bar bg-success" style="width: 100%"></div>
                                </div>
                                <span class="progress-text">100%</span>
                            </div>
                            <div class="ai-prediction">
                                <i class="fas fa-robot"></i>
                                <span>AI Predicted Maturity: 25/01/2025</span>
                            </div>
                            <div class="crop-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="editCrop(3)">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-success" onclick="addYield(3)">
                                    <i class="fas fa-plus"></i> Add Yield
                                </button>
                                <button class="btn btn-sm btn-info" onclick="viewCropDetails(3)">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteCrop(3)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <div class="crop-card">
                            <div class="crop-header">
                                <div class="crop-info">
                                    <h5 class="crop-name">Kava</h5>
                                    <p class="crop-variety">Noble Kava</p>
                                </div>
                                <span class="status-badge status-growing">Growing</span>
                            </div>
                            <div class="crop-details">
                                <div class="detail-row">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>Field: Medicinal Garden</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-ruler"></i>
                                    <span>Area: 0.2 ha</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>Planted: 15/01/2022</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-weight"></i>
                                    <span>Yield: 0 kg</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-harvest"></i>
                                    <span>Harvest: 15/01/2025</span>
                                </div>
                            </div>
                            <div class="progress-section">
                                <div class="progress-label">Growth Progress</div>
                                <div class="progress">
                                    <div class="progress-bar bg-success" style="width: 100%"></div>
                                </div>
                                <span class="progress-text">100%</span>
                            </div>
                            <div class="ai-prediction">
                                <i class="fas fa-robot"></i>
                                <span>AI Predicted Maturity: 15/01/2025</span>
                            </div>
                            <div class="crop-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="editCrop(4)">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-success" onclick="addYield(4)">
                                    <i class="fas fa-plus"></i> Add Yield
                                </button>
                                <button class="btn btn-sm btn-info" onclick="viewCropDetails(4)">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteCrop(4)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="livestockManagementView" style="display: none;">
                    <!-- Page Header -->
                    <div class="page-header mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h1 class="page-title">Livestock Management</h1>
                                <p class="page-subtitle">Manage your livestock, track health, and monitor breeding cycles</p>
                            </div>
                            <button class="btn btn-custom btn-lg" onclick="addNewLivestock()">
                                <i class="fas fa-plus me-2"></i>Add New Animal
                            </button>
                        </div>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="row mb-4">
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon bg-primary">
                                    <i class="fas fa-paw"></i>
                                </div>
                                <div class="stat-content">
                                    <h3 class="stat-number" id="totalAnimals">0</h3>
                                    <p class="stat-label">Total Animals</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon bg-info">
                                    <i class="fas fa-cow"></i>
                                </div>
                                <div class="stat-content">
                                    <h3 class="stat-number" id="livestock-count">0</h3>
                                    <p class="stat-label">Total Livestock</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon bg-success">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <div class="stat-content">
                                    <h3 class="stat-number" id="healthyAnimals">0</h3>
                                    <p class="stat-label">Healthy Animals</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon bg-warning">
                                    <i class="fas fa-baby"></i>
                                </div>
                                <div class="stat-content">
                                    <h3 class="stat-number" id="pregnantAnimals">0</h3>
                                    <p class="stat-label">Pregnant Animals</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon bg-info">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                                <div class="stat-content">
                                    <h3 class="stat-number" id="totalValue">0</h3>
                                    <p class="stat-label">Total Value (FJD)</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filter and Search -->
                    <div class="filter-section mb-4">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="livestockSearch" placeholder="Search animals..." class="form-control" aria-label="Search livestock">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="speciesFilter">
                                    <option value="">All Species</option>
                                    <option value="Cattle">Cattle</option>
                                    <option value="Pigs">Pigs</option>
                                    <option value="Chickens">Chickens</option>
                                    <option value="Sheep">Sheep</option>
                                    <option value="Goats">Goats</option>
                                    <option value="Horses">Horses</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="livestockStatusFilter">
                                    <option value="">All Status</option>
                                    <option value="HEALTHY">Healthy</option>
                                    <option value="SICK">Sick</option>
                                    <option value="PREGNANT">Pregnant</option>
                                    <option value="BREEDING">Breeding</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-primary w-100" onclick="filterLivestock()">
                                    <i class="fas fa-filter me-1"></i>Filter
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Livestock Grid -->
                    <div class="livestock-grid" id="livestockGrid">
                        <!-- Sample livestock cards for demonstration -->
                        <div class="livestock-card">
                            <div class="livestock-header">
                                <div class="livestock-info">
                                    <h5 class="livestock-name">Angus Bull #001</h5>
                                    <p class="livestock-breed">Angus Cattle</p>
                                </div>
                                <div class="status-badge-top">
                                    <span class="status-dot status-healthy"></span>
                                    <span class="status-badge status-healthy">Healthy</span>
                                </div>
                            </div>
                            <div class="livestock-details">
                                <div class="detail-row">
                                    <i class="fas fa-tag"></i>
                                    <span>Tag: AB001</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-venus-mars"></i>
                                    <span>Sex: Male</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>Birth: 15/03/2020</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-weight"></i>
                                    <span>Weight: 650 kg</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>Location: Pasture A</span>
                                </div>
                            </div>
                            <div class="livestock-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="editLivestock(1)">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-success" onclick="addHealthRecord(1)">
                                    <i class="fas fa-heartbeat"></i> Health
                                </button>
                                <button class="btn btn-sm btn-info" onclick="viewLivestockDetails(1)">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteLivestock(1)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <div class="livestock-card">
                            <div class="livestock-header">
                                <div class="livestock-info">
                                    <h5 class="livestock-name">Holstein Cow #002</h5>
                                    <p class="livestock-breed">Holstein Dairy</p>
                                </div>
                                <div class="status-badge-top">
                                    <span class="status-dot status-pregnant"></span>
                                    <span class="status-badge status-pregnant">Pregnant</span>
                                </div>
                            </div>
                            <div class="livestock-details">
                                <div class="detail-row">
                                    <i class="fas fa-tag"></i>
                                    <span>Tag: HC002</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-venus-mars"></i>
                                    <span>Sex: Female</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>Birth: 20/08/2019</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-weight"></i>
                                    <span>Weight: 580 kg</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>Location: Dairy Barn</span>
                                </div>
                            </div>
                            <div class="livestock-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="editLivestock(2)">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-success" onclick="addHealthRecord(2)">
                                    <i class="fas fa-heartbeat"></i> Health
                                </button>
                                <button class="btn btn-sm btn-info" onclick="viewLivestockDetails(2)">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteLivestock(2)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <div class="livestock-card">
                            <div class="livestock-header">
                                <div class="livestock-info">
                                    <h5 class="livestock-name">Yorkshire Pig #003</h5>
                                    <p class="livestock-breed">Yorkshire</p>
                                </div>
                                <div class="status-badge-top">
                                    <span class="status-dot status-healthy"></span>
                                    <span class="status-badge status-healthy">Healthy</span>
                                </div>
                            </div>
                            <div class="livestock-details">
                                <div class="detail-row">
                                    <i class="fas fa-tag"></i>
                                    <span>Tag: YP003</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-venus-mars"></i>
                                    <span>Sex: Female</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>Birth: 10/05/2021</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-weight"></i>
                                    <span>Weight: 180 kg</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>Location: Pig Pen B</span>
                                </div>
                            </div>
                            <div class="livestock-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="editLivestock(3)">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-success" onclick="addHealthRecord(3)">
                                    <i class="fas fa-heartbeat"></i> Health
                                </button>
                                <button class="btn btn-sm btn-info" onclick="viewLivestockDetails(3)">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteLivestock(3)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <div class="livestock-card">
                            <div class="livestock-header">
                                <div class="livestock-info">
                                    <h5 class="livestock-name">Rhode Island Red #004</h5>
                                    <p class="livestock-breed">Rhode Island Red</p>
                                </div>
                                <div class="status-badge-top">
                                    <span class="status-dot status-healthy"></span>
                                    <span class="status-badge status-healthy">Healthy</span>
                                </div>
                            </div>
                            <div class="livestock-details">
                                <div class="detail-row">
                                    <i class="fas fa-tag"></i>
                                    <span>Tag: RIR004</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-venus-mars"></i>
                                    <span>Sex: Female</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>Birth: 01/03/2022</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-weight"></i>
                                    <span>Weight: 2.5 kg</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>Location: Chicken Coop</span>
                                </div>
                            </div>
                            <div class="livestock-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="editLivestock(4)">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-success" onclick="addHealthRecord(4)">
                                    <i class="fas fa-heartbeat"></i> Health
                                </button>
                                <button class="btn btn-sm btn-info" onclick="viewLivestockDetails(4)">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteLivestock(4)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="petsManagementView" style="display: none;">
                    <!-- Page Header -->
                    <div class="page-header mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h1 class="page-title">Pets Management</h1>
                                <p class="page-subtitle">Manage your pets, track health, and monitor veterinary care</p>
                            </div>
                            <div>
                                <button class="btn btn-outline-success me-2" onclick="showGlobalPetsDatabase()">
                                    <i class="fas fa-globe me-2"></i>Global Database
                                </button>
                                <button class="btn btn-custom btn-lg" onclick="addNewPet()">
                                    <i class="fas fa-plus me-2"></i>Add New Pet
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="row mb-4">
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon bg-primary">
                                    <i class="fas fa-paw"></i>
                                </div>
                                <div class="stat-content">
                                    <h3 class="stat-number" id="totalPets">0</h3>
                                    <p class="stat-label">Total Pets</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon bg-success">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <div class="stat-content">
                                    <h3 class="stat-number" id="healthyPets">0</h3>
                                    <p class="stat-label">Healthy Pets</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon bg-info">
                                    <i class="fas fa-syringe"></i>
                                </div>
                                <div class="stat-content">
                                    <h3 class="stat-number" id="vaccinatedPets">0</h3>
                                    <p class="stat-label">Vaccinated Pets</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon bg-warning">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                                <div class="stat-content">
                                    <h3 class="stat-number" id="totalPetsValue">0</h3>
                                    <p class="stat-label">Total Value (FJD)</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filter and Search -->
                    <div class="filter-section mb-4">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="petsSearch" placeholder="Search pets..." class="form-control" aria-label="Search pets">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="petsSpeciesFilter">
                                    <option value="">All Species</option>
                                    <option value="Dog">Dog</option>
                                    <option value="Cat">Cat</option>
                                    <option value="Bird">Bird</option>
                                    <option value="Fish">Fish</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="petsStatusFilter">
                                    <option value="">All Status</option>
                                    <option value="Healthy">Healthy</option>
                                    <option value="Sick">Sick</option>
                                    <option value="Recovering">Recovering</option>
                                    <option value="Under Treatment">Under Treatment</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-primary w-100" onclick="filterPets()">
                                    <i class="fas fa-filter me-1"></i>Filter
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Pets Grid -->
                    <div class="pets-grid" id="petsGrid">
                        <!-- Sample pets cards for demonstration -->
                        <div class="pets-card">
                            <div class="pets-header">
                                <div class="pets-info">
                                    <h5 class="pets-name">Buddy</h5>
                                    <p class="pets-breed">Golden Retriever</p>
                                </div>
                                <div class="status-badge-top">
                                    <span class="status-dot status-healthy"></span>
                                    <span class="status-badge status-healthy">Healthy</span>
                                </div>
                            </div>
                            <div class="pets-details">
                                <div class="detail-row">
                                    <i class="fas fa-tag"></i>
                                    <span>ID: P001</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-venus-mars"></i>
                                    <span>Sex: Male</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>Birth: 15/03/2022</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-weight"></i>
                                    <span>Weight: 25 kg</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>Location: Home</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-syringe"></i>
                                    <span>Vaccination: Up to date</span>
                                </div>
                            </div>
                            <div class="pets-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="editPet(1)">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-success" onclick="addHealthRecord(1)">
                                    <i class="fas fa-heartbeat"></i> Health
                                </button>
                                <button class="btn btn-sm btn-info" onclick="viewPetDetails(1)">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deletePet(1)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Pets by Type</h5>
                            <div>
                                <button class="btn btn-outline-secondary me-2" onclick="showAllPets()">
                                    <i class="fas fa-list me-2"></i>Show All
                                </button>
                                <button class="btn btn-outline-primary" onclick="exportPetsData()">
                                    <i class="fas fa-download me-2"></i>Export
                                </button>
                            </div>
                        </div>
                        
                        <!-- Pets Type Tabs -->
                        <ul class="nav nav-tabs" id="petsTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="all-pets-tab" data-bs-toggle="tab" data-bs-target="#all-pets" type="button" role="tab" aria-controls="all-pets" aria-selected="true">
                                    <i class="fas fa-list me-2"></i>All Pets <span class="badge bg-secondary ms-1" id="all-pets-count">0</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="dogs-tab" data-bs-toggle="tab" data-bs-target="#dogs" type="button" role="tab" aria-controls="dogs" aria-selected="false">
                                    <i class="fas fa-dog me-2"></i>Dogs <span class="badge bg-primary ms-1" id="dogs-count">0</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="cats-tab" data-bs-toggle="tab" data-bs-target="#cats" type="button" role="tab" aria-controls="cats" aria-selected="false">
                                    <i class="fas fa-cat me-2"></i>Cats <span class="badge bg-info ms-1" id="cats-count">0</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="birds-tab" data-bs-toggle="tab" data-bs-target="#birds" type="button" role="tab" aria-controls="birds" aria-selected="false">
                                    <i class="fas fa-dove me-2"></i>Birds <span class="badge bg-warning ms-1" id="birds-count">0</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="fish-tab" data-bs-toggle="tab" data-bs-target="#fish" type="button" role="tab" aria-controls="fish" aria-selected="false">
                                    <i class="fas fa-fish me-2"></i>Fish <span class="badge bg-success ms-1" id="fish-count">0</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="other-pets-tab" data-bs-toggle="tab" data-bs-target="#other-pets" type="button" role="tab" aria-controls="other-pets" aria-selected="false">
                                    <i class="fas fa-paw me-2"></i>Other <span class="badge bg-secondary ms-1" id="other-pets-count">0</span>
                                </button>
                            </li>
                        </ul>
                        
                        <!-- Tab Content -->
                        <div class="tab-content" id="petsTabContent">
                            <!-- All Pets Tab -->
                            <div class="tab-pane fade show active" id="all-pets" role="tabpanel" aria-labelledby="all-pets-tab">
                                <div class="table-responsive mt-3">
                                    <table class="table table-custom">
                                        <thead>
                                            <tr>
                                                <th>Species</th>
                                                <th>Breed</th>
                                                <th>Name</th>
                                                <th>Age</th>
                                                <th>Gender</th>
                                                <th>Health Status</th>
                                                <th>Vaccination</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="petsTable">
                                            <!-- Pets will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Dogs Tab -->
                            <div class="tab-pane fade" id="dogs" role="tabpanel" aria-labelledby="dogs-tab">
                                <div class="table-responsive mt-3">
                                    <table class="table table-custom">
                                        <thead>
                                            <tr>
                                                <th>Breed</th>
                                                <th>Name</th>
                                                <th>Age</th>
                                                <th>Gender</th>
                                                <th>Health Status</th>
                                                <th>Vaccination</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dogsTable">
                                            <!-- Dogs will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Cats Tab -->
                            <div class="tab-pane fade" id="cats" role="tabpanel" aria-labelledby="cats-tab">
                                <div class="table-responsive mt-3">
                                    <table class="table table-custom">
                                        <thead>
                                            <tr>
                                                <th>Breed</th>
                                                <th>Name</th>
                                                <th>Age</th>
                                                <th>Gender</th>
                                                <th>Health Status</th>
                                                <th>Vaccination</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="catsTable">
                                            <!-- Cats will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Birds Tab -->
                            <div class="tab-pane fade" id="birds" role="tabpanel" aria-labelledby="birds-tab">
                                <div class="table-responsive mt-3">
                                    <table class="table table-custom">
                                        <thead>
                                            <tr>
                                                <th>Species</th>
                                                <th>Name</th>
                                                <th>Age</th>
                                                <th>Gender</th>
                                                <th>Health Status</th>
                                                <th>Vaccination</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="birdsTable">
                                            <!-- Birds will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Fish Tab -->
                            <div class="tab-pane fade" id="fish" role="tabpanel" aria-labelledby="fish-tab">
                                <div class="table-responsive mt-3">
                                    <table class="table table-custom">
                                        <thead>
                                            <tr>
                                                <th>Species</th>
                                                <th>Name</th>
                                                <th>Age</th>
                                                <th>Gender</th>
                                                <th>Health Status</th>
                                                <th>Vaccination</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="fishTable">
                                            <!-- Fish will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Other Pets Tab -->
                            <div class="tab-pane fade" id="other-pets" role="tabpanel" aria-labelledby="other-pets-tab">
                                <div class="table-responsive mt-3">
                                    <table class="table table-custom">
                                        <thead>
                                            <tr>
                                                <th>Species</th>
                                                <th>Breed</th>
                                                <th>Name</th>
                                                <th>Age</th>
                                                <th>Gender</th>
                                                <th>Health Status</th>
                                                <th>Vaccination</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="otherPetsTable">
                                            <!-- Other pets will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="inventoryManagementView" style="display: none;">
                    <h2>Inventory Management</h2>
                    <div class="dashboard-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Inventory Items</h5>
                            <button class="btn btn-custom" onclick="addInventoryItem()">
                                <i class="fas fa-plus me-2"></i>Add Item
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-custom">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Category</th>
                                        <th>Quantity</th>
                                        <th>Unit</th>
                                        <th>Last Updated</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="inventoryTable">
                                    <tr>
                                        <td>Fertilizer NPK</td>
                                        <td>Chemicals</td>
                                        <td>50</td>
                                        <td>kg</td>
                                        <td>2025-01-10</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editInventory(1)">Edit</button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteInventory(1)">Delete</button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Seeds - Tomato</td>
                                        <td>Seeds</td>
                                        <td>100</td>
                                        <td>packets</td>
                                        <td>2025-01-08</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editInventory(2)">Edit</button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteInventory(2)">Delete</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="analyticsView" style="display: none;">
                    <h2>Analytics & Reports</h2>
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="dashboard-card">
                                <h5>Revenue Analysis</h5>
                                <div class="chart-container">
                                    <canvas id="revenueChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="dashboard-card">
                                <h5>Cost Analysis</h5>
                                <div class="chart-container">
                                    <canvas id="costChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tasksView" style="display: none;">
                    <h2>Task Management</h2>
                    <div class="dashboard-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Tasks</h5>
                            <button class="btn btn-custom" onclick="addNewTask()">
                                <i class="fas fa-plus me-2"></i>Add Task
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-custom">
                                <thead>
                                    <tr>
                                        <th>Task</th>
                                        <th>Priority</th>
                                        <th>Due Date</th>
                                        <th>Status</th>
                                        <th>Assigned To</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tasksTable">
                                    <tr>
                                        <td>Harvest Field A</td>
                                        <td><span class="badge bg-danger">High</span></td>
                                        <td>2025-01-20</td>
                                        <td><span class="status-badge status-pending">Pending</span></td>
                                        <td>John Doe</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-success me-1" onclick="completeTask(1)">Complete</button>
                                            <button class="btn btn-sm btn-outline-primary" onclick="editTask(1)">Edit</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="reportsView" style="display: none;">
                    <h2>Reports & Data Export</h2>
                    
                    <!-- Quick Reports -->
                    <div class="dashboard-card mb-4">
                        <h5>Quick Reports</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-chart-bar fa-3x text-primary mb-3"></i>
                                        <h6>Farm Summary</h6>
                                        <p class="small text-muted">Overview of all farm data</p>
                                        <button class="btn btn-outline-primary btn-sm" onclick="generateReport('summary')">Generate</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-seedling fa-3x text-success mb-3"></i>
                                        <h6>Crop Report</h6>
                                        <p class="small text-muted">Detailed crop analysis</p>
                                        <button class="btn btn-outline-success btn-sm" onclick="generateReport('crops')">Generate</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-cow fa-3x text-info mb-3"></i>
                                        <h6>Livestock Report</h6>
                                        <p class="small text-muted">Livestock management data</p>
                                        <button class="btn btn-outline-info btn-sm" onclick="generateReport('livestock')">Generate</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-boxes fa-3x text-warning mb-3"></i>
                                        <h6>Inventory Report</h6>
                                        <p class="small text-muted">Stock and supplies analysis</p>
                                        <button class="btn btn-outline-warning btn-sm" onclick="generateReport('inventory')">Generate</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Data Export -->
                    <div class="dashboard-card mb-4">
                        <h5>Export Data</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-file-csv fa-3x text-success mb-3"></i>
                                        <h6>CSV Export</h6>
                                        <p class="small text-muted">Excel-compatible format</p>
                                        <div class="btn-group-vertical w-100">
                                            <button class="btn btn-outline-success btn-sm" onclick="exportToCSV('all')">All Data</button>
                                            <button class="btn btn-outline-success btn-sm" onclick="exportToCSV('crops')">Crops Only</button>
                                            <button class="btn btn-outline-success btn-sm" onclick="exportToCSV('livestock')">Livestock Only</button>
                                            <button class="btn btn-outline-success btn-sm" onclick="exportToCSV('inventory')">Inventory Only</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-file-pdf fa-3x text-danger mb-3"></i>
                                        <h6>PDF Report</h6>
                                        <p class="small text-muted">Professional formatted report</p>
                                        <div class="btn-group-vertical w-100">
                                            <button class="btn btn-outline-danger btn-sm" onclick="exportToPDF('summary')">Summary Report</button>
                                            <button class="btn btn-outline-danger btn-sm" onclick="exportToPDF('detailed')">Detailed Report</button>
                                            <button class="btn btn-outline-danger btn-sm" onclick="exportToPDF('financial')">Financial Report</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-file-code fa-3x text-info mb-3"></i>
                                        <h6>JSON Export</h6>
                                        <p class="small text-muted">Raw data for integration</p>
                                        <div class="btn-group-vertical w-100">
                                            <button class="btn btn-outline-info btn-sm" onclick="exportToJSON('all')">All Data</button>
                                            <button class="btn btn-outline-info btn-sm" onclick="exportToJSON('backup')">Backup Data</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Reports -->
                    <div class="dashboard-card">
                        <h5>Custom Report Builder</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Report Type</label>
                                    <select class="form-select" id="customReportType">
                                        <option value="summary">Farm Summary</option>
                                        <option value="crops">Crop Analysis</option>
                                        <option value="livestock">Livestock Management</option>
                                        <option value="inventory">Inventory Status</option>
                                        <option value="financial">Financial Overview</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Date Range</label>
                                    <select class="form-select" id="customDateRange">
                                        <option value="current">Current Month</option>
                                        <option value="last3">Last 3 Months</option>
                                        <option value="last6">Last 6 Months</option>
                                        <option value="year">This Year</option>
                                        <option value="all">All Time</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Include Charts</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="includeCharts" checked>
                                        <label class="form-check-label" for="includeCharts">
                                            Include visual charts
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Export Format</label>
                                    <select class="form-select" id="exportFormat">
                                        <option value="pdf">PDF Document</option>
                                        <option value="csv">CSV Spreadsheet</option>
                                        <option value="json">JSON Data</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="generateCustomReport()">
                            <i class="fas fa-file-alt me-2"></i>Generate Custom Report
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Watering Timing System -->
    <script src="js/watering-timing-system.js"></script>
    
    <script>
        // Data arrays for crops, livestock, pets, and inventory
        let crops = [];
        let livestock = [];
        let pets = [];
        let inventory = [];
        
        // Weather service
        let weatherService = null;

        // Global Agricultural Database
        let globalCropDatabase = {};
        let globalLivestockDatabase = {};
        let globalAquacultureDatabase = {};
        let globalPetsDatabase = {};

        // Initialize Global Agricultural Database
        function initializeGlobalDatabase() {
            // Global Crop Database
            globalCropDatabase = {
                'cereals': {
                    name: 'Cereal Crops (Grains)',
                    description: 'Staple food sources high in carbohydrates',
                    icon: 'üåæ',
                    crops: [
                        { name: 'Wheat', scientific: 'Triticum aestivum', category: 'cereals' },
                        { name: 'Rice', scientific: 'Oryza sativa', category: 'cereals' },
                        { name: 'Maize (Corn)', scientific: 'Zea mays', category: 'cereals' },
                        { name: 'Barley', scientific: 'Hordeum vulgare', category: 'cereals' },
                        { name: 'Sorghum', scientific: 'Sorghum bicolor', category: 'cereals' },
                        { name: 'Millet', scientific: 'Panicum miliaceum', category: 'cereals' },
                        { name: 'Oats', scientific: 'Avena sativa', category: 'cereals' },
                        { name: 'Rye', scientific: 'Secale cereale', category: 'cereals' },
                        { name: 'Triticale', scientific: 'Triticosecale', category: 'cereals' }
                    ]
                },
                'legumes': {
                    name: 'Legumes (Pulses)',
                    description: 'High-protein crops important for soil nitrogen fixing',
                    icon: 'üå∞',
                    crops: [
                        { name: 'Soybeans', scientific: 'Glycine max', category: 'legumes' },
                        { name: 'Lentils', scientific: 'Lens culinaris', category: 'legumes' },
                        { name: 'Chickpeas', scientific: 'Cicer arietinum', category: 'legumes' },
                        { name: 'Peas', scientific: 'Pisum sativum', category: 'legumes' },
                        { name: 'Kidney Beans', scientific: 'Phaseolus vulgaris', category: 'legumes' },
                        { name: 'Navy Beans', scientific: 'Phaseolus vulgaris', category: 'legumes' },
                        { name: 'Pinto Beans', scientific: 'Phaseolus vulgaris', category: 'legumes' },
                        { name: 'Mung Beans', scientific: 'Vigna radiata', category: 'legumes' },
                        { name: 'Black Beans', scientific: 'Phaseolus vulgaris', category: 'legumes' },
                        { name: 'Pigeon Peas', scientific: 'Cajanus cajan', category: 'legumes' },
                        { name: 'Cowpeas', scientific: 'Vigna unguiculata', category: 'legumes' },
                        { name: 'Faba Beans', scientific: 'Vicia faba', category: 'legumes' }
                    ]
                },
                'root_tubers': {
                    name: 'Root and Tuber Crops',
                    description: 'Underground storage organs, rich in starch',
                    icon: 'ü•î',
                    crops: [
                        { name: 'Potatoes', scientific: 'Solanum tuberosum', category: 'root_tubers' },
                        { name: 'Cassava', scientific: 'Manihot esculenta', category: 'root_tubers' },
                        { name: 'Sweet Potatoes', scientific: 'Ipomoea batatas', category: 'root_tubers' },
                        { name: 'Yams', scientific: 'Dioscorea spp.', category: 'root_tubers' },
                        { name: 'Taro', scientific: 'Colocasia esculenta', category: 'root_tubers' },
                        { name: 'Sugar Beet', scientific: 'Beta vulgaris', category: 'root_tubers' },
                        { name: 'Table Beet', scientific: 'Beta vulgaris', category: 'root_tubers' },
                        { name: 'Carrots', scientific: 'Daucus carota', category: 'root_tubers' },
                        { name: 'Radish', scientific: 'Raphanus sativus', category: 'root_tubers' },
                        { name: 'Turnips', scientific: 'Brassica rapa', category: 'root_tubers' },
                        { name: 'Ginger', scientific: 'Zingiber officinale', category: 'root_tubers' },
                        { name: 'Turmeric', scientific: 'Curcuma longa', category: 'root_tubers' }
                    ]
                },
                'vegetables': {
                    name: 'Vegetables',
                    description: 'Cultivated for leaves, stems, roots, or fruits',
                    icon: 'ü´ë',
                    crops: [
                        { name: 'Tomatoes', scientific: 'Solanum lycopersicum', category: 'vegetables' },
                        { name: 'Onions', scientific: 'Allium cepa', category: 'vegetables' },
                        { name: 'Cabbage', scientific: 'Brassica oleracea', category: 'vegetables' },
                        { name: 'Lettuce', scientific: 'Lactuca sativa', category: 'vegetables' },
                        { name: 'Spinach', scientific: 'Spinacia oleracea', category: 'vegetables' },
                        { name: 'Kale', scientific: 'Brassica oleracea', category: 'vegetables' },
                        { name: 'Cauliflower', scientific: 'Brassica oleracea', category: 'vegetables' },
                        { name: 'Broccoli', scientific: 'Brassica oleracea', category: 'vegetables' },
                        { name: 'Cucumber', scientific: 'Cucumis sativus', category: 'vegetables' },
                        { name: 'Pumpkin', scientific: 'Cucurbita pepo', category: 'vegetables' },
                        { name: 'Eggplant', scientific: 'Solanum melongena', category: 'vegetables' },
                        { name: 'Zucchini', scientific: 'Cucurbita pepo', category: 'vegetables' },
                        { name: 'Bell Peppers', scientific: 'Capsicum annuum', category: 'vegetables' },
                        { name: 'Chili Peppers', scientific: 'Capsicum frutescens', category: 'vegetables' },
                        { name: 'Okra', scientific: 'Abelmoschus esculentus', category: 'vegetables' }
                    ]
                },
                'fruits': {
                    name: 'Fruits (Tree and Non-Tree)',
                    description: 'Consumed fresh or processed, high in vitamins',
                    icon: 'üçé',
                    crops: [
                        // Tree Fruits
                        { name: 'Apples', scientific: 'Malus domestica', category: 'fruits', subcategory: 'tree' },
                        { name: 'Oranges', scientific: 'Citrus sinensis', category: 'fruits', subcategory: 'tree' },
                        { name: 'Mangoes', scientific: 'Mangifera indica', category: 'fruits', subcategory: 'tree' },
                        { name: 'Bananas', scientific: 'Musa acuminata', category: 'fruits', subcategory: 'tree' },
                        { name: 'Avocados', scientific: 'Persea americana', category: 'fruits', subcategory: 'tree' },
                        { name: 'Papayas', scientific: 'Carica papaya', category: 'fruits', subcategory: 'tree' },
                        { name: 'Pears', scientific: 'Pyrus communis', category: 'fruits', subcategory: 'tree' },
                        { name: 'Cherries', scientific: 'Prunus avium', category: 'fruits', subcategory: 'tree' },
                        { name: 'Plums', scientific: 'Prunus domestica', category: 'fruits', subcategory: 'tree' },
                        { name: 'Coconuts', scientific: 'Cocos nucifera', category: 'fruits', subcategory: 'tree' },
                        { name: 'Dates', scientific: 'Phoenix dactylifera', category: 'fruits', subcategory: 'tree' },
                        { name: 'Olives', scientific: 'Olea europaea', category: 'fruits', subcategory: 'tree' },
                        // Vine/Bush Fruits
                        { name: 'Grapes', scientific: 'Vitis vinifera', category: 'fruits', subcategory: 'vine' },
                        { name: 'Strawberries', scientific: 'Fragaria ananassa', category: 'fruits', subcategory: 'vine' },
                        { name: 'Blueberries', scientific: 'Vaccinium corymbosum', category: 'fruits', subcategory: 'vine' },
                        { name: 'Watermelon', scientific: 'Citrullus lanatus', category: 'fruits', subcategory: 'vine' },
                        { name: 'Cantaloupe', scientific: 'Cucumis melo', category: 'fruits', subcategory: 'vine' },
                        { name: 'Honeydew', scientific: 'Cucumis melo', category: 'fruits', subcategory: 'vine' },
                        { name: 'Pineapples', scientific: 'Ananas comosus', category: 'fruits', subcategory: 'vine' },
                        { name: 'Passion Fruit', scientific: 'Passiflora edulis', category: 'fruits', subcategory: 'vine' },
                        { name: 'Guava', scientific: 'Psidium guajava', category: 'fruits', subcategory: 'vine' }
                    ]
                },
                'herbs_spices': {
                    name: 'Herbs & Spices',
                    description: 'Used for flavor, medicine, or perfume',
                    icon: 'üå±',
                    crops: [
                        { name: 'Coriander', scientific: 'Coriandrum sativum', category: 'herbs_spices' },
                        { name: 'Basil', scientific: 'Ocimum basilicum', category: 'herbs_spices' },
                        { name: 'Mint', scientific: 'Mentha spp.', category: 'herbs_spices' },
                        { name: 'Parsley', scientific: 'Petroselinum crispum', category: 'herbs_spices' },
                        { name: 'Thyme', scientific: 'Thymus vulgaris', category: 'herbs_spices' },
                        { name: 'Oregano', scientific: 'Origanum vulgare', category: 'herbs_spices' },
                        { name: 'Rosemary', scientific: 'Rosmarinus officinalis', category: 'herbs_spices' },
                        { name: 'Sage', scientific: 'Salvia officinalis', category: 'herbs_spices' },
                        { name: 'Chili Pepper', scientific: 'Capsicum annuum', category: 'herbs_spices' },
                        { name: 'Black Pepper', scientific: 'Piper nigrum', category: 'herbs_spices' },
                        { name: 'Cinnamon', scientific: 'Cinnamomum verum', category: 'herbs_spices' },
                        { name: 'Cloves', scientific: 'Syzygium aromaticum', category: 'herbs_spices' },
                        { name: 'Nutmeg', scientific: 'Myristica fragrans', category: 'herbs_spices' },
                        { name: 'Cardamom', scientific: 'Elettaria cardamomum', category: 'herbs_spices' },
                        { name: 'Vanilla', scientific: 'Vanilla planifolia', category: 'herbs_spices' }
                    ]
                },
                'oilseeds': {
                    name: 'Oilseed Crops',
                    description: 'Farmed for oil extraction',
                    icon: 'üåª',
                    crops: [
                        { name: 'Sunflower', scientific: 'Helianthus annuus', category: 'oilseeds' },
                        { name: 'Canola', scientific: 'Brassica napus', category: 'oilseeds' },
                        { name: 'Soybeans', scientific: 'Glycine max', category: 'oilseeds' },
                        { name: 'Sesame', scientific: 'Sesamum indicum', category: 'oilseeds' },
                        { name: 'Groundnuts', scientific: 'Arachis hypogaea', category: 'oilseeds' },
                        { name: 'Palm Oil', scientific: 'Elaeis guineensis', category: 'oilseeds' },
                        { name: 'Flaxseed', scientific: 'Linum usitatissimum', category: 'oilseeds' },
                        { name: 'Cottonseed', scientific: 'Gossypium hirsutum', category: 'oilseeds' },
                        { name: 'Safflower', scientific: 'Carthamus tinctorius', category: 'oilseeds' }
                    ]
                },
                'beverage': {
                    name: 'Beverage Crops',
                    description: 'Grown specifically for drink production',
                    icon: 'üßÉ',
                    crops: [
                        { name: 'Coffee', scientific: 'Coffea arabica', category: 'beverage' },
                        { name: 'Tea', scientific: 'Camellia sinensis', category: 'beverage' },
                        { name: 'Cocoa', scientific: 'Theobroma cacao', category: 'beverage' },
                        { name: 'Sugarcane', scientific: 'Saccharum officinarum', category: 'beverage' },
                        { name: 'Sugar Beet', scientific: 'Beta vulgaris', category: 'beverage' }
                    ]
                },
                'flowers': {
                    name: 'Flowers & Ornamental Plants',
                    description: 'Ornamental garden flowers, florist flowers, and decorative plants',
                    icon: 'üå∫',
                    crops: [
                        // Ornamental Garden Flowers
                        { name: 'Rose', scientific: 'Rosa rubiginosa', category: 'flowers', subcategory: 'ornamental' },
                        { name: 'Tulip', scientific: 'Tulipa gesneriana', category: 'flowers', subcategory: 'ornamental' },
                        { name: 'Lily', scientific: 'Lilium candidum', category: 'flowers', subcategory: 'ornamental' },
                        { name: 'Sunflower', scientific: 'Helianthus annuus', category: 'flowers', subcategory: 'ornamental' },
                        { name: 'Marigold', scientific: 'Tagetes erecta', category: 'flowers', subcategory: 'ornamental' },
                        { name: 'Petunia', scientific: 'Petunia x hybrida', category: 'flowers', subcategory: 'ornamental' },
                        { name: 'Geranium', scientific: 'Pelargonium x hortorum', category: 'flowers', subcategory: 'ornamental' },
                        { name: 'Pansy', scientific: 'Viola tricolor', category: 'flowers', subcategory: 'ornamental' },
                        { name: 'Daisy', scientific: 'Bellis perennis', category: 'flowers', subcategory: 'ornamental' },
                        { name: 'Iris', scientific: 'Iris germanica', category: 'flowers', subcategory: 'ornamental' },
                        { name: 'Peony', scientific: 'Paeonia lactiflora', category: 'flowers', subcategory: 'ornamental' },
                        { name: 'Chrysanthemum', scientific: 'Chrysanthemum morifolium', category: 'flowers', subcategory: 'ornamental' },
                        { name: 'Lavender', scientific: 'Lavandula angustifolia', category: 'flowers', subcategory: 'ornamental' },
                        { name: 'Hydrangea', scientific: 'Hydrangea macrophylla', category: 'flowers', subcategory: 'ornamental' },
                        { name: 'Begonia', scientific: 'Begonia x semperflorens', category: 'flowers', subcategory: 'ornamental' },
                        
                        // Florist & Bouquet Flowers
                        { name: 'Orchid', scientific: 'Phalaenopsis amabilis', category: 'flowers', subcategory: 'florist' },
                        { name: 'Carnation', scientific: 'Dianthus caryophyllus', category: 'flowers', subcategory: 'florist' },
                        { name: 'Baby\'s Breath', scientific: 'Gypsophila paniculata', category: 'flowers', subcategory: 'florist' },
                        { name: 'Snapdragon', scientific: 'Antirrhinum majus', category: 'flowers', subcategory: 'florist' },
                        { name: 'Sweet Pea', scientific: 'Lathyrus odoratus', category: 'flowers', subcategory: 'florist' },
                        { name: 'Statice', scientific: 'Limonium sinuatum', category: 'flowers', subcategory: 'florist' },
                        { name: 'Alstroemeria', scientific: 'Alstroemeria aurea', category: 'flowers', subcategory: 'florist' },
                        { name: 'Freesia', scientific: 'Freesia refracta', category: 'flowers', subcategory: 'florist' },
                        { name: 'Gladiolus', scientific: 'Gladiolus hortulanus', category: 'flowers', subcategory: 'florist' },
                        { name: 'Anemone', scientific: 'Anemone coronaria', category: 'flowers', subcategory: 'florist' },
                        { name: 'Ranunculus', scientific: 'Ranunculus asiaticus', category: 'flowers', subcategory: 'florist' },
                        { name: 'Lisianthus', scientific: 'Eustoma grandiflorum', category: 'flowers', subcategory: 'florist' },
                        
                        // Wildflowers
                        { name: 'Wild Rose', scientific: 'Rosa canina', category: 'flowers', subcategory: 'wildflower' },
                        { name: 'Bluebell', scientific: 'Hyacinthoides non-scripta', category: 'flowers', subcategory: 'wildflower' },
                        { name: 'Poppy', scientific: 'Papaver rhoeas', category: 'flowers', subcategory: 'wildflower' },
                        { name: 'Buttercup', scientific: 'Ranunculus acris', category: 'flowers', subcategory: 'wildflower' },
                        { name: 'Violet', scientific: 'Viola odorata', category: 'flowers', subcategory: 'wildflower' },
                        { name: 'Forget-me-not', scientific: 'Myosotis scorpioides', category: 'flowers', subcategory: 'wildflower' },
                        { name: 'Cornflower', scientific: 'Centaurea cyanus', category: 'flowers', subcategory: 'wildflower' },
                        { name: 'Foxglove', scientific: 'Digitalis purpurea', category: 'flowers', subcategory: 'wildflower' },
                        { name: 'Primrose', scientific: 'Primula vulgaris', category: 'flowers', subcategory: 'wildflower' },
                        { name: 'Thistle', scientific: 'Cirsium vulgare', category: 'flowers', subcategory: 'wildflower' },
                        { name: 'Meadowsweet', scientific: 'Filipendula ulmaria', category: 'flowers', subcategory: 'wildflower' },
                        { name: 'Yarrow', scientific: 'Achillea millefolium', category: 'flowers', subcategory: 'wildflower' },
                        
                        // Tropical & Exotic Flowers
                        { name: 'Hibiscus', scientific: 'Hibiscus rosa-sinensis', category: 'flowers', subcategory: 'tropical' },
                        { name: 'Bird of Paradise', scientific: 'Strelitzia reginae', category: 'flowers', subcategory: 'tropical' },
                        { name: 'Bougainvillea', scientific: 'Bougainvillea spectabilis', category: 'flowers', subcategory: 'tropical' },
                        { name: 'Plumeria', scientific: 'Plumeria rubra', category: 'flowers', subcategory: 'tropical' },
                        { name: 'Ginger Lily', scientific: 'Hedychium coronarium', category: 'flowers', subcategory: 'tropical' },
                        { name: 'Heliconia', scientific: 'Heliconia rostrata', category: 'flowers', subcategory: 'tropical' },
                        { name: 'Torch Ginger', scientific: 'Etlingera elatior', category: 'flowers', subcategory: 'tropical' },
                        { name: 'Passion Flower', scientific: 'Passiflora incarnata', category: 'flowers', subcategory: 'tropical' },
                        { name: 'Jasmine', scientific: 'Jasminum officinale', category: 'flowers', subcategory: 'tropical' },
                        { name: 'Frangipani', scientific: 'Plumeria alba', category: 'flowers', subcategory: 'tropical' },
                        { name: 'Canna Lily', scientific: 'Canna indica', category: 'flowers', subcategory: 'tropical' },
                        { name: 'Gardenia', scientific: 'Gardenia jasminoides', category: 'flowers', subcategory: 'tropical' },
                        
                        // Religious & Cultural Flowers
                        { name: 'Lotus', scientific: 'Nelumbo nucifera', category: 'flowers', subcategory: 'religious' },
                        { name: 'Marigold (Indian)', scientific: 'Tagetes patula', category: 'flowers', subcategory: 'religious' },
                        { name: 'Jasmine (Sacred)', scientific: 'Jasminum sambac', category: 'flowers', subcategory: 'religious' },
                        { name: 'Rose (Sacred)', scientific: 'Rosa damascena', category: 'flowers', subcategory: 'religious' },
                        { name: 'Hibiscus (Sacred)', scientific: 'Hibiscus syriacus', category: 'flowers', subcategory: 'religious' },
                        { name: 'Chrysanthemum (Sacred)', scientific: 'Chrysanthemum indicum', category: 'flowers', subcategory: 'religious' },
                        { name: 'Temple Tree', scientific: 'Plumeria obtusa', category: 'flowers', subcategory: 'religious' },
                        { name: 'Sacred Basil', scientific: 'Ocimum tenuiflorum', category: 'flowers', subcategory: 'religious' },
                        { name: 'White Lily (Easter)', scientific: 'Lilium longiflorum', category: 'flowers', subcategory: 'religious' },
                        { name: 'Red Rose (Passion)', scientific: 'Rosa gallica', category: 'flowers', subcategory: 'religious' },
                        
                        // Edible & Medicinal Flowers
                        { name: 'Nasturtium', scientific: 'Tropaeolum majus', category: 'flowers', subcategory: 'edible' },
                        { name: 'Calendula', scientific: 'Calendula officinalis', category: 'flowers', subcategory: 'edible' },
                        { name: 'Borage', scientific: 'Borago officinalis', category: 'flowers', subcategory: 'edible' },
                        { name: 'Elderflower', scientific: 'Sambucus nigra', category: 'flowers', subcategory: 'edible' },
                        { name: 'Chamomile', scientific: 'Matricaria chamomilla', category: 'flowers', subcategory: 'edible' },
                        { name: 'Echinacea', scientific: 'Echinacea purpurea', category: 'flowers', subcategory: 'edible' },
                        { name: 'Saffron Crocus', scientific: 'Crocus sativus', category: 'flowers', subcategory: 'edible' },
                        { name: 'Hibiscus (Roselle)', scientific: 'Hibiscus sabdariffa', category: 'flowers', subcategory: 'edible' },
                        { name: 'Violet (Edible)', scientific: 'Viola tricolor', category: 'flowers', subcategory: 'edible' },
                        { name: 'Pansy (Edible)', scientific: 'Viola x wittrockiana', category: 'flowers', subcategory: 'edible' },
                        { name: 'Daylily', scientific: 'Hemerocallis fulva', category: 'flowers', subcategory: 'edible' },
                        { name: 'Squash Blossom', scientific: 'Cucurbita pepo', category: 'flowers', subcategory: 'edible' },
                        
                        // Climbers and Creepers
                        { name: 'Morning Glory', scientific: 'Ipomoea purpurea', category: 'flowers', subcategory: 'climber' },
                        { name: 'Clematis', scientific: 'Clematis vitalba', category: 'flowers', subcategory: 'climber' },
                        { name: 'Wisteria', scientific: 'Wisteria sinensis', category: 'flowers', subcategory: 'climber' },
                        { name: 'Honeysuckle', scientific: 'Lonicera periclymenum', category: 'flowers', subcategory: 'climber' },
                        { name: 'Sweet Pea (Climbing)', scientific: 'Lathyrus odoratus', category: 'flowers', subcategory: 'climber' },
                        { name: 'Climbing Rose', scientific: 'Rosa banksiae', category: 'flowers', subcategory: 'climber' },
                        { name: 'Trumpet Vine', scientific: 'Campsis radicans', category: 'flowers', subcategory: 'climber' },
                        { name: 'Climbing Hydrangea', scientific: 'Hydrangea anomala', category: 'flowers', subcategory: 'climber' },
                        { name: 'Jasmine (Climbing)', scientific: 'Jasminum polyanthum', category: 'flowers', subcategory: 'climber' },
                        { name: 'Passion Vine', scientific: 'Passiflora caerulea', category: 'flowers', subcategory: 'climber' },
                        { name: 'Black-eyed Susan Vine', scientific: 'Thunbergia alata', category: 'flowers', subcategory: 'climber' },
                        { name: 'Moonflower', scientific: 'Ipomoea alba', category: 'flowers', subcategory: 'climber' }
                    ]
                },
                'industrial': {
                    name: 'Industrial/Fiber Crops',
                    description: 'Grown for materials and non-food purposes',
                    icon: 'üè≠',
                    crops: [
                        { name: 'Cotton', scientific: 'Gossypium hirsutum', category: 'industrial' },
                        { name: 'Hemp', scientific: 'Cannabis sativa', category: 'industrial' },
                        { name: 'Flax', scientific: 'Linum usitatissimum', category: 'industrial' },
                        { name: 'Jute', scientific: 'Corchorus olitorius', category: 'industrial' },
                        { name: 'Rubber', scientific: 'Hevea brasiliensis', category: 'industrial' },
                        { name: 'Kenaf', scientific: 'Hibiscus cannabinus', category: 'industrial' },
                        { name: 'Agave', scientific: 'Agave sisalana', category: 'industrial' },
                        { name: 'Indigo', scientific: 'Indigofera tinctoria', category: 'industrial' }
                    ]
                },
                'medicinal': {
                    name: 'Medicinal and Aromatic Plants',
                    description: 'Cultivated for healing, pharma, or cosmetic use',
                    icon: 'üåø',
                    crops: [
                        { name: 'Aloe Vera', scientific: 'Aloe barbadensis', category: 'medicinal' },
                        { name: 'Neem', scientific: 'Azadirachta indica', category: 'medicinal' },
                        { name: 'Chamomile', scientific: 'Matricaria chamomilla', category: 'medicinal' },
                        { name: 'Echinacea', scientific: 'Echinacea purpurea', category: 'medicinal' },
                        { name: 'Lemongrass', scientific: 'Cymbopogon citratus', category: 'medicinal' },
                        { name: 'Ginseng', scientific: 'Panax ginseng', category: 'medicinal' },
                        { name: 'Ashwagandha', scientific: 'Withania somnifera', category: 'medicinal' },
                        { name: 'Turmeric', scientific: 'Curcuma longa', category: 'medicinal' },
                        { name: 'Moringa', scientific: 'Moringa oleifera', category: 'medicinal' },
                        { name: 'Lavender', scientific: 'Lavandula angustifolia', category: 'medicinal' },
                        { name: 'Kava', scientific: 'Piper methysticum', category: 'medicinal' }
                    ]
                },
                'specialty': {
                    name: 'Specialty & Other Crops',
                    description: 'Unique and specialized agricultural products',
                    icon: 'üçÑ',
                    crops: [
                        { name: 'Mushrooms', scientific: 'Pleurotus ostreatus', category: 'specialty' },
                        { name: 'Bamboo Shoots', scientific: 'Bambusa vulgaris', category: 'specialty' },
                        { name: 'Seaweed', scientific: 'Porphyra spp.', category: 'specialty' },
                        { name: 'Quinoa', scientific: 'Chenopodium quinoa', category: 'specialty' },
                        { name: 'Amaranth', scientific: 'Amaranthus spp.', category: 'specialty' },
                        { name: 'Buckwheat', scientific: 'Fagopyrum esculentum', category: 'specialty' }
                    ]
                }
            };

            // Global Livestock Database
            globalLivestockDatabase = {
                'cattle': {
                    name: 'Cattle',
                    icon: 'üêÑ',
                    breeds: [
                        'Holstein', 'Angus', 'Hereford', 'Simmental', 'Charolais', 'Limousin',
                        'Brahman', 'Jersey', 'Guernsey', 'Brown Swiss', 'Shorthorn', 'Gelbvieh',
                        'Belted Galloway', 'Highland', 'Texas Longhorn', 'Wagyu', 'Zebu', 'Ankole'
                    ]
                },
                'pigs': {
                    name: 'Pigs',
                    icon: 'üê∑',
                    breeds: [
                        'Yorkshire', 'Hampshire', 'Duroc', 'Landrace', 'Berkshire', 'Tamworth',
                        'Pietrain', 'Chester White', 'Poland China', 'Spotted', 'Gloucestershire Old Spot',
                        'Mangalitsa', 'Kunekune', 'Vietnamese Pot-bellied', 'Meishan', 'Large Black'
                    ]
                },
                'sheep': {
                    name: 'Sheep',
                    icon: 'üêë',
                    breeds: [
                        'Merino', 'Suffolk', 'Dorset', 'Hampshire', 'Rambouillet', 'Columbia',
                        'Targhee', 'Corriedale', 'Romney', 'Cheviot', 'Southdown', 'Shropshire',
                        'Border Leicester', 'Texel', 'Katahdin', 'Dorper', 'St. Croix', 'Barbados Blackbelly'
                    ]
                },
                'goats': {
                    name: 'Goats',
                    icon: 'üêê',
                    breeds: [
                        'Boer', 'Nubian', 'Saanen', 'Alpine', 'Toggenburg', 'LaMancha',
                        'Oberhasli', 'Nigerian Dwarf', 'Pygmy', 'Angora', 'Cashmere', 'Kiko',
                        'Spanish', 'Myotonic', 'Fainting', 'Tennessee', 'Savanna', 'Kalahari Red'
                    ]
                },
                'poultry': {
                    name: 'Poultry',
                    icon: 'üêî',
                    breeds: [
                        'Rhode Island Red', 'Leghorn', 'Orpington', 'Sussex', 'Wyandotte',
                        'Plymouth Rock', 'Australorp', 'Brahma', 'Cochin', 'Silkie', 'Polish',
                        'Sebright', 'Ancona', 'Andalusian', 'Campine', 'Hamburg', 'Lakenvelder',
                        'Minorca', 'New Hampshire', 'Welsummer', 'Araucana', 'Easter Egger'
                    ]
                },
                'horses': {
                    name: 'Horses',
                    icon: 'üê¥',
                    breeds: [
                        'Thoroughbred', 'Quarter Horse', 'Arabian', 'Paint', 'Appaloosa',
                        'Morgan', 'Tennessee Walking Horse', 'Standardbred', 'Mustang',
                        'Friesian', 'Clydesdale', 'Percheron', 'Belgian', 'Shire', 'Fjord',
                        'Icelandic', 'Welsh Pony', 'Shetland Pony', 'Miniature Horse'
                    ]
                },
                'aquaculture': {
                    name: 'Aquaculture',
                    icon: 'üêü',
                    species: [
                        'Tilapia', 'Catfish', 'Carp', 'Trout', 'Salmon', 'Barramundi',
                        'Pangasius', 'Snakehead', 'Eel', 'Pacu', 'Gourami', 'Sea Bass',
                        'Sea Bream', 'Cobia', 'Tuna', 'Flounder', 'Milkfish', 'Halibut',
                        'Amberjack', 'Shrimp', 'Prawns', 'Crabs', 'Oysters', 'Mussels',
                        'Clams', 'Scallops', 'Cockles'
                    ]
                },
                'pets': {
                    name: 'Pets & Companion Animals',
                    icon: 'üê∂',
                    species: [
                        'Dogs', 'Cats', 'Rabbits', 'Guinea Pigs', 'Hamsters', 'Gerbils',
                        'Mice', 'Rats', 'Ferrets', 'Birds', 'Fish', 'Turtles', 'Tortoises',
                        'Lizards', 'Snakes', 'Frogs', 'Hedgehogs', 'Sugar Gliders', 'Capybaras'
                    ]
                }
            };

            // Global Aquaculture Database
            globalAquacultureDatabase = {
                'freshwater_fish': {
                    name: 'Freshwater Fish',
                    icon: 'üåä',
                    species: [
                        { name: 'Tilapia', scientific: 'Oreochromis niloticus', notes: 'Most farmed globally, fast-growing' },
                        { name: 'Catfish', scientific: 'Clarias spp.', notes: 'Hardy, high protein diet' },
                        { name: 'Carp', scientific: 'Cyprinus carpio', notes: 'Common in Asia' },
                        { name: 'Trout', scientific: 'Oncorhynchus mykiss', notes: 'Coldwater fish, high market demand' },
                        { name: 'Barramundi', scientific: 'Lates calcarifer', notes: 'Also called Asian sea bass' },
                        { name: 'Pangasius', scientific: 'Pangasianodon hypophthalmus', notes: 'Fast-growing, native to Southeast Asia' },
                        { name: 'Snakehead Fish', scientific: 'Channa striata', notes: 'High value in Asian markets' },
                        { name: 'Eel', scientific: 'Anguilla spp.', notes: 'High market value in Japan & Korea' },
                        { name: 'Pacu', scientific: 'Piaractus mesopotamicus', notes: 'Related to piranha, farmed in South America' },
                        { name: 'Gourami', scientific: 'Osphronemidae', notes: 'Hardy species, farmed at small scale' }
                    ]
                },
                'marine_fish': {
                    name: 'Marine Fish',
                    icon: 'üåä',
                    species: [
                        { name: 'Salmon', scientific: 'Salmo salar', notes: 'High-value export fish' },
                        { name: 'Sea Bass', scientific: 'Dicentrarchus labrax', notes: 'Popular in Europe & Mediterranean' },
                        { name: 'Sea Bream', scientific: 'Sparus aurata', notes: 'Grown in cages in the Mediterranean' },
                        { name: 'Cobia', scientific: 'Rachycentron canadum', notes: 'Fast growth, farmed in tropical seas' },
                        { name: 'Tuna', scientific: 'Thunnus spp.', notes: 'Not bred yet, mostly fattened in captivity' },
                        { name: 'Flounder', scientific: 'Paralichthys spp.', notes: 'Flatfish, good for export' },
                        { name: 'Milkfish', scientific: 'Chanos chanos', notes: 'Very common in Southeast Asia' },
                        { name: 'Halibut', scientific: 'Hippoglossus hippoglossus', notes: 'Cold water species, high market value' },
                        { name: 'Amberjack', scientific: 'Seriola spp.', notes: 'High growth rate in offshore cages' }
                    ]
                },
                'shellfish': {
                    name: 'Shellfish & Bivalves',
                    icon: 'üêö',
                    species: [
                        { name: 'Pacific Oyster', scientific: 'Crassostrea gigas', notes: 'Most farmed oyster globally' },
                        { name: 'Blue Mussel', scientific: 'Mytilus edulis', notes: 'Easy to grow on ropes' },
                        { name: 'Manila Clam', scientific: 'Ruditapes philippinarum', notes: 'Widely farmed in Asia & Europe' },
                        { name: 'Japanese Scallop', scientific: 'Patinopecten yessoensis', notes: 'Popular in Asia' },
                        { name: 'Green-lipped Mussel', scientific: 'Perna canaliculus', notes: 'Farmed mainly in New Zealand' },
                        { name: 'Eastern Oyster', scientific: 'Crassostrea virginica', notes: 'Common in US East Coast' }
                    ]
                },
                'crustaceans': {
                    name: 'Crustaceans',
                    icon: 'ü¶ê',
                    species: [
                        { name: 'Whiteleg Shrimp', scientific: 'Litopenaeus vannamei', notes: 'Most widely farmed shrimp' },
                        { name: 'Giant Tiger Prawn', scientific: 'Penaeus monodon', notes: 'Large commercial species' },
                        { name: 'Freshwater Prawn', scientific: 'Macrobrachium rosenbergii', notes: 'Freshwater alternative' },
                        { name: 'Mud Crab', scientific: 'Scylla serrata', notes: 'High-value crustacean' },
                        { name: 'Blue Swimming Crab', scientific: 'Portunus pelagicus', notes: 'Popular in Asian markets' }
                    ]
                }
            };

            // Global Pets Database
            globalPetsDatabase = {
                'dogs': {
                    name: 'Dogs',
                    icon: 'üêï',
                    breeds: [
                        { name: 'Golden Retriever', size: 'Large', temperament: 'Friendly, Intelligent', lifespan: '10-12 years' },
                        { name: 'Labrador Retriever', size: 'Large', temperament: 'Outgoing, Active', lifespan: '10-14 years' },
                        { name: 'German Shepherd', size: 'Large', temperament: 'Confident, Courageous', lifespan: '9-13 years' },
                        { name: 'French Bulldog', size: 'Small', temperament: 'Adaptable, Playful', lifespan: '10-12 years' },
                        { name: 'Bulldog', size: 'Medium', temperament: 'Calm, Friendly', lifespan: '8-10 years' },
                        { name: 'Poodle', size: 'Medium', temperament: 'Active, Alert', lifespan: '12-15 years' },
                        { name: 'Beagle', size: 'Medium', temperament: 'Friendly, Curious', lifespan: '13-16 years' },
                        { name: 'Rottweiler', size: 'Large', temperament: 'Loyal, Confident', lifespan: '9-10 years' },
                        { name: 'Siberian Husky', size: 'Large', temperament: 'Loyal, Mischievous', lifespan: '12-14 years' },
                        { name: 'Chihuahua', size: 'Small', temperament: 'Graceful, Alert', lifespan: '14-16 years' }
                    ]
                },
                'cats': {
                    name: 'Cats',
                    icon: 'üê±',
                    breeds: [
                        { name: 'Persian', size: 'Medium', temperament: 'Quiet, Sweet', lifespan: '10-17 years' },
                        { name: 'Maine Coon', size: 'Large', temperament: 'Gentle, Friendly', lifespan: '13-14 years' },
                        { name: 'British Shorthair', size: 'Medium', temperament: 'Calm, Easy-going', lifespan: '12-20 years' },
                        { name: 'Siamese', size: 'Medium', temperament: 'Active, Vocal', lifespan: '15-20 years' },
                        { name: 'Ragdoll', size: 'Large', temperament: 'Calm, Affectionate', lifespan: '12-17 years' },
                        { name: 'Scottish Fold', size: 'Medium', temperament: 'Sweet, Easy-going', lifespan: '11-15 years' },
                        { name: 'Sphynx', size: 'Medium', temperament: 'Energetic, Curious', lifespan: '8-14 years' },
                        { name: 'Abyssinian', size: 'Medium', temperament: 'Active, Playful', lifespan: '9-15 years' },
                        { name: 'Russian Blue', size: 'Medium', temperament: 'Quiet, Shy', lifespan: '15-20 years' },
                        { name: 'Bengal', size: 'Large', temperament: 'Active, Playful', lifespan: '12-16 years' }
                    ]
                },
                'birds': {
                    name: 'Birds',
                    icon: 'üê¶',
                    species: [
                        { name: 'Budgerigar (Budgie)', size: 'Small', temperament: 'Social, Playful', lifespan: '5-10 years' },
                        { name: 'Cockatiel', size: 'Small', temperament: 'Gentle, Affectionate', lifespan: '10-15 years' },
                        { name: 'Canary', size: 'Small', temperament: 'Active, Musical', lifespan: '10-15 years' },
                        { name: 'Lovebird', size: 'Small', temperament: 'Social, Active', lifespan: '10-15 years' },
                        { name: 'Cockatoo', size: 'Large', temperament: 'Intelligent, Demanding', lifespan: '40-60 years' },
                        { name: 'African Grey Parrot', size: 'Medium', temperament: 'Intelligent, Talkative', lifespan: '40-60 years' },
                        { name: 'Macaw', size: 'Large', temperament: 'Social, Intelligent', lifespan: '50-80 years' },
                        { name: 'Conure', size: 'Medium', temperament: 'Playful, Social', lifespan: '15-30 years' },
                        { name: 'Finch', size: 'Small', temperament: 'Active, Social', lifespan: '5-10 years' },
                        { name: 'Zebra Finch', size: 'Small', temperament: 'Active, Hardy', lifespan: '5-7 years' }
                    ]
                },
                'fish': {
                    name: 'Fish',
                    icon: 'üê†',
                    species: [
                        { name: 'Goldfish', size: 'Small', temperament: 'Peaceful', lifespan: '10-30 years' },
                        { name: 'Betta Fish', size: 'Small', temperament: 'Territorial', lifespan: '2-3 years' },
                        { name: 'Guppy', size: 'Small', temperament: 'Peaceful', lifespan: '1-3 years' },
                        { name: 'Angelfish', size: 'Medium', temperament: 'Semi-aggressive', lifespan: '10-12 years' },
                        { name: 'Neon Tetra', size: 'Small', temperament: 'Peaceful', lifespan: '5-8 years' },
                        { name: 'Discus', size: 'Medium', temperament: 'Peaceful', lifespan: '10-15 years' },
                        { name: 'Oscar', size: 'Large', temperament: 'Aggressive', lifespan: '10-18 years' },
                        { name: 'Molly', size: 'Small', temperament: 'Peaceful', lifespan: '3-5 years' },
                        { name: 'Platy', size: 'Small', temperament: 'Peaceful', lifespan: '2-3 years' },
                        { name: 'Swordtail', size: 'Small', temperament: 'Peaceful', lifespan: '3-5 years' }
                    ]
                },
                'other_pets': {
                    name: 'Other Pets',
                    icon: 'üêæ',
                    species: [
                        { name: 'Rabbit', size: 'Small', temperament: 'Gentle, Social', lifespan: '8-12 years' },
                        { name: 'Hamster', size: 'Small', temperament: 'Active, Nocturnal', lifespan: '2-3 years' },
                        { name: 'Guinea Pig', size: 'Small', temperament: 'Social, Gentle', lifespan: '4-8 years' },
                        { name: 'Chinchilla', size: 'Small', temperament: 'Active, Playful', lifespan: '10-20 years' },
                        { name: 'Ferret', size: 'Small', temperament: 'Playful, Curious', lifespan: '6-10 years' },
                        { name: 'Hedgehog', size: 'Small', temperament: 'Solitary, Nocturnal', lifespan: '3-6 years' },
                        { name: 'Turtle', size: 'Medium', temperament: 'Calm, Long-lived', lifespan: '20-40 years' },
                        { name: 'Iguana', size: 'Large', temperament: 'Docile, Arboreal', lifespan: '15-20 years' },
                        { name: 'Snake', size: 'Medium', temperament: 'Calm, Low-maintenance', lifespan: '10-30 years' },
                        { name: 'Tarantula', size: 'Small', temperament: 'Docile, Low-maintenance', lifespan: '5-20 years' }
                    ]
                }
            };

            console.log('Global agricultural database initialized successfully');
        }

        // Initialize weather service
        function initializeWeatherService() {
            // Auto-migrate any cached Fiji locations to Australia
            try {
                const savedLocation = localStorage.getItem('smartfarm_user_location');
                if (savedLocation) {
                    const location = JSON.parse(savedLocation);
                    if ((location.name && (location.name.includes('Fiji') || location.name.includes('Suva'))) ||
                        (location.lat === -18.1248 && location.lng === 178.4501)) {
                        console.log('üîÑ Auto-migrating cached Fiji location to Australia');
                        const newLocation = {
                            lat: -33.8688,
                            lng: 151.2093,
                            name: 'Sydney, NSW, Australia'
                        };
                        localStorage.setItem('smartfarm_user_location', JSON.stringify(newLocation));
                    }
                }
            } catch (e) {
                console.warn('Error migrating location:', e);
            }
            
            if (window.WeatherService) {
                weatherService = window.WeatherService;
                
                // Subscribe to weather updates
                weatherService.subscribe((weatherData) => {
                    updateLocationDisplay(weatherData);
                });
                
                // Update location display immediately if data is available
                if (weatherService.weatherData) {
                    updateLocationDisplay(weatherService.weatherData);
                }
                
                console.log('‚úÖ Weather Service initialized');
            } else {
                console.warn('‚ö†Ô∏è Weather Service not available');
                updateLocationDisplay({ location: { name: 'Australia' }, source: 'Demo' });
            }
        }

        // Update location display in navbar
        function updateLocationDisplay(weatherData) {
            const locationDisplay = document.getElementById('currentLocationDisplay');
            if (locationDisplay && weatherData) {
                const locationName = weatherData.location?.name || 'Unknown';
                const isRealData = weatherData.source === 'OpenWeatherMap';
                
                locationDisplay.innerHTML = `
                    ${locationName}
                    <span class="badge ${isRealData ? 'bg-success' : 'bg-warning'} ms-1" style="font-size: 0.7rem;">
                        ${isRealData ? 'Live' : 'Demo'}
                    </span>
                `;
            }
        }

        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Global JavaScript Error:', e.error);
            console.error('Error details:', {
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno,
                stack: e.error ? e.error.stack : 'No stack trace'
            });
            
            // Show user-friendly error message for navigation errors
            if (e.message.includes('showDashboard') || e.message.includes('showFarm') || 
                e.message.includes('showCrop') || e.message.includes('showLivestock') ||
                e.message.includes('showPets') || e.message.includes('showInventory') ||
                e.message.includes('showAnalytics') || e.message.includes('showTasks') ||
                e.message.includes('showReports')) {
                console.error('Navigation function error detected. Please refresh the page.');
            }
        });

        // Function to verify all required functions are defined
        function verifyRequiredFunctions() {
            const requiredFunctions = [
                'showView',
                'setActiveNav',
                'updateURL',
                'showDashboard',
                'showFarmManagement',
                'showCropManagement',
                'showLivestockManagement',
                'showPetsManagement',
                'showInventoryManagement',
                'showAnalytics',
                'showTasks',
                'showReports'
            ];
            
            const missingFunctions = [];
            requiredFunctions.forEach(funcName => {
                if (typeof window[funcName] !== 'function') {
                    missingFunctions.push(funcName);
                }
            });
            
            if (missingFunctions.length > 0) {
                console.error('Missing required functions:', missingFunctions);
                return false;
            } else {
                console.log('All required functions are defined');
                return true;
            }
        }

        // Navigation test function
        function testNavigation() {
            console.log('Testing navigation functions...');
            const navTests = [
                { name: 'Dashboard', func: 'showDashboard', view: 'dashboardView' },
                { name: 'Farm Management', func: 'showFarmManagement', view: 'farmManagementView' },
                { name: 'Crop Management', func: 'showCropManagement', view: 'cropManagementView' },
                { name: 'Livestock Management', func: 'showLivestockManagement', view: 'livestockManagementView' },
                { name: 'Pets Management', func: 'showPetsManagement', view: 'petsManagementView' },
                { name: 'Inventory Management', func: 'showInventoryManagement', view: 'inventoryManagementView' },
                { name: 'Analytics', func: 'showAnalytics', view: 'analyticsView' },
                { name: 'Tasks', func: 'showTasks', view: 'tasksView' },
                { name: 'Reports', func: 'showReports', view: 'reportsView' }
            ];

            navTests.forEach(test => {
                try {
                    // Test if function exists
                    if (typeof window[test.func] === 'function') {
                        console.log(`‚úÖ ${test.name}: Function exists`);
                        
                        // Test if view element exists
                        const viewElement = document.getElementById(test.view);
                        if (viewElement) {
                            console.log(`‚úÖ ${test.name}: View element exists`);
                        } else {
                            console.error(`‚ùå ${test.name}: View element '${test.view}' not found`);
                        }
                    } else {
                        console.error(`‚ùå ${test.name}: Function '${test.func}' not defined`);
                    }
                } catch (error) {
                    console.error(`‚ùå ${test.name}: Test failed - ${error.message}`);
                }
            });
        }

        // URL Routing System
        function updateURL(viewId) {
            try {
                const urlMap = {
                    'dashboardView': '/dashboard',
                    'farmManagementView': '/farm-management',
                    'cropManagementView': '/crop-management',
                    'livestockManagementView': '/livestock-management',
                    'petsManagementView': '/pets-management',
                    'inventoryManagementView': '/inventory-management',
                    'analyticsView': '/analytics',
                    'tasksView': '/tasks',
                    'reportsView': '/reports'
                };
                
                const path = urlMap[viewId] || '/dashboard';
                
                // Update URL without page reload
                if (history.pushState) {
                    history.pushState({view: viewId}, '', path);
                }
                
                console.log('URL updated to:', path);
            } catch (error) {
                console.error('Error updating URL:', error);
            }
        }

        // Initialize URL routing
        function initializeURLRouting() {
            try {
                // Handle browser back/forward buttons
                window.addEventListener('popstate', function(event) {
                    if (event.state && event.state.view) {
                        showView(event.state.view);
                    }
                });
                
                // Check current URL and show appropriate view
                const currentPath = window.location.pathname;
                const pathToView = {
                    '/dashboard': 'dashboardView',
                    '/farm-management': 'farmManagementView',
                    '/crop-management': 'cropManagementView',
                    '/livestock-management': 'livestockManagementView',
                    '/pets-management': 'petsManagementView',
                    '/inventory-management': 'inventoryManagementView',
                    '/analytics': 'analyticsView',
                    '/tasks': 'tasksView',
                    '/reports': 'reportsView'
                };
                
                const viewId = pathToView[currentPath] || 'dashboardView';
                showView(viewId);
                
                console.log('URL routing initialized for path:', currentPath);
            } catch (error) {
                console.error('Error initializing URL routing:', error);
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // One-time migration: Clear any Fiji locations from localStorage
                try {
                    const savedLocation = localStorage.getItem('smartfarm_user_location');
                    if (savedLocation) {
                        const location = JSON.parse(savedLocation);
                        if ((location.name && (location.name.includes('Fiji') || location.name.includes('Suva'))) ||
                            (location.lat === -18.1248 && location.lng === 178.4501)) {
                            console.log('üîÑ Clearing cached Fiji location - will default to Australia');
                            localStorage.removeItem('smartfarm_user_location');
                            // Force WeatherService to use Australia default
                            if (window.WeatherService && window.WeatherService.currentLocation) {
                                if (window.WeatherService.currentLocation.name && window.WeatherService.currentLocation.name.includes('Fiji')) {
                                    window.WeatherService.currentLocation = { lat: -33.8688, lng: 151.2093, name: 'Sydney, NSW, Australia' };
                                    window.WeatherService.saveLocationPreference(window.WeatherService.currentLocation);
                                }
                            }
                        }
                    }
                } catch (migrateError) {
                    console.warn('Location migration error:', migrateError);
                }
                
                // Verify all required functions are defined
                verifyRequiredFunctions();
                
                // Test navigation functions
                testNavigation();
                testNavigationFunctions(); // Test navigation functions and DOM elements
                
                // Initialize statistics with error handling
                try {
                    updateCropStatistics();
                } catch (error) {
                    console.warn('Warning: Could not update crop statistics:', error);
                }
                
                try {
                    updateLivestockStatistics();
                } catch (error) {
                    console.warn('Warning: Could not update livestock statistics:', error);
                }
                
                // Initialize modal accessibility
                try {
                    if (window.fixAllModalAccessibility) {
                        window.fixAllModalAccessibility();
                    }
                } catch (error) {
                    console.warn('Warning: Could not initialize modal accessibility:', error);
                }
                
                // Initialize core components with error handling
                try {
                    initializeGlobalDatabase();
                    initializeDashboard();
                    initializeWeatherService();
                    updateLastUpdated();
                    setInterval(updateLastUpdated, 60000); // Update every minute
                } catch (error) {
                    console.warn('Warning: Could not initialize core components:', error);
                }
                
                console.log('Dashboard initialized successfully');
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                // Don't throw - let the dashboard continue to function
            }
            
            // Initialize URL routing with error handling
            try {
                initializeURLRouting();
            } catch (error) {
                console.warn('Warning: Could not initialize URL routing:', error);
            }
            
            // Check API availability first
            try {
                const apiAvailable = await checkApiAvailability();
                if (!apiAvailable) {
                    console.warn('‚ö†Ô∏è API not available, using offline mode');
                    showApiUnavailableMessage();
                }
            } catch (error) {
                console.warn('Warning: Could not check API availability:', error);
            }
            
            // Load data from API with robust error handling
            try {
                await loadFarmData();
            } catch (error) {
                console.warn('Warning: Could not load farm data:', error);
                // Set fallback values
                safeText('#farm-count', '0');
            }
            
            try {
                await loadCropsData();
            } catch (error) {
                console.warn('Warning: Could not load crops data:', error);
            }
            
            try {
                await loadLivestockData();
            } catch (error) {
                console.warn('Warning: Could not load livestock data:', error);
                // Set fallback values
                safeText('#livestock-count', '0');
                safeText('#healthyAnimals', '0');
                safeText('#totalValue', '0');
            }
            
                // Initialize ads
                initializeAds();
                
                // Signal successful initialization
                window.dispatchEvent(new CustomEvent('dashboardInitialized'));
            });
        
        // Initialize ads function
        function initializeAds() {
            if (typeof adsProvider !== 'undefined') {
                console.log('üì¢ Initializing ads...');
                
                // Insert sidebar ads
                setTimeout(() => {
                    adsProvider.insertSidebarAds();
                }, 2000); // Delay to ensure page is loaded
                
                // Insert content ads
                setTimeout(() => {
                    adsProvider.insertContentAds();
                }, 3000);
                
                console.log('‚úÖ Ads initialized');
            } else {
                console.warn('‚ö†Ô∏è Ads provider not available');
            }
        }
        
        // Initialize QR Traceability System
        if (typeof QRTraceability !== 'undefined') {
            window.qrTraceability = new QRTraceability();
            console.log('‚úÖ QR Traceability System initialized');
        } else {
            console.log('‚ö†Ô∏è QR Traceability System not available');
        }
        
        // Initialize Weeding Task Synchronization
        initializeWeedingTaskSync();
        
        // QR Code Library Helper Functions
        /**
         * Check if QR Code library is available
         * Since we're hosting locally, this should always be available
         * @returns {boolean} - True if library is loaded
         */
        function isQRCodeLibraryAvailable() {
            if (typeof QRCode !== 'undefined') {
                return true;
            }
            console.error('‚ùå QR Code library not available. Check that js/qrcode.min.js exists and is accessible.');
            return false;
        }
        
        /**
         * Wait for QR Code library to load (simplified for local hosting)
         * @param {number} maxWaitTime - Maximum time to wait in milliseconds
         * @returns {Promise<boolean>} - True if library loaded, false if timeout
         */
        async function waitForQRCodeLibrary(maxWaitTime = 2000) {
            // If already loaded, return immediately
            if (typeof QRCode !== 'undefined') {
                return true;
            }
            
            // For local hosting, library should load quickly
            const startTime = Date.now();
            
            return new Promise((resolve) => {
                const checkInterval = setInterval(() => {
                    if (typeof QRCode !== 'undefined') {
                        clearInterval(checkInterval);
                        console.log('‚úÖ QR Code library loaded');
                        resolve(true);
                    } else if (Date.now() - startTime >= maxWaitTime) {
                        clearInterval(checkInterval);
                        console.error('‚ùå QR Code library load timeout - check file exists at js/qrcode.min.js');
                        resolve(false);
                    }
                }, 50); // Check more frequently since it's local
            });
        }
        
        // QR Code Generator Functions
        async function generateQRCode() {
            try {
                // Check if QR Code library is available (should always be available with local hosting)
                if (typeof QRCode === 'undefined') {
                    console.error('‚ùå QR Code library not loaded');
                    
                    // Wait briefly in case script is still loading
                    await waitForQRCodeLibrary(1000);
                    
                    if (typeof QRCode === 'undefined') {
                        showErrorDialog(
                            'QR Code Library Not Available', 
                            'The QR Code library file (js/qrcode.min.js) is missing or not accessible. ' +
                            'Please ensure the file exists in the /js/ directory and refresh the page. ' +
                            'If you are a developer, download the library from: https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js'
                        );
                        return;
                    }
                }
                
                // Check if QR Traceability system is available
                if (typeof qrTraceability !== 'undefined' && qrTraceability && typeof qrTraceability.generateQRCode === 'function') {
                    qrTraceability.generateQRCode();
                } else {
                    // Fallback: Try to generate QR code directly if QRCode library is available
                    if (typeof QRCode !== 'undefined') {
                        const productSelect = document.getElementById('productSelect');
                        const qrCodeDisplay = document.getElementById('qrCodeDisplay');
                        
                        if (!productSelect || !qrCodeDisplay) {
                            showErrorDialog('QR Code Generator', 'Product selector or QR code display area not found. Please refresh the page.');
                            return;
                        }
                        
                        const selectedProductId = productSelect.value;
                        if (!selectedProductId) {
                            showErrorDialog('No Product Selected', 'Please select a product first before generating a QR code.');
                            return;
                        }
                        
                        // Get product data
                        const selectedOption = productSelect.options[productSelect.selectedIndex];
                        const productName = selectedOption.text || 'Product';
                        
                        // Generate traceability URL
                        const traceabilityURL = `${window.location.origin}/traceability.html?product=${selectedProductId}`;
                        
                        // Clear previous QR code
                        qrCodeDisplay.innerHTML = '';
                        
                        // Generate QR code using QRCode library
                        QRCode.toCanvas(qrCodeDisplay, traceabilityURL, {
                            width: 200,
                            height: 200,
                            color: {
                                dark: '#000000',
                                light: '#FFFFFF'
                            },
                            margin: 2
                        }, (error) => {
                            if (error) {
                                console.error('QR Code generation error:', error);
                                showErrorDialog('QR Code Generation Failed', `Failed to generate QR code: ${error.message}. Please try again.`);
                                qrCodeDisplay.innerHTML = '<p class="text-danger">Error generating QR code</p>';
                            } else {
                                // Add product info below QR code
                                const infoDiv = document.createElement('div');
                                infoDiv.className = 'mt-3';
                                infoDiv.innerHTML = `
                                    <p class="mb-1"><strong>Product:</strong> ${productName}</p>
                                    <p class="mb-1"><strong>Traceability URL:</strong></p>
                                    <p class="small text-break"><a href="${traceabilityURL}" target="_blank">${traceabilityURL}</a></p>
                                `;
                                qrCodeDisplay.appendChild(infoDiv);
                                showAlert('QR Code generated successfully!', 'success');
                            }
                        });
                    } else {
                        // QR Code library not loaded
                        showErrorDialog('QR System Not Available', 'The QR Code library is not loaded. Please refresh the page and try again.');
                    }
                }
            } catch (error) {
                console.error('Error in generateQRCode:', error);
                showErrorDialog('QR Code Generation Error', `An error occurred while generating the QR code: ${error.message}. Please try again.`);
            }
        }

        function downloadAllQRCodes() {
            if (typeof smartFarm !== 'undefined' && smartFarm && typeof smartFarm.downloadAllQRCodes === 'function') {
                smartFarm.downloadAllQRCodes();
            } else if (typeof qrTraceability !== 'undefined' && qrTraceability) {
                // Fallback: try to use qrTraceability if available
                showErrorDialog('Download Feature', 'Download all QR codes feature is not available. Please use the individual product download option.');
            } else {
                showErrorDialog('Feature Not Available', 'The download all QR codes feature is not loaded. Please refresh the page and try again.');
            }
        }

        function printAllQRCodes() {
            if (typeof smartFarm !== 'undefined' && smartFarm && typeof smartFarm.printAllQRCodes === 'function') {
                smartFarm.printAllQRCodes();
            } else if (typeof qrTraceability !== 'undefined' && qrTraceability) {
                // Fallback: try to use qrTraceability if available
                showErrorDialog('Print Feature', 'Print all QR codes feature is not available. Please use the individual product print option.');
            } else {
                showErrorDialog('Feature Not Available', 'The print all QR codes feature is not loaded. Please refresh the page and try again.');
            }
        }

        // Auto-generate QR code for newly created product
        function autoGenerateQRCode(productData) {
            if (typeof qrTraceability !== 'undefined' && qrTraceability) {
                // Add the new product to the QR system
                qrTraceability.addProduct(productData);
                
                // Update the product selector
                qrTraceability.updateProductSelector();
                
                // Auto-select the new product
                const productSelect = document.getElementById('productSelect');
                if (productSelect) {
                    productSelect.value = productData.id;
                    
                    // Generate QR code automatically
                    setTimeout(() => {
                        qrTraceability.generateQRCode();
                        showQRCodeGenerationModal(productData);
                    }, 500);
                }
            }
        }

        function showQRCodeGenerationModal(productData) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-qrcode me-2"></i>QR Code Generated Successfully!
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Product Information</h6>
                                    <p><strong>Product:</strong> ${productData.name}</p>
                                    <p><strong>Batch Number:</strong> ${productData.batchNumber}</p>
                                    <p><strong>Location:</strong> ${productData.location}</p>
                                    <p><strong>Farmer:</strong> ${productData.farmer}</p>
                                    <p><strong>Harvest Date:</strong> ${productData.harvestDate}</p>
                                    <p><strong>Certifications:</strong> ${productData.certifications.join(', ')}</p>
                                </div>
                                <div class="col-md-6">
                                    <div id="qrCodePreview" class="text-center">
                                        <p class="text-muted">QR Code will appear here...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Traceability URL:</strong> <span id="traceabilityUrl">Generating...</span>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="downloadQRCode('${productData.id}')">
                                <i class="fas fa-download me-1"></i>Download QR Code
                            </button>
                            <button type="button" class="btn btn-success" onclick="printQRCode('${productData.id}')">
                                <i class="fas fa-print me-1"></i>Print QR Code
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Generate QR code for preview
            setTimeout(() => {
                generateQRCodePreview(productData, modal);
            }, 1000);
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        async function generateQRCodePreview(productData, modal) {
            const traceabilityURL = `https://smartfarm-app.com/traceability?product=${productData.id}&batch=${productData.batchNumber}`;
            
            // Update traceability URL
            const urlElement = modal.querySelector('#traceabilityUrl');
            if (urlElement) {
                urlElement.textContent = traceabilityURL;
            }
            
            // Ensure QR Code library is loaded
            if (typeof QRCode === 'undefined') {
                await waitForQRCodeLibrary(3000);
            }
            
            // Generate QR code
            if (typeof QRCode !== 'undefined') {
                const qrContainer = modal.querySelector('#qrCodePreview');
                qrContainer.innerHTML = '';
                
                QRCode.toCanvas(qrContainer, traceabilityURL, {
                    width: 200,
                    height: 200,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                }, (error) => {
                    if (error) {
                        console.error('QR Code generation error:', error);
                        qrContainer.innerHTML = '<p class="text-danger">Error generating QR code</p>';
                    } else {
                        console.log('QR Code generated successfully');
                    }
                });
            } else {
                const qrContainer = modal.querySelector('#qrCodePreview');
                qrContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        QR Code library not loaded. Please refresh the page and try again.
                    </div>
                `;
            }
        }

        function downloadQRCode(productId) {
            try {
                if (typeof qrTraceability !== 'undefined' && qrTraceability && typeof qrTraceability.downloadQRCode === 'function') {
                    qrTraceability.downloadQRCode(productId);
                } else {
                    showErrorDialog('Download Failed', 'QR Code system not available for download. Please refresh the page and try again.');
                }
            } catch (error) {
                console.error('Error downloading QR code:', error);
                showErrorDialog('Download Error', `Failed to download QR code: ${error.message}. Please try again.`);
            }
        }

        function printQRCode(productId) {
            try {
                if (typeof qrTraceability !== 'undefined' && qrTraceability && typeof qrTraceability.printQRCode === 'function') {
                    qrTraceability.printQRCode(productId);
                } else {
                    showErrorDialog('Print Failed', 'QR Code system not available for printing. Please refresh the page and try again.');
                }
            } catch (error) {
                console.error('Error printing QR code:', error);
                showErrorDialog('Print Error', `Failed to print QR code: ${error.message}. Please try again.`);
            }
        }

        function showQRCodeOptions() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-cog me-2"></i>QR Code Options
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Quick Actions</h6>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary" onclick="generateQRCode()">
                                            <i class="fas fa-qrcode me-2"></i>Generate QR Code
                                        </button>
                                        <button class="btn btn-success" onclick="downloadAllQRCodes()">
                                            <i class="fas fa-download me-2"></i>Download All QR Codes
                                        </button>
                                        <button class="btn btn-warning" onclick="printAllQRCodes()">
                                            <i class="fas fa-print me-2"></i>Print All QR Codes
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>Product Management</h6>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-info" onclick="addNewProduct()">
                                            <i class="fas fa-plus me-2"></i>Add New Product
                                        </button>
                                        <button class="btn btn-secondary" onclick="viewAllProducts()">
                                            <i class="fas fa-list me-2"></i>View All Products
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="refreshProductList()">
                                            <i class="fas fa-sync me-2"></i>Refresh List
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Tip:</strong> QR codes contain traceability URLs that link to detailed product information including harvest date, location, farmer details, and certifications.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        // Identification & Diagnosis Functions
        function startCropIdentification() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-seedling me-2"></i>Crop Issue Identification
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="identification-form">
                                        <h6 class="text-success mb-3">
                                            <i class="fas fa-clipboard-list me-2"></i>Describe the Issue
                                        </h6>
                                        <div class="mb-3">
                                            <label class="form-label">Crop Type</label>
                                            <select class="form-select" id="cropType">
                                                <option value="">Select crop type...</option>
                                                <option value="tomato">Tomato</option>
                                                <option value="lettuce">Lettuce</option>
                                                <option value="corn">Corn</option>
                                                <option value="wheat">Wheat</option>
                                                <option value="potato">Potato</option>
                                                <option value="carrot">Carrot</option>
                                                <option value="pepper">Pepper</option>
                                                <option value="cucumber">Cucumber</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Symptoms</label>
                                            <select class="form-select" id="cropSymptoms">
                                                <option value="">Select symptoms...</option>
                                                <option value="yellow-leaves">Yellow leaves</option>
                                                <option value="brown-spots">Brown spots on leaves</option>
                                                <option value="wilting">Wilting plants</option>
                                                <option value="stunted-growth">Stunted growth</option>
                                                <option value="holes-leaves">Holes in leaves</option>
                                                <option value="white-powder">White powdery coating</option>
                                                <option value="black-spots">Black spots</option>
                                                <option value="curling-leaves">Curling leaves</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Affected Area</label>
                                            <select class="form-select" id="affectedArea">
                                                <option value="">Select area...</option>
                                                <option value="leaves">Leaves</option>
                                                <option value="stems">Stems</option>
                                                <option value="roots">Roots</option>
                                                <option value="fruits">Fruits</option>
                                                <option value="flowers">Flowers</option>
                                                <option value="entire-plant">Entire plant</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Additional Notes</label>
                                            <textarea class="form-control" id="cropNotes" rows="3" placeholder="Describe any other observations..."></textarea>
                                        </div>
                                        <button class="btn btn-success w-100" onclick="analyzeCropIssue()">
                                            <i class="fas fa-search me-2"></i>Analyze Issue
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="identification-results" id="cropResults" style="display: none;">
                                        <h6 class="text-primary mb-3">
                                            <i class="fas fa-diagnosis me-2"></i>Analysis Results
                                        </h6>
                                        <div id="cropAnalysisContent">
                                            <!-- Analysis results will be displayed here -->
                                        </div>
                                    </div>
                                    <div class="identification-guide" id="cropGuide">
                                        <h6 class="text-info mb-3">
                                            <i class="fas fa-book me-2"></i>Quick Guide
                                        </h6>
                                        <div class="guide-content">
                                            <p><strong>Common Issues:</strong></p>
                                            <ul class="list-unstyled">
                                                <li><i class="fas fa-arrow-right text-success me-2"></i>Yellow leaves: Nutrient deficiency or overwatering</li>
                                                <li><i class="fas fa-arrow-right text-warning me-2"></i>Brown spots: Fungal disease or sunburn</li>
                                                <li><i class="fas fa-arrow-right text-danger me-2"></i>Wilting: Underwatering or root rot</li>
                                                <li><i class="fas fa-arrow-right text-info me-2"></i>Holes in leaves: Pest damage</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-success" onclick="showCropDiseaseGuide()">
                                <i class="fas fa-book me-1"></i>Disease Guide
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function analyzeCropIssue() {
            const cropType = document.getElementById('cropType').value;
            const symptoms = document.getElementById('cropSymptoms').value;
            const affectedArea = document.getElementById('affectedArea').value;
            const notes = document.getElementById('cropNotes').value;

            if (!cropType || !symptoms) {
                showErrorMessage('Please select both crop type and symptoms for analysis.');
                return;
            }

            // Show loading
            const resultsDiv = document.getElementById('cropResults');
            const analysisContent = document.getElementById('cropAnalysisContent');
            resultsDiv.style.display = 'block';
            analysisContent.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><br>Analyzing issue...</div>';

            // Simulate analysis delay
            setTimeout(() => {
                const analysis = getCropAnalysis(cropType, symptoms, affectedArea, notes);
                analysisContent.innerHTML = analysis;
            }, 2000);
        }

        function getCropAnalysis(cropType, symptoms, affectedArea, notes) {
            const analysisDatabase = {
                'yellow-leaves': {
                    likelyCause: 'Nutrient Deficiency or Overwatering',
                    severity: 'Medium',
                    treatment: [
                        'Check soil pH and nutrient levels',
                        'Reduce watering frequency if overwatering',
                        'Apply balanced fertilizer (NPK 10-10-10)',
                        'Ensure proper drainage'
                    ],
                    prevention: [
                        'Regular soil testing',
                        'Proper watering schedule',
                        'Crop rotation',
                        'Organic matter addition'
                    ]
                },
                'brown-spots': {
                    likelyCause: 'Fungal Disease or Sunburn',
                    severity: 'High',
                    treatment: [
                        'Remove affected leaves immediately',
                        'Apply fungicide (copper-based)',
                        'Improve air circulation',
                        'Avoid overhead watering'
                    ],
                    prevention: [
                        'Proper spacing between plants',
                        'Morning watering only',
                        'Regular fungicide application',
                        'Remove plant debris'
                    ]
                },
                'wilting': {
                    likelyCause: 'Underwatering or Root Rot',
                    severity: 'High',
                    treatment: [
                        'Check soil moisture levels',
                        'Water deeply but infrequently',
                        'Check for root damage',
                        'Apply root treatment if needed'
                    ],
                    prevention: [
                        'Consistent watering schedule',
                        'Well-draining soil',
                        'Proper irrigation system',
                        'Monitor soil moisture'
                    ]
                },
                'holes-leaves': {
                    likelyCause: 'Pest Damage',
                    severity: 'Medium',
                    treatment: [
                        'Identify specific pest',
                        'Apply appropriate pesticide',
                        'Use organic alternatives (neem oil)',
                        'Hand-pick larger pests'
                    ],
                    prevention: [
                        'Regular pest monitoring',
                        'Companion planting',
                        'Physical barriers',
                        'Beneficial insects'
                    ]
                }
            };

            const analysis = analysisDatabase[symptoms] || {
                likelyCause: 'Unknown Issue',
                severity: 'Unknown',
                treatment: ['Consult with agricultural expert', 'Take detailed photos', 'Test soil samples'],
                prevention: ['Regular monitoring', 'Proper care practices']
            };

            return `
                <div class="analysis-result">
                    <div class="alert alert-${analysis.severity === 'High' ? 'danger' : analysis.severity === 'Medium' ? 'warning' : 'info'}">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Likely Cause: ${analysis.likelyCause}</h6>
                        <p class="mb-0">Severity: <span class="badge bg-${analysis.severity === 'High' ? 'danger' : analysis.severity === 'Medium' ? 'warning' : 'info'}">${analysis.severity}</span></p>
                    </div>
                    
                    <div class="treatment-section">
                        <h6 class="text-success"><i class="fas fa-medkit me-2"></i>Treatment Steps:</h6>
                        <ol class="treatment-list">
                            ${analysis.treatment.map(step => `<li>${step}</li>`).join('')}
                        </ol>
                    </div>
                    
                    <div class="prevention-section">
                        <h6 class="text-info"><i class="fas fa-shield-alt me-2"></i>Prevention Tips:</h6>
                        <ul class="prevention-list">
                            ${analysis.prevention.map(tip => `<li>${tip}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="alert alert-light mt-3">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>Pro Tip:</strong> For accurate diagnosis, consider taking photos and consulting with local agricultural extension services.
                    </div>
                </div>
            `;
        }

        function startLivestockDiagnosis() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-stethoscope me-2"></i>Livestock Health Diagnosis
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="diagnosis-form">
                                        <h6 class="text-info mb-3">
                                            <i class="fas fa-clipboard-list me-2"></i>Animal Information
                                        </h6>
                                        <div class="mb-3">
                                            <label class="form-label">Animal Type</label>
                                            <select class="form-select" id="animalType">
                                                <option value="">Select animal type...</option>
                                                <option value="cattle">Cattle</option>
                                                <option value="pigs">Pigs</option>
                                                <option value="sheep">Sheep</option>
                                                <option value="goats">Goats</option>
                                                <option value="chickens">Chickens</option>
                                                <option value="ducks">Ducks</option>
                                                <option value="horses">Horses</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Age</label>
                                            <select class="form-select" id="animalAge">
                                                <option value="">Select age...</option>
                                                <option value="young">Young (0-6 months)</option>
                                                <option value="adult">Adult (6 months - 2 years)</option>
                                                <option value="mature">Mature (2+ years)</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Symptoms</label>
                                            <select class="form-select" id="animalSymptoms">
                                                <option value="">Select symptoms...</option>
                                                <option value="lethargy">Lethargy/Weakness</option>
                                                <option value="fever">Fever/High temperature</option>
                                                <option value="loss-appetite">Loss of appetite</option>
                                                <option value="diarrhea">Diarrhea</option>
                                                <option value="coughing">Coughing/Sneezing</option>
                                                <option value="lameness">Lameness</option>
                                                <option value="discharge">Nasal/Eye discharge</option>
                                                <option value="behavioral">Behavioral changes</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Duration</label>
                                            <select class="form-select" id="symptomDuration">
                                                <option value="">Select duration...</option>
                                                <option value="acute">Acute (0-24 hours)</option>
                                                <option value="subacute">Subacute (1-3 days)</option>
                                                <option value="chronic">Chronic (3+ days)</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Additional Observations</label>
                                            <textarea class="form-control" id="animalNotes" rows="3" placeholder="Describe any other observations..."></textarea>
                                        </div>
                                        <button class="btn btn-info w-100" onclick="analyzeLivestockIssue()">
                                            <i class="fas fa-stethoscope me-2"></i>Diagnose Issue
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="diagnosis-results" id="livestockResults" style="display: none;">
                                        <h6 class="text-primary mb-3">
                                            <i class="fas fa-diagnosis me-2"></i>Diagnosis Results
                                        </h6>
                                        <div id="livestockAnalysisContent">
                                            <!-- Analysis results will be displayed here -->
                                        </div>
                                    </div>
                                    <div class="diagnosis-guide" id="livestockGuide">
                                        <h6 class="text-info mb-3">
                                            <i class="fas fa-heartbeat me-2"></i>Health Guide
                                        </h6>
                                        <div class="guide-content">
                                            <p><strong>Common Issues:</strong></p>
                                            <ul class="list-unstyled">
                                                <li><i class="fas fa-arrow-right text-danger me-2"></i>Lethargy: Possible infection or nutritional issue</li>
                                                <li><i class="fas fa-arrow-right text-warning me-2"></i>Fever: Bacterial or viral infection</li>
                                                <li><i class="fas fa-arrow-right text-info me-2"></i>Loss of appetite: Digestive or stress-related</li>
                                                <li><i class="fas fa-arrow-right text-success me-2"></i>Diarrhea: Parasitic or dietary issue</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-info" onclick="showLivestockHealthGuide()">
                                <i class="fas fa-heartbeat me-1"></i>Health Guide
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function analyzeLivestockIssue() {
            const animalType = document.getElementById('animalType').value;
            const age = document.getElementById('animalAge').value;
            const symptoms = document.getElementById('animalSymptoms').value;
            const duration = document.getElementById('symptomDuration').value;
            const notes = document.getElementById('animalNotes').value;

            if (!animalType || !symptoms) {
                showErrorMessage('Please select both animal type and symptoms for diagnosis.');
                return;
            }

            // Show loading
            const resultsDiv = document.getElementById('livestockResults');
            const analysisContent = document.getElementById('livestockAnalysisContent');
            resultsDiv.style.display = 'block';
            analysisContent.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><br>Analyzing health issue...</div>';

            // Simulate analysis delay
            setTimeout(() => {
                const analysis = getLivestockAnalysis(animalType, age, symptoms, duration, notes);
                analysisContent.innerHTML = analysis;
            }, 2000);
        }

        function getLivestockAnalysis(animalType, age, symptoms, duration, notes) {
            const analysisDatabase = {
                'lethargy': {
                    likelyCause: 'Infection or Nutritional Deficiency',
                    severity: 'High',
                    treatment: [
                        'Isolate the animal immediately',
                        'Check temperature and vital signs',
                        'Provide fresh water and quality feed',
                        'Consult veterinarian if severe'
                    ],
                    prevention: [
                        'Regular health monitoring',
                        'Balanced nutrition',
                        'Clean living environment',
                        'Vaccination schedule'
                    ]
                },
                'fever': {
                    likelyCause: 'Bacterial or Viral Infection',
                    severity: 'High',
                    treatment: [
                        'Isolate immediately',
                        'Monitor temperature regularly',
                        'Provide cool, clean water',
                        'Contact veterinarian urgently'
                    ],
                    prevention: [
                        'Proper vaccination',
                        'Clean environment',
                        'Quarantine new animals',
                        'Regular health checks'
                    ]
                },
                'loss-appetite': {
                    likelyCause: 'Digestive Issue or Stress',
                    severity: 'Medium',
                    treatment: [
                        'Check feed quality and freshness',
                        'Reduce stress factors',
                        'Provide clean water',
                        'Monitor for other symptoms'
                    ],
                    prevention: [
                        'Consistent feeding schedule',
                        'High-quality feed',
                        'Minimize stress',
                        'Regular health monitoring'
                    ]
                },
                'diarrhea': {
                    likelyCause: 'Parasitic or Dietary Issue',
                    severity: 'Medium',
                    treatment: [
                        'Provide electrolyte solution',
                        'Check for parasites',
                        'Review diet changes',
                        'Monitor hydration'
                    ],
                    prevention: [
                        'Regular deworming',
                        'Gradual diet changes',
                        'Clean water supply',
                        'Proper sanitation'
                    ]
                }
            };

            const analysis = analysisDatabase[symptoms] || {
                likelyCause: 'Unknown Health Issue',
                severity: 'Unknown',
                treatment: ['Consult with veterinarian', 'Monitor closely', 'Isolate if necessary'],
                prevention: ['Regular health monitoring', 'Proper care practices']
            };

            return `
                <div class="analysis-result">
                    <div class="alert alert-${analysis.severity === 'High' ? 'danger' : analysis.severity === 'Medium' ? 'warning' : 'info'}">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Likely Cause: ${analysis.likelyCause}</h6>
                        <p class="mb-0">Severity: <span class="badge bg-${analysis.severity === 'High' ? 'danger' : analysis.severity === 'Medium' ? 'warning' : 'info'}">${analysis.severity}</span></p>
                    </div>
                    
                    <div class="treatment-section">
                        <h6 class="text-success"><i class="fas fa-medkit me-2"></i>Treatment Steps:</h6>
                        <ol class="treatment-list">
                            ${analysis.treatment.map(step => `<li>${step}</li>`).join('')}
                        </ol>
                    </div>
                    
                    <div class="prevention-section">
                        <h6 class="text-info"><i class="fas fa-shield-alt me-2"></i>Prevention Tips:</h6>
                        <ul class="prevention-list">
                            ${analysis.prevention.map(tip => `<li>${tip}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Important:</strong> This is a preliminary diagnosis. Always consult with a qualified veterinarian for proper medical treatment.
                    </div>
                </div>
            `;
        }

        function showCropDiseaseGuide() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-book me-2"></i>Crop Disease Identification Guide
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-danger">Fungal Diseases</h6>
                                    <div class="disease-list">
                                        <div class="disease-item">
                                            <strong>Powdery Mildew</strong>
                                            <p>White powdery coating on leaves</p>
                                            <span class="badge bg-warning">Medium Severity</span>
                                        </div>
                                        <div class="disease-item">
                                            <strong>Late Blight</strong>
                                            <p>Dark spots with water-soaked appearance</p>
                                            <span class="badge bg-danger">High Severity</span>
                                        </div>
                                        <div class="disease-item">
                                            <strong>Rust</strong>
                                            <p>Orange/yellow pustules on leaves</p>
                                            <span class="badge bg-warning">Medium Severity</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-info">Bacterial Diseases</h6>
                                    <div class="disease-list">
                                        <div class="disease-item">
                                            <strong>Bacterial Blight</strong>
                                            <p>Water-soaked lesions on leaves</p>
                                            <span class="badge bg-danger">High Severity</span>
                                        </div>
                                        <div class="disease-item">
                                            <strong>Crown Gall</strong>
                                            <p>Swollen growths on stems/roots</p>
                                            <span class="badge bg-warning">Medium Severity</span>
                                        </div>
                                        <div class="disease-item">
                                            <strong>Soft Rot</strong>
                                            <p>Mushy, foul-smelling tissue</p>
                                            <span class="badge bg-danger">High Severity</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function showLivestockHealthGuide() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-heartbeat me-2"></i>Livestock Health Guide
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-danger">Common Health Issues</h6>
                                    <div class="health-list">
                                        <div class="health-item">
                                            <strong>Mastitis</strong>
                                            <p>Inflammation of mammary gland</p>
                                            <span class="badge bg-danger">High Severity</span>
                                        </div>
                                        <div class="health-item">
                                            <strong>Foot Rot</strong>
                                            <p>Bacterial infection of hooves</p>
                                            <span class="badge bg-warning">Medium Severity</span>
                                        </div>
                                        <div class="health-item">
                                            <strong>Respiratory Issues</strong>
                                            <p>Coughing, nasal discharge</p>
                                            <span class="badge bg-warning">Medium Severity</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-success">Prevention Tips</h6>
                                    <div class="prevention-tips">
                                        <div class="tip-item">
                                            <i class="fas fa-check-circle text-success me-2"></i>
                                            Regular vaccination schedule
                                        </div>
                                        <div class="tip-item">
                                            <i class="fas fa-check-circle text-success me-2"></i>
                                            Clean, dry living environment
                                        </div>
                                        <div class="tip-item">
                                            <i class="fas fa-check-circle text-success me-2"></i>
                                            Balanced nutrition
                                        </div>
                                        <div class="tip-item">
                                            <i class="fas fa-check-circle text-success me-2"></i>
                                            Regular health monitoring
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function viewAllProducts() {
            if (typeof qrTraceability !== 'undefined' && qrTraceability) {
                const products = qrTraceability.products;
                
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-dialog-centered modal-xl">
                        <div class="modal-content border-0 shadow-lg">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-list me-2"></i>All Products (${products.length})
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    ${products.map(product => `
                                        <div class="col-md-6 mb-3">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h6 class="card-title">${product.name}</h6>
                                                    <p class="card-text">
                                                        <strong>Batch:</strong> ${product.batchNumber}<br>
                                                        <strong>Type:</strong> ${product.type}<br>
                                                        <strong>Harvest Date:</strong> ${product.harvestDate}<br>
                                                        <strong>Location:</strong> ${product.location || 'N/A'}<br>
                                                        <strong>Farmer:</strong> ${product.farmer || 'N/A'}
                                                    </p>
                                                    <div class="d-grid gap-2">
                                                        <button class="btn btn-primary btn-sm" onclick="generateQRForProduct('${product.id}')">
                                                            <i class="fas fa-qrcode me-1"></i>Generate QR
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                const bsModal = new bootstrap.Modal(modal);
                bsModal.show();
                
                modal.addEventListener('hidden.bs.modal', () => {
                    document.body.removeChild(modal);
                });
            }
        }

        function generateQRForProduct(productId) {
            // Close the current modal
            const currentModal = document.querySelector('.modal.show');
            if (currentModal) {
                const bsModal = bootstrap.Modal.getInstance(currentModal);
                bsModal.hide();
            }
            
            // Select the product in the dropdown
            const productSelect = document.getElementById('productSelect');
            if (productSelect) {
                productSelect.value = productId;
            }
            
            // Generate QR code
            setTimeout(() => {
                generateQRCode();
            }, 500);
        }

        function refreshProductList() {
            if (typeof qrTraceability !== 'undefined' && qrTraceability) {
                qrTraceability.updateProductSelector();
                showSuccessDialog('List Refreshed', 'Product list has been updated successfully.');
            }
        }
        
        function addNewProduct() {
            showAddProductModal();
        }
        
        function showAddProductModal() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-plus me-2"></i>Add New Product
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addProductForm">
                                <div class="mb-3">
                                    <label for="productName" class="form-label">Product Name</label>
                                    <input type="text" class="form-control" id="productName" placeholder="e.g., Organic Strawberries" required>
                                </div>
                                <div class="mb-3">
                                    <label for="batchNumber" class="form-label">Batch Number</label>
                                    <input type="text" class="form-control" id="batchNumber" placeholder="e.g., BATCH2024006" required>
                                </div>
                                <div class="mb-3">
                                    <label for="productType" class="form-label">Product Type</label>
                                    <select class="form-select" id="productType" required>
                                        <option value="">Select type...</option>
                                        <option value="vegetable">Vegetable</option>
                                        <option value="fruit">Fruit</option>
                                        <option value="dairy">Dairy</option>
                                        <option value="poultry">Poultry</option>
                                        <option value="grain">Grain</option>
                                        <option value="herb">Herb</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="harvestDate" class="form-label">Harvest Date</label>
                                    <input type="date" class="form-control" id="harvestDate" required>
                                </div>
                                <div class="mb-3">
                                    <label for="productDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="productDescription" rows="3" placeholder="Brief description of the product..."></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-success" onclick="saveNewProduct()">
                                <i class="fas fa-save me-1"></i>Add Product
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }
        
        function saveNewProduct() {
            const productName = document.getElementById('productName').value;
            const batchNumber = document.getElementById('batchNumber').value;
            const productType = document.getElementById('productType').value;
            const harvestDate = document.getElementById('harvestDate').value;
            const description = document.getElementById('productDescription').value;
            
            if (!productName || !batchNumber || !productType || !harvestDate) {
                showErrorDialog('Missing Information', 'Please fill in all required fields.');
                return;
            }
            
            // Generate new product ID
            const productId = 'PROD' + String(Date.now()).slice(-6);
            
            // Add to product select dropdown
            const productSelect = document.getElementById('productSelect');
            const newOption = document.createElement('option');
            newOption.value = productId;
            newOption.textContent = `${productName} (${batchNumber})`;
            productSelect.appendChild(newOption);
            
            // Add to QR traceability system if available
            if (typeof qrTraceability !== 'undefined' && qrTraceability) {
                const newProduct = {
                    id: productId,
                    name: productName,
                    batchNumber: batchNumber,
                    type: productType,
                    harvestDate: harvestDate,
                    description: description,
                    location: 'Nakaile', // Default location
                    farmer: 'Local', // Default farmer
                    certifications: ['Organic'], // Default certification
                    createdAt: new Date().toISOString()
                };
                
                qrTraceability.products.push(newProduct);
                qrTraceability.saveProducts();
                
                // Auto-generate QR code for the new product
                setTimeout(() => {
                    autoGenerateQRCode(newProduct);
                }, 1000);
            }
            
            // Close modal
            const modal = document.querySelector('.modal.show');
            if (modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                bsModal.hide();
            }
            
            showSuccessDialog(
                '‚úÖ Product Created Successfully!',
                `${productName} has been added to the system!\n\nProduct ID: ${productId}\nBatch: ${batchNumber}\nType: ${productType}\n\nQR Code is being generated automatically...`
            );
        }

        // Competitive Features Implementation
        let weatherData = null;
        let financialData = {
            monthlyRevenue: 0,
            monthlyCosts: 0,
            netProfit: 0,
            monthlyROI: 0
        };

        // Weather Integration
        async function fetchWeatherData() {
            try {
                // Simulate weather API call (replace with real API)
                const weather = {
                    temperature: 25 + Math.random() * 10,
                    humidity: 60 + Math.random() * 30,
                    windSpeed: 5 + Math.random() * 15,
                    rainfall: Math.random() * 20,
                    condition: ['Sunny', 'Cloudy', 'Rainy', 'Partly Cloudy'][Math.floor(Math.random() * 4)],
                    icon: ['‚òÄÔ∏è', '‚õÖ', 'üåßÔ∏è', 'üå§Ô∏è'][Math.floor(Math.random() * 4)]
                };
                
                weatherData = weather;
                updateWeatherDisplay();
                generateWeatherAlerts();
                return weather;
            } catch (error) {
                console.error('Weather fetch error:', error);
                return null;
            }
        }

        function updateWeatherDisplay() {
            if (!weatherData) return;
            
            document.querySelector('.weather-temp').textContent = `${Math.round(weatherData.temperature)}¬∞C`;
            document.querySelector('.weather-desc').textContent = weatherData.condition;
            document.querySelector('.weather-icon').textContent = weatherData.icon;
            document.getElementById('humidity').textContent = Math.round(weatherData.humidity);
            document.getElementById('windSpeed').textContent = Math.round(weatherData.windSpeed);
            document.getElementById('rainfall').textContent = weatherData.rainfall.toFixed(1);
        }

        function generateWeatherAlerts() {
            if (!weatherData) return;
            
            const alertsContainer = document.getElementById('weatherAlerts');
            alertsContainer.innerHTML = '';
            
            if (weatherData.rainfall > 15) {
                alertsContainer.innerHTML += `
                    <div class="weather-alert alert-warning clickable-alert" onclick="showWeatherAdvice('heavy-rain')">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Heavy rain expected - Click for protection advice
                        <i class="fas fa-chevron-right float-end"></i>
                    </div>
                `;
            }
            
            if (weatherData.temperature > 35) {
                alertsContainer.innerHTML += `
                    <div class="weather-alert alert-warning clickable-alert" onclick="showWeatherAdvice('high-temperature')">
                        <i class="fas fa-thermometer-full me-2"></i>
                        High temperature - Click for heat protection advice
                        <i class="fas fa-chevron-right float-end"></i>
                    </div>
                `;
            }
            
            if (weatherData.windSpeed > 20) {
                alertsContainer.innerHTML += `
                    <div class="weather-alert alert-info clickable-alert" onclick="showWeatherAdvice('strong-winds')">
                        <i class="fas fa-wind me-2"></i>
                        Strong winds - Click for safety advice
                        <i class="fas fa-chevron-right float-end"></i>
                    </div>
                `;
            }
            
            if (weatherData.humidity > 90) {
                alertsContainer.innerHTML += `
                    <div class="weather-alert alert-info clickable-alert" onclick="showWeatherAdvice('high-humidity')">
                        <i class="fas fa-tint me-2"></i>
                        High humidity - Click for disease prevention advice
                        <i class="fas fa-chevron-right float-end"></i>
                    </div>
                `;
            }
            
            if (weatherData.uvIndex > 8) {
                alertsContainer.innerHTML += `
                    <div class="weather-alert alert-warning clickable-alert" onclick="showWeatherAdvice('high-uv')">
                        <i class="fas fa-sun me-2"></i>
                        High UV index - Click for sun protection advice
                        <i class="fas fa-chevron-right float-end"></i>
                    </div>
                `;
            }
        }

        // Weather Advice System
        function showWeatherAdvice(alertType) {
            const adviceData = getWeatherAdvice(alertType);
            showWeatherAdviceModal(adviceData);
        }

        function getWeatherAdvice(alertType) {
            const adviceDatabase = {
                'heavy-rain': {
                    title: 'Heavy Rain Protection Advice',
                    icon: 'fas fa-cloud-rain',
                    color: 'warning',
                    severity: 'High',
                    crops: [
                        'Cover sensitive crops with plastic sheets or row covers',
                        'Ensure proper drainage in fields to prevent waterlogging',
                        'Harvest mature crops before heavy rain if possible',
                        'Move potted plants to sheltered areas',
                        'Check and repair greenhouse structures',
                        'Apply fungicides preventively to avoid fungal diseases'
                    ],
                    livestock: [
                        'Move livestock to covered shelters or barns',
                        'Ensure adequate bedding to keep animals dry',
                        'Check for leaks in barn roofs and walls',
                        'Provide extra feed as animals may be stressed',
                        'Monitor for signs of respiratory issues',
                        'Keep water troughs clean and filled'
                    ],
                    equipment: [
                        'Secure or move farm equipment to covered areas',
                        'Cover exposed machinery with tarps',
                        'Check drainage around equipment storage areas',
                        'Ensure fuel tanks are properly sealed',
                        'Move electrical equipment away from water'
                    ],
                    general: [
                        'Monitor weather updates regularly',
                        'Have emergency contact numbers ready',
                        'Check insurance coverage for weather damage',
                        'Document any damage for insurance claims',
                        'Prepare for potential power outages'
                    ]
                },
                'high-temperature': {
                    title: 'High Temperature Protection Advice',
                    icon: 'fas fa-thermometer-full',
                    color: 'danger',
                    severity: 'High',
                    crops: [
                        'Increase irrigation frequency during early morning or evening',
                        'Apply mulch to retain soil moisture',
                        'Use shade cloths for sensitive crops',
                        'Harvest crops early in the morning when temperatures are cooler',
                        'Consider temporary shade structures',
                        'Monitor soil moisture levels more frequently'
                    ],
                    livestock: [
                        'Provide ample shade and ventilation in barns',
                        'Ensure continuous access to fresh, cool water',
                        'Use fans or misting systems in livestock areas',
                        'Reduce handling and transportation during peak heat',
                        'Monitor for signs of heat stress',
                        'Consider adjusting feeding times to cooler periods'
                    ],
                    equipment: [
                        'Check cooling systems on tractors and machinery',
                        'Store equipment in shaded areas when possible',
                        'Monitor tire pressure as heat can cause expansion',
                        'Keep fuel tanks less than full to allow for expansion',
                        'Check hydraulic fluid levels and condition'
                    ],
                    general: [
                        'Schedule outdoor work for early morning or evening',
                        'Stay hydrated and take frequent breaks',
                        'Wear appropriate protective clothing and sunscreen',
                        'Monitor weather forecasts for heat wave duration',
                        'Have emergency cooling plans ready'
                    ]
                },
                'strong-winds': {
                    title: 'Strong Wind Safety Advice',
                    icon: 'fas fa-wind',
                    color: 'info',
                    severity: 'Medium',
                    crops: [
                        'Stake or tie down tall crops and plants',
                        'Harvest or secure loose fruits and vegetables',
                        'Check and reinforce greenhouse structures',
                        'Use windbreaks or temporary barriers',
                        'Avoid planting or transplanting during high winds',
                        'Monitor for wind damage to crops'
                    ],
                    livestock: [
                        'Ensure all gates and fences are secure',
                        'Move livestock to more protected areas if possible',
                        'Check barn doors and windows are properly secured',
                        'Monitor for signs of stress in animals',
                        'Keep emergency contact information handy',
                        'Have backup power sources ready'
                    ],
                    equipment: [
                        'Secure all loose equipment and tools',
                        'Lower or secure any raised equipment',
                        'Check and reinforce equipment storage structures',
                        'Move vehicles to sheltered areas',
                        'Secure tarps and covers with additional weights',
                        'Check electrical connections for safety'
                    ],
                    general: [
                        'Avoid working in open areas during high winds',
                        'Wear appropriate safety gear',
                        'Monitor weather updates for wind speed changes',
                        'Have emergency plans ready for power outages',
                        'Check for fallen branches or debris after winds'
                    ]
                },
                'high-humidity': {
                    title: 'High Humidity Disease Prevention',
                    icon: 'fas fa-tint',
                    color: 'info',
                    severity: 'Medium',
                    crops: [
                        'Improve air circulation around plants',
                        'Apply fungicides preventively',
                        'Avoid overhead watering to reduce leaf wetness',
                        'Prune plants to improve air flow',
                        'Monitor for early signs of fungal diseases',
                        'Consider using resistant crop varieties'
                    ],
                    livestock: [
                        'Ensure good ventilation in barns and shelters',
                        'Keep bedding dry and change frequently',
                        'Monitor for respiratory issues in animals',
                        'Provide adequate space to prevent overcrowding',
                        'Check for signs of fungal infections',
                        'Maintain clean water sources'
                    ],
                    equipment: [
                        'Check for moisture damage to equipment',
                        'Ensure electrical connections are dry and safe',
                        'Store tools in dry, well-ventilated areas',
                        'Check for rust or corrosion on metal equipment',
                        'Maintain proper humidity levels in storage areas'
                    ],
                    general: [
                        'Monitor humidity levels regularly',
                        'Use dehumidifiers in critical areas if needed',
                        'Check weather forecasts for humidity changes',
                        'Maintain good hygiene practices',
                        'Have disease treatment plans ready'
                    ]
                },
                'high-uv': {
                    title: 'High UV Index Protection Advice',
                    icon: 'fas fa-sun',
                    color: 'warning',
                    severity: 'Medium',
                    crops: [
                        'Use shade cloths for sensitive crops',
                        'Apply sunscreen or protective coatings to fruit',
                        'Harvest during early morning or late afternoon',
                        'Consider UV-resistant crop varieties',
                        'Monitor for sunburn damage on plants',
                        'Provide adequate water to prevent stress'
                    ],
                    livestock: [
                        'Ensure adequate shade for all animals',
                        'Provide extra water to prevent dehydration',
                        'Monitor for signs of heat stress',
                        'Use fans or misting systems if available',
                        'Avoid handling animals during peak UV hours',
                        'Check for sunburn on light-colored animals'
                    ],
                    equipment: [
                        'Store equipment in shaded areas when possible',
                        'Use UV-resistant covers for sensitive equipment',
                        'Check plastic components for UV damage',
                        'Apply protective coatings to exposed surfaces',
                        'Monitor tire condition as UV can cause cracking'
                    ],
                    general: [
                        'Wear protective clothing and sunscreen',
                        'Work during early morning or late afternoon',
                        'Take frequent breaks in shaded areas',
                        'Stay hydrated throughout the day',
                        'Monitor UV index levels regularly'
                    ]
                }
            };

            return adviceDatabase[alertType] || {
                title: 'Weather Alert',
                icon: 'fas fa-exclamation-triangle',
                color: 'info',
                severity: 'Unknown',
                crops: ['No specific advice available'],
                livestock: ['No specific advice available'],
                equipment: ['No specific advice available'],
                general: ['Monitor conditions and take appropriate precautions']
            };
        }

        function showWeatherAdviceModal(advice) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-${advice.color} text-white">
                            <h5 class="modal-title">
                                <i class="${advice.icon} me-2"></i>${advice.title}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="alert alert-${advice.color} mb-0">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>Severity:</strong> ${advice.severity}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="alert alert-info mb-0">
                                        <i class="fas fa-clock me-2"></i>
                                        <strong>Time:</strong> ${new Date().toLocaleString()}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="advice-section">
                                        <h6 class="text-success mb-3">
                                            <i class="fas fa-seedling me-2"></i>Crop Protection
                                        </h6>
                                        <ul class="list-group list-group-flush">
                                            ${advice.crops.map(item => `<li class="list-group-item">${item}</li>`).join('')}
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="advice-section">
                                        <h6 class="text-primary mb-3">
                                            <i class="fas fa-paw me-2"></i>Livestock Care
                                        </h6>
                                        <ul class="list-group list-group-flush">
                                            ${advice.livestock.map(item => `<li class="list-group-item">${item}</li>`).join('')}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="advice-section">
                                        <h6 class="text-warning mb-3">
                                            <i class="fas fa-tools me-2"></i>Equipment Safety
                                        </h6>
                                        <ul class="list-group list-group-flush">
                                            ${advice.equipment.map(item => `<li class="list-group-item">${item}</li>`).join('')}
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="advice-section">
                                        <h6 class="text-info mb-3">
                                            <i class="fas fa-clipboard-list me-2"></i>General Safety
                                        </h6>
                                        <ul class="list-group list-group-flush">
                                            ${advice.general.map(item => `<li class="list-group-item">${item}</li>`).join('')}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-light mt-3">
                                <i class="fas fa-lightbulb me-2"></i>
                                <strong>Pro Tip:</strong> Always monitor weather conditions and adjust your farming practices accordingly. 
                                Consider investing in weather monitoring equipment for better preparedness.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-${advice.color}" onclick="printWeatherAdvice('${advice.title}')">
                                <i class="fas fa-print me-1"></i>Print Advice
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function printWeatherAdvice(title) {
            window.print();
        }

        // Weeding Task Synchronization System
        function initializeWeedingTaskSync() {
            console.log('üå± Initializing Weeding Task Synchronization...');
            
            // Create unified weeding task storage
            if (!localStorage.getItem('unifiedWeedingTasks')) {
                const defaultTasks = [
                    {
                        id: 'task_001',
                        crop: 'Tomatoes',
                        field: 'Field A',
                        urgency: 'Critical',
                        urgencyPercent: 85,
                        weedGrowth: 1.3,
                        daysSince: 20,
                        estimatedCost: 125,
                        weather: 'Weather OK',
                        schedule: 'Today',
                        action: 'Immediate chemical application required',
                        status: 'active',
                        weatherIssue: false,
                        lastUpdated: new Date().toISOString()
                    },
                    {
                        id: 'task_002',
                        crop: 'Lettuce',
                        field: 'Field C',
                        urgency: 'Medium',
                        urgencyPercent: 60,
                        weedGrowth: 0.9,
                        daysSince: 14,
                        estimatedCost: 60,
                        weather: 'Weather Issue - Wait for dry conditions',
                        schedule: 'Day after tomorrow',
                        action: 'Manual weeding or light chemical treatment',
                        status: 'active',
                        weatherIssue: true,
                        lastUpdated: new Date().toISOString()
                    },
                    {
                        id: 'task_003',
                        crop: 'Carrots',
                        field: 'Field D',
                        urgency: 'Low',
                        urgencyPercent: 30,
                        weedGrowth: 0.6,
                        daysSince: 10,
                        estimatedCost: 45,
                        weather: 'Weather OK',
                        schedule: 'Next week',
                        action: 'Manual weeding when weather permits',
                        status: 'active',
                        weatherIssue: false,
                        lastUpdated: new Date().toISOString()
                    },
                    {
                        id: 'task_004',
                        crop: 'Peppers',
                        field: 'Field B',
                        urgency: 'Critical',
                        urgencyPercent: 75,
                        weedGrowth: 1.12,
                        daysSince: 15,
                        estimatedCost: 30,
                        weather: 'Rain expected - wait for dry conditions',
                        schedule: '29/09/2025',
                        action: 'Immediate chemical application required',
                        status: 'active',
                        weatherIssue: true,
                        lastUpdated: new Date().toISOString()
                    }
                ];
                localStorage.setItem('unifiedWeedingTasks', JSON.stringify(defaultTasks));
            }
            
            // Sync with intelligent weeding system
            syncWithIntelligentWeeding();
            
            // Update dashboard weeding tasks
            updateDashboardWeedingTasks();
            
            console.log('‚úÖ Weeding Task Synchronization initialized');
        }

        function syncWithIntelligentWeeding() {
            const tasks = JSON.parse(localStorage.getItem('unifiedWeedingTasks') || '[]');
            
            // Update intelligent weeding system if available
            if (typeof window.intelligentWeeding !== 'undefined') {
                window.intelligentWeeding.syncTasks(tasks);
            }
            
            // Update weeding management page if open
            if (window.location.pathname.includes('weeding-management.html')) {
                updateWeedingManagementPage(tasks);
            }
        }

        function updateDashboardWeedingTasks() {
            const tasks = JSON.parse(localStorage.getItem('unifiedWeedingTasks') || '[]');
            const container = document.getElementById('weedingTasksContainer');
            
            if (!container) return;
            
            container.innerHTML = '';
            
            tasks.forEach(task => {
                const taskCard = createWeedingTaskCard(task);
                container.appendChild(taskCard);
            });
        }

        function createWeedingTaskCard(task) {
            const card = document.createElement('div');
            card.className = 'col-md-4 mb-3';
            
            const urgencyColor = getUrgencyColor(task.urgency);
            const urgencyBadge = getUrgencyBadge(task.urgency);
            
            card.innerHTML = `
                <div class="card weeding-task-card border-${urgencyColor}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">${task.crop} - ${task.field}</h6>
                        <span class="badge bg-${urgencyColor}">${urgencyBadge}</span>
                    </div>
                    <div class="card-body">
                        <div class="task-metrics">
                            <div class="metric-item">
                                <i class="fas fa-chart-line text-primary"></i>
                                <span>Weed Growth: ${task.weedGrowth}x</span>
                            </div>
                            <div class="metric-item">
                                <i class="fas fa-calendar text-info"></i>
                                <span>Days Since: ${task.daysSince} days</span>
                            </div>
                            <div class="metric-item">
                                <i class="fas fa-dollar-sign text-success"></i>
                                <span>Est. Cost: $${task.estimatedCost}</span>
                            </div>
                            <div class="metric-item">
                                <i class="fas fa-cloud text-${task.weatherIssue ? 'warning' : 'success'}"></i>
                                <span>${task.weather}</span>
                            </div>
                            <div class="metric-item">
                                <i class="fas fa-calendar-alt text-secondary"></i>
                                <span>Schedule: ${task.schedule}</span>
                            </div>
                            <div class="metric-item">
                                <i class="fas fa-info-circle text-info"></i>
                                <span>${task.action}</span>
                            </div>
                        </div>
                        <div class="task-actions mt-3">
                            <button class="btn btn-success btn-sm me-2" onclick="executeWeedingTask('${task.id}')">
                                <i class="fas fa-play me-1"></i>Execute
                            </button>
                            <button class="btn btn-info btn-sm me-2" onclick="viewWeedingTaskDetails('${task.id}')">
                                <i class="fas fa-info me-1"></i>Details
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="rescheduleWeedingTask('${task.id}')">
                                <i class="fas fa-clock me-1"></i>Reschedule
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }

        function getUrgencyColor(urgency) {
            switch(urgency) {
                case 'Critical': return 'danger';
                case 'Urgent': return 'warning';
                case 'Medium': return 'info';
                case 'Low': return 'success';
                default: return 'secondary';
            }
        }

        function getUrgencyBadge(urgency) {
            switch(urgency) {
                case 'Critical': return 'CRITICAL';
                case 'Urgent': return 'URGENT';
                case 'Medium': return 'MEDIUM';
                case 'Low': return 'LOW';
                default: return 'UNKNOWN';
            }
        }

        // Weeding Task Actions
        function executeWeedingTask(taskId) {
            const tasks = JSON.parse(localStorage.getItem('unifiedWeedingTasks') || '[]');
            const task = tasks.find(t => t.id === taskId);
            
            if (!task) {
                showErrorDialog('Task Not Found', 'The selected weeding task could not be found.');
                return;
            }
            
            showWeedingExecutionModal(task);
        }

        function viewWeedingTaskDetails(taskId) {
            const tasks = JSON.parse(localStorage.getItem('unifiedWeedingTasks') || '[]');
            const task = tasks.find(t => t.id === taskId);
            
            if (!task) {
                showErrorDialog('Task Not Found', 'The selected weeding task could not be found.');
                return;
            }
            
            showWeedingTaskDetailsModal(task);
        }

        function rescheduleWeedingTask(taskId) {
            const tasks = JSON.parse(localStorage.getItem('unifiedWeedingTasks') || '[]');
            const task = tasks.find(t => t.id === taskId);
            
            if (!task) {
                showErrorDialog('Task Not Found', 'The selected weeding task could not be found.');
                return;
            }
            
            showWeedingRescheduleModal(task);
        }

        function showWeedingExecutionModal(task) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-play me-2"></i>Execute Weeding Task
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Task Details</h6>
                                    <p><strong>Crop:</strong> ${task.crop} - ${task.field}</p>
                                    <p><strong>Urgency:</strong> <span class="badge bg-${getUrgencyColor(task.urgency)}">${task.urgency}</span></p>
                                    <p><strong>Action:</strong> ${task.action}</p>
                                    <p><strong>Estimated Cost:</strong> $${task.estimatedCost}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6>Current Conditions</h6>
                                    <p><strong>Weather:</strong> ${task.weather}</p>
                                    <p><strong>Weed Growth:</strong> ${task.weedGrowth}x</p>
                                    <p><strong>Days Since Last Action:</strong> ${task.daysSince} days</p>
                                    <p><strong>Scheduled:</strong> ${task.schedule}</p>
                                </div>
                            </div>
                            
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Note:</strong> This task will be marked as completed and removed from the active tasks list.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-success" onclick="confirmWeedingTaskExecution('${task.id}')">
                                <i class="fas fa-check me-1"></i>Confirm Execution
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function confirmWeedingTaskExecution(taskId) {
            const tasks = JSON.parse(localStorage.getItem('unifiedWeedingTasks') || '[]');
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            
            if (taskIndex !== -1) {
                // Mark task as completed
                tasks[taskIndex].status = 'completed';
                tasks[taskIndex].completedAt = new Date().toISOString();
                
                // Save updated tasks
                localStorage.setItem('unifiedWeedingTasks', JSON.stringify(tasks));
                
                // Update displays
                updateDashboardWeedingTasks();
                syncWithIntelligentWeeding();
                
                // Close modal
                const modal = document.querySelector('.modal.show');
                if (modal) {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    bsModal.hide();
                }
                
                showSuccessDialog(
                    '‚úÖ Task Completed',
                    `Weeding task for ${tasks[taskIndex].crop} - ${tasks[taskIndex].field} has been completed successfully!`
                );
            }
        }

        function showWeedingTaskDetailsModal(task) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-info me-2"></i>Weeding Task Details
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Task Information</h6>
                                    <p><strong>Crop:</strong> ${task.crop}</p>
                                    <p><strong>Field:</strong> ${task.field}</p>
                                    <p><strong>Urgency:</strong> <span class="badge bg-${getUrgencyColor(task.urgency)}">${task.urgency} (${task.urgencyPercent}%)</span></p>
                                    <p><strong>Status:</strong> <span class="badge bg-${task.status === 'active' ? 'success' : 'secondary'}">${task.status.toUpperCase()}</span></p>
                                </div>
                                <div class="col-md-6">
                                    <h6>Metrics</h6>
                                    <p><strong>Weed Growth Rate:</strong> ${task.weedGrowth}x</p>
                                    <p><strong>Days Since Last Action:</strong> ${task.daysSince} days</p>
                                    <p><strong>Estimated Cost:</strong> $${task.estimatedCost}</p>
                                    <p><strong>Last Updated:</strong> ${new Date(task.lastUpdated).toLocaleString()}</p>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <h6>Weather Conditions</h6>
                                    <p><strong>Current Weather:</strong> ${task.weather}</p>
                                    <p><strong>Weather Issue:</strong> ${task.weatherIssue ? 'Yes' : 'No'}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6>Schedule & Action</h6>
                                    <p><strong>Scheduled:</strong> ${task.schedule}</p>
                                    <p><strong>Recommended Action:</strong> ${task.action}</p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-success" onclick="executeWeedingTask('${task.id}')">
                                <i class="fas fa-play me-1"></i>Execute Task
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function showWeedingRescheduleModal(task) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-warning text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-clock me-2"></i>Reschedule Weeding Task
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="newSchedule" class="form-label">New Schedule Date</label>
                                <input type="date" class="form-control" id="newSchedule" value="${task.schedule}">
                            </div>
                            <div class="mb-3">
                                <label for="rescheduleReason" class="form-label">Reason for Rescheduling</label>
                                <select class="form-select" id="rescheduleReason">
                                    <option value="weather">Weather Conditions</option>
                                    <option value="equipment">Equipment Issues</option>
                                    <option value="priority">Priority Change</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Current Schedule:</strong> ${task.schedule}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-warning" onclick="confirmWeedingTaskReschedule('${task.id}')">
                                <i class="fas fa-check me-1"></i>Reschedule Task
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function confirmWeedingTaskReschedule(taskId) {
            const newSchedule = document.getElementById('newSchedule').value;
            const reason = document.getElementById('rescheduleReason').value;
            
            if (!newSchedule) {
                showErrorDialog('Invalid Date', 'Please select a valid schedule date.');
                return;
            }
            
            const tasks = JSON.parse(localStorage.getItem('unifiedWeedingTasks') || '[]');
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            
            if (taskIndex !== -1) {
                tasks[taskIndex].schedule = newSchedule;
                tasks[taskIndex].rescheduleReason = reason;
                tasks[taskIndex].lastUpdated = new Date().toISOString();
                
                localStorage.setItem('unifiedWeedingTasks', JSON.stringify(tasks));
                
                updateDashboardWeedingTasks();
                syncWithIntelligentWeeding();
                
                const modal = document.querySelector('.modal.show');
                if (modal) {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    bsModal.hide();
                }
                
                showSuccessDialog(
                    '‚úÖ Task Rescheduled',
                    `Weeding task has been rescheduled to ${newSchedule}.`
                );
            }
        }

        // Financial Analytics
        function calculateFinancialMetrics() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            // Calculate revenue from crops and livestock
            let monthlyRevenue = 0;
            let monthlyCosts = 0;
            
            // Simulate revenue from crops (harvested crops)
            crops.forEach(crop => {
                if (crop.status === 'Harvested') {
                    // Simulate yield and price
                    const yield = Math.random() * 1000; // kg
                    const price = 2 + Math.random() * 5; // per kg
                    monthlyRevenue += yield * price;
                }
            });
            
            // Simulate revenue from livestock
            livestock.forEach(animal => {
                if (animal.status === 'Healthy') {
                    // Simulate production value
                    monthlyRevenue += animal.quantity * (50 + Math.random() * 200);
                }
            });
            
            // Simulate costs (feed, fertilizer, equipment, etc.)
            monthlyCosts = (crops.length * 100) + (livestock.length * 50) + (Math.random() * 1000);
            
            const netProfit = monthlyRevenue - monthlyCosts;
            const monthlyROI = monthlyCosts > 0 ? (netProfit / monthlyCosts * 100) : 0;
            
            financialData = {
                monthlyRevenue,
                monthlyCosts,
                netProfit,
                monthlyROI
            };
            
            updateFinancialDisplay();
        }

        function updateFinancialDisplay() {
            const symbol = window.currencyManager ? window.currencyManager.getSymbol() : '$';
            
            document.getElementById('monthlyRevenue').textContent = 
                `${symbol}${financialData.monthlyRevenue.toFixed(0)}`;
            document.getElementById('monthlyCosts').textContent = 
                `${symbol}${financialData.monthlyCosts.toFixed(0)}`;
            
            const profitElement = document.getElementById('netProfit');
            const profitValue = financialData.netProfit.toFixed(0);
            profitElement.textContent = `${symbol}${profitValue}`;
            profitElement.className = `metric-value profit ${financialData.netProfit < 0 ? 'negative' : ''}`;
            
            document.getElementById('monthlyROI').textContent = 
                `${financialData.monthlyROI.toFixed(1)}%`;
        }

        function showFinancialDetails() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-chart-line me-2"></i>Financial Details
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Revenue Breakdown</h6>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between">
                                            <span>Crop Sales:</span>
                                            <span>${window.currencyManager ? window.currencyManager.getSymbol() : '$'}${(financialData.monthlyRevenue * 0.6).toFixed(0)}</span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between">
                                            <span>Livestock Sales:</span>
                                            <span>${window.currencyManager ? window.currencyManager.getSymbol() : '$'}${(financialData.monthlyRevenue * 0.4).toFixed(0)}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>Cost Breakdown</h6>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between">
                                            <span>Feed & Fertilizer:</span>
                                            <span>${window.currencyManager ? window.currencyManager.getSymbol() : '$'}${(financialData.monthlyCosts * 0.5).toFixed(0)}</span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between">
                                            <span>Equipment & Maintenance:</span>
                                            <span>${window.currencyManager ? window.currencyManager.getSymbol() : '$'}${(financialData.monthlyCosts * 0.3).toFixed(0)}</span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between">
                                            <span>Other Costs:</span>
                                            <span>${window.currencyManager ? window.currencyManager.getSymbol() : '$'}${(financialData.monthlyCosts * 0.2).toFixed(0)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        // Performance Analytics
        function calculatePerformanceMetrics() {
            // Crop Yield Efficiency
            const totalCrops = crops.length;
            const harvestedCrops = crops.filter(c => c.status === 'Harvested').length;
            const cropEfficiency = totalCrops > 0 ? (harvestedCrops / totalCrops * 100) : 0;
            
            // Livestock Health Score
            const totalLivestock = livestock.length;
            const healthyLivestock = livestock.filter(l => l.status === 'Healthy').length;
            const livestockHealth = totalLivestock > 0 ? (healthyLivestock / totalLivestock * 100) : 0;
            
            // Sustainability Score (simulated based on practices)
            const sustainabilityScore = 75 + Math.random() * 20; // 75-95%
            
            // Cost Efficiency
            const costEfficiency = financialData.monthlyCosts > 0 ? 
                (financialData.monthlyRevenue / financialData.monthlyCosts * 100) : 0;
            
            updatePerformanceDisplay({
                cropEfficiency,
                livestockHealth,
                sustainabilityScore,
                costEfficiency
            });
        }

        function updatePerformanceDisplay(metrics) {
            document.getElementById('cropEfficiency').textContent = `${metrics.cropEfficiency.toFixed(0)}%`;
            document.getElementById('livestockHealth').textContent = `${metrics.livestockHealth.toFixed(0)}%`;
            document.getElementById('sustainabilityScore').textContent = `${metrics.sustainabilityScore.toFixed(0)}%`;
            document.getElementById('costEfficiency').textContent = `${metrics.costEfficiency.toFixed(0)}%`;
            
            // Add trend indicators
            document.getElementById('cropTrend').textContent = '‚ÜóÔ∏è +5%';
            document.getElementById('cropTrend').className = 'analytics-trend trend-up';
            
            document.getElementById('livestockTrend').textContent = '‚ÜóÔ∏è +3%';
            document.getElementById('livestockTrend').className = 'analytics-trend trend-up';
            
            document.getElementById('sustainabilityTrend').textContent = '‚Üí 0%';
            document.getElementById('sustainabilityTrend').className = 'analytics-trend trend-stable';
            
            document.getElementById('costTrend').textContent = '‚ÜòÔ∏è -2%';
            document.getElementById('costTrend').className = 'analytics-trend trend-down';
        }

        // Marketplace Feature
        function showMarketplace() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-store me-2"></i>SmartFarm Marketplace
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>üåæ Sell Your Products</h6>
                                    <div class="marketplace-section">
                                        <div class="sell-item">
                                            <h6>Fresh Tomatoes</h6>
                                            <p>Current Market Price: $3.50/kg</p>
                                            <button class="btn btn-success btn-sm">List for Sale</button>
                                        </div>
                                        <div class="sell-item">
                                            <h6>Organic Lettuce</h6>
                                            <p>Current Market Price: $2.80/kg</p>
                                            <button class="btn btn-success btn-sm">List for Sale</button>
                                        </div>
                                        <div class="sell-item">
                                            <h6>Free-Range Eggs</h6>
                                            <p>Current Market Price: $4.20/dozen</p>
                                            <button class="btn btn-success btn-sm">List for Sale</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>üõí Buy Farm Supplies</h6>
                                    <div class="marketplace-section">
                                        <div class="buy-item">
                                            <h6>Organic Fertilizer</h6>
                                            <p>Price: $25/bag</p>
                                            <button class="btn btn-primary btn-sm">Add to Cart</button>
                                        </div>
                                        <div class="buy-item">
                                            <h6>Livestock Feed</h6>
                                            <p>Price: $45/bag</p>
                                            <button class="btn btn-primary btn-sm">Add to Cart</button>
                                        </div>
                                        <div class="buy-item">
                                            <h6>Seed Packets</h6>
                                            <p>Price: $12/packet</p>
                                            <button class="btn btn-primary btn-sm">Add to Cart</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        // Initialize Competitive Features
        function initializeCompetitiveFeatures() {
            fetchWeatherData();
            calculateFinancialMetrics();
            calculatePerformanceMetrics();
            
            // Update every 5 minutes
            setInterval(() => {
                fetchWeatherData();
                calculateFinancialMetrics();
                calculatePerformanceMetrics();
            }, 300000);
        }

        async function initializeDashboard() {
            try {
                console.log('üöÄ Initializing SmartFarm Dashboard...');
                
                // Initialize charts with error handling
                try {
                    initializeCharts();
                    console.log('‚úÖ Charts initialized successfully');
                } catch (chartError) {
                    console.warn('‚ö†Ô∏è Chart initialization failed:', chartError);
                }
                
                // Check authentication
                try {
                    checkAuthentication();
                    console.log('‚úÖ Authentication checked');
                } catch (authError) {
                    console.warn('‚ö†Ô∏è Authentication check failed:', authError);
                }
                
                // Initialize competitive features
                try {
                    initializeCompetitiveFeatures();
                    console.log('‚úÖ Competitive features initialized');
                } catch (featuresError) {
                    console.warn('‚ö†Ô∏è Competitive features initialization failed:', featuresError);
                }
                
                // Load initial data
                try {
                    await loadDashboardData();
                    console.log('‚úÖ Dashboard data loaded');
                } catch (dataError) {
                    console.warn('‚ö†Ô∏è Dashboard data loading failed:', dataError);
                }
                
                console.log('üéâ Dashboard initialization completed successfully!');
                
            } catch (error) {
                console.error('‚ùå Dashboard initialization failed:', error);
                // Show a user-friendly error message
                if (typeof showErrorMessage === 'function') {
                    showErrorMessage('Dashboard initialization failed. Some features may not work properly.');
                } else {
                    console.error('showErrorMessage function not available');
                }
            }
        }

        function checkAuthentication() {
            console.log('=== AUTH CHECK DEBUG START ===');
            
            // Wait a moment for any pending storage operations to complete
            setTimeout(() => {
                const user = localStorage.getItem('smartfarm_user') || sessionStorage.getItem('smartfarm_user');
                const token = localStorage.getItem('smartfarm_token') || sessionStorage.getItem('smartfarm_token');
                const rememberMe = localStorage.getItem('smartfarm_remember');
                
                console.log('Auth check - user:', user);
                console.log('Auth check - token:', token ? 'Present' : 'Missing');
                console.log('Auth check - rememberMe:', rememberMe);
                console.log('Auth check - localStorage user:', localStorage.getItem('smartfarm_user'));
                console.log('Auth check - sessionStorage user:', sessionStorage.getItem('smartfarm_user'));
                console.log('Auth check - localStorage token:', localStorage.getItem('smartfarm_token') ? 'Present' : 'Missing');
                console.log('Auth check - sessionStorage token:', sessionStorage.getItem('smartfarm_token') ? 'Present' : 'Missing');
                
                // Check if we're coming from a successful login (check URL params or recent timestamp)
                const urlParams = new URLSearchParams(window.location.search);
                const fromLogin = urlParams.get('login') === 'success';
                const recentLogin = checkRecentLogin();
                
                console.log('Auth check - fromLogin param:', fromLogin);
                console.log('Auth check - recentLogin:', recentLogin);
                
                // If we just logged in successfully, give more time for data to be stored
                if (fromLogin || recentLogin) {
                    console.log('‚úÖ Recent login detected, allowing access');
                    updateUserInfo(user || 'Farmer');
                    return;
                }
                
                // Additional check: if we have valid auth data, allow access regardless of URL params
                if (user && token) {
                    console.log('‚úÖ Valid auth data found, allowing access');
                    updateUserInfo(user);
                    return;
                }
                
                // If we have user data but no token, still allow access (demo mode)
                if (user && !token) {
                    console.log('‚úÖ User found without token (demo mode), allowing access');
                    updateUserInfo(user);
                    return;
                }
                
                if (!user) {
                    console.log('‚ùå No user found, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }
                
                if (!token) {
                    console.log('‚ùå No token found, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }
                
                // If we have user but no token, check if this is a demo mode login
                if (user && !token) {
                    console.log('‚ö†Ô∏è User found but no token - checking for demo mode');
                    const userData = localStorage.getItem('smartfarm_userData') || sessionStorage.getItem('smartfarm_userData');
                    if (userData) {
                        console.log('‚úÖ Demo mode detected, allowing access');
                        updateUserInfo(user);
                        return;
                    }
                }
                
                // Continue with session validation...
                validateSession(user, token, rememberMe);
            }, 100); // Small delay to ensure storage operations complete
        }
        
        function checkRecentLogin() {
            const loginTime = localStorage.getItem('smartfarm_loginTime') || sessionStorage.getItem('smartfarm_loginTime');
            if (loginTime) {
                const timeSinceLogin = Date.now() - new Date(loginTime).getTime();
                const recentThreshold = 30 * 1000; // 30 seconds
                return timeSinceLogin < recentThreshold;
            }
            return false;
        }
        
        function validateSession(user, token, rememberMe) {
            
            // Check if session is still valid (for non-remember me users)
            if (!rememberMe) {
                const loginTime = sessionStorage.getItem('smartfarm_loginTime');
                console.log('Session check - loginTime:', loginTime);
                if (loginTime) {
                    const sessionAge = Date.now() - new Date(loginTime).getTime();
                    const maxSessionAge = 24 * 60 * 60 * 1000; // 24 hours
                    console.log('Session check - age:', sessionAge, 'max:', maxSessionAge);
                    if (sessionAge > maxSessionAge) {
                        console.log('‚ùå Session expired, redirecting to login');
                        sessionStorage.clear();
                        window.location.href = 'login.html';
                        return;
                    }
                } else {
                    console.log('‚ùå No login time found for session user, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }
            }
            
            // Update user info in navbar
            updateUserInfo(user);
            
            console.log('‚úÖ Authentication successful');
            console.log('=== AUTH CHECK DEBUG END ===');
        }
        
        function updateUserInfo(user) {
            let userName = 'Farmer';
            let userInitial = 'F';
            let userPicture = null;
            let userProvider = null;
            
            try {
                // Parse user data if it's a JSON string
                let userData = user;
                if (typeof user === 'string') {
                    try {
                        userData = JSON.parse(user);
                    } catch (e) {
                        // If parsing fails, treat as a simple string (email)
                        userData = { email: user };
                    }
                }
                
                if (typeof userData === 'object' && userData.firstName && userData.lastName) {
                    userName = `${userData.firstName} ${userData.lastName}`;
                    userInitial = userData.firstName.charAt(0).toUpperCase();
                    userPicture = userData.picture;
                    userProvider = userData.provider;
                } else if (typeof userData === 'object' && userData.email) {
                    userName = userData.email.split('@')[0];
                    userInitial = userName.charAt(0).toUpperCase();
                    userPicture = userData.picture;
                    userProvider = userData.provider;
                } else if (typeof userData === 'string') {
                    userName = userData.split('@')[0];
                    userInitial = userName.charAt(0).toUpperCase();
                }
            } catch (error) {
                console.warn('Error parsing user data:', error);
                userName = 'Farmer';
                userInitial = 'F';
            }
            
            const userNameElement = document.getElementById('userName');
            const userAvatarElement = document.getElementById('userAvatar');
            
            if (userNameElement) {
                userNameElement.textContent = userName;
                
                // Add provider indicator for social login users
                if (userProvider) {
                    const providerIcon = userProvider === 'google' ? 'üîç' : userProvider === 'facebook' ? 'üìò' : '';
                    userNameElement.innerHTML = `${userName} ${providerIcon}`;
                }
            }
            
            if (userAvatarElement) {
                if (userPicture) {
                    // Use profile picture for social login users
                    userAvatarElement.style.backgroundImage = `url(${userPicture})`;
                    userAvatarElement.style.backgroundSize = 'cover';
                    userAvatarElement.style.backgroundPosition = 'center';
                    userAvatarElement.textContent = '';
                } else {
                    // Use initials for regular users
                    userAvatarElement.style.backgroundImage = '';
                    userAvatarElement.style.backgroundSize = '';
                    userAvatarElement.style.backgroundPosition = '';
                    userAvatarElement.textContent = userInitial;
                }
            }
            
            console.log('‚úÖ User info updated:', userName, userProvider ? `(${userProvider})` : '');
        }
        
        async function checkApiAvailability() {
            try {
                if (typeof window.SmartFarmAPI === 'undefined') {
                    console.log('‚ö†Ô∏è SmartFarmAPI not available');
                    return false;
                }
                
                const response = await window.SmartFarmAPI.healthCheck();
                return response && response.success;
            } catch (error) {
                console.warn('API availability check failed:', error);
                return false;
            }
        }
        
        function showApiUnavailableMessage() {
            // Remove existing message if present
            const existingMessage = document.getElementById('api-unavailable-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // Create message
            const message = document.createElement('div');
            message.id = 'api-unavailable-message';
            message.style.cssText = `
                position: fixed;
                top: 70px;
                left: 20px;
                right: 20px;
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                color: #856404;
                padding: 15px;
                border-radius: 8px;
                z-index: 1000;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                font-family: Arial, sans-serif;
            `;
            message.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center;">
                        <i class="fas fa-exclamation-triangle" style="margin-right: 10px; color: #f39c12;"></i>
                        <div>
                            <strong>API Temporarily Unavailable</strong><br>
                            <small>Some features may not work properly. Data will be loaded from cache when possible.</small>
                        </div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: #856404; cursor: pointer; font-size: 18px; padding: 0; margin-left: 15px;">&times;</button>
                </div>
            `;
            
            document.body.appendChild(message);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (message.parentElement) {
                    message.remove();
                }
            }, 10000);
        }

        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = now.toLocaleTimeString();
        }

        // Global chart instances
        let yieldChart = null;
        let fieldStatusChart = null;
        let revenueChart = null;
        let costChart = null;

        function initializeCharts() {
            try {
                // Yield Chart
                const yieldCtxElement = document.getElementById('yieldChart');
                if (!yieldCtxElement) {
                    console.warn('‚ö†Ô∏è yieldChart element not found');
                    return;
                }
                const yieldCtx = yieldCtxElement.getContext('2d');
                yieldChart = new Chart(yieldCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Yield (tons)',
                        data: [2.1, 2.3, 2.8, 2.5, 2.9, 3.1],
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Field Status Chart
            const fieldCtx = document.getElementById('fieldStatusChart').getContext('2d');
            fieldStatusChart = new Chart(fieldCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Active', 'Harvesting', 'Fallow'],
                    datasets: [{
                        data: [6, 2, 0],
                        backgroundColor: ['#4CAF50', '#FF9800', '#9E9E9E']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.5,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            } catch (error) {
                console.error('‚ùå Chart initialization failed:', error);
            }
        }

        function initializeAnalyticsCharts() {
            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart');
            if (revenueCtx) {
                revenueChart = new Chart(revenueCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Crops', 'Livestock', 'Total'],
                        datasets: [{
                            label: 'Revenue (' + (window.currencyManager ? window.currencyManager.getSymbol() : '$') + ')',
                            data: [0, 0, 0],
                            backgroundColor: ['#4CAF50', '#2196F3', '#FF9800']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Cost Chart
            const costCtx = document.getElementById('costChart');
            if (costCtx) {
                costChart = new Chart(costCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Seeds/Feed', 'Equipment', 'Labor', 'Other'],
                        datasets: [{
                            data: [25, 30, 35, 10],
                            backgroundColor: ['#FF5722', '#9C27B0', '#3F51B5', '#607D8B']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 1.5,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        async function loadDashboardData() {
            try {
                console.log('üìä Loading dashboard data...');
                
                // Load farm data from API or localStorage
                try {
                    await loadFarmData();
                    console.log('‚úÖ Farm data loaded');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Farm data loading failed:', error);
                }
                
                // Load crops data
                try {
                    await loadCropsData();
                    console.log('‚úÖ Crops data loaded');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Crops data loading failed:', error);
                }
                
                // Load livestock data
                try {
                    await loadLivestockData();
                    console.log('‚úÖ Livestock data loaded');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Livestock data loading failed:', error);
                }
                
                // Load inventory data
                try {
                    loadInventoryData();
                    console.log('‚úÖ Inventory data loaded');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Inventory data loading failed:', error);
                }
                
                // Update pesticide statistics
                try {
                    updatePesticideStatistics();
                    console.log('‚úÖ Pesticide statistics updated');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Pesticide statistics update failed:', error);
                }
                
                console.log('‚úÖ Dashboard data loading completed');
                
            } catch (error) {
                console.error('‚ùå Dashboard data loading failed:', error);
                throw error;
            }
        }

        function updatePesticideStatistics() {
            // Update pesticide count - check if elements exist first
            const totalPesticidesEl = document.getElementById('totalPesticides');
            const totalPestsEl = document.getElementById('totalPests');
            
            if (totalPesticidesEl) {
                totalPesticidesEl.textContent = '13';
            }
            
            if (totalPestsEl) {
                totalPestsEl.textContent = '80+';
            }
            
            // You can also dynamically load from the pesticide management system
            // if (typeof pesticideManagement !== 'undefined') {
            //     const pesticideCount = pesticideManagement.pesticideDatabase.length;
            //     const pestCount = Object.keys(pesticideManagement.pestPesticideMatching).length;
            //     if (totalPesticidesEl) totalPesticidesEl.textContent = pesticideCount;
            //     if (totalPestsEl) totalPestsEl.textContent = pestCount + '+';
            // }
        }

        function loadFarmData() {
            const savedFarmData = localStorage.getItem('farmData');
            if (savedFarmData) {
                try {
                    const farmData = JSON.parse(savedFarmData);
                    
                    // Update form fields with saved data
                    const farmNameField = document.getElementById('farmName');
                    const farmLocationField = document.getElementById('farmLocation');
                    const farmAreaField = document.getElementById('farmArea');
                    const farmTypeField = document.getElementById('farmType');
                    
                    if (farmNameField) farmNameField.value = farmData.name || 'Green Valley Farm';
                    if (farmLocationField) farmLocationField.value = farmData.location || 'Sydney, Australia';
                    if (farmAreaField) farmAreaField.value = farmData.area || '25.5';
                    if (farmTypeField) farmTypeField.value = farmData.type || 'Mixed Farming';
                    
                    console.log('Farm data loaded from localStorage:', farmData);
                } catch (e) {
                    console.error('Error loading farm data:', e);
                }
            } else {
                console.log('No saved farm data found, using defaults');
            }
        }

        function loadCropsData() {
            const savedCrops = localStorage.getItem('cropsData');
            if (savedCrops) {
                try {
                    crops = JSON.parse(savedCrops);
                    console.log('Crops data loaded from localStorage:', crops);
                } catch (e) {
                    console.error('Error loading crops data:', e);
                    crops = [];
                }
            } else {
                // Initialize with default data
                crops = [
                    { id: 1, name: 'Tomatoes', field: 'Field A', plantedDate: '2025-01-15', status: 'Growing' },
                    { id: 2, name: 'Lettuce', field: 'Field B', plantedDate: '2025-01-10', status: 'Ready' }
                ];
                saveCropsData();
            }
            renderCropsTable();
        }

        // loadLivestockData function moved to API integration section (line ~12458)
        // This function now uses the modern API version for better data management
        // The localStorage version has been removed to prevent function conflicts

        function loadPetsData() {
            const savedPets = localStorage.getItem('petsData');
            if (savedPets) {
                try {
                    pets = JSON.parse(savedPets);
                    console.log('Pets data loaded from localStorage:', pets);
                } catch (e) {
                    console.error('Error loading pets data:', e);
                    pets = [];
                }
            } else {
                // Initialize with default data
                pets = [
                    { 
                        id: 1, 
                        species: 'Dog', 
                        breed: 'Golden Retriever', 
                        name: 'Buddy',
                        age: 3,
                        gender: 'Male',
                        healthStatus: 'Healthy',
                        vaccination: 'Up to date',
                        lastVetVisit: '2025-01-01',
                        notes: 'Friendly and energetic',
                        weight: '25 kg',
                        location: 'Home',
                        value: 500
                    },
                    { 
                        id: 2, 
                        species: 'Cat', 
                        breed: 'Persian', 
                        name: 'Whiskers',
                        age: 2,
                        gender: 'Female',
                        healthStatus: 'Healthy',
                        vaccination: 'Up to date',
                        lastVetVisit: '2024-12-15',
                        notes: 'Calm and affectionate',
                        weight: '4 kg',
                        location: 'Home',
                        value: 300
                    }
                ];
                savePetsData();
            }
            renderPetsGrid();
            renderPetsTable();
            updatePetsTabCounts();
            updatePetsStatistics();
        }

        function loadInventoryData() {
            const savedInventory = localStorage.getItem('inventoryData');
            if (savedInventory) {
                try {
                    inventory = JSON.parse(savedInventory);
                    console.log('Inventory data loaded from localStorage:', inventory);
                } catch (e) {
                    console.error('Error loading inventory data:', e);
                    inventory = [];
                }
            } else {
                // Initialize with default data
                inventory = [
                    { id: 1, name: 'Fertilizer NPK', category: 'Chemicals', quantity: 50, unit: 'kg', lastUpdated: '2025-01-10' },
                    { id: 2, name: 'Seeds - Tomato', category: 'Seeds', quantity: 100, unit: 'packets', lastUpdated: '2025-01-08' }
                ];
                saveInventoryData();
            }
            renderInventoryTable();
        }

        // Navigation functions
        function showDashboard() {
            console.log('Switching to Dashboard...');
            try {
                showView('dashboardView');
                setActiveNav('dashboard');
                updateURL('dashboardView');
                console.log('Successfully switched to Dashboard');
            } catch (error) {
                console.error('Error switching to Dashboard:', error);
                // Fallback: just show the view
                document.getElementById('dashboardView').style.display = 'block';
            }
        }

        function showFarmManagement() {
            console.log('üåæ showFarmManagement called');
            try {
                // Check if view element exists
                const viewElement = document.getElementById('farmManagementView');
                if (!viewElement) {
                    console.error('‚ùå farmManagementView element not found');
                    return;
                }
                console.log('‚úÖ farmManagementView element found');

                // Check if showView function exists
                if (typeof showView !== 'function') {
                    console.error('‚ùå showView function not found');
                    return;
                }
                console.log('‚úÖ showView function found');

                // Show the view
                showView('farmManagementView');
                console.log('‚úÖ showView called');

                // Set active navigation
                if (typeof setActiveNav === 'function') {
                    setActiveNav('farm');
                    console.log('‚úÖ setActiveNav called');
                } else {
                    console.warn('‚ö†Ô∏è setActiveNav function not found');
                }

                // Update URL
                if (typeof updateURL === 'function') {
                    updateURL('farmManagementView');
                    console.log('‚úÖ updateURL called');
                } else {
                    console.warn('‚ö†Ô∏è updateURL function not found');
                }

                // Load fresh farm data when switching to this tab
                if (typeof loadFarmData === 'function') {
                    loadFarmData();
                    console.log('‚úÖ loadFarmData called');
                } else {
                    console.warn('‚ö†Ô∏è loadFarmData function not found');
                }

                console.log('üéâ Successfully switched to Farm Management');
            } catch (error) {
                console.error('‚ùå Error switching to Farm Management:', error);
                console.error('Error stack:', error.stack);
                // Fallback: just show the view
                const viewElement = document.getElementById('farmManagementView');
                if (viewElement) {
                    viewElement.style.display = 'block';
                    console.log('‚úÖ Fallback: Farm Management view displayed');
                } else {
                    console.error('‚ùå Fallback failed: farmManagementView not found');
                }
            }
        }

        function showCropManagement() {
            console.log('Switching to Crop Management...');
            try {
                showView('cropManagementView');
                setActiveNav('crop');
                updateURL('cropManagementView');
                // Load fresh crop data when switching to this tab
                loadCropsData();
                console.log('Crops data after loading:', crops);
                console.log('Successfully switched to Crop Management');
            } catch (error) {
                console.error('Error switching to Crop Management:', error);
                // Fallback: just show the view
                document.getElementById('cropManagementView').style.display = 'block';
            }
        }

        function showLivestockManagement() {
            console.log('Switching to Livestock Management...');
            try {
                // Check if required functions exist
                if (typeof showView !== 'function') {
                    console.error('showView function not defined');
                    throw new Error('showView function not defined');
                }
                if (typeof setActiveNav !== 'function') {
                    console.error('setActiveNav function not defined');
                    throw new Error('setActiveNav function not defined');
                }
                
                showView('livestockManagementView');
                setActiveNav('livestock');
                updateURL('livestockManagementView');
                // Load fresh livestock data when switching to this tab
                if (typeof loadLivestockData === 'function') {
                    loadLivestockData();
                }
                console.log('Livestock data after loading:', typeof livestock !== 'undefined' ? livestock : 'Not loaded');
                console.log('Successfully switched to Livestock Management');
            } catch (error) {
                console.error('Error switching to Livestock Management:', error);
                // Fallback: just show the view
                const livestockView = document.getElementById('livestockManagementView');
                if (livestockView) {
                    livestockView.style.display = 'block';
                } else {
                    console.error('livestockManagementView element not found');
                }
            }
        }

        function showPetsManagement() {
            console.log('Switching to Pets Management...');
            try {
                showView('petsManagementView');
                setActiveNav('pets');
                updateURL('petsManagementView');
                console.log('Successfully switched to Pets Management');
            } catch (error) {
                console.error('Error switching to Pets Management:', error);
                // Fallback: just show the view
                document.getElementById('petsManagementView').style.display = 'block';
            }
            // Load fresh pets data when switching to this tab
            loadPetsData();
            console.log('Pets data after loading:', pets);
            
            // Add event listeners for search and filter
            setTimeout(() => {
                const searchInput = document.getElementById('petsSearch');
                const speciesFilter = document.getElementById('petsSpeciesFilter');
                const statusFilter = document.getElementById('petsStatusFilter');
                
                if (searchInput) {
                    searchInput.addEventListener('input', filterPets);
                }
                if (speciesFilter) {
                    speciesFilter.addEventListener('change', filterPets);
                }
                if (statusFilter) {
                    statusFilter.addEventListener('change', filterPets);
                }
            }, 100);
        }

        function showInventoryManagement() {
            console.log('Switching to Inventory Management...');
            try {
                showView('inventoryManagementView');
                setActiveNav('inventory');
                updateURL('inventoryManagementView');
                console.log('Successfully switched to Inventory Management');
            } catch (error) {
                console.error('Error switching to Inventory Management:', error);
                // Fallback: just show the view
                document.getElementById('inventoryManagementView').style.display = 'block';
            }
            // Load fresh inventory data when switching to this tab
            loadInventoryData();
            console.log('Inventory data after loading:', inventory);
        }

        function showAnalytics() {
            console.log('Switching to Analytics...');
            try {
                showView('analyticsView');
                setActiveNav('analytics');
                updateURL('analyticsView');
                console.log('Successfully switched to Analytics');
            } catch (error) {
                console.error('Error switching to Analytics:', error);
                // Fallback: just show the view
                document.getElementById('analyticsView').style.display = 'block';
            }
            // Initialize analytics charts if not already initialized
            if (!revenueChart || !costChart) {
                initializeAnalyticsCharts();
            }
            // Update charts with current data
            updateAnalyticsCharts();
        }

        function showTasks() {
            console.log('Switching to Tasks...');
            try {
                showView('tasksView');
                setActiveNav('tasks');
                updateURL('tasksView');
                
                // Load tasks table
                if (typeof loadTasksTable === 'function') {
                    loadTasksTable();
                }
                
                // Initialize weeding tasks if not already done
                if (typeof intelligentWeeding !== 'undefined') {
                    intelligentWeeding.generateWeedingTasks();
                }
                console.log('Successfully switched to Tasks');
            } catch (error) {
                console.error('Error switching to Tasks:', error);
                // Fallback: just show the view
                document.getElementById('tasksView').style.display = 'block';
            }
        }

        function showReports() {
            console.log('üìä showReports called');
            try {
                // Check if view element exists
                const viewElement = document.getElementById('reportsView');
                if (!viewElement) {
                    console.error('‚ùå reportsView element not found');
                    return;
                }
                console.log('‚úÖ reportsView element found');

                // Check if showView function exists
                if (typeof showView !== 'function') {
                    console.error('‚ùå showView function not found');
                    return;
                }
                console.log('‚úÖ showView function found');

                // Show the view
                showView('reportsView');
                console.log('‚úÖ showView called');

                // Set active navigation
                if (typeof setActiveNav === 'function') {
                    setActiveNav('reports');
                    console.log('‚úÖ setActiveNav called');
                } else {
                    console.warn('‚ö†Ô∏è setActiveNav function not found');
                }

                // Update URL
                if (typeof updateURL === 'function') {
                    updateURL('reportsView');
                    console.log('‚úÖ updateURL called');
                } else {
                    console.warn('‚ö†Ô∏è updateURL function not found');
                }

                console.log('üéâ Successfully switched to Reports');
            } catch (error) {
                console.error('‚ùå Error switching to Reports:', error);
                console.error('Error stack:', error.stack);
                // Fallback: just show the view
                const viewElement = document.getElementById('reportsView');
                if (viewElement) {
                    viewElement.style.display = 'block';
                    console.log('‚úÖ Fallback: Reports view displayed');
                } else {
                    console.error('‚ùå Fallback failed: reportsView not found');
                }
            }
        }

        function showView(viewId) {
            console.log('Showing view:', viewId);
            
            try {
                // Hide all views
                const views = ['dashboardView', 'farmManagementView', 'cropManagementView', 
                              'livestockManagementView', 'petsManagementView', 'inventoryManagementView', 
                              'analyticsView', 'tasksView', 'reportsView'];
                
                views.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.style.display = 'none';
                    } else {
                        console.warn('View element not found:', id);
                    }
                });
                
                // Show selected view
                const targetView = document.getElementById(viewId);
                if (targetView) {
                    targetView.style.display = 'block';
                    console.log('Successfully displayed view:', viewId);
                } else {
                    console.error('Target view not found:', viewId);
                }
            } catch (error) {
                console.error('Error in showView:', error);
            }
        }

        function setActiveNav(navItem) {
            try {
                console.log('Setting active nav for:', navItem);
                
                // Remove active class from all nav links
                const navLinks = document.querySelectorAll('.sidebar .nav-link');
                if (navLinks && navLinks.length > 0) {
                    navLinks.forEach(link => {
                        link.classList.remove('active');
                    });
                }
                
                // Add active class to the corresponding nav link based on navItem
                let targetLink = null;
                
                // Map navItem to specific selectors
                const navSelectors = {
                    'dashboard': '[onclick*="showDashboard"]',
                    'farm': '[onclick*="showFarmManagement"]',
                    'crop': '[onclick*="showCropManagement"]',
                    'livestock': '[onclick*="showLivestockManagement"]',
                    'pets': '[onclick*="showPetsManagement"]',
                    'inventory': '[onclick*="showInventoryManagement"]',
                    'analytics': '[onclick*="showAnalytics"]',
                    'tasks': '[onclick*="showTasks"]',
                    'reports': '[onclick*="showReports"]'
                };
                
                if (navSelectors[navItem]) {
                    targetLink = document.querySelector(navSelectors[navItem]);
                }
                
                if (targetLink) {
                    targetLink.classList.add('active');
                    console.log('Set active nav link:', targetLink.textContent.trim());
                } else {
                    console.warn('Could not find nav link for:', navItem);
                }
                
                // Also try to add active class to clicked nav link if event exists
                if (event && event.target && event.target.classList) {
                    event.target.classList.add('active');
                }
            } catch (error) {
                console.error('Error setting active navigation:', error);
            }
        }

        // Data management functions
        async function saveFarmData() {
            // Get form values
            const farmName = document.getElementById('farmName').value.trim();
            const farmLocation = document.getElementById('farmLocation').value.trim();
            const farmArea = document.getElementById('farmArea').value.trim();
            const farmType = document.getElementById('farmType').value;

            // Basic validation
            if (!farmName) {
                showInfoDialog('Validation Error', 'Please enter a farm name.', 'OK', () => {
                    document.getElementById('farmName').focus();
                });
                return;
            }

            if (!farmLocation) {
                showInfoDialog('Validation Error', 'Please enter a farm location.', 'OK', () => {
                    document.getElementById('farmLocation').focus();
                });
                return;
            }

            if (!farmArea || isNaN(farmArea) || parseFloat(farmArea) <= 0) {
                showInfoDialog('Validation Error', 'Please enter a valid farm area (positive number).', 'OK', () => {
                    document.getElementById('farmArea').focus();
                });
                return;
            }

            if (!farmType) {
                showInfoDialog('Validation Error', 'Please select a farm type.', 'OK', () => {
                    document.getElementById('farmType').focus();
                });
                return;
            }

            // Show loading state
            const submitButton = document.querySelector('button[onclick="saveFarmData()"]');
            const originalText = submitButton.innerHTML;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
            submitButton.disabled = true;

            try {
                // Create farm data object
                const farmData = {
                    name: farmName,
                    location: farmLocation,
                    size: parseFloat(farmArea),
                    type: farmType,
                    description: document.getElementById('farmDescription')?.value?.trim() || ''
                };

                // Call API to create farm
                const response = await window.SmartFarmAPI.createFarm(farmData);

                if (response.success) {
                    // Success - update UI
                    showSuccessMessage('Farm created successfully!');
                    
                    // Clear form
                    document.getElementById('farmName').value = '';
                    document.getElementById('farmLocation').value = '';
                    document.getElementById('farmArea').value = '';
                    document.getElementById('farmType').value = '';
                    if (document.getElementById('farmDescription')) {
                        document.getElementById('farmDescription').value = '';
                    }

                    // Refresh farm data
                    await loadFarmData();
                } else {
                    showErrorMessage(response.error || 'Failed to create farm');
                }
            } catch (error) {
                console.error('Error saving farm data:', error);
                showErrorMessage('An error occurred while saving farm data');
            } finally {
                // Restore button state
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }
        }

        // Helper functions for API integration
        function showSuccessMessage(message) {
            if (window.SmartFarmAPI && window.SmartFarmAPI.showSuccessMessage) {
                window.SmartFarmAPI.showSuccessMessage(message);
            } else {
                // Fallback notification
                const notification = document.createElement('div');
                notification.className = 'alert alert-success alert-dismissible fade show';
                notification.style.position = 'fixed';
                notification.style.top = '20px';
                notification.style.right = '20px';
                notification.style.zIndex = '9999';
                notification.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.body.appendChild(notification);
                
                // Auto-remove after 3 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            }
        }

        function showErrorMessage(message) {
            if (window.SmartFarmAPI && window.SmartFarmAPI.showErrorMessage) {
                window.SmartFarmAPI.showErrorMessage(message);
            } else {
                // Fallback notification
                const notification = document.createElement('div');
                notification.className = 'alert alert-danger alert-dismissible fade show';
                notification.style.position = 'fixed';
                notification.style.top = '20px';
                notification.style.right = '20px';
                notification.style.zIndex = '9999';
                notification.innerHTML = `
                    <i class="fas fa-exclamation-circle me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.body.appendChild(notification);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 5000);
            }
        }

        // Load farm data from API
        // Enhanced safe DOM manipulation utilities
        function safeText(selector, value) {
            const el = document.querySelector(selector);
            if (el) {
                try {
                    el.textContent = String(value ?? '');
                } catch (error) {
                    console.warn('Error setting text for', selector, error);
                }
            } else {
                console.warn('Element not found:', selector);
            }
        }

        function safeHTML(selector, html) {
            const el = document.querySelector(selector);
            if (el) {
                try {
                    el.innerHTML = html;
                } catch (error) {
                    console.warn('Error setting HTML for', selector, error);
                }
            } else {
                console.warn('Element not found:', selector);
            }
        }

        function safeValue(selector, value) {
            const el = document.querySelector(selector);
            if (el) {
                try {
                    el.value = String(value ?? '');
                } catch (error) {
                    console.warn('Error setting value for', selector, error);
                }
            } else {
                console.warn('Element not found:', selector);
            }
        }

        // Legacy function names for backward compatibility
        function safeSetText(selector, text) { return safeText(selector, text); }
        function safeSetHTML(selector, html) { return safeHTML(selector, html); }
        function safeSetValue(selector, value) { return safeValue(selector, value); }

        async function loadFarmData() {
            // Check if we should use cached data to reduce API calls
            const cacheKey = 'smartfarm_farm_data_cache';
            const cacheTime = localStorage.getItem('smartfarm_cache_time') || 0;
            const now = Date.now();
            const cacheValid = (now - cacheTime) < 300000; // 5 minutes cache
            
            if (cacheValid) {
                const cachedData = localStorage.getItem(cacheKey);
                if (cachedData) {
                    try {
                        const data = JSON.parse(cachedData);
                        updateFarmDisplay(data);
                        return; // Use cached data, skip API call
                    } catch (e) {
                        // Cache corrupted, continue to API
                    }
                }
            }
            
            try {
                // Check if API is available
                if (typeof window.SmartFarmAPI === 'undefined') {
                    loadFarmDataFromStorage();
                    return;
                }

                const response = await window.SmartFarmAPI.getFarms();
                if (!response || response.success === false || !response.data) {
                    safeText('#farm-count', '0');
                    return;
                }
                
                // Update farm data in UI safely
                updateFarmDisplay(response.data);
                // Cache the data
                localStorage.setItem(cacheKey, JSON.stringify(response.data));
                localStorage.setItem('smartfarm_cache_time', now.toString());
            } catch (error) {
                // Silent error handling to reduce console noise
                safeText('#farm-count', '0');
                // Fallback to localStorage
                loadFarmDataFromStorage();
            }
        }

        function updateFarmDisplay(farmData) {
            try {
                if (!farmData || !Array.isArray(farmData) || farmData.length === 0) {
                    console.warn('No farm data to display');
                    safeText('#farm-count', '0');
                    return;
                }

                const farm = farmData[0]; // Use first farm
                safeValue('#farmName', farm.name || '');
                safeValue('#farmLocation', farm.location || '');
                safeValue('#farmArea', farm.area || '');
                safeValue('#farmType', farm.type || '');
                safeText('#farm-count', farmData.length.toString());
                
                console.log('‚úÖ Farm display updated successfully');
            } catch (error) {
                console.error('Error updating farm display:', error);
                safeText('#farm-count', '0');
            }
        }

        function loadFarmDataFromStorage() {
            const savedFarmData = localStorage.getItem('farmData');
            if (savedFarmData) {
                try {
                    const farmData = JSON.parse(savedFarmData);
                    console.log('‚úÖ Farm data loaded from localStorage:', farmData);
                } catch (e) {
                    console.error('Error loading farm data from localStorage:', e);
                }
            }
        }

        function updateFarmDisplay(farms) {
            // Update farm statistics
            const farmStats = document.querySelector('.farm-stats');
            if (farmStats && farms.length > 0) {
                const totalArea = farms.reduce((sum, farm) => sum + (farm.size || 0), 0);
                farmStats.innerHTML = `
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3>${farms.length}</h3>
                                <p>Total Farms</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3>${totalArea.toFixed(1)}</h3>
                                <p>Total Area (acres)</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3>${farms.filter(f => f.status === 'active').length}</h3>
                                <p>Active Farms</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3>${(totalArea / farms.length).toFixed(1)}</h3>
                                <p>Avg Area (acres)</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function updateAnalyticsCharts() {
            try {
                // Ensure arrays are defined
                if (typeof crops === 'undefined') {
                    console.warn('‚ö†Ô∏è Crops array not defined');
                    return;
                }
                if (typeof livestock === 'undefined') {
                    console.warn('‚ö†Ô∏è Livestock array not defined');
                    return;
                }
                
                // Calculate revenue from crops and livestock
                let cropRevenue = 0;
                let livestockRevenue = 0;
                
                // Simple revenue calculation based on data
                cropRevenue = crops.length * 250; // $250 per crop type
                livestockRevenue = livestock.reduce((total, animal) => total + (animal.quantity * 50), 0); // $50 per animal
                
                const totalRevenue = cropRevenue + livestockRevenue;
            
            // Update revenue chart
            if (revenueChart) {
                revenueChart.data.datasets[0].data = [cropRevenue, livestockRevenue, totalRevenue];
                revenueChart.update();
            }
            
            // Update field status chart based on crops
            if (fieldStatusChart) {
                const activeCrops = crops.filter(crop => crop.status.toLowerCase() === 'growing').length;
                const readyCrops = crops.filter(crop => crop.status.toLowerCase() === 'ready').length;
                const harvestedCrops = crops.filter(crop => crop.status.toLowerCase() === 'harvested').length;
                
                fieldStatusChart.data.datasets[0].data = [activeCrops, readyCrops, harvestedCrops];
                fieldStatusChart.data.labels = ['Growing', 'Ready', 'Harvested'];
                fieldStatusChart.update();
            }
            
            // Update yield chart with crop data
            if (yieldChart) {
                // Generate yield data based on crops
                const yieldData = [];
                for (let i = 0; i < 6; i++) {
                    yieldData.push(2.0 + (crops.length * 0.1) + (Math.random() * 0.5));
                }
                yieldChart.data.datasets[0].data = yieldData;
                yieldChart.update();
            }
            
            console.log('Analytics charts updated:', { cropRevenue, livestockRevenue, totalRevenue });
            
            } catch (error) {
                console.error('‚ùå Analytics charts update failed:', error);
            }
        }

        // Save functions for data persistence
        function saveCropsData() {
            localStorage.setItem('cropsData', JSON.stringify(crops));
        }

        function saveLivestockData() {
            localStorage.setItem('livestockData', JSON.stringify(livestock));
        }

        function renderLivestockGrid() {
            const livestockGrid = document.getElementById('livestockGrid');
            if (!livestockGrid) return;

            livestockGrid.innerHTML = '';

            livestock.forEach(animal => {
                const animalCard = createLivestockCard(animal);
                livestockGrid.appendChild(animalCard);
            });
        }

        function createLivestockCard(animal) {
            const card = document.createElement('div');
            card.className = 'livestock-card';
            
            const statusClass = animal.healthStatus ? animal.healthStatus.toLowerCase().replace(' ', '-') : 'healthy';
            const statusColor = getStatusColor(animal.healthStatus || 'Healthy');
            
            card.innerHTML = `
                <div class="livestock-header">
                    <div class="livestock-info">
                        <h5 class="livestock-name">${animal.name}</h5>
                        <p class="livestock-breed">${animal.breed}</p>
                    </div>
                    <div class="status-badge-top">
                        <span class="status-dot status-${statusClass}"></span>
                        <span class="status-badge status-${statusClass}">${animal.healthStatus || 'Healthy'}</span>
                    </div>
                </div>
                <div class="livestock-details">
                    <div class="detail-row">
                        <i class="fas fa-tag"></i>
                        <span>ID: L${animal.id.toString().padStart(3, '0')}</span>
                    </div>
                    <div class="detail-row">
                        <i class="fas fa-paw"></i>
                        <span>Type: ${animal.type}</span>
                    </div>
                    <div class="detail-row">
                        <i class="fas fa-hashtag"></i>
                        <span>Quantity: ${animal.quantity || 1}</span>
                    </div>
                    <div class="detail-row">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Location: ${animal.location || 'Not specified'}</span>
                    </div>
                    <div class="detail-row">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Birth: ${animal.birthDate || 'Unknown'}</span>
                    </div>
                    <div class="detail-row">
                        <i class="fas fa-weight"></i>
                        <span>Weight: ${animal.weight || 'Not recorded'}</span>
                    </div>
                </div>
                <div class="livestock-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="editLivestock(${animal.id})">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-success" onclick="addHealthRecord(${animal.id})">
                        <i class="fas fa-heartbeat"></i> Health
                    </button>
                    <button class="btn btn-sm btn-info" onclick="viewLivestockDetails(${animal.id})">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteLivestock(${animal.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            return card;
        }

        function updateLivestockStatistics() {
            const totalAnimals = livestock.length;
            const healthyAnimals = livestock.filter(animal => animal.healthStatus === 'Healthy').length;
            const pregnantAnimals = livestock.filter(animal => animal.healthStatus === 'Pregnant').length;
            const totalValue = livestock.reduce((sum, animal) => sum + (animal.value || 0), 0);

            document.getElementById('totalAnimals').textContent = totalAnimals;
            document.getElementById('healthyAnimals').textContent = healthyAnimals;
            document.getElementById('pregnantAnimals').textContent = pregnantAnimals;
            document.getElementById('totalValue').textContent = totalValue.toLocaleString();
        }

        function savePetsData() {
            localStorage.setItem('petsData', JSON.stringify(pets));
        }

        function saveInventoryData() {
            localStorage.setItem('inventoryData', JSON.stringify(inventory));
        }

        // Table rendering functions
        function renderCropsTable() {
            const tbody = document.querySelector('#cropsTable');
            if (!tbody) return;

            tbody.innerHTML = '';
            crops.forEach(crop => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${crop.name}</td>
                    <td>${crop.field || 'Field A'}</td>
                    <td>${crop.plantedDate || new Date().toISOString().split('T')[0]}</td>
                    <td><span class="status-badge status-${crop.status.toLowerCase()}">${crop.status}</span></td>
                    <td>${crop.phLevel ? crop.phLevel : '-'}</td>
                    <td>${crop.pestIssues ? '<span class="text-danger">‚ö†Ô∏è Issues</span>' : '<span class="text-success">‚úÖ Clear</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editCrop(${crop.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info me-1" onclick="showAISuggestions(${crop.id})">
                            <i class="fas fa-brain"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCrop(${crop.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderLivestockTable() {
            // Update tab counts first
            updateLivestockTabCounts();
            
            // Render all tabs
            renderAllLivestockTab();
            renderCattleTab();
            renderPigsTab();
            renderPoultryTab();
            renderSheepGoatsTab();
            renderHorsesTab();
            renderOtherLivestockTab();
        }

        function updateLivestockTabCounts() {
            const counts = {
                all: livestock.length,
                cattle: livestock.filter(animal => animal.type.toLowerCase() === 'cattle').length,
                pigs: livestock.filter(animal => animal.type.toLowerCase() === 'pigs').length,
                poultry: livestock.filter(animal => ['chickens', 'ducks', 'turkeys'].includes(animal.type.toLowerCase())).length,
                sheepGoats: livestock.filter(animal => ['sheep', 'goats'].includes(animal.type.toLowerCase())).length,
                horses: livestock.filter(animal => animal.type.toLowerCase() === 'horses').length,
                other: livestock.filter(animal => !['cattle', 'pigs', 'chickens', 'ducks', 'turkeys', 'sheep', 'goats', 'horses'].includes(animal.type.toLowerCase())).length
            };

            // Safe element updates with null checks
            const allCountEl = document.getElementById('all-count');
            const cattleCountEl = document.getElementById('cattle-count');
            const pigsCountEl = document.getElementById('pigs-count');
            const poultryCountEl = document.getElementById('poultry-count');
            const sheepGoatsCountEl = document.getElementById('sheep-goats-count');
            const horsesCountEl = document.getElementById('horses-count');
            const otherCountEl = document.getElementById('other-count');
            
            if (allCountEl) allCountEl.textContent = counts.all;
            if (cattleCountEl) cattleCountEl.textContent = counts.cattle;
            if (pigsCountEl) pigsCountEl.textContent = counts.pigs;
            if (poultryCountEl) poultryCountEl.textContent = counts.poultry;
            if (sheepGoatsCountEl) sheepGoatsCountEl.textContent = counts.sheepGoats;
            if (horsesCountEl) horsesCountEl.textContent = counts.horses;
            if (otherCountEl) otherCountEl.textContent = counts.other;
        }

        function createLivestockRow(animal, showSpecies = true) {
            const row = document.createElement('tr');
            
            // Get last weight record
            const lastWeight = animal.weightRecords && animal.weightRecords.length > 0 
                ? animal.weightRecords[animal.weightRecords.length - 1].avgWeight 
                : 'N/A';
            
            // Get ear tags display
            const earTags = Array.isArray(animal.earTags) ? animal.earTags : [];
            const earTagsDisplay = earTags.length > 0 
                ? earTags.slice(0, 2).join(', ') + (earTags.length > 2 ? ` (+${earTags.length - 2})` : '')
                : 'None';
            
            // GPS location display
            const gpsDisplay = animal.gpsLocation 
                ? `<button class="btn btn-sm btn-outline-info" onclick="showGPSLocation(${animal.id})" title="View GPS Location">
                     <i class="fas fa-map-marker-alt"></i>
                   </button>`
                : 'N/A';
            
            // Create row HTML based on whether to show species column
            const speciesColumn = showSpecies ? `<td>${animal.type}</td>` : '';
            
            row.innerHTML = `
                ${speciesColumn}
                <td>${animal.breed}</td>
                <td>${animal.quantity}</td>
                <td><small>${earTagsDisplay}</small></td>
                <td>${animal.location}</td>
                <td>${gpsDisplay}</td>
                <td>${lastWeight} kg</td>
                <td><span class="status-badge status-${animal.status.toLowerCase()}">${animal.status}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editLivestock(${animal.id})" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info me-1" onclick="viewLivestockDetails(${animal.id})" title="View Details">
                        <i class="fas fa-info-circle"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success me-1" onclick="addWeightRecord(${animal.id})" title="Add Weight">
                        <i class="fas fa-weight"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-warning me-1" onclick="addImmunization(${animal.id})" title="Add Immunization">
                        <i class="fas fa-syringe"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteLivestock(${animal.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            return row;
        }

        function renderAllLivestockTab() {
            const tbody = document.querySelector('#allLivestockTable');
            if (!tbody) return;

            tbody.innerHTML = '';
            livestock.forEach(animal => {
                const row = createLivestockRow(animal, true);
                tbody.appendChild(row);
            });
        }

        function renderCattleTab() {
            const tbody = document.querySelector('#cattleTable');
            if (!tbody) return;

            tbody.innerHTML = '';
            const cattle = livestock.filter(animal => animal.type.toLowerCase() === 'cattle');
            cattle.forEach(animal => {
                const row = createLivestockRow(animal, false);
                tbody.appendChild(row);
            });
        }

        function renderPigsTab() {
            const tbody = document.querySelector('#pigsTable');
            if (!tbody) return;

            tbody.innerHTML = '';
            const pigs = livestock.filter(animal => animal.type.toLowerCase() === 'pigs');
            pigs.forEach(animal => {
                const row = createLivestockRow(animal, false);
                tbody.appendChild(row);
            });
        }

        function renderPoultryTab() {
            const tbody = document.querySelector('#poultryTable');
            if (!tbody) return;

            tbody.innerHTML = '';
            const poultry = livestock.filter(animal => ['chickens', 'ducks', 'turkeys'].includes(animal.type.toLowerCase()));
            poultry.forEach(animal => {
                const row = createLivestockRow(animal, true);
                tbody.appendChild(row);
            });
        }

        function renderSheepGoatsTab() {
            const tbody = document.querySelector('#sheepGoatsTable');
            if (!tbody) return;

            tbody.innerHTML = '';
            const sheepGoats = livestock.filter(animal => ['sheep', 'goats'].includes(animal.type.toLowerCase()));
            sheepGoats.forEach(animal => {
                const row = createLivestockRow(animal, true);
                tbody.appendChild(row);
            });
        }

        function renderHorsesTab() {
            const tbody = document.querySelector('#horsesTable');
            if (!tbody) return;

            tbody.innerHTML = '';
            const horses = livestock.filter(animal => animal.type.toLowerCase() === 'horses');
            horses.forEach(animal => {
                const row = createLivestockRow(animal, false);
                tbody.appendChild(row);
            });
        }

        function renderOtherLivestockTab() {
            const tbody = document.querySelector('#otherLivestockTable');
            if (!tbody) return;

            tbody.innerHTML = '';
            const other = livestock.filter(animal => !['cattle', 'pigs', 'chickens', 'ducks', 'turkeys', 'sheep', 'goats', 'horses'].includes(animal.type.toLowerCase()));
            other.forEach(animal => {
                const row = createLivestockRow(animal, true);
                tbody.appendChild(row);
            });
        }

        function renderInventoryTable() {
            const tbody = document.querySelector('#inventoryTable');
            if (!tbody) return;

            tbody.innerHTML = '';
            inventory.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.category}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unit}</td>
                    <td>${item.lastUpdated || new Date().toISOString().split('T')[0]}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editInventory(${item.id})">Edit</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteInventory(${item.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function addNewCrop() {
            // Create add crop modal with enhanced fields
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add New Crop</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addCropForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="newCropName" class="form-label">Crop Name *</label>
                                            <input type="text" class="form-control" id="newCropName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newCropField" class="form-label">Field Name *</label>
                                            <input type="text" class="form-control" id="newCropField" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newCropArea" class="form-label">Area (hectares)</label>
                                            <input type="number" class="form-control" id="newCropArea" step="0.1">
                                        </div>
                                        <div class="mb-3">
                                            <label for="newCropPlantedDate" class="form-label">Planted Date *</label>
                                            <input type="date" class="form-control" id="newCropPlantedDate" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newCropStatus" class="form-label">Status *</label>
                                            <select class="form-select" id="newCropStatus" required>
                                                <option value="planted">Planted</option>
                                                <option value="growing">Growing</option>
                                                <option value="ready">Ready for Harvest</option>
                                                <option value="harvested">Harvested</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="newCropPH" class="form-label">Soil pH Level</label>
                                            <input type="number" class="form-control" id="newCropPH" min="0" max="14" step="0.1" placeholder="6.5">
                                            <small class="form-text text-muted">Optimal range: 6.0-7.0 for most crops</small>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newCropPestIssues" class="form-label">Pest Issues</label>
                                            <textarea class="form-control" id="newCropPestIssues" rows="3" placeholder="Describe any pest problems observed..."></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newCropNotes" class="form-label">Additional Notes</label>
                                            <textarea class="form-control" id="newCropNotes" rows="2" placeholder="Any additional observations..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveNewCrop()">Add Crop</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function saveNewCrop() {
            const name = document.getElementById('newCropName').value.trim();
            const field = document.getElementById('newCropField').value.trim();
            const area = document.getElementById('newCropArea').value.trim();
            const plantedDate = document.getElementById('newCropPlantedDate').value.trim();
            const status = document.getElementById('newCropStatus').value.trim();
            const phLevel = document.getElementById('newCropPH').value.trim();
            const pestIssues = document.getElementById('newCropPestIssues').value.trim();
            const notes = document.getElementById('newCropNotes').value.trim();

            if (!name || !field || !plantedDate || !status) {
                showInfoDialog('Validation Error', 'Please fill in all required fields', 'OK');
                return;
            }

            const newCrop = {
                id: Date.now(),
                name: name,
                field: field,
                area: area ? parseFloat(area) : null,
                plantedDate: plantedDate,
                status: status,
                phLevel: phLevel ? parseFloat(phLevel) : null,
                pestIssues: pestIssues || null,
                notes: notes || null,
                lastUpdated: new Date().toLocaleDateString()
            };

            crops.push(newCrop);
            console.log('Adding new crop:', newCrop);
            saveCropsData();
            renderCropsTable();
            updateAnalyticsCharts();
            showSuccessMessage('Crop added successfully!');

            // Close modal
            const modal = document.querySelector('.modal');
            if (modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                bsModal.hide();
            }
        }

        function editCrop(id) {
            const crop = crops.find(c => c.id === id);
            if (!crop) {
                showInfoDialog('Error', 'Crop not found', 'OK');
                return;
            }

            // Create edit modal
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Crop</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editCropForm">
                                <div class="mb-3">
                                    <label for="editCropName" class="form-label">Crop Name</label>
                                    <input type="text" class="form-control" id="editCropName" value="${crop.name}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editCropField" class="form-label">Field</label>
                                    <input type="text" class="form-control" id="editCropField" value="${crop.field}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editCropArea" class="form-label">Area (hectares)</label>
                                    <input type="number" class="form-control" id="editCropArea" value="${crop.area || ''}" step="0.1">
                                </div>
                                <div class="mb-3">
                                    <label for="editCropPlantedDate" class="form-label">Planted Date</label>
                                    <input type="date" class="form-control" id="editCropPlantedDate" value="${crop.plantedDate}">
                                </div>
                                <div class="mb-3">
                                    <label for="editCropStatus" class="form-label">Status</label>
                                    <select class="form-select" id="editCropStatus" required>
                                        <option value="growing" ${crop.status.toLowerCase() === 'growing' ? 'selected' : ''}>Growing</option>
                                        <option value="ready" ${crop.status.toLowerCase() === 'ready' ? 'selected' : ''}>Ready for Harvest</option>
                                        <option value="harvested" ${crop.status.toLowerCase() === 'harvested' ? 'selected' : ''}>Harvested</option>
                                        <option value="planted" ${crop.status.toLowerCase() === 'planted' ? 'selected' : ''}>Planted</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="editCropPH" class="form-label">Soil pH Level</label>
                                    <input type="number" class="form-control" id="editCropPH" min="0" max="14" step="0.1" value="${crop.phLevel || ''}" placeholder="6.5">
                                    <small class="form-text text-muted">Optimal range: 6.0-7.0 for most crops</small>
                                </div>
                                <div class="mb-3">
                                    <label for="editCropPestIssues" class="form-label">Pest Issues</label>
                                    <textarea class="form-control" id="editCropPestIssues" rows="3" placeholder="Describe any pest problems observed...">${crop.pestIssues || ''}</textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="editCropNotes" class="form-label">Additional Notes</label>
                                    <textarea class="form-control" id="editCropNotes" rows="2" placeholder="Any additional observations...">${crop.notes || ''}</textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveEditedCrop(${id})">Save Changes</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function saveEditedCrop(id) {
            const name = document.getElementById('editCropName').value.trim();
            const field = document.getElementById('editCropField').value.trim();
            const area = document.getElementById('editCropArea').value.trim();
            const plantedDate = document.getElementById('editCropPlantedDate').value.trim();
            const status = document.getElementById('editCropStatus').value.trim();
            const phLevel = document.getElementById('editCropPH').value.trim();
            const pestIssues = document.getElementById('editCropPestIssues').value.trim();
            const notes = document.getElementById('editCropNotes').value.trim();

            if (!name || !field || !plantedDate || !status) {
                showInfoDialog('Validation Error', 'Please fill in all required fields', 'OK');
                return;
            }

            // Find and update the crop
            const cropIndex = crops.findIndex(c => c.id === id);
            if (cropIndex !== -1) {
                crops[cropIndex] = {
                    ...crops[cropIndex],
                    name: name,
                    field: field,
                    area: area || null,
                    plantedDate: plantedDate,
                    status: status,
                    phLevel: phLevel ? parseFloat(phLevel) : null,
                    pestIssues: pestIssues || null,
                    notes: notes || null,
                    lastUpdated: new Date().toLocaleDateString()
                };

                saveCropsData();
                renderCropsTable();
                updateAnalyticsCharts();
                showSuccessMessage('Crop updated successfully!');

                // Close modal
                const modal = document.querySelector('.modal');
                if (modal) {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    bsModal.hide();
                }
            }
        }

        function deleteCrop(id) {
            showConfirmDialog(
                'Delete Crop',
                'Are you sure you want to delete this crop?',
                'Yes, Delete',
                'Cancel',
                () => {
                    crops = crops.filter(crop => crop.id !== id);
                    saveCropsData();
                    renderCropsTable();
                    showSuccessMessage('Crop deleted successfully!');
                }
            );
        }

        function addNewLivestock() {
            // Show the static modal using Bootstrap's standard method
            const modal = document.getElementById('dashboardAddLivestockModal');
            if (modal) {
                const bsModal = new bootstrap.Modal(modal, {
                    backdrop: 'static',  // Prevent closing by clicking backdrop
                    keyboard: false      // Prevent closing with ESC key
                });
                bsModal.show();
                
                // Store modal instance for later use
                window.currentLivestockModal = bsModal;
                
                // Set up event listeners for auto-calculating lifecycle stage
                setupLivestockLifecycleListeners();
            } else {
                console.error('Dashboard add livestock modal not found');
            }
        }
        
        function setupLivestockLifecycleListeners() {
            // Add event listeners to auto-update lifecycle stage
            const speciesSelect = document.getElementById('dashboardLivestockSpecies');
            const birthDateInput = document.getElementById('dashboardLivestockBirthDate');
            const sexSelect = document.getElementById('dashboardLivestockSex');
            
            if (speciesSelect) {
                speciesSelect.addEventListener('change', updateDashboardLivestockLifecycle);
            }
            if (birthDateInput) {
                birthDateInput.addEventListener('change', updateDashboardLivestockLifecycle);
            }
            if (sexSelect) {
                sexSelect.addEventListener('change', updateDashboardLivestockLifecycle);
            }
        }
        
        function updateDashboardLivestockLifecycle() {
            const species = document.getElementById('dashboardLivestockSpecies')?.value;
            const birthDate = document.getElementById('dashboardLivestockBirthDate')?.value;
            const sex = document.getElementById('dashboardLivestockSex')?.value;
            const lifecycleField = document.getElementById('dashboardLivestockLifecycle');
            
            if (lifecycleField && birthDate && species && sex) {
                const calculatedStage = calculateLifecycleStage(species, birthDate, sex);
                lifecycleField.value = calculatedStage || '';
            } else if (lifecycleField) {
                lifecycleField.value = '';
            }
        }
        
        function confirmCancelLivestockForm() {
            // Check if form has any data
            const hasData = 
                document.getElementById('dashboardLivestockSpecies').value ||
                document.getElementById('dashboardLivestockTag').value ||
                document.getElementById('dashboardLivestockBirthDate').value ||
                document.getElementById('dashboardLivestockBreed').value;
            
            if (hasData) {
                showConfirmDialog(
                    'Cancel Form',
                    'Are you sure you want to close this? All entered data will be lost.',
                    'Yes',
                    'No',
                    () => {
                        // User confirmed - clear form and close modal
                        document.getElementById('dashboardAddLivestockForm').reset();
                        document.querySelectorAll('#dashboardAddLivestockForm .is-invalid').forEach(el => {
                            el.classList.remove('is-invalid');
                        });
                        
                        const modal = bootstrap.Modal.getInstance(document.getElementById('dashboardAddLivestockModal'));
                        if (modal) {
                            modal.hide();
                        }
                    },
                    () => {
                        // User cancelled - do nothing
                        console.log('User chose to continue editing');
                    }
                );
            } else {
                // No data entered - just close
                const modal = bootstrap.Modal.getInstance(document.getElementById('dashboardAddLivestockModal'));
                if (modal) {
                    modal.hide();
                }
            }
        }

        // Fallback function to close modal if Bootstrap fails
        function closeLivestockModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.style.display !== 'none') {
                    modal.style.display = 'none';
                    modal.classList.remove('show');
                    document.body.classList.remove('modal-open');
                    // Remove backdrop
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }
                }
            });
        }

        // Calculate lifecycle stage based on species, birth date, and sex
        function calculateLifecycleStage(species, birthDate, sex) {
            const birth = new Date(birthDate);
            const now = new Date();
            const ageInMonths = Math.floor((now - birth) / (1000 * 60 * 60 * 24 * 30.44)); // Average days per month
            
            const speciesLower = species.toLowerCase();
            
            if (speciesLower === 'cattle') {
                if (ageInMonths < 12) return 'Calf';
                if (ageInMonths < 24) return sex === 'Female' ? 'Heifer' : 'Bull';
                return sex === 'Female' ? 'Cow' : 'Bull';
            }
            
            if (speciesLower === 'pigs') {
                if (ageInMonths < 6) return 'Piglet';
                if (ageInMonths < 12) return sex === 'Female' ? 'Gilt' : 'Boar';
                return sex === 'Female' ? 'Sow' : 'Boar';
            }
            
            if (speciesLower === 'chickens') {
                if (ageInMonths < 4) return 'Chick';
                if (ageInMonths < 6) return sex === 'Female' ? 'Pullet' : 'Cockerel';
                return sex === 'Female' ? 'Hen' : 'Rooster';
            }
            
            if (speciesLower === 'sheep') {
                if (ageInMonths < 12) return 'Lamb';
                return sex === 'Female' ? 'Ewe' : 'Ram';
            }
            
            if (speciesLower === 'goats') {
                if (ageInMonths < 12) return 'Kid';
                return sex === 'Female' ? 'Doe' : 'Buck';
            }
            
            if (speciesLower === 'horses') {
                if (ageInMonths < 12) return 'Foal';
                if (ageInMonths < 48) return sex === 'Female' ? 'Filly' : 'Colt';
                return sex === 'Female' ? 'Mare' : 'Stallion';
            }
            
            // Default fallback
            return ageInMonths < 12 ? 'Juvenile' : 'Adult';
        }

        async function saveDashboardNewLivestock() {
            console.log('üêÑ saveDashboardNewLivestock called');
            
            // Get form values from the static modal
            const species = document.getElementById('dashboardLivestockSpecies').value;
            const tag = document.getElementById('dashboardLivestockTag').value;
            const birthDate = document.getElementById('dashboardLivestockBirthDate').value;
            const purpose = document.getElementById('dashboardLivestockPurpose').value;
            const location = document.getElementById('dashboardLivestockLocation').value;
            const sireTag = document.getElementById('dashboardLivestockSireTag').value;
            const healthNotes = document.getElementById('dashboardLivestockHealthNotes').value;
            const breed = document.getElementById('dashboardLivestockBreed').value;
            const sex = document.getElementById('dashboardLivestockSex').value;
            const weight = document.getElementById('dashboardLivestockWeight').value;
            const lifecycle = document.getElementById('dashboardLivestockLifecycle').value;
            const value = document.getElementById('dashboardLivestockValue').value;
            const damTag = document.getElementById('dashboardLivestockDamTag').value;

            // Auto-calculate lifecycle stage based on birth date, species, and sex
            let calculatedLifecycle = '';
            if (birthDate && species && sex) {
                calculatedLifecycle = calculateLifecycleStage(species, birthDate, sex);
            }
            
            console.log('Form values:', {
                species, tag, birthDate, purpose, location, sireTag, healthNotes,
                breed, sex, weight, lifecycle: calculatedLifecycle, value, damTag
            });

            // Enhanced validation with specific error messages
            const errors = [];
            
            if (!species) errors.push('Species is required');
            if (!tag || tag.trim() === '') errors.push('Tag/ID Number is required');
            if (!birthDate) errors.push('Birth Date is required');
            if (!purpose) errors.push('Production Purpose is required');
            if (!location || location.trim() === '') errors.push('Location/Pen is required');
            if (!breed || breed.trim() === '') errors.push('Breed is required');
            if (!sex) errors.push('Sex is required');

            if (errors.length > 0) {
                console.error('Validation errors:', errors);
                
                // Highlight invalid fields
                if (!species) document.getElementById('dashboardLivestockSpecies').classList.add('is-invalid');
                if (!tag || tag.trim() === '') document.getElementById('dashboardLivestockTag').classList.add('is-invalid');
                if (!birthDate) document.getElementById('dashboardLivestockBirthDate').classList.add('is-invalid');
                if (!purpose) document.getElementById('dashboardLivestockPurpose').classList.add('is-invalid');
                if (!location || location.trim() === '') document.getElementById('dashboardLivestockLocation').classList.add('is-invalid');
                if (!breed || breed.trim() === '') document.getElementById('dashboardLivestockBreed').classList.add('is-invalid');
                if (!sex) document.getElementById('dashboardLivestockSex').classList.add('is-invalid');
                
                showInfoDialog('Validation Error', `Please fix the following:\n‚Ä¢ ${errors.join('\n‚Ä¢ ')}`, 'OK');
                return;
            }
            
            // Clear any previous validation errors
            document.querySelectorAll('#dashboardAddLivestockForm .is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
            
            console.log('‚úÖ All validation checks passed');

            // Show loading state
            const submitButton = document.querySelector('button[onclick="saveDashboardNewLivestock()"]');
            const originalText = submitButton.innerHTML;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Adding...';
            submitButton.disabled = true;

            try {
                let savedViaAPI = false;
                
                // Try to save via API directly (skip health check for faster response)
                if (typeof window.SmartFarmAPI !== 'undefined') {
                    try {
                        console.log('üåê Attempting to add livestock via API');
                        
                        // Get farm ID - use cached value if available, otherwise fetch with timeout
                        let farmId = null;
                        
                        // Check for cached farm ID first (to avoid unnecessary API call)
                        const cachedFarmId = sessionStorage.getItem('smartfarm_current_farm_id');
                        if (cachedFarmId) {
                            farmId = cachedFarmId;
                            console.log('‚úÖ Using cached farm ID:', farmId);
                        } else {
                            // Fetch farms with timeout to avoid hanging
                            try {
                                const farmsPromise = window.SmartFarmAPI.getFarms();
                                const timeoutPromise = new Promise((_, reject) => 
                                    setTimeout(() => reject(new Error('Farm fetch timeout')), 2000)
                                );
                                
                                const farmsResponse = await Promise.race([farmsPromise, timeoutPromise]);
                                
                                if (farmsResponse && farmsResponse.success && farmsResponse.data && farmsResponse.data.length > 0) {
                                    farmId = farmsResponse.data[0].id;
                                    // Cache the farm ID for future use
                                    sessionStorage.setItem('smartfarm_current_farm_id', farmId);
                                    console.log('‚úÖ Using farm ID:', farmId);
                                } else {
                                    console.log('‚ÑπÔ∏è No farms found, saving without farm ID');
                                }
                            } catch (farmError) {
                                console.warn('‚ö†Ô∏è Error fetching farms, continuing without farm ID:', farmError.message);
                            }
                        }
                        
                        // Prepare livestock data (farmId is optional)
                        const livestockData = {
                            name: `${breed} ${tag}`,
                            type: species,
                            breed: breed,
                            birthDate: birthDate,
                            weight: weight ? parseFloat(weight) : null,
                            description: `${sex} ${species} - ${purpose} - Tag: ${tag}${healthNotes ? ' - ' + healthNotes : ''}`,
                            tag: tag,
                            sex: sex,
                            purpose: purpose,
                            location: location,
                            lifecycle: calculatedLifecycle,
                            value: value ? parseFloat(value) : null,
                            sireTag: sireTag,
                            damTag: damTag
                        };
                        
                        // Only add farmId if we have one
                        if (farmId) {
                            livestockData.farmId = farmId;
                        }

                        const response = await window.SmartFarmAPI.createLivestock(livestockData);

                        if (response.success) {
                            console.log('‚úÖ Livestock added successfully via API');
                            savedViaAPI = true;
                            showSuccessMessage('Livestock added successfully!');
                            
                            // Refresh livestock data
                            await loadLivestockData();
                        } else {
                            console.warn('‚ö†Ô∏è API request failed, falling back to localStorage:', response.error);
                            // Fall through to localStorage fallback
                        }
                    } catch (apiError) {
                        console.warn('‚ö†Ô∏è API error, falling back to localStorage:', apiError);
                        // Fall through to localStorage fallback
                    }
                }
                
                // Use localStorage fallback if API didn't work or is not available
                if (!savedViaAPI) {
                    console.log('üíæ Using localStorage to add livestock');
                    
                    const newLivestock = {
                        id: Date.now(), // Simple ID generation
                        name: `${breed} ${tag}`,
                        species: species,
                        type: species,
                        breed: breed,
                        tag: tag,
                        birthDate: birthDate,
                        purpose: purpose,
                        location: location,
                        sireTag: sireTag,
                        damTag: damTag,
                        healthNotes: healthNotes || '',
                        sex: sex,
                        weight: weight ? parseFloat(weight) : null,
                        lifecycle: calculatedLifecycle,
                        value: value ? parseFloat(value) : 0,
                        healthStatus: 'healthy',
                        lastUpdated: new Date().toISOString()
                    };

                    // Add to livestock array
                    livestock.push(newLivestock);
                    saveLivestockData();
                    
                    showSuccessMessage('Livestock added successfully! (Saved locally)');
                    
                    // Refresh display
                    renderLivestockGrid();
                    renderLivestockTable();
                    updateLivestockStatistics();
                }
                
                // Clear form
                document.getElementById('dashboardLivestockSpecies').value = '';
                document.getElementById('dashboardLivestockTag').value = '';
                document.getElementById('dashboardLivestockBirthDate').value = '';
                document.getElementById('dashboardLivestockPurpose').value = '';
                document.getElementById('dashboardLivestockLocation').value = '';
                document.getElementById('dashboardLivestockSireTag').value = '';
                document.getElementById('dashboardLivestockHealthNotes').value = '';
                document.getElementById('dashboardLivestockBreed').value = '';
                document.getElementById('dashboardLivestockSex').value = '';
                document.getElementById('dashboardLivestockWeight').value = '';
                document.getElementById('dashboardLivestockLifecycle').value = '';
                document.getElementById('dashboardLivestockValue').value = '';
                document.getElementById('dashboardLivestockDamTag').value = '';

                // Close modal using Bootstrap
                const modal = bootstrap.Modal.getInstance(document.getElementById('dashboardAddLivestockModal'));
                if (modal) {
                    modal.hide();
                }

            } catch (error) {
                console.error('Error adding livestock:', error);
                showErrorMessage('An error occurred while adding livestock: ' + error.message);
                // Restore button state and keep modal open on error
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
                return; // Don't proceed to close modal
            }
            
            // Only reach here on success - restore button state and close modal
            submitButton.innerHTML = originalText;
            submitButton.disabled = false;
        }

        // Keep the old function for backwards compatibility
        async function saveNewLivestock() {
            // Redirect to the new function
            return await saveDashboardNewLivestock();
        }

        // Dashboard Feed Mix Calculator Functions
        function showDashboardFeedMixCalculator() {
            const modalElement = document.getElementById('feedMixCalculatorModal');
            if (!modalElement) {
                showAlert('Feed Mix Calculator modal not found. Please refresh the page.', 'error');
                console.error('feedMixCalculatorModal not found');
                return;
            }
            
            try {
                let modal = bootstrap.Modal.getInstance(modalElement);
                if (!modal) {
                    modal = new bootstrap.Modal(modalElement);
                }
                modal.show();
            } catch (error) {
                console.error('Error showing feed mix calculator modal:', error);
                showAlert('Error opening Feed Mix Calculator. Please try again.', 'error');
            }
        }

        function updateFeedMixLifecycleOptions() {
            const species = document.getElementById('feedMixSpecies').value;
            const lifecycleSelect = document.getElementById('feedMixLifecycle');
            
            if (!lifecycleSelect) {
                console.error('feedMixLifecycle select not found');
                return;
            }
            
            // Clear existing options
            lifecycleSelect.innerHTML = '<option value="">Select Lifecycle Stage</option>';
            
            if (species) {
                if (window.FeedMixCalculator && typeof window.FeedMixCalculator.getLifecycleStages === 'function') {
                    try {
                        const stages = window.FeedMixCalculator.getLifecycleStages(species);
                        if (stages && Array.isArray(stages)) {
                            stages.forEach(stage => {
                                const option = document.createElement('option');
                                option.value = stage.value;
                                option.textContent = stage.label;
                                lifecycleSelect.appendChild(option);
                            });
                        }
                    } catch (error) {
                        console.error('Error getting lifecycle stages:', error);
                    }
                } else {
                    console.warn('FeedMixCalculator not available or getLifecycleStages method not found');
                    // Fallback: Add common lifecycle stages
                    const commonStages = [
                        { value: 'calf', label: 'Calf' },
                        { value: 'heifer', label: 'Heifer' },
                        { value: 'cow', label: 'Cow' },
                        { value: 'bull', label: 'Bull' }
                    ];
                    commonStages.forEach(stage => {
                        const option = document.createElement('option');
                        option.value = stage.value;
                        option.textContent = stage.label;
                        lifecycleSelect.appendChild(option);
                    });
                }
            }
        }

        async function calculateFeedMix() {
            try {
                // Get form values
                const species = document.getElementById('feedMixSpecies').value;
                const lifecycle = document.getElementById('feedMixLifecycle').value;
                const weight = parseFloat(document.getElementById('feedMixWeight').value);
                const age = document.getElementById('feedMixAge').value ? parseFloat(document.getElementById('feedMixAge').value) : null;
                const purpose = document.getElementById('feedMixPurpose').value;

                // Validate required fields
                if (!species || !lifecycle || !weight) {
                    showAlert('Please fill in Species, Lifecycle Stage, and Weight', 'error');
                    return;
                }

                // Prepare animal data
                const animalData = {
                    species: species,
                    weight: weight,
                    age: age,
                    lifecycle: lifecycle,
                    purpose: purpose,
                    productionStage: purpose
                };

                // Check if FeedMixCalculator is available
                if (!window.FeedMixCalculator || typeof window.FeedMixCalculator.calculateFeedMix !== 'function') {
                    showAlert('Feed Mix Calculator is not available. Please refresh the page.', 'error');
                    console.error('FeedMixCalculator not available');
                    return;
                }

                // Calculate feed mix
                let result;
                try {
                    result = window.FeedMixCalculator.calculateFeedMix(animalData);
                    if (!result || !result.feedMix) {
                        throw new Error('Invalid result from FeedMixCalculator');
                    }
                } catch (calcError) {
                    console.error('Error calculating feed mix:', calcError);
                    showAlert('Error calculating feed mix: ' + calcError.message, 'error');
                    return;
                }
                
                // Display results
                displayFeedMixResults(result);
                
                // Show results section
                const resultsDiv = document.getElementById('feedMixResults');
                const instructionsDiv = document.getElementById('feedMixInstructions');
                if (resultsDiv) resultsDiv.style.display = 'block';
                if (instructionsDiv) instructionsDiv.style.display = 'none';
                
                showAlert('Feed mix calculated successfully!', 'success');
                
            } catch (error) {
                console.error('Error calculating feed mix:', error);
                showAlert('Error calculating feed mix: ' + error.message, 'error');
            }
        }

        function displayFeedMixResults(result) {
            if (!result || !result.requirements || !result.feedMix) {
                console.error('Invalid result data for displayFeedMixResults:', result);
                showAlert('Error displaying results: Invalid data', 'error');
                return;
            }

            // Display nutritional requirements
            const requirementsDiv = document.getElementById('nutritionalRequirements');
            if (requirementsDiv) {
                if (result.requirements.dailyRequirements) {
                    // New format with ranges
                    requirementsDiv.innerHTML = `
                        <div class="col-md-6">
                            <div class="mb-2">
                                <strong>Protein:</strong> ${result.requirements.dailyRequirements.protein.min}-${result.requirements.dailyRequirements.protein.max}%
                            </div>
                            <div class="mb-2">
                                <strong>Energy:</strong> ${result.requirements.dailyRequirements.energy.min}-${result.requirements.dailyRequirements.energy.max} Mcal/kg
                            </div>
                            <div class="mb-2">
                                <strong>Fiber:</strong> ${result.requirements.dailyRequirements.fiber.min}-${result.requirements.dailyRequirements.fiber.max}%
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-2">
                                <strong>Calcium:</strong> ${result.requirements.dailyRequirements.calcium.min}-${result.requirements.dailyRequirements.calcium.max}%
                            </div>
                            <div class="mb-2">
                                <strong>Phosphorus:</strong> ${result.requirements.dailyRequirements.phosphorus.min}-${result.requirements.dailyRequirements.phosphorus.max}%
                            </div>
                            <div class="mb-2">
                                <strong>Daily Intake:</strong> ${result.requirements.dailyRequirements.dailyIntake.min}-${result.requirements.dailyRequirements.dailyIntake.max}% of body weight
                            </div>
                        </div>
                    `;
                } else {
                    // Fallback format
                    requirementsDiv.innerHTML = `
                        <div class="col-md-6">
                            <p><strong>Daily Energy:</strong> ${result.requirements.energy ? result.requirements.energy.toFixed(2) : 'N/A'} MCal</p>
                            <p><strong>Daily Protein:</strong> ${result.requirements.protein ? result.requirements.protein.toFixed(2) : 'N/A'} kg</p>
                            <p><strong>Daily Fiber:</strong> ${result.requirements.fiber ? result.requirements.fiber.toFixed(2) : 'N/A'} kg</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Daily Calcium:</strong> ${result.requirements.calcium ? result.requirements.calcium.toFixed(2) : 'N/A'} g</p>
                            <p><strong>Daily Phosphorus:</strong> ${result.requirements.phosphorus ? result.requirements.phosphorus.toFixed(2) : 'N/A'} g</p>
                        </div>
                    `;
                }
            }

            // Display feed mix composition
            const compositionDiv = document.getElementById('feedMixComposition');
            if (compositionDiv && result.feedMix) {
                let compositionHTML = '';
                for (const [ingredient, percentage] of Object.entries(result.feedMix)) {
                    compositionHTML += `
                        <div class="d-flex justify-content-between mb-2">
                            <span>${ingredient}</span>
                            <span class="badge bg-primary">${typeof percentage === 'number' ? percentage.toFixed(1) : percentage}%</span>
                        </div>
                    `;
                }
                compositionDiv.innerHTML = compositionHTML;
            }

            // Display costs
            const costsDiv = document.getElementById('feedMixCosts');
            if (costsDiv && result.totalCost) {
                costsDiv.innerHTML = `
                    <div class="mb-2">
                        <strong>Daily Intake:</strong> ${result.dailyIntake && result.dailyIntake.recommended ? result.dailyIntake.recommended.toFixed(1) : 'N/A'} kg
                    </div>
                    <div class="mb-2">
                        <strong>Cost per kg:</strong> $${result.totalCost.costPerKg ? result.totalCost.costPerKg.toFixed(2) : '0.00'}
                    </div>
                    <div class="mb-2">
                        <strong>Daily Cost:</strong> $${result.totalCost.dailyCost ? result.totalCost.dailyCost.toFixed(2) : '0.00'}
                    </div>
                    <div class="mb-2">
                        <strong>Monthly Cost:</strong> $${result.totalCost.monthlyCost ? result.totalCost.monthlyCost.toFixed(2) : '0.00'}
                    </div>
                    <div class="mb-2">
                        <strong>Annual Cost:</strong> $${result.totalCost.annualCost ? result.totalCost.annualCost.toFixed(2) : '0.00'}
                    </div>
                `;
            }

            // Display recommendations
            const recommendationsDiv = document.getElementById('feedMixRecommendations');
            if (recommendationsDiv) {
                let recommendationsHTML = '';
                if (result.recommendations && Array.isArray(result.recommendations)) {
                    result.recommendations.forEach(rec => {
                        if (typeof rec === 'object' && rec.message) {
                            const alertClass = rec.type === 'warning' ? 'alert-warning' : 
                                             rec.type === 'success' ? 'alert-success' : 'alert-info';
                            recommendationsHTML += `
                                <div class="alert ${alertClass} alert-sm mb-2">
                                    <i class="fas fa-${rec.type === 'warning' ? 'exclamation-triangle' : 
                                                       rec.type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                                    ${rec.message}
                                </div>
                            `;
                        } else {
                            recommendationsHTML += `
                                <div class="alert alert-info alert-sm mb-2">
                                    <i class="fas fa-info-circle me-2"></i>${rec}
                                </div>
                            `;
                        }
                    });
                }
                recommendationsDiv.innerHTML = recommendationsHTML || '<p class="text-muted">No specific recommendations available.</p>';
            }
        }

        function printFeedMixReport() {
            const resultsDiv = document.getElementById('feedMixResults');
            if (!resultsDiv || resultsDiv.style.display === 'none') {
                showAlert('Please calculate a feed mix first before printing.', 'warning');
                return;
            }

            window.print();
        }

        function editLivestock(id) {
            const animal = livestock.find(l => l.id === id);
            if (!animal) {
                showInfoDialog('Error', 'Livestock record not found', 'OK');
                return;
            }

            // Create comprehensive edit modal with all fields
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-edit me-2"></i>Edit Livestock - ${animal.type} ${animal.breed}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editLivestockForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-primary mb-3">Basic Information</h6>
                                        <div class="mb-3">
                                            <label for="editLivestockType" class="form-label">Type</label>
                                            <select class="form-select" id="editLivestockType" required>
                                                <option value="Cattle" ${animal.type === 'Cattle' ? 'selected' : ''}>Cattle</option>
                                                <option value="Pigs" ${animal.type === 'Pigs' ? 'selected' : ''}>Pigs</option>
                                                <option value="Chickens" ${animal.type === 'Chickens' ? 'selected' : ''}>Chickens</option>
                                                <option value="Sheep" ${animal.type === 'Sheep' ? 'selected' : ''}>Sheep</option>
                                                <option value="Goats" ${animal.type === 'Goats' ? 'selected' : ''}>Goats</option>
                                                <option value="Horses" ${animal.type === 'Horses' ? 'selected' : ''}>Horses</option>
                                                <option value="Ducks" ${animal.type === 'Ducks' ? 'selected' : ''}>Ducks</option>
                                                <option value="Other" ${animal.type === 'Other' ? 'selected' : ''}>Other</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editLivestockBreed" class="form-label">Breed</label>
                                            <input type="text" class="form-control" id="editLivestockBreed" value="${animal.breed}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editLivestockQuantity" class="form-label">Quantity</label>
                                            <input type="number" class="form-control" id="editLivestockQuantity" value="${animal.quantity}" min="1" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editLivestockLocation" class="form-label">Location</label>
                                            <input type="text" class="form-control" id="editLivestockLocation" value="${animal.location}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editLivestockStatus" class="form-label">Health Status</label>
                                            <select class="form-select" id="editLivestockStatus" required>
                                                <option value="Healthy" ${animal.status === 'Healthy' ? 'selected' : ''}>Healthy</option>
                                                <option value="Sick" ${animal.status === 'Sick' ? 'selected' : ''}>Sick</option>
                                                <option value="Quarantine" ${animal.status === 'Quarantine' ? 'selected' : ''}>Quarantine</option>
                                                <option value="Recovering" ${animal.status === 'Recovering' ? 'selected' : ''}>Recovering</option>
                                                <option value="Pregnant" ${animal.status === 'Pregnant' ? 'selected' : ''}>Pregnant</option>
                                                <option value="Breeding" ${animal.status === 'Breeding' ? 'selected' : ''}>Breeding</option>
                                                <option value="Lactating" ${animal.status === 'Lactating' ? 'selected' : ''}>Lactating</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-primary mb-3">Tracking Information</h6>
                                        <div class="mb-3">
                                            <label for="editEarTags" class="form-label">Ear Tags (comma-separated)</label>
                                            <input type="text" class="form-control" id="editEarTags" value="${animal.earTags ? animal.earTags.join(', ') : ''}" placeholder="ET001, ET002, ET003">
                                            <small class="form-text text-muted">Enter ear tag numbers separated by commas</small>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editGpsLat" class="form-label">GPS Latitude</label>
                                            <input type="number" class="form-control" id="editGpsLat" step="any" value="${animal.gpsLocation ? animal.gpsLocation.lat : ''}" placeholder="-18.1416">
                                        </div>
                                        <div class="mb-3">
                                            <label for="editGpsLng" class="form-label">GPS Longitude</label>
                                            <input type="number" class="form-control" id="editGpsLng" step="any" value="${animal.gpsLocation ? animal.gpsLocation.lng : ''}" placeholder="178.4419">
                                        </div>
                                        <div class="mb-3">
                                            <label for="editHealthNotes" class="form-label">Health Notes</label>
                                            <textarea class="form-control" id="editHealthNotes" rows="3" placeholder="Any health observations or notes...">${animal.healthNotes || ''}</textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Weight Records Section -->
                                <div class="mt-4">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-weight me-2"></i>Weight Records
                                        <button type="button" class="btn btn-sm btn-outline-success ms-2" onclick="addWeightRecordFromEdit(${id})">
                                            <i class="fas fa-plus"></i> Add Weight
                                        </button>
                                    </h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Weight (kg)</th>
                                                    <th>Notes</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="editWeightRecordsTable">
                                                ${animal.weightRecords && animal.weightRecords.length > 0 
                                                    ? animal.weightRecords.map(record => `
                                                        <tr>
                                                            <td>${new Date(record.date).toLocaleDateString()}</td>
                                                            <td>${record.avgWeight}</td>
                                                            <td>${record.notes}</td>
                                                            <td>
                                                                <button class="btn btn-sm btn-outline-danger" onclick="removeWeightRecord(${id}, '${record.date}')">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    `).join('')
                                                    : '<tr><td colspan="4" class="text-muted">No weight records</td></tr>'
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Immunization Records Section -->
                                <div class="mt-4">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-syringe me-2"></i>Immunization Records
                                        <button type="button" class="btn btn-sm btn-outline-warning ms-2" onclick="addImmunizationFromEdit(${id})">
                                            <i class="fas fa-plus"></i> Add Immunization
                                        </button>
                                    </h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Vaccine</th>
                                                    <th>Next Due</th>
                                                    <th>Vet</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="editImmunizationRecordsTable">
                                                ${animal.immunizations && animal.immunizations.length > 0 
                                                    ? animal.immunizations.map(immunization => `
                                                        <tr>
                                                            <td>${new Date(immunization.date).toLocaleDateString()}</td>
                                                            <td>${immunization.vaccine}</td>
                                                            <td>${new Date(immunization.nextDue).toLocaleDateString()}</td>
                                                            <td>${immunization.vet}</td>
                                                            <td>
                                                                <button class="btn btn-sm btn-outline-danger" onclick="removeImmunizationRecord(${id}, '${immunization.date}', '${immunization.vaccine}')">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    `).join('')
                                                    : '<tr><td colspan="5" class="text-muted">No immunization records</td></tr>'
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveEditedLivestock(${id})">
                                <i class="fas fa-save me-2"></i>Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function saveEditedLivestock(id) {
            const type = document.getElementById('editLivestockType').value.trim();
            const breed = document.getElementById('editLivestockBreed').value.trim();
            const quantity = parseInt(document.getElementById('editLivestockQuantity').value);
            const location = document.getElementById('editLivestockLocation').value.trim();
            const status = document.getElementById('editLivestockStatus').value.trim();
            const earTagsText = document.getElementById('editEarTags').value;
            const gpsLat = parseFloat(document.getElementById('editGpsLat').value);
            const gpsLng = parseFloat(document.getElementById('editGpsLng').value);
            const healthNotes = document.getElementById('editHealthNotes').value;

            if (!type || !breed || !quantity || !location || !status) {
                showInfoDialog('Validation Error', 'Please fill in all required fields', 'OK');
                return;
            }

            if (quantity < 1) {
                showInfoDialog('Validation Error', 'Quantity must be at least 1', 'OK');
                return;
            }

            // Process ear tags
            const earTags = earTagsText ? earTagsText.split(',').map(tag => tag.trim()).filter(tag => tag) : [];

            // Create GPS location if coordinates provided
            let gpsLocation = null;
            if (gpsLat && gpsLng) {
                gpsLocation = {
                    lat: gpsLat,
                    lng: gpsLng,
                    lastUpdate: new Date().toISOString()
                };
            }

            // Find and update the livestock
            const livestockIndex = livestock.findIndex(l => l.id === id);
            if (livestockIndex !== -1) {
                livestock[livestockIndex] = {
                    ...livestock[livestockIndex],
                    type: type,
                    breed: breed,
                    quantity: quantity,
                    location: location,
                    status: status,
                    earTags: earTags,
                    gpsLocation: gpsLocation,
                    healthNotes: healthNotes || livestock[livestockIndex].healthNotes || 'No notes'
                };

                saveLivestockData();
                renderLivestockTable();
                updateAnalyticsCharts();
                showSuccessMessage('Livestock updated successfully!');

                // Close modal
                const modal = document.querySelector('.modal');
                if (modal) {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    bsModal.hide();
                }
            }
        }

        function deleteLivestock(id) {
            showConfirmDialog(
                'Delete Livestock',
                'Are you sure you want to delete this livestock record?',
                'Yes, Delete',
                'Cancel',
                () => {
                    livestock = livestock.filter(animal => animal.id !== id);
                    saveLivestockData();
                    renderLivestockTable();
                    showSuccessMessage('Livestock deleted successfully!');
                }
            );
        }

        // Pets Management Functions
        function renderPetsTable() {
            // Update tab counts first
            updatePetsTabCounts();
            
            // Render all pets table
            const allPetsTbody = document.querySelector('#petsTable');
            if (allPetsTbody) {
                allPetsTbody.innerHTML = '';
                pets.forEach(pet => {
                    allPetsTbody.appendChild(createPetRow(pet, true));
                });
            }
            
            // Render dogs table
            const dogsTbody = document.querySelector('#dogsTable');
            if (dogsTbody) {
                dogsTbody.innerHTML = '';
                pets.filter(pet => pet.species.toLowerCase() === 'dog').forEach(pet => {
                    dogsTbody.appendChild(createPetRow(pet, false));
                });
            }
            
            // Render cats table
            const catsTbody = document.querySelector('#catsTable');
            if (catsTbody) {
                catsTbody.innerHTML = '';
                pets.filter(pet => pet.species.toLowerCase() === 'cat').forEach(pet => {
                    catsTbody.appendChild(createPetRow(pet, false));
                });
            }
            
            // Render birds table
            const birdsTbody = document.querySelector('#birdsTable');
            if (birdsTbody) {
                birdsTbody.innerHTML = '';
                pets.filter(pet => pet.species.toLowerCase() === 'bird').forEach(pet => {
                    birdsTbody.appendChild(createPetRow(pet, true));
                });
            }
            
            // Render fish table
            const fishTbody = document.querySelector('#fishTable');
            if (fishTbody) {
                fishTbody.innerHTML = '';
                pets.filter(pet => pet.species.toLowerCase() === 'fish').forEach(pet => {
                    fishTbody.appendChild(createPetRow(pet, true));
                });
            }
            
            // Render other pets table
            const otherPetsTbody = document.querySelector('#otherPetsTable');
            if (otherPetsTbody) {
                otherPetsTbody.innerHTML = '';
                pets.filter(pet => !['dog', 'cat', 'bird', 'fish'].includes(pet.species.toLowerCase())).forEach(pet => {
                    otherPetsTbody.appendChild(createPetRow(pet, true));
                });
            }
        }

        function updatePetsTabCounts() {
            const counts = {
                all: pets.length,
                dogs: pets.filter(pet => pet.species.toLowerCase() === 'dog').length,
                cats: pets.filter(pet => pet.species.toLowerCase() === 'cat').length,
                birds: pets.filter(pet => pet.species.toLowerCase() === 'bird').length,
                fish: pets.filter(pet => pet.species.toLowerCase() === 'fish').length,
                other: pets.filter(pet => !['dog', 'cat', 'bird', 'fish'].includes(pet.species.toLowerCase())).length
            };

            document.getElementById('all-pets-count').textContent = counts.all;
            document.getElementById('dogs-count').textContent = counts.dogs;
            document.getElementById('cats-count').textContent = counts.cats;
            document.getElementById('birds-count').textContent = counts.birds;
            document.getElementById('fish-count').textContent = counts.fish;
            document.getElementById('other-pets-count').textContent = counts.other;
        }

        function renderPetsGrid() {
            const petsGrid = document.getElementById('petsGrid');
            if (!petsGrid) return;

            petsGrid.innerHTML = '';

            pets.forEach(pet => {
                const petCard = createPetsCard(pet);
                petsGrid.appendChild(petCard);
            });
        }

        function createPetsCard(pet) {
            const card = document.createElement('div');
            card.className = 'pets-card';
            
            const statusClass = pet.healthStatus.toLowerCase().replace(' ', '-');
            const statusColor = getStatusColor(pet.healthStatus);
            
            card.innerHTML = `
                <div class="pets-header">
                    <div class="pets-info">
                        <h5 class="pets-name">${pet.name}</h5>
                        <p class="pets-breed">${pet.breed}</p>
                    </div>
                    <div class="status-badge-top">
                        <span class="status-dot status-${statusClass}"></span>
                        <span class="status-badge status-${statusClass}">${pet.healthStatus}</span>
                    </div>
                </div>
                <div class="pets-details">
                    <div class="detail-row">
                        <i class="fas fa-tag"></i>
                        <span>ID: P${pet.id.toString().padStart(3, '0')}</span>
                    </div>
                    <div class="detail-row">
                        <i class="fas fa-venus-mars"></i>
                        <span>Sex: ${pet.gender}</span>
                    </div>
                    <div class="detail-row">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Age: ${pet.age} years</span>
                    </div>
                    <div class="detail-row">
                        <i class="fas fa-weight"></i>
                        <span>Weight: ${pet.weight || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Location: ${pet.location || 'Home'}</span>
                    </div>
                    <div class="detail-row">
                        <i class="fas fa-syringe"></i>
                        <span>Vaccination: ${pet.vaccination}</span>
                    </div>
                </div>
                <div class="pets-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="editPet(${pet.id})">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-success" onclick="addHealthRecord(${pet.id})">
                        <i class="fas fa-heartbeat"></i> Health
                    </button>
                    <button class="btn btn-sm btn-info" onclick="viewPetDetails(${pet.id})">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deletePet(${pet.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            return card;
        }

        function updatePetsStatistics() {
            const totalPets = pets.length;
            const healthyPets = pets.filter(pet => pet.healthStatus === 'Healthy').length;
            const vaccinatedPets = pets.filter(pet => pet.vaccination === 'Up to date').length;
            const totalValue = pets.reduce((sum, pet) => sum + (pet.value || 0), 0);

            document.getElementById('totalPets').textContent = totalPets;
            document.getElementById('healthyPets').textContent = healthyPets;
            document.getElementById('vaccinatedPets').textContent = vaccinatedPets;
            document.getElementById('totalPetsValue').textContent = totalValue.toLocaleString();
        }

        function getStatusColor(status) {
            switch (status.toLowerCase()) {
                case 'healthy': return 'success';
                case 'sick': return 'danger';
                case 'recovering': return 'warning';
                case 'under treatment': return 'info';
                default: return 'secondary';
            }
        }

        function filterPets() {
            const searchTerm = document.getElementById('petsSearch').value.toLowerCase();
            const speciesFilter = document.getElementById('petsSpeciesFilter').value;
            const statusFilter = document.getElementById('petsStatusFilter').value;

            let filteredPets = pets.filter(pet => {
                const matchesSearch = pet.name.toLowerCase().includes(searchTerm) || 
                                    pet.breed.toLowerCase().includes(searchTerm) ||
                                    pet.species.toLowerCase().includes(searchTerm);
                const matchesSpecies = !speciesFilter || pet.species === speciesFilter;
                const matchesStatus = !statusFilter || pet.healthStatus === statusFilter;
                
                return matchesSearch && matchesSpecies && matchesStatus;
            });

            // Update the pets grid with filtered results
            const petsGrid = document.getElementById('petsGrid');
            if (petsGrid) {
                petsGrid.innerHTML = '';
                filteredPets.forEach(pet => {
                    const petCard = createPetsCard(pet);
                    petsGrid.appendChild(petCard);
                });
            }
        }

        function createPetRow(pet, showSpecies = true) {
            const row = document.createElement('tr');
            
            const healthStatusClass = pet.healthStatus === 'Healthy' ? 'text-success' : 
                                    pet.healthStatus === 'Sick' ? 'text-danger' : 'text-warning';
            
            const vaccinationClass = pet.vaccination === 'Up to date' ? 'text-success' : 'text-warning';
            
            row.innerHTML = `
                ${showSpecies ? `<td>${pet.species}</td>` : ''}
                <td>${pet.breed}</td>
                <td><strong>${pet.name}</strong></td>
                <td>${pet.age} years</td>
                <td>${pet.gender}</td>
                <td><span class="${healthStatusClass}">${pet.healthStatus}</span></td>
                <td><span class="${vaccinationClass}">${pet.vaccination}</span></td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary" onclick="viewPetDetails(${pet.id})" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="editPet(${pet.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePet(${pet.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            
            return row;
        }

        function addNewPet() {
            // Create comprehensive add pet modal
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'addPetModal'; // Add ID for easier targeting
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-plus me-2"></i>Add New Pet
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addPetForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="petSpecies" class="form-label">Species</label>
                                            <select class="form-select" id="petSpecies" data-catalog-group="pets" required onchange="updatePetBreeds()">
                                                <option value="">Select Species</option>
                                                <option value="Dog">Dog</option>
                                                <option value="Cat">Cat</option>
                                                <option value="Bird">Bird</option>
                                                <option value="Fish">Fish</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="petBreed" class="form-label">Breed</label>
                                            <input type="text" class="form-control" id="petBreed" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="petName" class="form-label">Name</label>
                                            <input type="text" class="form-control" id="petName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="petAge" class="form-label">Age (years)</label>
                                            <input type="number" class="form-control" id="petAge" min="0" max="50" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="petGender" class="form-label">Gender</label>
                                            <select class="form-select" id="petGender" required>
                                                <option value="">Select Gender</option>
                                                <option value="Male">Male</option>
                                                <option value="Female">Female</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="petHealthStatus" class="form-label">Health Status</label>
                                            <select class="form-select" id="petHealthStatus" required>
                                                <option value="Healthy">Healthy</option>
                                                <option value="Sick">Sick</option>
                                                <option value="Recovering">Recovering</option>
                                                <option value="Under Treatment">Under Treatment</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="petVaccination" class="form-label">Vaccination Status</label>
                                            <select class="form-select" id="petVaccination" required>
                                                <option value="Up to date">Up to date</option>
                                                <option value="Due soon">Due soon</option>
                                                <option value="Overdue">Overdue</option>
                                                <option value="Not vaccinated">Not vaccinated</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="lastVetVisit" class="form-label">Last Vet Visit</label>
                                            <input type="date" class="form-control" id="lastVetVisit">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="petNotes" class="form-label">Notes</label>
                                    <textarea class="form-control" id="petNotes" rows="3" placeholder="Any additional notes about the pet..."></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveNewPet()">
                                <i class="fas fa-save me-2"></i>Add Pet
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function updatePetBreeds() {
            const species = document.getElementById('petSpecies').value;
            const breedInput = document.getElementById('petBreed');
            
            if (species && globalPetsDatabase[species.toLowerCase()]) {
                const breeds = globalPetsDatabase[species.toLowerCase()].breeds || globalPetsDatabase[species.toLowerCase()].species;
                if (breeds) {
                    breedInput.type = 'text';
                    breedInput.setAttribute('list', 'breedList');
                    
                    // Create datalist for breed suggestions
                    let datalist = document.getElementById('breedList');
                    if (datalist) datalist.remove();
                    
                    datalist = document.createElement('datalist');
                    datalist.id = 'breedList';
                    breeds.forEach(breed => {
                        const option = document.createElement('option');
                        option.value = breed.name;
                        datalist.appendChild(option);
                    });
                    document.body.appendChild(datalist);
                }
            } else {
                breedInput.type = 'text';
                breedInput.removeAttribute('list');
            }
        }

        function saveNewPet() {
            const species = document.getElementById('petSpecies').value;
            const breed = document.getElementById('petBreed').value;
            const name = document.getElementById('petName').value;
            const age = parseInt(document.getElementById('petAge').value);
            const gender = document.getElementById('petGender').value;
            const healthStatus = document.getElementById('petHealthStatus').value;
            const vaccination = document.getElementById('petVaccination').value;
            const lastVetVisit = document.getElementById('lastVetVisit').value;
            const notes = document.getElementById('petNotes').value;

            if (!species || !breed || !name || !age || !gender) {
                showSuccessMessage('Please fill in all required fields', 'error');
                return;
            }

            const newPet = {
                id: Date.now(),
                species: species,
                breed: breed,
                name: name,
                age: age,
                gender: gender,
                healthStatus: healthStatus,
                vaccination: vaccination,
                lastVetVisit: lastVetVisit || null,
                notes: notes || '',
                dateAdded: new Date().toISOString()
            };

            pets.push(newPet);
            savePetsData();
            renderPetsGrid();
            renderPetsTable();
            updatePetsStatistics();
            updateAnalyticsCharts();
            
            // Close modal - try multiple methods to ensure it closes
            const modalElement = document.getElementById('addPetModal');
            if (modalElement) {
                const bsModal = bootstrap.Modal.getInstance(modalElement);
                if (bsModal) {
                    bsModal.hide();
                } else {
                    // Fallback: manually close the modal
                    modalElement.classList.remove('show');
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }
                    modalElement.style.display = 'none';
                    modalElement.setAttribute('aria-hidden', 'true');
                    modalElement.removeAttribute('aria-modal');
                    // Trigger hidden event to clean up
                    const hiddenEvent = new Event('hidden.bs.modal', { bubbles: true });
                    modalElement.dispatchEvent(hiddenEvent);
                }
            } else {
                // Fallback: find modal via form
                const petForm = document.getElementById('addPetForm');
                if (petForm) {
                    const formModal = petForm.closest('.modal');
                    if (formModal) {
                        const bsModal = bootstrap.Modal.getInstance(formModal);
                        if (bsModal) {
                            bsModal.hide();
                        }
                    }
                }
            }
            
            // Reset the form
            const petForm = document.getElementById('addPetForm');
            if (petForm) {
                petForm.reset();
            }
            
            showSuccessMessage('Pet added successfully!');
        }

        function viewPetDetails(id) {
            const pet = pets.find(p => p.id === id);
            if (!pet) {
                showSuccessMessage('Pet record not found', 'error');
                return;
            }

            // Create detailed view modal
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-paw me-2"></i>Pet Details - ${pet.name}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Basic Information</h6>
                                    <table class="table table-sm">
                                        <tr><td><strong>Species:</strong></td><td>${pet.species}</td></tr>
                                        <tr><td><strong>Breed:</strong></td><td>${pet.breed}</td></tr>
                                        <tr><td><strong>Name:</strong></td><td>${pet.name}</td></tr>
                                        <tr><td><strong>Age:</strong></td><td>${pet.age} years</td></tr>
                                        <tr><td><strong>Gender:</strong></td><td>${pet.gender}</td></tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6>Health Information</h6>
                                    <table class="table table-sm">
                                        <tr><td><strong>Health Status:</strong></td><td><span class="${pet.healthStatus === 'Healthy' ? 'text-success' : 'text-warning'}">${pet.healthStatus}</span></td></tr>
                                        <tr><td><strong>Vaccination:</strong></td><td><span class="${pet.vaccination === 'Up to date' ? 'text-success' : 'text-warning'}">${pet.vaccination}</span></td></tr>
                                        <tr><td><strong>Last Vet Visit:</strong></td><td>${pet.lastVetVisit || 'Not recorded'}</td></tr>
                                        <tr><td><strong>Date Added:</strong></td><td>${new Date(pet.dateAdded).toLocaleDateString()}</td></tr>
                                    </table>
                                </div>
                            </div>
                            ${pet.notes ? `<div class="mt-3"><h6>Notes</h6><p>${pet.notes}</p></div>` : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-warning" onclick="editPet(${pet.id})">
                                <i class="fas fa-edit me-2"></i>Edit Pet
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function editPet(id) {
            const pet = pets.find(p => p.id === id);
            if (!pet) {
                showSuccessMessage('Pet record not found', 'error');
                return;
            }

            // Create edit pet modal
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-edit me-2"></i>Edit Pet - ${pet.name}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editPetForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editPetSpecies" class="form-label">Species</label>
                                            <select class="form-select" id="editPetSpecies" required>
                                                <option value="Dog" ${pet.species === 'Dog' ? 'selected' : ''}>Dog</option>
                                                <option value="Cat" ${pet.species === 'Cat' ? 'selected' : ''}>Cat</option>
                                                <option value="Bird" ${pet.species === 'Bird' ? 'selected' : ''}>Bird</option>
                                                <option value="Fish" ${pet.species === 'Fish' ? 'selected' : ''}>Fish</option>
                                                <option value="Other" ${pet.species === 'Other' ? 'selected' : ''}>Other</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editPetBreed" class="form-label">Breed</label>
                                            <input type="text" class="form-control" id="editPetBreed" value="${pet.breed}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editPetName" class="form-label">Name</label>
                                            <input type="text" class="form-control" id="editPetName" value="${pet.name}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editPetAge" class="form-label">Age (years)</label>
                                            <input type="number" class="form-control" id="editPetAge" value="${pet.age}" min="0" max="50" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editPetGender" class="form-label">Gender</label>
                                            <select class="form-select" id="editPetGender" required>
                                                <option value="Male" ${pet.gender === 'Male' ? 'selected' : ''}>Male</option>
                                                <option value="Female" ${pet.gender === 'Female' ? 'selected' : ''}>Female</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editPetHealthStatus" class="form-label">Health Status</label>
                                            <select class="form-select" id="editPetHealthStatus" required>
                                                <option value="Healthy" ${pet.healthStatus === 'Healthy' ? 'selected' : ''}>Healthy</option>
                                                <option value="Sick" ${pet.healthStatus === 'Sick' ? 'selected' : ''}>Sick</option>
                                                <option value="Recovering" ${pet.healthStatus === 'Recovering' ? 'selected' : ''}>Recovering</option>
                                                <option value="Under Treatment" ${pet.healthStatus === 'Under Treatment' ? 'selected' : ''}>Under Treatment</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editPetVaccination" class="form-label">Vaccination Status</label>
                                            <select class="form-select" id="editPetVaccination" required>
                                                <option value="Up to date" ${pet.vaccination === 'Up to date' ? 'selected' : ''}>Up to date</option>
                                                <option value="Due soon" ${pet.vaccination === 'Due soon' ? 'selected' : ''}>Due soon</option>
                                                <option value="Overdue" ${pet.vaccination === 'Overdue' ? 'selected' : ''}>Overdue</option>
                                                <option value="Not vaccinated" ${pet.vaccination === 'Not vaccinated' ? 'selected' : ''}>Not vaccinated</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editLastVetVisit" class="form-label">Last Vet Visit</label>
                                            <input type="date" class="form-control" id="editLastVetVisit" value="${pet.lastVetVisit || ''}">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="editPetNotes" class="form-label">Notes</label>
                                    <textarea class="form-control" id="editPetNotes" rows="3">${pet.notes || ''}</textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-warning" onclick="saveEditedPet(${pet.id})">
                                <i class="fas fa-save me-2"></i>Update Pet
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function saveEditedPet(id) {
            const pet = pets.find(p => p.id === id);
            if (!pet) {
                showSuccessMessage('Pet record not found', 'error');
                return;
            }

            const species = document.getElementById('editPetSpecies').value;
            const breed = document.getElementById('editPetBreed').value;
            const name = document.getElementById('editPetName').value;
            const age = parseInt(document.getElementById('editPetAge').value);
            const gender = document.getElementById('editPetGender').value;
            const healthStatus = document.getElementById('editPetHealthStatus').value;
            const vaccination = document.getElementById('editPetVaccination').value;
            const lastVetVisit = document.getElementById('editLastVetVisit').value;
            const notes = document.getElementById('editPetNotes').value;

            if (!species || !breed || !name || !age || !gender) {
                showSuccessMessage('Please fill in all required fields', 'error');
                return;
            }

            // Update pet data
            pet.species = species;
            pet.breed = breed;
            pet.name = name;
            pet.age = age;
            pet.gender = gender;
            pet.healthStatus = healthStatus;
            pet.vaccination = vaccination;
            pet.lastVetVisit = lastVetVisit || null;
            pet.notes = notes || '';
            pet.lastUpdated = new Date().toISOString();

            savePetsData();
            renderPetsGrid();
            renderPetsTable();
            updatePetsStatistics();
            updateAnalyticsCharts();
            
            // Close modal
            const modal = document.querySelector('.modal');
            if (modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                    bsModal.hide();
                }
            }
            
            showSuccessMessage('Pet updated successfully!');
        }

        function deletePet(id) {
            // Ensure id is a number for proper comparison
            const petId = typeof id === 'string' ? parseInt(id, 10) : id;
            
            // Check if pet exists
            const pet = pets.find(p => p.id === petId || p.id === id);
            if (!pet) {
                showSuccessMessage('Pet record not found', 'error');
                return;
            }
            
            showConfirmDialog(
                'Delete Pet',
                `Are you sure you want to delete ${pet.name} (${pet.breed})?`,
                'Yes, Delete',
                'Cancel',
                () => {
                    // Remove pet using both ID formats to ensure deletion
                    pets = pets.filter(p => {
                        const pId = typeof p.id === 'string' ? parseInt(p.id, 10) : p.id;
                        return pId !== petId && p.id !== petId && p.id !== id;
                    });
                    
                    savePetsData();
                    renderPetsGrid();
                    renderPetsTable();
                    updatePetsStatistics();
                    updateAnalyticsCharts();
                    showSuccessMessage('Pet deleted successfully!');
                }
            );
        }

        function viewPetDetails(id) {
            const pet = pets.find(p => p.id === id);
            if (!pet) {
                showInfoDialog('Error', 'Pet record not found', 'OK');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-paw me-2"></i>Pet Details - ${pet.name}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary mb-3">Basic Information</h6>
                                    <div class="detail-item mb-2">
                                        <strong>Name:</strong> ${pet.name}
                                    </div>
                                    <div class="detail-item mb-2">
                                        <strong>Species:</strong> ${pet.species}
                                    </div>
                                    <div class="detail-item mb-2">
                                        <strong>Breed:</strong> ${pet.breed}
                                    </div>
                                    <div class="detail-item mb-2">
                                        <strong>Age:</strong> ${pet.age} years
                                    </div>
                                    <div class="detail-item mb-2">
                                        <strong>Gender:</strong> ${pet.gender}
                                    </div>
                                    <div class="detail-item mb-2">
                                        <strong>Weight:</strong> ${pet.weight || 'N/A'}
                                    </div>
                                    <div class="detail-item mb-2">
                                        <strong>Location:</strong> ${pet.location || 'Home'}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-success mb-3">Health Information</h6>
                                    <div class="detail-item mb-2">
                                        <strong>Health Status:</strong> 
                                        <span class="badge bg-${getStatusColor(pet.healthStatus)}">${pet.healthStatus}</span>
                                    </div>
                                    <div class="detail-item mb-2">
                                        <strong>Vaccination:</strong> ${pet.vaccination}
                                    </div>
                                    <div class="detail-item mb-2">
                                        <strong>Last Vet Visit:</strong> ${pet.lastVetVisit || 'Not recorded'}
                                    </div>
                                    <div class="detail-item mb-2">
                                        <strong>Value:</strong> FJD ${pet.value || 'Not set'}
                                    </div>
                                </div>
                            </div>
                            ${pet.notes ? `
                                <div class="mt-3">
                                    <h6 class="text-info mb-2">Notes</h6>
                                    <div class="alert alert-light">${pet.notes}</div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="editPet(${pet.id}); const modal = bootstrap.Modal.getInstance(document.querySelector('.modal')); modal.hide();">
                                <i class="fas fa-edit me-1"></i>Edit Pet
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function addHealthRecord(petId) {
            const pet = pets.find(p => p.id === petId);
            if (!pet) {
                showInfoDialog('Error', 'Pet record not found', 'OK');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-heartbeat me-2"></i>Health Record - ${pet.name}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Health Status</label>
                                <select class="form-select" id="healthStatus">
                                    <option value="Healthy" ${pet.healthStatus === 'Healthy' ? 'selected' : ''}>Healthy</option>
                                    <option value="Sick" ${pet.healthStatus === 'Sick' ? 'selected' : ''}>Sick</option>
                                    <option value="Recovering" ${pet.healthStatus === 'Recovering' ? 'selected' : ''}>Recovering</option>
                                    <option value="Under Treatment" ${pet.healthStatus === 'Under Treatment' ? 'selected' : ''}>Under Treatment</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Vaccination Status</label>
                                <select class="form-select" id="vaccinationStatus">
                                    <option value="Up to date" ${pet.vaccination === 'Up to date' ? 'selected' : ''}>Up to date</option>
                                    <option value="Due soon" ${pet.vaccination === 'Due soon' ? 'selected' : ''}>Due soon</option>
                                    <option value="Overdue" ${pet.vaccination === 'Overdue' ? 'selected' : ''}>Overdue</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="petLastVetVisit">Last Vet Visit</label>
                                <input type="date" class="form-control" id="petLastVetVisit" value="${pet.lastVetVisit || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="petHealthNotes">Health Notes</label>
                                <textarea class="form-control" id="petHealthNotes" rows="3" placeholder="Enter any health notes or observations...">${pet.notes || ''}</textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-success" onclick="saveHealthRecord(${petId})">
                                <i class="fas fa-save me-1"></i>Save Health Record
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function saveHealthRecord(petId) {
            const pet = pets.find(p => p.id === petId);
            if (!pet) return;

            const healthStatus = document.getElementById('healthStatus').value;
            const vaccinationStatus = document.getElementById('vaccinationStatus').value;
            const lastVetVisit = document.getElementById('lastVetVisit').value;
            const healthNotes = document.getElementById('healthNotes').value;

            pet.healthStatus = healthStatus;
            pet.vaccination = vaccinationStatus;
            pet.lastVetVisit = lastVetVisit || null;
            pet.notes = healthNotes;
            pet.lastUpdated = new Date().toISOString();

            savePetsData();
            renderPetsGrid();
            renderPetsTable();
            updatePetsStatistics();
            
            // Close modal
            const modal = document.querySelector('.modal');
            if (modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                    bsModal.hide();
                }
            }
            
            showSuccessMessage('Health record updated successfully!');
        }

        function showAllPets() {
            // Reset filters and show all pets
            document.getElementById('petsSearch').value = '';
            document.getElementById('petsSpeciesFilter').value = '';
            document.getElementById('petsStatusFilter').value = '';
            renderPetsGrid();
        }

        function exportPetsData() {
            const dataStr = JSON.stringify(pets, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'pets-data.json';
            link.click();
            URL.revokeObjectURL(url);
            showSuccessMessage('Pets data exported successfully!');
        }

        // Enhanced Livestock Management Functions
        function viewLivestockDetails(id) {
            const animal = livestock.find(l => l.id === id);
            if (!animal) {
                showInfoDialog('Error', 'Livestock record not found', 'OK');
                return;
            }

            // Create detailed view modal
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-info-circle me-2"></i>Livestock Details - ${animal.type} ${animal.breed}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary">Basic Information</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>Type:</strong> ${animal.type}</li>
                                        <li><strong>Breed:</strong> ${animal.breed}</li>
                                        <li><strong>Quantity:</strong> ${animal.quantity}</li>
                                        <li><strong>Location:</strong> ${animal.location}</li>
                                        <li><strong>Status:</strong> <span class="badge bg-${animal.status.toLowerCase() === 'healthy' ? 'success' : 'warning'}">${animal.status}</span></li>
                                    </ul>
                                    
                                    <h6 class="text-primary mt-3">Ear Tags</h6>
                                    <div class="mb-3">
                                        ${animal.earTags && animal.earTags.length > 0 
                                            ? animal.earTags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('')
                                            : '<span class="text-muted">No ear tags recorded</span>'
                                        }
                                    </div>
                                    
                                    <h6 class="text-primary mt-3">GPS Location</h6>
                                    ${animal.gpsLocation 
                                        ? `<p><strong>Coordinates:</strong> ${animal.gpsLocation.lat.toFixed(4)}, ${animal.gpsLocation.lng.toFixed(4)}<br>
                                           <strong>Last Update:</strong> ${new Date(animal.gpsLocation.lastUpdate).toLocaleString()}</p>`
                                        : '<p class="text-muted">No GPS data available</p>'
                                    }
                                </div>
                                
                                <div class="col-md-6">
                                    <h6 class="text-primary">Weight Records</h6>
                                    <div class="mb-3" style="max-height: 200px; overflow-y: auto;">
                                        ${animal.weightRecords && animal.weightRecords.length > 0 
                                            ? animal.weightRecords.map(record => `
                                                <div class="card mb-2">
                                                    <div class="card-body p-2">
                                                        <div class="d-flex justify-content-between">
                                                            <strong>${record.avgWeight} kg</strong>
                                                            <small>${new Date(record.date).toLocaleDateString()}</small>
                                                        </div>
                                                        <small class="text-muted">${record.notes}</small>
                                                    </div>
                                                </div>
                                            `).join('')
                                            : '<p class="text-muted">No weight records available</p>'
                                        }
                                    </div>
                                    
                                    <h6 class="text-primary mt-3">Immunization Records</h6>
                                    <div class="mb-3" style="max-height: 200px; overflow-y: auto;">
                                        ${animal.immunizations && animal.immunizations.length > 0 
                                            ? animal.immunizations.map(immunization => `
                                                <div class="card mb-2">
                                                    <div class="card-body p-2">
                                                        <div class="d-flex justify-content-between">
                                                            <strong>${immunization.vaccine}</strong>
                                                            <small>${new Date(immunization.date).toLocaleDateString()}</small>
                                                        </div>
                                                        <div><small>Next Due: ${new Date(immunization.nextDue).toLocaleDateString()}</small></div>
                                                        <div><small>Vet: ${immunization.vet}</small></div>
                                                    </div>
                                                </div>
                                            `).join('')
                                            : '<p class="text-muted">No immunization records available</p>'
                                        }
                                    </div>
                                </div>
                            </div>
                            
                            ${animal.healthNotes ? `
                                <div class="mt-3">
                                    <h6 class="text-primary">Health Notes</h6>
                                    <p class="bg-light p-3 rounded">${animal.healthNotes}</p>
                                </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="editLivestock(${animal.id}); bootstrap.Modal.getInstance(this.closest('.modal')).hide();">
                                <i class="fas fa-edit me-2"></i>Edit Record
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function showGPSLocation(id) {
            const animal = livestock.find(l => l.id === id);
            if (!animal || !animal.gpsLocation) {
                showInfoDialog('No GPS Data', 'No GPS location data available for this livestock', 'OK');
                return;
            }

            const { lat, lng, lastUpdate } = animal.gpsLocation;
            
            // Create GPS modal
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-map-marker-alt me-2"></i>GPS Location - ${animal.type} ${animal.breed}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <h6>Current Location</h6>
                                <p><strong>Latitude:</strong> ${lat.toFixed(6)}</p>
                                <p><strong>Longitude:</strong> ${lng.toFixed(6)}</p>
                                <p><strong>Last Updated:</strong> ${new Date(lastUpdate).toLocaleString()}</p>
                            </div>
                            
                            <div class="mb-3">
                                <h6>Quick Actions</h6>
                                <button class="btn btn-outline-primary me-2" onclick="updateGPSLocation(${id})">
                                    <i class="fas fa-sync me-1"></i>Update Location
                                </button>
                                <button class="btn btn-outline-info" onclick="openInMaps(${lat}, ${lng})">
                                    <i class="fas fa-external-link-alt me-1"></i>Open in Maps
                                </button>
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Note:</strong> GPS tracking helps monitor livestock movement, 
                                grazing patterns, and ensures animal safety through location monitoring.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function updateGPSLocation(id) {
            const animal = livestock.find(l => l.id === id);
            if (!animal) return;

            // Simulate GPS update (in real app, this would get actual GPS coordinates)
            const newLat = animal.gpsLocation.lat + (Math.random() - 0.5) * 0.001; // Small random movement
            const newLng = animal.gpsLocation.lng + (Math.random() - 0.5) * 0.001;
            
            animal.gpsLocation = {
                lat: newLat,
                lng: newLng,
                lastUpdate: new Date().toISOString()
            };
            
            saveLivestockData();
            renderLivestockTable();
            showSuccessMessage('GPS location updated successfully!');
        }

        function openInMaps(lat, lng) {
            const mapsUrl = `https://www.google.com/maps?q=${lat},${lng}`;
            window.open(mapsUrl, '_blank');
        }

        function addWeightRecord(id) {
            const animal = livestock.find(l => l.id === id);
            if (!animal) return;

            // Create weight record modal
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-weight me-2"></i>Add Weight Record - ${animal.type} ${animal.breed}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="weightRecordForm">
                                <div class="mb-3">
                                    <label for="weightDate" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="weightDate" value="${new Date().toISOString().split('T')[0]}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="weightValue" class="form-label">Average Weight (kg)</label>
                                    <input type="number" class="form-control" id="weightValue" step="0.1" required>
                                </div>
                                <div class="mb-3">
                                    <label for="weightNotes" class="form-label">Notes</label>
                                    <textarea class="form-control" id="weightNotes" rows="3" placeholder="e.g., Monthly weigh-in, pre-breeding check, etc."></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-success" onclick="saveWeightRecord(${id})">
                                <i class="fas fa-save me-2"></i>Save Weight Record
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function saveWeightRecord(id) {
            const animal = livestock.find(l => l.id === id);
            if (!animal) return;

            const date = document.getElementById('weightDate').value;
            const weight = parseFloat(document.getElementById('weightValue').value);
            const notes = document.getElementById('weightNotes').value;

            if (!date || !weight || weight <= 0) {
                showInfoDialog('Validation Error', 'Please fill in all required fields with valid data', 'OK');
                return;
            }

            // Initialize weightRecords if it doesn't exist
            if (!animal.weightRecords) {
                animal.weightRecords = [];
            }

            // Add new weight record
            animal.weightRecords.push({
                date: date,
                avgWeight: weight,
                notes: notes || 'No notes'
            });

            // Sort by date (newest first)
            animal.weightRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

            saveLivestockData();
            renderLivestockTable();
            
            // Close modal
            const modal = document.querySelector('.modal');
            if (modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                bsModal.hide();
            }
            
            showSuccessMessage('Weight record added successfully!');
        }

        function addImmunization(id) {
            const animal = livestock.find(l => l.id === id);
            if (!animal) return;

            // Create immunization modal
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-dark">
                            <h5 class="modal-title">
                                <i class="fas fa-syringe me-2"></i>Add Immunization Record - ${animal.type} ${animal.breed}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="immunizationForm">
                                <div class="mb-3">
                                    <label for="immunizationDate" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="immunizationDate" value="${new Date().toISOString().split('T')[0]}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="vaccineName" class="form-label">Vaccine Name</label>
                                    <select class="form-select" id="vaccineName" required>
                                        <option value="">Select Vaccine</option>
                                        <option value="FMD">Foot and Mouth Disease (FMD)</option>
                                        <option value="Anthrax">Anthrax</option>
                                        <option value="Brucellosis">Brucellosis</option>
                                        <option value="PRRS">Porcine Reproductive and Respiratory Syndrome (PRRS)</option>
                                        <option value="Swine Flu">Swine Flu</option>
                                        <option value="Pneumonia">Pneumonia</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="nextDueDate" class="form-label">Next Due Date</label>
                                    <input type="date" class="form-control" id="nextDueDate" required>
                                </div>
                                <div class="mb-3">
                                    <label for="vetName" class="form-label">Veterinarian</label>
                                    <input type="text" class="form-control" id="vetName" placeholder="Dr. Smith" required>
                                </div>
                                <div class="mb-3">
                                    <label for="immunizationNotes" class="form-label">Notes</label>
                                    <textarea class="form-control" id="immunizationNotes" rows="3" placeholder="Any additional notes about the vaccination..."></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-warning" onclick="saveImmunization(${id})">
                                <i class="fas fa-save me-2"></i>Save Immunization Record
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function saveImmunization(id) {
            const animal = livestock.find(l => l.id === id);
            if (!animal) return;

            const date = document.getElementById('immunizationDate').value;
            const vaccine = document.getElementById('vaccineName').value;
            const nextDue = document.getElementById('nextDueDate').value;
            const vet = document.getElementById('vetName').value;
            const notes = document.getElementById('immunizationNotes').value;

            if (!date || !vaccine || !nextDue || !vet) {
                showInfoDialog('Validation Error', 'Please fill in all required fields', 'OK');
                return;
            }

            // Initialize immunizations if it doesn't exist
            if (!animal.immunizations) {
                animal.immunizations = [];
            }

            // Add new immunization record
            animal.immunizations.push({
                date: date,
                vaccine: vaccine,
                nextDue: nextDue,
                vet: vet,
                notes: notes || 'No notes'
            });

            // Sort by date (newest first)
            animal.immunizations.sort((a, b) => new Date(b.date) - new Date(a.date));

            saveLivestockData();
            renderLivestockTable();
            
            // Close modal
            const modal = document.querySelector('.modal');
            if (modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                bsModal.hide();
            }
            
            showSuccessMessage('Immunization record added successfully!');
        }

        // Helper functions for edit modal
        function addWeightRecordFromEdit(id) {
            // Create a simple weight record modal within the edit context
            const date = new Date().toISOString().split('T')[0];
            showPromptDialog(
                'Add Weight Record',
                'Enter weight (kg):',
                'number',
                'Enter weight in kg',
                'Add',
                'Cancel',
                (weight) => {
                    if (!weight || isNaN(weight)) {
                        showInfoDialog('Validation Error', 'Please enter a valid weight', 'OK');
                        return;
                    }
                    
                    const notes = 'No notes'; // Default notes
                    
                    const animal = livestock.find(l => l.id === id);
                    if (animal) {
                        if (!animal.weightRecords) animal.weightRecords = [];
                        
                        animal.weightRecords.push({
                            date: date,
                            avgWeight: parseFloat(weight),
                            notes: notes
                        });
                        
                        // Sort by date (newest first)
                        animal.weightRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                        
                        // Refresh the edit modal by closing and reopening
                        const modal = document.querySelector('.modal');
                        if (modal) {
                            const bsModal = bootstrap.Modal.getInstance(modal);
                            bsModal.hide();
                        }
                        
                        // Reopen edit modal with updated data
                        setTimeout(() => {
                            editLivestock(id);
                        }, 300);
                    }
                }
            );
        }

        function addImmunizationFromEdit(id) {
            // Create a simple immunization modal within the edit context
            const date = new Date().toISOString().split('T')[0];
            showPromptDialog(
                'Add Immunization Record',
                'Enter vaccine name:',
                'text',
                'Enter vaccine name',
                'Next',
                'Cancel',
                (vaccine) => {
                    if (!vaccine) {
                        showInfoDialog('Validation Error', 'Please enter vaccine name', 'OK');
                        return;
                    }
                    
                    showPromptDialog(
                        'Add Immunization Record',
                        'Enter next due date (YYYY-MM-DD):',
                        'date',
                        'Enter next due date',
                        'Add',
                        'Cancel',
                        (nextDue) => {
                            if (!nextDue) {
                                showInfoDialog('Validation Error', 'Please enter next due date', 'OK');
                                return;
                            }
                            
                            const vet = 'Dr. Unknown'; // Default vet
                            const notes = 'No notes'; // Default notes
                            
                            const animal = livestock.find(l => l.id === id);
                            if (animal) {
                                if (!animal.immunizations) animal.immunizations = [];
                                
                                animal.immunizations.push({
                                    date: date,
                                    vaccine: vaccine,
                                    nextDue: nextDue,
                                    vet: vet,
                                    notes: notes
                                });
                                
                                // Sort by date (newest first)
                                animal.immunizations.sort((a, b) => new Date(b.date) - new Date(a.date));
                                
                                // Refresh the edit modal by closing and reopening
                                const modal = document.querySelector('.modal');
                                if (modal) {
                                    const bsModal = bootstrap.Modal.getInstance(modal);
                                    bsModal.hide();
                                }
                                
                                // Reopen edit modal with updated data
                                setTimeout(() => {
                                    editLivestock(id);
                                }, 300);
                            }
                        }
                    );
                }
            );
        }

        function removeWeightRecord(id, date) {
            showConfirmDialog(
                'Remove Weight Record',
                'Are you sure you want to remove this weight record?',
                'Yes, Remove',
                'Cancel',
                () => {
                    const animal = livestock.find(l => l.id === id);
                    if (animal && animal.weightRecords) {
                        animal.weightRecords = animal.weightRecords.filter(record => record.date !== date);
                        
                        // Refresh the edit modal by closing and reopening
                        const modal = document.querySelector('.modal');
                        if (modal) {
                            const bsModal = bootstrap.Modal.getInstance(modal);
                            bsModal.hide();
                        }
                        
                        // Reopen edit modal with updated data
                        setTimeout(() => {
                            editLivestock(id);
                        }, 300);
                    }
                }
            );
        }

        function removeImmunizationRecord(id, date, vaccine) {
            showConfirmDialog(
                'Remove Immunization Record',
                'Are you sure you want to remove this immunization record?',
                'Yes, Remove',
                'Cancel',
                () => {
                    const animal = livestock.find(l => l.id === id);
                    if (animal && animal.immunizations) {
                        animal.immunizations = animal.immunizations.filter(immunization => 
                            !(immunization.date === date && immunization.vaccine === vaccine)
                        );
                        
                        // Refresh the edit modal by closing and reopening
                        const modal = document.querySelector('.modal');
                        if (modal) {
                            const bsModal = bootstrap.Modal.getInstance(modal);
                            bsModal.hide();
                        }
                        
                        // Reopen edit modal with updated data
                        setTimeout(() => {
                            editLivestock(id);
                        }, 300);
                    }
                }
            );
        }

        function addInventoryItem() {
            showPromptDialog(
                'Add Inventory Item',
                'Enter item name:',
                'text',
                'Enter item name',
                'Next',
                'Cancel',
                (name) => {
                    if (!name) return;
                    
                    showPromptDialog(
                        'Add Inventory Item',
                        'Enter category (Seeds/Supplies/Tools/Equipment):',
                        'text',
                        'Enter category',
                        'Next',
                        'Cancel',
                        (category) => {
                            if (!category) return;
                            
                            showPromptDialog(
                                'Add Inventory Item',
                                'Enter quantity:',
                                'number',
                                'Enter quantity',
                                'Next',
                                'Cancel',
                                (quantity) => {
                                    if (!quantity || isNaN(quantity) || parseInt(quantity) <= 0) {
                                        showInfoDialog('Validation Error', 'Please enter a valid quantity.', 'OK');
                                        return;
                                    }
                                    
                                    showPromptDialog(
                                        'Add Inventory Item',
                                        'Enter unit (bags/packets/pieces/liters):',
                                        'text',
                                        'Enter unit',
                                        'Add',
                                        'Cancel',
                                        (unit) => {
                                            if (!unit) return;
                                            
                                            const newItem = {
                                                id: Date.now(),
                                                name: name.trim(),
                                                category: category.trim(),
                                                quantity: parseInt(quantity),
                                                unit: unit.trim(),
                                                lastUpdated: new Date().toISOString().split('T')[0]
                                            };
                                            
                                            inventory.push(newItem);
                                            saveInventoryData();
                                            renderInventoryTable();
                                            showSuccessMessage('Inventory item added successfully!');
                                        }
                                    );
                                }
                            );
                        }
                    );
                }
            );
        }

        function editInventory(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) {
                showInfoDialog('Error', 'Inventory item not found', 'OK');
                return;
            }

            // Create edit modal
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Inventory Item</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editInventoryForm">
                                <div class="mb-3">
                                    <label for="editInventoryName" class="form-label">Item Name</label>
                                    <input type="text" class="form-control" id="editInventoryName" value="${item.name}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editInventoryCategory" class="form-label">Category</label>
                                    <select class="form-select" id="editInventoryCategory" required>
                                        <option value="seeds" ${item.category.toLowerCase() === 'seeds' ? 'selected' : ''}>Seeds</option>
                                        <option value="fertilizers" ${item.category.toLowerCase() === 'fertilizers' ? 'selected' : ''}>Fertilizers</option>
                                        <option value="tools" ${item.category.toLowerCase() === 'tools' ? 'selected' : ''}>Tools</option>
                                        <option value="equipment" ${item.category.toLowerCase() === 'equipment' ? 'selected' : ''}>Equipment</option>
                                        <option value="feed" ${item.category.toLowerCase() === 'feed' ? 'selected' : ''}>Feed</option>
                                        <option value="medicine" ${item.category.toLowerCase() === 'medicine' ? 'selected' : ''}>Medicine</option>
                                        <option value="other" ${!['seeds', 'fertilizers', 'tools', 'equipment', 'feed', 'medicine'].includes(item.category.toLowerCase()) ? 'selected' : ''}>Other</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="editInventoryQuantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="editInventoryQuantity" value="${item.quantity}" min="0" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editInventoryUnit" class="form-label">Unit</label>
                                    <select class="form-select" id="editInventoryUnit" required>
                                        <option value="kg" ${item.unit.toLowerCase() === 'kg' ? 'selected' : ''}>Kilograms (kg)</option>
                                        <option value="liters" ${item.unit.toLowerCase() === 'liters' ? 'selected' : ''}>Liters</option>
                                        <option value="pieces" ${item.unit.toLowerCase() === 'pieces' ? 'selected' : ''}>Pieces</option>
                                        <option value="bags" ${item.unit.toLowerCase() === 'bags' ? 'selected' : ''}>Bags</option>
                                        <option value="boxes" ${item.unit.toLowerCase() === 'boxes' ? 'selected' : ''}>Boxes</option>
                                        <option value="tons" ${item.unit.toLowerCase() === 'tons' ? 'selected' : ''}>Tons</option>
                                        <option value="gallons" ${item.unit.toLowerCase() === 'gallons' ? 'selected' : ''}>Gallons</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="editInventoryStatus" class="form-label">Status</label>
                                    <select class="form-select" id="editInventoryStatus" required>
                                        <option value="in-stock" ${item.status === 'in-stock' ? 'selected' : ''}>In Stock</option>
                                        <option value="low-stock" ${item.status === 'low-stock' ? 'selected' : ''}>Low Stock</option>
                                        <option value="out-of-stock" ${item.status === 'out-of-stock' ? 'selected' : ''}>Out of Stock</option>
                                        <option value="ordered" ${item.status === 'ordered' ? 'selected' : ''}>Ordered</option>
                                        <option value="expired" ${item.status === 'expired' ? 'selected' : ''}>Expired</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveEditedInventory(${id})">Save Changes</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function saveEditedInventory(id) {
            const name = document.getElementById('editInventoryName').value.trim();
            const category = document.getElementById('editInventoryCategory').value.trim();
            const quantity = parseInt(document.getElementById('editInventoryQuantity').value);
            const unit = document.getElementById('editInventoryUnit').value.trim();
            const status = document.getElementById('editInventoryStatus').value.trim();

            if (!name || !category || quantity < 0 || !unit || !status) {
                showInfoDialog('Validation Error', 'Please fill in all required fields', 'OK');
                return;
            }

            // Find and update the inventory item
            const inventoryIndex = inventory.findIndex(i => i.id === id);
            if (inventoryIndex !== -1) {
                inventory[inventoryIndex] = {
                    ...inventory[inventoryIndex],
                    name: name,
                    category: category,
                    quantity: quantity,
                    unit: unit,
                    status: status,
                    lastUpdated: new Date().toLocaleDateString()
                };

                saveInventoryData();
                renderInventoryTable();
                updateAnalyticsCharts();
                showSuccessMessage('Inventory item updated successfully!');

                // Close modal
                const modal = document.querySelector('.modal');
                if (modal) {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    bsModal.hide();
                }
            }
        }

        function deleteInventory(id) {
            showConfirmDialog(
                'Delete Inventory Item',
                'Are you sure you want to delete this inventory item?',
                'Yes, Delete',
                'Cancel',
                () => {
                    inventory = inventory.filter(item => item.id !== id);
                    saveInventoryData();
                    renderInventoryTable();
                    showSuccessMessage('Inventory item deleted successfully!');
                }
            );
        }

        function addNewTask() {
            showAddTaskModal();
        }

        function showAddTaskModal() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-plus-circle me-2"></i>Add New Task
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addTaskForm">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label for="taskTitle" class="form-label">Task Title *</label>
                                            <input type="text" class="form-control" id="taskTitle" placeholder="Enter task title" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="taskPriority" class="form-label">Priority *</label>
                                            <select class="form-select" id="taskPriority" required>
                                                <option value="">Select Priority</option>
                                                <option value="low">Low</option>
                                                <option value="medium">Medium</option>
                                                <option value="high">High</option>
                                                <option value="urgent">Urgent</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="taskDueDate" class="form-label">Due Date *</label>
                                            <input type="date" class="form-control" id="taskDueDate" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="taskAssignedTo" class="form-label">Assigned To</label>
                                            <input type="text" class="form-control" id="taskAssignedTo" placeholder="Enter assignee name">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="taskDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="taskDescription" rows="3" placeholder="Enter task description"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="taskCategory" class="form-label">Category</label>
                                    <select class="form-select" id="taskCategory">
                                        <option value="">Select Category</option>
                                        <option value="farming">Farming</option>
                                        <option value="maintenance">Maintenance</option>
                                        <option value="harvest">Harvest</option>
                                        <option value="planting">Planting</option>
                                        <option value="livestock">Livestock Care</option>
                                        <option value="equipment">Equipment</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-success" onclick="saveNewTask()">
                                <i class="fas fa-save me-2"></i>Save Task
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Set minimum date to today
            document.getElementById('taskDueDate').min = new Date().toISOString().split('T')[0];
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function saveNewTask() {
            const title = document.getElementById('taskTitle').value.trim();
            const priority = document.getElementById('taskPriority').value;
            const dueDate = document.getElementById('taskDueDate').value;
            const assignedTo = document.getElementById('taskAssignedTo').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const category = document.getElementById('taskCategory').value;

            if (!title || !priority || !dueDate) {
                showErrorDialog('Validation Error', 'Please fill in all required fields (Title, Priority, Due Date).');
                return;
            }

            // Create new task
            const newTask = {
                id: Date.now(),
                title: title,
                priority: priority,
                dueDate: dueDate,
                assignedTo: assignedTo || 'Unassigned',
                description: description,
                category: category || 'other',
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            // Save to localStorage
            let tasks = JSON.parse(localStorage.getItem('farmTasks') || '[]');
            tasks.push(newTask);
            localStorage.setItem('farmTasks', JSON.stringify(tasks));

            // Close modal
            const modal = document.querySelector('.modal');
            if (modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                    bsModal.hide();
                }
            }

            // Refresh tasks table
            loadTasksTable();

            showSuccessDialog(
                '‚úÖ Task Created Successfully',
                `Task "${title}" has been created and added to your task list.\n\nPriority: ${priority.charAt(0).toUpperCase() + priority.slice(1)}\nDue Date: ${new Date(dueDate).toLocaleDateString()}\nAssigned To: ${assignedTo || 'Unassigned'}`
            );
        }

        function editTask(id) {
            const tasks = JSON.parse(localStorage.getItem('farmTasks') || '[]');
            const task = tasks.find(t => t.id == id);
            
            if (!task) {
                showErrorDialog('Task Not Found', 'The selected task could not be found.');
                return;
            }

            showEditTaskModal(task);
        }

        function showEditTaskModal(task) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-edit me-2"></i>Edit Task
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editTaskForm">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label for="editTaskTitle" class="form-label">Task Title *</label>
                                            <input type="text" class="form-control" id="editTaskTitle" value="${task.title}" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="editTaskPriority" class="form-label">Priority *</label>
                                            <select class="form-select" id="editTaskPriority" required>
                                                <option value="low" ${task.priority === 'low' ? 'selected' : ''}>Low</option>
                                                <option value="medium" ${task.priority === 'medium' ? 'selected' : ''}>Medium</option>
                                                <option value="high" ${task.priority === 'high' ? 'selected' : ''}>High</option>
                                                <option value="urgent" ${task.priority === 'urgent' ? 'selected' : ''}>Urgent</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editTaskDueDate" class="form-label">Due Date *</label>
                                            <input type="date" class="form-control" id="editTaskDueDate" value="${task.dueDate}" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editTaskAssignedTo" class="form-label">Assigned To</label>
                                            <input type="text" class="form-control" id="editTaskAssignedTo" value="${task.assignedTo}">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="editTaskDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="editTaskDescription" rows="3">${task.description}</textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="editTaskCategory" class="form-label">Category</label>
                                    <select class="form-select" id="editTaskCategory">
                                        <option value="farming" ${task.category === 'farming' ? 'selected' : ''}>Farming</option>
                                        <option value="maintenance" ${task.category === 'maintenance' ? 'selected' : ''}>Maintenance</option>
                                        <option value="harvest" ${task.category === 'harvest' ? 'selected' : ''}>Harvest</option>
                                        <option value="planting" ${task.category === 'planting' ? 'selected' : ''}>Planting</option>
                                        <option value="livestock" ${task.category === 'livestock' ? 'selected' : ''}>Livestock Care</option>
                                        <option value="equipment" ${task.category === 'equipment' ? 'selected' : ''}>Equipment</option>
                                        <option value="other" ${task.category === 'other' ? 'selected' : ''}>Other</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="editTaskStatus" class="form-label">Status</label>
                                    <select class="form-select" id="editTaskStatus">
                                        <option value="pending" ${task.status === 'pending' ? 'selected' : ''}>Pending</option>
                                        <option value="in_progress" ${task.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                        <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Completed</option>
                                        <option value="cancelled" ${task.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-danger me-2" onclick="deleteTask(${task.id})">
                                <i class="fas fa-trash me-2"></i>Delete
                            </button>
                            <button type="button" class="btn btn-primary" onclick="saveEditedTask(${task.id})">
                                <i class="fas fa-save me-2"></i>Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function completeTask(id) {
            showConfirmDialog(
                'Complete Task',
                'Are you sure you want to mark this task as completed?',
                'Yes, Complete',
                'Cancel',
                () => {
                    let tasks = JSON.parse(localStorage.getItem('farmTasks') || '[]');
                    const taskIndex = tasks.findIndex(t => t.id == id);
                    
                    if (taskIndex === -1) {
                        showErrorDialog('Task Not Found', 'The selected task could not be found.');
                        return;
                    }

                    tasks[taskIndex].status = 'completed';
                    tasks[taskIndex].completedAt = new Date().toISOString();
                    localStorage.setItem('farmTasks', JSON.stringify(tasks));

                    // Refresh tasks table
                    loadTasksTable();

                    showSuccessDialog(
                        '‚úÖ Task Completed Successfully',
                        `Task "${tasks[taskIndex].title}" has been marked as completed.\n\nCompleted on: ${new Date().toLocaleDateString()}`
                    );
                }
            );
        }

        function saveEditedTask(taskId) {
            const title = document.getElementById('editTaskTitle').value.trim();
            const priority = document.getElementById('editTaskPriority').value;
            const dueDate = document.getElementById('editTaskDueDate').value;
            const assignedTo = document.getElementById('editTaskAssignedTo').value.trim();
            const description = document.getElementById('editTaskDescription').value.trim();
            const category = document.getElementById('editTaskCategory').value;
            const status = document.getElementById('editTaskStatus').value;

            if (!title || !priority || !dueDate) {
                showErrorDialog('Validation Error', 'Please fill in all required fields (Title, Priority, Due Date).');
                return;
            }

            // Update task
            let tasks = JSON.parse(localStorage.getItem('farmTasks') || '[]');
            const taskIndex = tasks.findIndex(t => t.id == taskId);
            
            if (taskIndex === -1) {
                showErrorDialog('Task Not Found', 'The selected task could not be found.');
                return;
            }

            tasks[taskIndex] = {
                ...tasks[taskIndex],
                title: title,
                priority: priority,
                dueDate: dueDate,
                assignedTo: assignedTo || 'Unassigned',
                description: description,
                category: category || 'other',
                status: status,
                updatedAt: new Date().toISOString()
            };

            localStorage.setItem('farmTasks', JSON.stringify(tasks));

            // Close modal
            const modal = document.querySelector('.modal');
            if (modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                    bsModal.hide();
                }
            }

            // Refresh tasks table
            loadTasksTable();

            showSuccessDialog(
                '‚úÖ Task Updated Successfully',
                `Task "${title}" has been updated successfully.\n\nPriority: ${priority.charAt(0).toUpperCase() + priority.slice(1)}\nStatus: ${status.charAt(0).toUpperCase() + status.slice(1).replace('_', ' ')}\nDue Date: ${new Date(dueDate).toLocaleDateString()}`
            );
        }

        function deleteTask(taskId) {
            showConfirmDialog(
                'Delete Task',
                'Are you sure you want to delete this task? This action cannot be undone.',
                'Yes, Delete',
                'Cancel',
                () => {
                    let tasks = JSON.parse(localStorage.getItem('farmTasks') || '[]');
                    const taskIndex = tasks.findIndex(t => t.id == taskId);
                    
                    if (taskIndex === -1) {
                        showErrorDialog('Task Not Found', 'The selected task could not be found.');
                        return;
                    }

                    const taskTitle = tasks[taskIndex].title;
                    tasks.splice(taskIndex, 1);
                    localStorage.setItem('farmTasks', JSON.stringify(tasks));

                    // Close modal
                    const modal = document.querySelector('.modal');
                    if (modal) {
                        const bsModal = bootstrap.Modal.getInstance(modal);
                        if (bsModal) {
                            bsModal.hide();
                        }
                    }

                    // Refresh tasks table
                    loadTasksTable();

                    showSuccessDialog(
                        '‚úÖ Task Deleted Successfully',
                        `Task "${taskTitle}" has been deleted from your task list.`
                    );
                }
            );
        }

        function loadTasksTable() {
            const tasks = JSON.parse(localStorage.getItem('farmTasks') || '[]');
            const tbody = document.getElementById('tasksTable');
            
            if (!tbody) return;

            if (tasks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-tasks fa-3x mb-3 d-block"></i>
                            <h5>No Tasks Found</h5>
                            <p>Click "Add Task" to create your first task.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = tasks.map(task => {
                const priorityClass = {
                    'low': 'bg-secondary',
                    'medium': 'bg-info',
                    'high': 'bg-warning',
                    'urgent': 'bg-danger'
                }[task.priority] || 'bg-secondary';

                const statusClass = {
                    'pending': 'status-pending',
                    'in_progress': 'status-active',
                    'completed': 'status-completed',
                    'cancelled': 'status-cancelled'
                }[task.status] || 'status-pending';

                const statusText = {
                    'pending': 'Pending',
                    'in_progress': 'In Progress',
                    'completed': 'Completed',
                    'cancelled': 'Cancelled'
                }[task.status] || 'Pending';

                return `
                    <tr>
                        <td>
                            <div>
                                <strong>${task.title}</strong>
                                ${task.description ? `<br><small class="text-muted">${task.description}</small>` : ''}
                            </div>
                        </td>
                        <td><span class="badge ${priorityClass}">${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}</span></td>
                        <td>${new Date(task.dueDate).toLocaleDateString()}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${task.assignedTo}</td>
                        <td>
                            ${task.status !== 'completed' ? `
                                <button class="btn btn-sm btn-outline-success me-1" onclick="completeTask(${task.id})" title="Complete Task">
                                    <i class="fas fa-check"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editTask(${task.id})" title="Edit Task">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${task.id})" title="Delete Task">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function generateReport(type) {
            // Check if jsPDF is available first
            if (typeof window.jspdf === 'undefined') {
                showErrorDialog('PDF Library Error', 'PDF library not loaded. Please refresh the page and try again.');
                return;
            }
            
            showInfoDialog(
                'üìÑ Generating Report',
                `Generating ${type.charAt(0).toUpperCase() + type.slice(1)} Report...\n\nPlease wait while we compile your farm data and create a comprehensive report.`
            );
            
            // Simulate report generation delay
            setTimeout(() => {
                try {
                    switch(type) {
                        case 'summary':
                            generateSummaryReportPDF();
                            break;
                        case 'crops':
                            generateCropReportPDF();
                            break;
                        case 'livestock':
                            generateLivestockReportPDF();
                            break;
                        case 'inventory':
                            generateInventoryReportPDF();
                            break;
                        case 'financial':
                            generateFinancialReportPDF();
                            break;
                        case 'tasks':
                            generateTasksReportPDF();
                            break;
                        default:
                            showErrorDialog('Report Error', 'Report type not implemented yet');
                    }
                } catch (error) {
                    console.error('Error in generateReport:', error);
                    showErrorDialog('Report Generation Error', 'An error occurred while generating the report. Please try again.');
                }
            }, 2000);
        }

        function generateSummaryReportPDF() {
            try {
                if (typeof window.jspdf === 'undefined') {
                    showErrorMessage('PDF library not loaded. Please refresh the page and try again.');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
            
            // Set up colors
            const primaryColor = [46, 125, 50];
            const secondaryColor = [76, 175, 80];
            const textColor = [33, 37, 41];
            
            let yPosition = 20;
            const pageWidth = doc.internal.pageSize.width;
            const margin = 20;
            const contentWidth = pageWidth - (margin * 2);
            
            // Helper functions
            const addText = (text, x, y, options = {}) => {
                doc.setFontSize(options.fontSize || 12);
                doc.setTextColor(...(options.color || textColor));
                if (options.fontStyle) doc.setFont(undefined, options.fontStyle);
                doc.text(text, x, y, { align: options.align || 'left' });
            };
            
            const addLine = (x1, y1, x2, y2, color = primaryColor, width = 1) => {
                doc.setDrawColor(...color);
                doc.setLineWidth(width);
                doc.line(x1, y1, x2, y2);
            };
            
            // Header
            addText('SMARTFARM SUMMARY REPORT', pageWidth / 2, yPosition, {
                fontSize: 24,
                color: primaryColor,
                fontStyle: 'bold',
                align: 'center'
            });
            yPosition += 10;
            addText(`Generated on: ${new Date().toLocaleDateString()}`, pageWidth / 2, yPosition, {
                fontSize: 12,
                color: textColor,
                align: 'center'
            });
            yPosition += 15;
            addLine(margin, yPosition, pageWidth - margin, yPosition, primaryColor, 2);
            yPosition += 15;
            
            // Farm Information
            const farmData = JSON.parse(localStorage.getItem('farmData') || '{}');
            addText('FARM INFORMATION', margin, yPosition, {
                fontSize: 18,
                color: primaryColor,
                fontStyle: 'bold'
            });
            yPosition += 10;
            
            const farmInfo = [
                `Farm Name: ${farmData.name || 'Not specified'}`,
                `Location: ${farmData.location || 'Not specified'}`,
                `Total Area: ${farmData.area || 'Not specified'} hectares`,
                `Farm Type: ${farmData.type || 'Not specified'}`
            ];
            
            farmInfo.forEach(info => {
                addText(`‚Ä¢ ${info}`, margin + 10, yPosition);
                yPosition += 7;
            });
            yPosition += 10;
            
            // Crop Summary
            addText('CROP SUMMARY', margin, yPosition, {
                fontSize: 18,
                color: primaryColor,
                fontStyle: 'bold'
            });
            yPosition += 10;
            
            const cropCount = crops.length;
            const growingCrops = crops.filter(c => c.status.toLowerCase() === 'growing').length;
            const readyCrops = crops.filter(c => c.status.toLowerCase() === 'ready').length;
            const harvestedCrops = crops.filter(c => c.status.toLowerCase() === 'harvested').length;
            
            const cropInfo = [
                `Total Crop Types: ${cropCount}`,
                `Growing: ${growingCrops}`,
                `Ready for Harvest: ${readyCrops}`,
                `Harvested: ${harvestedCrops}`
            ];
            
            cropInfo.forEach(info => {
                addText(`‚Ä¢ ${info}`, margin + 10, yPosition);
                yPosition += 7;
            });
            yPosition += 10;
            
            // Livestock Summary
            addText('LIVESTOCK SUMMARY', margin, yPosition, {
                fontSize: 18,
                color: primaryColor,
                fontStyle: 'bold'
            });
            yPosition += 10;
            
            const livestockCount = livestock.reduce((total, animal) => total + animal.quantity, 0);
            const cattleCount = livestock.filter(l => l.type.toLowerCase() === 'cattle').length;
            const pigsCount = livestock.filter(l => l.type.toLowerCase() === 'pigs').length;
            const poultryCount = livestock.filter(l => l.type.toLowerCase() === 'poultry').length;
            
            const livestockInfo = [
                `Total Animals: ${livestockCount}`,
                `Cattle: ${cattleCount}`,
                `Pigs: ${pigsCount}`,
                `Poultry: ${poultryCount}`
            ];
            
            livestockInfo.forEach(info => {
                addText(`‚Ä¢ ${info}`, margin + 10, yPosition);
                yPosition += 7;
            });
            yPosition += 10;
            
            // Footer
            addLine(margin, yPosition, pageWidth - margin, yPosition, primaryColor, 1);
            yPosition += 10;
            addText('SmartFarm Management System', pageWidth / 2, yPosition, {
                fontSize: 10,
                color: textColor,
                align: 'center'
            });
            
            // Save the PDF
            const fileName = `FarmSummaryReport_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            
            showSuccessDialog(
                'üìÑ Report Generated Successfully',
                `Your farm summary report has been generated and downloaded as a PDF.\n\nFile: ${fileName}\n\nThe report includes:\n‚Ä¢ Farm information overview\n‚Ä¢ Crop summary statistics\n‚Ä¢ Livestock summary statistics\n‚Ä¢ Complete farm data analysis\n\nYou can open the PDF file in any PDF viewer to view the full report.`
            );
            } catch (error) {
                console.error('Error generating summary PDF:', error);
                showErrorMessage('Error generating PDF report. Please try again.');
            }
        }

        function generateCropReportPDF() {
            try {
                if (typeof window.jspdf === 'undefined') {
                    showErrorMessage('PDF library not loaded. Please refresh the page and try again.');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
            
            // Set up colors
            const primaryColor = [46, 125, 50];
            const textColor = [33, 37, 41];
            
            let yPosition = 20;
            const pageWidth = doc.internal.pageSize.width;
            const margin = 20;
            
            // Helper functions
            const addText = (text, x, y, options = {}) => {
                doc.setFontSize(options.fontSize || 12);
                doc.setTextColor(...(options.color || textColor));
                if (options.fontStyle) doc.setFont(undefined, options.fontStyle);
                doc.text(text, x, y, { align: options.align || 'left' });
            };
            
            // Header
            addText('CROP MANAGEMENT REPORT', pageWidth / 2, yPosition, {
                fontSize: 24,
                color: primaryColor,
                fontStyle: 'bold',
                align: 'center'
            });
            yPosition += 10;
            addText(`Generated on: ${new Date().toLocaleDateString()}`, pageWidth / 2, yPosition, {
                fontSize: 12,
                color: textColor,
                align: 'center'
            });
            yPosition += 20;
            
            // Crop Details Table
            if (crops.length > 0) {
                const tableData = crops.map(crop => [
                    crop.name || 'N/A',
                    crop.variety || 'N/A',
                    crop.plantingDate || 'N/A',
                    crop.status || 'N/A',
                    crop.area || 'N/A'
                ]);
                
                doc.autoTable({
                    head: [['Crop Name', 'Variety', 'Planting Date', 'Status', 'Area (hectares)']],
                    body: tableData,
                    startY: yPosition,
                    margin: { left: margin, right: margin },
                    styles: { fontSize: 10, cellPadding: 3 },
                    headStyles: { fillColor: primaryColor, textColor: [255, 255, 255], fontStyle: 'bold' },
                    alternateRowStyles: { fillColor: [248, 249, 250] }
                });
            } else {
                addText('No crop data available', margin, yPosition);
            }
            
            // Save the PDF
            const fileName = `CropReport_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            
            showSuccessDialog(
                'üìÑ Crop Report Generated',
                `Your crop management report has been generated and downloaded as a PDF.\n\nFile: ${fileName}\n\nThe report includes detailed information about all your crops.`
            );
            } catch (error) {
                console.error('Error generating crop PDF:', error);
                showErrorMessage('Error generating PDF report. Please try again.');
            }
        }

        function generateTasksReportPDF() {
            try {
                if (typeof window.jspdf === 'undefined') {
                    showErrorMessage('PDF library not loaded. Please refresh the page and try again.');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
            
            // Set up colors
            const primaryColor = [46, 125, 50];
            const textColor = [33, 37, 41];
            
            let yPosition = 20;
            const pageWidth = doc.internal.pageSize.width;
            const margin = 20;
            
            // Helper functions
            const addText = (text, x, y, options = {}) => {
                doc.setFontSize(options.fontSize || 12);
                doc.setTextColor(...(options.color || textColor));
                if (options.fontStyle) doc.setFont(undefined, options.fontStyle);
                doc.text(text, x, y, { align: options.align || 'left' });
            };
            
            // Header
            addText('TASK MANAGEMENT REPORT', pageWidth / 2, yPosition, {
                fontSize: 24,
                color: primaryColor,
                fontStyle: 'bold',
                align: 'center'
            });
            yPosition += 10;
            addText(`Generated on: ${new Date().toLocaleDateString()}`, pageWidth / 2, yPosition, {
                fontSize: 12,
                color: textColor,
                align: 'center'
            });
            yPosition += 20;
            
            // Task Details Table
            const tasks = JSON.parse(localStorage.getItem('farmTasks') || '[]');
            if (tasks.length > 0) {
                const tableData = tasks.map(task => [
                    task.title || 'N/A',
                    task.priority || 'N/A',
                    task.status || 'N/A',
                    task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'N/A',
                    task.assignedTo || 'N/A'
                ]);
                
                doc.autoTable({
                    head: [['Task Title', 'Priority', 'Status', 'Due Date', 'Assigned To']],
                    body: tableData,
                    startY: yPosition,
                    margin: { left: margin, right: margin },
                    styles: { fontSize: 10, cellPadding: 3 },
                    headStyles: { fillColor: primaryColor, textColor: [255, 255, 255], fontStyle: 'bold' },
                    alternateRowStyles: { fillColor: [248, 249, 250] }
                });
            } else {
                addText('No tasks available', margin, yPosition);
            }
            
            // Save the PDF
            const fileName = `TasksReport_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            
            showSuccessDialog(
                'üìÑ Tasks Report Generated',
                `Your task management report has been generated and downloaded as a PDF.\n\nFile: ${fileName}\n\nThe report includes detailed information about all your tasks.`
            );
            } catch (error) {
                console.error('Error generating tasks PDF:', error);
                showErrorMessage('Error generating PDF report. Please try again.');
            }
        }

        function generateLivestockReportPDF() {
            try {
                if (typeof window.jspdf === 'undefined') {
                    showErrorMessage('PDF library not loaded. Please refresh the page and try again.');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
            
            // Set up colors
            const primaryColor = [46, 125, 50];
            const textColor = [33, 37, 41];
            
            let yPosition = 20;
            const pageWidth = doc.internal.pageSize.width;
            const margin = 20;
            
            // Helper functions
            const addText = (text, x, y, options = {}) => {
                doc.setFontSize(options.fontSize || 12);
                doc.setTextColor(...(options.color || textColor));
                if (options.fontStyle) doc.setFont(undefined, options.fontStyle);
                doc.text(text, x, y, { align: options.align || 'left' });
            };
            
            // Header
            addText('LIVESTOCK MANAGEMENT REPORT', pageWidth / 2, yPosition, {
                fontSize: 24,
                color: primaryColor,
                fontStyle: 'bold',
                align: 'center'
            });
            yPosition += 10;
            addText(`Generated on: ${new Date().toLocaleDateString()}`, pageWidth / 2, yPosition, {
                fontSize: 12,
                color: textColor,
                align: 'center'
            });
            yPosition += 20;
            
            // Livestock Details Table
            if (livestock.length > 0) {
                const tableData = livestock.map(animal => [
                    animal.type || 'N/A',
                    animal.breed || 'N/A',
                    animal.quantity || 'N/A',
                    animal.location || 'N/A',
                    animal.status || 'N/A',
                    animal.age || 'N/A'
                ]);
                
                doc.autoTable({
                    head: [['Type', 'Breed', 'Quantity', 'Location', 'Status', 'Age']],
                    body: tableData,
                    startY: yPosition,
                    margin: { left: margin, right: margin },
                    styles: { fontSize: 10, cellPadding: 3 },
                    headStyles: { fillColor: primaryColor, textColor: [255, 255, 255], fontStyle: 'bold' },
                    alternateRowStyles: { fillColor: [248, 249, 250] }
                });
            } else {
                addText('No livestock data available', margin, yPosition);
            }
            
            // Save the PDF
            const fileName = `LivestockReport_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            
            showSuccessDialog(
                'üìÑ Livestock Report Generated',
                `Your livestock management report has been generated and downloaded as a PDF.\n\nFile: ${fileName}\n\nThe report includes detailed information about all your livestock.`
            );
            } catch (error) {
                console.error('Error generating livestock PDF:', error);
                showErrorMessage('Error generating PDF report. Please try again.');
            }
        }

        function generateInventoryReportPDF() {
            try {
                if (typeof window.jspdf === 'undefined') {
                    showErrorMessage('PDF library not loaded. Please refresh the page and try again.');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
            
            // Set up colors
            const primaryColor = [46, 125, 50];
            const textColor = [33, 37, 41];
            
            let yPosition = 20;
            const pageWidth = doc.internal.pageSize.width;
            const margin = 20;
            
            // Helper functions
            const addText = (text, x, y, options = {}) => {
                doc.setFontSize(options.fontSize || 12);
                doc.setTextColor(...(options.color || textColor));
                if (options.fontStyle) doc.setFont(undefined, options.fontStyle);
                doc.text(text, x, y, { align: options.align || 'left' });
            };
            
            // Header
            addText('INVENTORY MANAGEMENT REPORT', pageWidth / 2, yPosition, {
                fontSize: 24,
                color: primaryColor,
                fontStyle: 'bold',
                align: 'center'
            });
            yPosition += 10;
            addText(`Generated on: ${new Date().toLocaleDateString()}`, pageWidth / 2, yPosition, {
                fontSize: 12,
                color: textColor,
                align: 'center'
            });
            yPosition += 20;
            
            // Inventory Details Table
            if (inventory.length > 0) {
                const tableData = inventory.map(item => [
                    item.name || 'N/A',
                    item.category || 'N/A',
                    item.quantity || 'N/A',
                    item.unit || 'N/A',
                    item.status || 'N/A',
                    item.lastUpdated || 'N/A'
                ]);
                
                doc.autoTable({
                    head: [['Item Name', 'Category', 'Quantity', 'Unit', 'Status', 'Last Updated']],
                    body: tableData,
                    startY: yPosition,
                    margin: { left: margin, right: margin },
                    styles: { fontSize: 10, cellPadding: 3 },
                    headStyles: { fillColor: primaryColor, textColor: [255, 255, 255], fontStyle: 'bold' },
                    alternateRowStyles: { fillColor: [248, 249, 250] }
                });
            } else {
                addText('No inventory data available', margin, yPosition);
            }
            
            // Save the PDF
            const fileName = `InventoryReport_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            
            showSuccessDialog(
                'üìÑ Inventory Report Generated',
                `Your inventory management report has been generated and downloaded as a PDF.\n\nFile: ${fileName}\n\nThe report includes detailed information about all your inventory items.`
            );
            } catch (error) {
                console.error('Error generating inventory PDF:', error);
                showErrorMessage('Error generating PDF report. Please try again.');
            }
        }

        function generateFinancialReportPDF() {
            try {
                if (typeof window.jspdf === 'undefined') {
                    showErrorMessage('PDF library not loaded. Please refresh the page and try again.');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Set up colors
                const primaryColor = [46, 125, 50];
                const textColor = [33, 37, 41];
                
                let yPosition = 20;
                const pageWidth = doc.internal.pageSize.width;
                const margin = 20;
                
                // Helper functions
                const addText = (text, x, y, options = {}) => {
                    doc.setFontSize(options.fontSize || 12);
                    doc.setTextColor(...(options.color || textColor));
                    if (options.fontStyle) doc.setFont(undefined, options.fontStyle);
                    doc.text(text, x, y, { align: options.align || 'left' });
                };
                
                // Header
                addText('FINANCIAL REPORT', pageWidth / 2, yPosition, {
                    fontSize: 24,
                    color: primaryColor,
                    fontStyle: 'bold',
                    align: 'center'
                });
                yPosition += 10;
                addText(`Generated on: ${new Date().toLocaleDateString()}`, pageWidth / 2, yPosition, {
                    fontSize: 12,
                    color: textColor,
                    align: 'center'
                });
                yPosition += 20;
                
                // Financial Summary
                addText('Financial Summary', margin, yPosition, {
                    fontSize: 16,
                    fontStyle: 'bold'
                });
                yPosition += 15;
                
                // Get financial data
                const financialData = JSON.parse(localStorage.getItem('financialData') || '{}');
                const income = financialData.totalIncome || 0;
                const expenses = financialData.totalExpenses || 0;
                const profit = income - expenses;
                
                const financialSummary = [
                    `Total Income: FJD ${income.toFixed(2)}`,
                    `Total Expenses: FJD ${expenses.toFixed(2)}`,
                    `Net Profit: FJD ${profit.toFixed(2)}`,
                    `Profit Margin: ${income > 0 ? ((profit / income) * 100).toFixed(1) : 0}%`
                ];
                
                financialSummary.forEach(line => {
                    addText(line, margin, yPosition);
                    yPosition += 10;
                });
                
                yPosition += 10;
                
                // Income Sources
                addText('Income Sources', margin, yPosition, {
                    fontSize: 14,
                    fontStyle: 'bold'
                });
                yPosition += 10;
                
                const incomeSources = financialData.incomeSources || [
                    { source: 'Crop Sales', amount: income * 0.6 },
                    { source: 'Livestock Sales', amount: income * 0.3 },
                    { source: 'Other Income', amount: income * 0.1 }
                ];
                
                incomeSources.forEach(source => {
                    addText(`${source.source}: FJD ${source.amount.toFixed(2)}`, margin + 10, yPosition);
                    yPosition += 8;
                });
                
                yPosition += 10;
                
                // Expense Categories
                addText('Expense Categories', margin, yPosition, {
                    fontSize: 14,
                    fontStyle: 'bold'
                });
                yPosition += 10;
                
                const expenseCategories = financialData.expenseCategories || [
                    { category: 'Feed & Supplies', amount: expenses * 0.4 },
                    { category: 'Equipment', amount: expenses * 0.2 },
                    { category: 'Labor', amount: expenses * 0.3 },
                    { category: 'Other Expenses', amount: expenses * 0.1 }
                ];
                
                expenseCategories.forEach(expense => {
                    addText(`${expense.category}: FJD ${expense.amount.toFixed(2)}`, margin + 10, yPosition);
                    yPosition += 8;
                });
                
                // Save the PDF
                const fileName = `FinancialReport_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                showSuccessDialog(
                    'üìÑ Financial Report Generated',
                    `Your financial report has been generated and downloaded as a PDF.\n\nFile: ${fileName}\n\nThe report includes detailed financial analysis and summaries.`
                );
            } catch (error) {
                console.error('Error generating financial PDF:', error);
                showErrorMessage('Error generating PDF report. Please try again.');
            }
        }

        function generateSummaryReport() {
            const farmData = JSON.parse(localStorage.getItem('farmData') || '{}');
            const cropCount = crops.length;
            const livestockCount = livestock.reduce((total, animal) => total + animal.quantity, 0);
            const inventoryCount = inventory.reduce((total, item) => total + item.quantity, 0);
            
            const report = `
SMARTFARM SUMMARY REPORT
Generated: ${new Date().toLocaleDateString()}

FARM INFORMATION:
- Farm Name: ${farmData.name || 'Not specified'}
- Location: ${farmData.location || 'Not specified'}
- Total Area: ${farmData.area || 'Not specified'} hectares
- Farm Type: ${farmData.type || 'Not specified'}

CROP SUMMARY:
- Total Crop Types: ${cropCount}
- Growing: ${crops.filter(c => c.status.toLowerCase() === 'growing').length}
- Ready for Harvest: ${crops.filter(c => c.status.toLowerCase() === 'ready').length}
- Harvested: ${crops.filter(c => c.status.toLowerCase() === 'harvested').length}

LIVESTOCK SUMMARY:
- Total Animals: ${livestockCount}
- Cattle: ${livestock.filter(l => l.type.toLowerCase() === 'cattle').length}
- Pigs: ${livestock.filter(l => l.type.toLowerCase() === 'pigs').length}
- Other: ${livestock.filter(l => !['cattle', 'pigs'].includes(l.type.toLowerCase())).length}

INVENTORY SUMMARY:
- Total Items: ${inventoryCount}
- Categories: ${[...new Set(inventory.map(i => i.category))].join(', ')}
- Low Stock Items: ${inventory.filter(i => i.status === 'low-stock').length}
            `;
            
            showReportModal('Farm Summary Report', report);
        }

        function generateCropReport() {
            let report = `CROP DETAILED REPORT\nGenerated: ${new Date().toLocaleDateString()}\n\n`;
            
            crops.forEach((crop, index) => {
                report += `${index + 1}. ${crop.name}\n`;
                report += `   Field: ${crop.field}\n`;
                report += `   Planted: ${crop.plantedDate}\n`;
                report += `   Status: ${crop.status}\n\n`;
            });
            
            showReportModal('Crop Report', report);
        }

        function generateLivestockReport() {
            let report = `LIVESTOCK DETAILED REPORT\nGenerated: ${new Date().toLocaleDateString()}\n\n`;
            
            livestock.forEach((animal, index) => {
                report += `${index + 1}. ${animal.type} - ${animal.breed}\n`;
                report += `   Quantity: ${animal.quantity}\n`;
                report += `   Location: ${animal.location}\n`;
                report += `   Health Status: ${animal.status}\n\n`;
            });
            
            showReportModal('Livestock Report', report);
        }

        function generateInventoryReport() {
            let report = `INVENTORY DETAILED REPORT\nGenerated: ${new Date().toLocaleDateString()}\n\n`;
            
            inventory.forEach((item, index) => {
                report += `${index + 1}. ${item.name}\n`;
                report += `   Category: ${item.category}\n`;
                report += `   Quantity: ${item.quantity} ${item.unit}\n`;
                report += `   Last Updated: ${item.lastUpdated}\n\n`;
            });
            
            showReportModal('Inventory Report', report);
        }

        function exportData() {
            exportToCSV('all');
        }

        function showReportModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${title}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <pre style="white-space: pre-wrap; font-family: monospace; max-height: 400px; overflow-y: auto;">${content}</pre>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="exportReportAsText('${title}', \`${content}\`)">Export as Text</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        // CSV Export Functions
        function exportToCSV(type) {
            let csvContent = '';
            let filename = '';
            
            switch(type) {
                case 'all':
                    csvContent = generateAllDataCSV();
                    filename = 'smartfarm-all-data.csv';
                    break;
                case 'crops':
                    csvContent = generateCropsCSV();
                    filename = 'smartfarm-crops.csv';
                    break;
                case 'livestock':
                    csvContent = generateLivestockCSV();
                    filename = 'smartfarm-livestock.csv';
                    break;
                case 'inventory':
                    csvContent = generateInventoryCSV();
                    filename = 'smartfarm-inventory.csv';
                    break;
            }
            
            downloadCSV(csvContent, filename);
        }

        function generateAllDataCSV() {
            let csv = 'Type,Name,Field/Breed,Area/Quantity,Status,Location/Unit,Date\n';
            
            // Add crops
            crops.forEach(crop => {
                csv += `Crop,${crop.name},${crop.field},${crop.area || ''},${crop.status},,${crop.plantedDate}\n`;
            });
            
            // Add livestock
            livestock.forEach(animal => {
                csv += `Livestock,${animal.type},${animal.breed},${animal.quantity},${animal.status},${animal.location},\n`;
            });
            
            // Add inventory
            inventory.forEach(item => {
                csv += `Inventory,${item.name},${item.category},${item.quantity},${item.status || 'in-stock'},${item.unit},${item.lastUpdated}\n`;
            });
            
            return csv;
        }

        function generateCropsCSV() {
            let csv = 'Crop Name,Field,Planted Date,Status\n';
            crops.forEach(crop => {
                csv += `${crop.name},${crop.field},${crop.plantedDate},${crop.status}\n`;
            });
            return csv;
        }

        function generateLivestockCSV() {
            let csv = 'Type,Breed,Quantity,Location,Health Status\n';
            livestock.forEach(animal => {
                csv += `${animal.type},${animal.breed},${animal.quantity},${animal.location},${animal.status}\n`;
            });
            return csv;
        }

        function generateInventoryCSV() {
            let csv = 'Item Name,Category,Quantity,Unit,Last Updated,Status\n';
            inventory.forEach(item => {
                csv += `${item.name},${item.category},${item.quantity},${item.unit},${item.lastUpdated},${item.status || 'in-stock'}\n`;
            });
            return csv;
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccessMessage(`${filename} downloaded successfully!`);
        }

        // PDF Export Functions
        function exportToPDF(type) {
            try {
                // Check if jsPDF is available
                if (typeof window.jspdf === 'undefined') {
                    showErrorMessage('PDF library not loaded. Please refresh the page and try again.');
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let yPosition = 20;
                const lineHeight = 7;
                const margin = 20;

                // Add title
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('SmartFarm Report', margin, yPosition);
                yPosition += 15;

                // Add report type and date
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`Report Type: ${type.charAt(0).toUpperCase() + type.slice(1)} Report`, margin, yPosition);
                yPosition += lineHeight;
                doc.text(`Generated: ${new Date().toLocaleString()}`, margin, yPosition);
                yPosition += 20;

                // Generate content based on type
                switch(type) {
                    case 'summary':
                        generateSummaryPDFContent(doc, yPosition, lineHeight, margin, pageWidth);
                        break;
                    case 'detailed':
                        generateDetailedPDFContent(doc, yPosition, lineHeight, margin, pageWidth);
                        break;
                    case 'financial':
                        generateFinancialPDFContent(doc, yPosition, lineHeight, margin, pageWidth);
                        break;
                    default:
                        generateSummaryPDFContent(doc, yPosition, lineHeight, margin, pageWidth);
                }

                // Save the PDF
                const fileName = `SmartFarm_${type}_Report_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);

                showSuccessMessage(`PDF ${type} report generated successfully! File: ${fileName}`);
            } catch (error) {
                console.error('Error generating PDF:', error);
                showErrorMessage('Error generating PDF report. Please try again.');
            }
        }

        function generateSummaryPDFContent(doc, yPosition, lineHeight, margin, pageWidth) {
            // Farm Overview
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Farm Overview', margin, yPosition);
            yPosition += lineHeight + 5;

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            // Get farm data
            const farmData = JSON.parse(localStorage.getItem('farmData') || '{}');
            const crops = JSON.parse(localStorage.getItem('crops') || '[]');
            const livestock = JSON.parse(localStorage.getItem('livestock') || '[]');
            const inventory = JSON.parse(localStorage.getItem('inventory') || '[]');

            const summaryData = [
                `Farm Name: ${farmData.farmName || 'SmartFarm'}`,
                `Location: ${farmData.location || 'Not specified'}`,
                `Total Crops: ${crops.length}`,
                `Total Livestock: ${livestock.length}`,
                `Inventory Items: ${inventory.length}`,
                `Report Date: ${new Date().toLocaleDateString()}`
            ];

            summaryData.forEach(line => {
                if (yPosition > 280) {
                    doc.addPage();
                    yPosition = 20;
                }
                doc.text(line, margin, yPosition);
                yPosition += lineHeight;
            });

            // Crops Summary
            yPosition += 10;
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Crops Summary', margin, yPosition);
            yPosition += lineHeight + 5;

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            if (crops.length > 0) {
                crops.slice(0, 10).forEach(crop => {
                    if (yPosition > 280) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    doc.text(`‚Ä¢ ${crop.name} - ${crop.variety} (${crop.area} acres)`, margin + 5, yPosition);
                    yPosition += lineHeight;
                });
                if (crops.length > 10) {
                    doc.text(`... and ${crops.length - 10} more crops`, margin + 5, yPosition);
                }
            } else {
                doc.text('No crops data available', margin + 5, yPosition);
            }
        }

        function generateDetailedPDFContent(doc, yPosition, lineHeight, margin, pageWidth) {
            // Detailed Farm Report
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Detailed Farm Report', margin, yPosition);
            yPosition += lineHeight + 5;

            // Get all data
            const farmData = JSON.parse(localStorage.getItem('farmData') || '{}');
            const crops = JSON.parse(localStorage.getItem('crops') || '[]');
            const livestock = JSON.parse(localStorage.getItem('livestock') || '[]');
            const inventory = JSON.parse(localStorage.getItem('inventory') || '[]');

            // Crops Details
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Crops Details', margin, yPosition);
            yPosition += lineHeight + 5;

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            crops.forEach(crop => {
                if (yPosition > 280) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.text(`${crop.name} (${crop.variety})`, margin, yPosition);
                yPosition += lineHeight;
                doc.text(`  Area: ${crop.area} acres | Status: ${crop.status} | Yield: ${crop.yield || 'N/A'}`, margin + 5, yPosition);
                yPosition += lineHeight + 2;
            });

            // Livestock Details
            yPosition += 10;
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Livestock Details', margin, yPosition);
            yPosition += lineHeight + 5;

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            livestock.forEach(animal => {
                if (yPosition > 280) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.text(`${animal.type} - ${animal.breed}`, margin, yPosition);
                yPosition += lineHeight;
                doc.text(`  Age: ${animal.age} | Weight: ${animal.weight} | Status: ${animal.status}`, margin + 5, yPosition);
                yPosition += lineHeight + 2;
            });
        }

        function generateFinancialPDFContent(doc, yPosition, lineHeight, margin, pageWidth) {
            // Financial Report
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Financial Report', margin, yPosition);
            yPosition += lineHeight + 5;

            // Get financial data
            const farmData = JSON.parse(localStorage.getItem('farmData') || '{}');
            const crops = JSON.parse(localStorage.getItem('crops') || '[]');
            const livestock = JSON.parse(localStorage.getItem('livestock') || '[]');
            const inventory = JSON.parse(localStorage.getItem('inventory') || '[]');

            // Calculate totals
            const totalCropValue = crops.reduce((sum, crop) => sum + (parseFloat(crop.value) || 0), 0);
            const totalLivestockValue = livestock.reduce((sum, animal) => sum + (parseFloat(animal.value) || 0), 0);
            const totalInventoryValue = inventory.reduce((sum, item) => sum + (parseFloat(item.value) || 0), 0);
            const totalFarmValue = totalCropValue + totalLivestockValue + totalInventoryValue;

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            const financialData = [
                `Total Crop Value: $${totalCropValue.toFixed(2)}`,
                `Total Livestock Value: $${totalLivestockValue.toFixed(2)}`,
                `Total Inventory Value: $${totalInventoryValue.toFixed(2)}`,
                `Total Farm Value: $${totalFarmValue.toFixed(2)}`,
                `Number of Crops: ${crops.length}`,
                `Number of Livestock: ${livestock.length}`,
                `Inventory Items: ${inventory.length}`
            ];

            financialData.forEach(line => {
                if (yPosition > 280) {
                    doc.addPage();
                    yPosition = 20;
                }
                doc.text(line, margin, yPosition);
                yPosition += lineHeight;
            });

            // Revenue Breakdown
            yPosition += 10;
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Revenue Breakdown', margin, yPosition);
            yPosition += lineHeight + 5;

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            const revenueBreakdown = [
                `Crops Revenue: $${totalCropValue.toFixed(2)} (${((totalCropValue/totalFarmValue)*100).toFixed(1)}%)`,
                `Livestock Revenue: $${totalLivestockValue.toFixed(2)} (${((totalLivestockValue/totalFarmValue)*100).toFixed(1)}%)`,
                `Inventory Value: $${totalInventoryValue.toFixed(2)} (${((totalInventoryValue/totalFarmValue)*100).toFixed(1)}%)`
            ];

            revenueBreakdown.forEach(line => {
                if (yPosition > 280) {
                    doc.addPage();
                    yPosition = 20;
                }
                doc.text(line, margin, yPosition);
                yPosition += lineHeight;
            });
        }

        // JSON Export Functions
        function exportToJSON(type) {
            let data = {};
            let filename = '';
            
            switch(type) {
                case 'all':
                    data = {
                        farmData: JSON.parse(localStorage.getItem('farmData') || '{}'),
                        crops: crops,
                        livestock: livestock,
                        inventory: inventory,
                        exportDate: new Date().toISOString()
                    };
                    filename = 'smartfarm-complete-data.json';
                    break;
                case 'backup':
                    data = {
                        farmData: JSON.parse(localStorage.getItem('farmData') || '{}'),
                        crops: crops,
                        livestock: livestock,
                        inventory: inventory,
                        backupDate: new Date().toISOString(),
                        version: '1.0'
                    };
                    filename = 'smartfarm-backup.json';
                    break;
            }
            
            const jsonContent = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccessMessage(`${filename} downloaded successfully!`);
        }

        // Custom Report Builder
        function generateCustomReport() {
            const reportType = document.getElementById('customReportType').value;
            const dateRange = document.getElementById('customDateRange').value;
            const includeCharts = document.getElementById('includeCharts').checked;
            const exportFormat = document.getElementById('exportFormat').value;
            
            showSuccessMessage(`Generating ${reportType} report for ${dateRange}...`);
            
            // For now, generate a summary report
            setTimeout(() => {
                generateReport(reportType);
            }, 1000);
        }

        function exportReportAsText(title, content) {
            const filename = `${title.replace(/\s+/g, '-').toLowerCase()}-${new Date().toISOString().split('T')[0]}.txt`;
            const blob = new Blob([content], { type: 'text/plain' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccessMessage(`${filename} downloaded successfully!`);
        }

        // ===== AI SUGGESTIONS FUNCTIONALITY =====

        function showAISuggestions(cropId) {
            const crop = crops.find(c => c.id === cropId);
            if (!crop) {
                showInfoDialog('Error', 'Crop not found', 'OK');
                return;
            }

            // Show loading state
            const brainIcon = document.querySelector(`button[onclick="showAISuggestions(${cropId})"]`);
            if (brainIcon) {
                brainIcon.disabled = true;
                brainIcon.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }

            // Use setTimeout to prevent UI freezing
            setTimeout(() => {
                try {
                    // Debug: Log crop data
                    console.log('Crop data:', crop);
                    
                    // Validate crop has required properties
                    if (!crop.name) {
                        throw new Error('Crop name is missing');
                    }
                    if (!crop.plantedDate) {
                        throw new Error('Crop planted date is missing');
                    }
                    
                    const suggestions = generateAISuggestions(crop);
                    console.log('Generated suggestions:', suggestions);
                    
                    displayAISuggestionsModal(crop, suggestions);
                } catch (error) {
                    console.error('Error generating AI suggestions:', error);
                    console.error('Error stack:', error.stack);
                    showInfoDialog('AI Error', 'Error generating AI suggestions: ' + error.message, 'OK');
                } finally {
                    // Restore brain icon
                    if (brainIcon) {
                        brainIcon.disabled = false;
                        brainIcon.innerHTML = 'üß†';
                    }
                }
            }, 100);
        }

        function displayAISuggestionsModal(crop, suggestions) {
            // Validate inputs
            if (!crop) {
                throw new Error('Crop data is missing');
            }
            if (!suggestions || !Array.isArray(suggestions)) {
                throw new Error('Suggestions data is invalid');
            }
            
            // Create AI suggestions modal
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-brain me-2"></i>AI Suggestions for ${crop.name}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary">üå± Crop Information</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>Crop:</strong> ${crop.name}</li>
                                        <li><strong>Field:</strong> ${crop.field}</li>
                                        <li><strong>Status:</strong> ${crop.status}</li>
                                        <li><strong>pH Level:</strong> ${crop.phLevel || 'Not measured'}</li>
                                        <li><strong>Planted:</strong> ${crop.plantedDate}</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-warning">üêõ Pest Issues</h6>
                                    <p>${crop.pestIssues || 'No pest issues reported'}</p>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <div class="ai-suggestions">
                                ${suggestions.map(suggestion => `
                                    <div class="suggestion-card mb-3 p-3 border-start border-4 ${suggestion.type === 'critical' ? 'border-danger bg-light' : suggestion.type === 'warning' ? 'border-warning bg-light' : 'border-success bg-light'}">
                                        <div class="d-flex align-items-start">
                                            <div class="me-3">
                                                ${suggestion.type === 'critical' ? 'üö®' : suggestion.type === 'warning' ? '‚ö†Ô∏è' : '‚úÖ'}
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-2">${suggestion.title}</h6>
                                                <p class="mb-2">${suggestion.description}</p>
                                                <div class="actions mb-3">
                                                    ${suggestion.actions.map(action => `
                                                        <button class="btn btn-sm btn-outline-primary me-2 mb-1" onclick="executeSuggestion('${action}', ${crop.id})">
                                                            ${action}
                                                        </button>
                                                    `).join('')}
                                                </div>
                                                ${suggestion.treatments ? `
                                                    <div class="treatment-recipes mt-3">
                                                        <h6 class="text-primary mb-2">üß™ Treatment Recipes:</h6>
                                                        ${suggestion.treatments.map(treatment => `
                                                            <div class="treatment-card mb-3 p-3 bg-white border rounded">
                                                                <h6 class="text-success mb-2">${treatment.name}</h6>
                                                                <div class="ingredients mb-2">
                                                                    <strong>Ingredients:</strong>
                                                                    <ul class="mb-2">
                                                                        ${treatment.ingredients.map(ingredient => `<li>${ingredient}</li>`).join('')}
                                                                    </ul>
                                                                </div>
                                                                <div class="instructions">
                                                                    <strong>Instructions:</strong>
                                                                    <ol class="mb-2">
                                                                        ${treatment.instructions.map(instruction => `<li>${instruction}</li>`).join('')}
                                                                    </ol>
                                                                </div>
                                                                <div class="targets">
                                                                    <small class="text-muted"><strong>Targets:</strong> ${treatment.targets}</small>
                                                                </div>
                                                                ${treatment.timing ? `
                                                                    <div class="timing">
                                                                        <small class="text-info"><strong>Timing:</strong> ${treatment.timing}</small>
                                                                    </div>
                                                                ` : ''}
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-info" onclick="updateCropFromSuggestions(${crop.id})">
                                <i class="fas fa-sync me-2"></i>Update Crop Data
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            try {
                document.body.appendChild(modal);
                const bsModal = new bootstrap.Modal(modal);
                bsModal.show();
                
                modal.addEventListener('hidden.bs.modal', () => {
                    if (document.body.contains(modal)) {
                        document.body.removeChild(modal);
                    }
                });
            } catch (error) {
                console.error('Error creating AI suggestions modal:', error);
                // Clean up modal if it was partially created
                if (document.body.contains(modal)) {
                    document.body.removeChild(modal);
                }
                throw new Error('Failed to display AI suggestions modal: ' + error.message);
            }
        }

        function generateAISuggestions(crop) {
            console.log('Starting SIMPLE AI suggestions for crop:', crop.name || 'Unknown');
            
            // Simple, bulletproof AI suggestions
            const suggestions = [];
            
            // Enhanced pH Analysis with Detailed Recommendations
            if (crop.phLevel) {
                if (crop.phLevel < 6.0) {
                    suggestions.push({
                        type: 'critical',
                        title: 'Soil pH Too Acidic',
                        description: `Your soil pH of ${crop.phLevel} is too acidic. Most crops prefer pH 6.0-7.0. Immediate action needed.`,
                        actions: ['Apply Lime', 'Test Again', 'Monitor Progress'],
                        treatments: getSoilAcidityTreatments(crop.phLevel)
                    });
                } else if (crop.phLevel > 7.5) {
                    suggestions.push({
                        type: 'critical',
                        title: 'Soil pH Too Alkaline',
                        description: `Your soil pH of ${crop.phLevel} is too alkaline. Consider acidifying treatments.`,
                        actions: ['Apply Sulfur', 'Test Again', 'Monitor Progress'],
                        treatments: getSoilAlkalinityTreatments(crop.phLevel)
                    });
                } else {
                    suggestions.push({
                        type: 'success',
                        title: 'Optimal Soil pH',
                        description: `Excellent! Your soil pH of ${crop.phLevel} is in the optimal range for most crops.`,
                        actions: ['Continue Monitoring', 'Record in Log', 'Maintain Levels']
                    });
                }
            } else {
                suggestions.push({
                    type: 'warning',
                    title: 'Soil pH Testing Required',
                    description: 'Soil pH testing is crucial for optimal crop growth. Please test your soil pH levels.',
                    actions: ['Buy pH Tester', 'Schedule Testing', 'Professional Test'],
                    treatments: getSoilTestingRecommendations()
                });
            }
            
            // Enhanced Pest Analysis with Treatment Recommendations
            if (crop.pestIssues && crop.pestIssues.trim() !== '') {
                const pestText = crop.pestIssues.toLowerCase();
                suggestions.push({
                    type: 'critical',
                    title: 'Pest Issues Detected',
                    description: `Pest problems reported: "${crop.pestIssues}". Immediate action required to prevent crop damage.`,
                    actions: ['Identify Pests', 'Apply Treatment', 'Monitor Results'],
                    treatments: getDetailedPestTreatments(pestText)
                });
                
                // Add specific pest recommendations based on pest type
                if (pestText.includes('aphid') || pestText.includes('bug')) {
                    suggestions.push({
                        type: 'warning',
                        title: 'Insect Pest Management',
                        description: 'Insect pests detected. Apply these organic treatments for effective control.',
                        actions: ['Neem Oil Spray', 'Insecticidal Soap', 'Beneficial Insects'],
                        treatments: getInsectPestTreatments()
                    });
                }
                
                if (pestText.includes('fungus') || pestText.includes('mold') || pestText.includes('mildew')) {
                    suggestions.push({
                        type: 'warning',
                        title: 'Fungal Disease Control',
                        description: 'Fungal diseases detected. Apply fungicides and improve growing conditions.',
                        actions: ['Apply Fungicide', 'Improve Drainage', 'Increase Air Circulation'],
                        treatments: getFungalDiseaseTreatments()
                    });
                }
                
                if (pestText.includes('slug') || pestText.includes('snail')) {
                    suggestions.push({
                        type: 'warning',
                        title: 'Slug & Snail Control',
                        description: 'Slugs and snails detected. Use these effective control methods.',
                        actions: ['Beer Traps', 'Diatomaceous Earth', 'Hand Picking'],
                        treatments: getSlugSnailTreatments()
                    });
                }
            } else {
                suggestions.push({
                    type: 'success',
                    title: 'No Pest Issues Reported',
                    description: 'Excellent! No pest problems reported for this crop. Continue preventive measures.',
                    actions: ['Continue Monitoring', 'Maintain Prevention', 'Record Status'],
                    treatments: getPreventiveMeasures()
                });
            }
            
            // Basic growth stage suggestion
            try {
                const plantedDate = new Date(crop.plantedDate);
                const currentDate = new Date();
                const daysSincePlanted = Math.floor((currentDate - plantedDate) / (1000 * 60 * 60 * 24));
                
                if (daysSincePlanted < 14) {
                    suggestions.push({
                        type: 'warning',
                        title: 'Early Growth',
                        description: `Crop is ${daysSincePlanted} days old. Focus on gentle care.`,
                        actions: ['Light Watering', 'Monitor Daily']
                    });
                } else if (daysSincePlanted < 45) {
                    suggestions.push({
                        type: 'success',
                        title: 'Active Growth',
                        description: `Crop is ${daysSincePlanted} days old. Regular care needed.`,
                        actions: ['Regular Watering', 'Fertilize']
                    });
                } else {
                    suggestions.push({
                        type: 'success',
                        title: 'Mature Stage',
                        description: `Crop is ${daysSincePlanted} days old. Prepare for harvest.`,
                        actions: ['Check Readiness', 'Harvest Planning']
                    });
                }
            } catch (error) {
                console.error('Error calculating growth stage:', error);
                suggestions.push({
                    type: 'warning',
                    title: 'Growth Stage Unknown',
                    description: 'Unable to calculate growth stage. Please check planted date.',
                    actions: ['Check Date', 'Manual Assessment']
                });
            }
            
            console.log('Generated', suggestions.length, 'enhanced AI suggestions');
            return suggestions;
        }

        // Soil pH Treatment Functions
        function getSoilAcidityTreatments(currentpH) {
            const treatments = [];
            const targetpH = 6.5;
            const phDifference = targetpH - currentpH;
            
            treatments.push({
                name: "Agricultural Lime Application",
                ingredients: [
                    "Agricultural lime (calcium carbonate or dolomitic lime)",
                    "Soil testing kit",
                    "Garden rake or tiller",
                    "Water for irrigation"
                ],
                instructions: [
                    `Apply ${Math.round(phDifference * 2)} lbs of lime per 100 sq ft`,
                    "Work lime into top 6 inches of soil",
                    "Water thoroughly after application",
                    "Wait 2-3 weeks before retesting pH",
                    "Reapply if needed based on test results"
                ],
                targets: "Acidic soil pH correction",
                timing: "Best applied in fall or early spring"
            });
            
            treatments.push({
                name: "Organic pH Amendment",
                ingredients: [
                    "Wood ash (from hardwood only)",
                    "Compost or well-rotted manure",
                    "Eggshells (ground)",
                    "Bone meal"
                ],
                instructions: [
                    "Apply 1-2 inches of compost to soil surface",
                    "Sprinkle wood ash at 1 lb per 100 sq ft",
                    "Add ground eggshells around plant bases",
                    "Work amendments into top 4 inches of soil",
                    "Water thoroughly and monitor pH monthly"
                ],
                targets: "Gradual pH increase with organic methods",
                timing: "Can be applied anytime during growing season"
            });
            
            return treatments;
        }

        function getSoilAlkalinityTreatments(currentpH) {
            const treatments = [];
            const targetpH = 6.5;
            const phDifference = currentpH - targetpH;
            
            treatments.push({
                name: "Elemental Sulfur Application",
                ingredients: [
                    "Elemental sulfur (powdered or granular)",
                    "Soil testing kit",
                    "Garden rake",
                    "Water for irrigation"
                ],
                instructions: [
                    `Apply ${Math.round(phDifference * 1.5)} lbs sulfur per 100 sq ft`,
                    "Work sulfur into top 6 inches of soil",
                    "Water thoroughly after application",
                    "Wait 4-6 weeks before retesting pH",
                    "Reapply if needed based on test results"
                ],
                targets: "Alkaline soil pH correction",
                timing: "Best applied in fall for spring planting"
            });
            
            treatments.push({
                name: "Organic Acidification",
                ingredients: [
                    "Peat moss (sphagnum peat)",
                    "Composted pine needles",
                    "Coffee grounds",
                    "Vinegar solution (1 cup per gallon water)"
                ],
                instructions: [
                    "Mix 2-3 inches of peat moss into soil",
                    "Apply composted pine needles as mulch",
                    "Add coffee grounds around plant bases",
                    "Use vinegar solution for spot treatments",
                    "Monitor pH monthly and adjust as needed"
                ],
                targets: "Gradual pH decrease with organic methods",
                timing: "Apply throughout growing season"
            });
            
            return treatments;
        }

        function getSoilTestingRecommendations() {
            return [
                {
                    name: "Home Soil pH Testing",
                    ingredients: [
                        "Soil pH test kit (digital or chemical)",
                        "Clean containers for soil samples",
                        "Distilled water",
                        "Clean spoon or trowel"
                    ],
                    instructions: [
                        "Collect soil samples from 6 inches deep",
                        "Mix samples from multiple locations",
                        "Follow test kit instructions exactly",
                        "Test at different times of year",
                        "Record results and track changes over time"
                    ],
                    targets: "Regular soil pH monitoring",
                    timing: "Test 2-3 times per year"
                },
                {
                    name: "Professional Soil Analysis",
                    ingredients: [
                        "Soil sample bags from testing lab",
                        "Clean shovel or soil probe",
                        "Clean plastic bucket",
                        "Labeling materials"
                    ],
                    instructions: [
                        "Contact local agricultural extension office",
                        "Collect samples following lab guidelines",
                        "Send samples for comprehensive analysis",
                        "Receive detailed pH and nutrient report",
                        "Follow lab recommendations for amendments"
                    ],
                    targets: "Comprehensive soil analysis",
                    timing: "Annual testing recommended"
                }
            ];
        }

        // Pest Treatment Functions
        function getDetailedPestTreatments(pestText) {
            const treatments = [];
            
            // General pest control recommendations
            treatments.push({
                name: "Integrated Pest Management (IPM)",
                ingredients: [
                    "Beneficial insects (ladybugs, lacewings)",
                    "Physical barriers (row covers, sticky traps)",
                    "Organic pesticides (neem oil, insecticidal soap)",
                    "Monitoring tools (magnifying glass, notebook)"
                ],
                instructions: [
                    "Identify the specific pest species first",
                    "Use physical barriers to prevent pest access",
                    "Introduce beneficial insects for natural control",
                    "Apply organic pesticides as last resort",
                    "Monitor pest populations regularly and adjust strategy"
                ],
                targets: "General pest management approach",
                timing: "Apply throughout growing season as needed"
            });
            
            return treatments;
        }

        function getInsectPestTreatments() {
            return [
                {
                    name: "Neem Oil Spray",
                    ingredients: [
                        "2 teaspoons cold-pressed neem oil",
                        "1 teaspoon liquid dish soap (unscented)",
                        "1 gallon warm water",
                        "Spray bottle or garden sprayer"
                    ],
                    instructions: [
                        "Mix neem oil and dish soap in small container",
                        "Add to 1 gallon of warm water and stir well",
                        "Pour into spray bottle and shake before use",
                        "Apply early morning or evening to avoid sunburn",
                        "Spray both tops and bottoms of leaves",
                        "Reapply every 7-10 days until pests are controlled"
                    ],
                    targets: "Aphids, whiteflies, spider mites, thrips",
                    timing: "Apply when pests first appear"
                },
                {
                    name: "Insecticidal Soap",
                    ingredients: [
                        "1 tablespoon liquid dish soap (unscented)",
                        "1 gallon water",
                        "Spray bottle",
                        "Optional: 1 teaspoon vegetable oil"
                    ],
                    instructions: [
                        "Mix soap with water in spray bottle",
                        "Add vegetable oil for better adherence",
                        "Test on small area first to check for plant sensitivity",
                        "Spray directly on pests (soap must contact pest)",
                        "Apply in early morning or evening",
                        "Reapply every 5-7 days as needed"
                    ],
                    targets: "Soft-bodied insects (aphids, mealybugs, spider mites)",
                    timing: "Apply when pests are actively feeding"
                }
            ];
        }

        function getFungalDiseaseTreatments() {
            return [
                {
                    name: "Copper Fungicide Spray",
                    ingredients: [
                        "Copper fungicide (copper sulfate or copper hydroxide)",
                        "Water",
                        "Spray bottle or garden sprayer",
                        "Protective equipment (gloves, goggles)"
                    ],
                    instructions: [
                        "Follow product label for mixing instructions",
                        "Wear protective equipment during application",
                        "Apply to affected areas and surrounding healthy tissue",
                        "Spray early morning when leaves are dry",
                        "Reapply every 7-14 days as needed",
                        "Stop using 2 weeks before harvest"
                    ],
                    targets: "Fungal diseases (powdery mildew, blight, rust)",
                    timing: "Apply at first sign of fungal infection"
                },
                {
                    name: "Baking Soda Fungicide",
                    ingredients: [
                        "1 tablespoon baking soda",
                        "1 gallon water",
                        "1 teaspoon liquid dish soap",
                        "Spray bottle"
                    ],
                    instructions: [
                        "Mix baking soda and soap in water",
                        "Pour into spray bottle and shake well",
                        "Apply to affected plant areas",
                        "Spray every 7-10 days until symptoms disappear",
                        "Test on small area first for plant sensitivity",
                        "Apply early morning to avoid leaf burn"
                    ],
                    targets: "Powdery mildew, fungal leaf spots",
                    timing: "Apply preventatively or at first signs"
                }
            ];
        }

        function getSlugSnailTreatments() {
            return [
                {
                    name: "Beer Trap Method",
                    ingredients: [
                        "Shallow containers (yogurt cups, pie tins)",
                        "Cheap beer (not expensive - slugs aren't picky)",
                        "Small trowel or spoon",
                        "Disposable gloves"
                    ],
                    instructions: [
                        "Dig small holes around affected plants",
                        "Place containers so rim is level with soil",
                        "Fill containers 3/4 full with beer",
                        "Check and empty traps daily",
                        "Replace beer every 2-3 days",
                        "Dispose of dead slugs away from garden"
                    ],
                    targets: "Slugs and snails",
                    timing: "Set traps in evening, check in morning"
                },
                {
                    name: "Diatomaceous Earth Barrier",
                    ingredients: [
                        "Food-grade diatomaceous earth",
                        "Dust mask and gloves",
                        "Hand duster or shaker",
                        "Water spray bottle"
                    ],
                    instructions: [
                        "Wear dust mask and gloves for safety",
                        "Apply DE in dry conditions around plant bases",
                        "Create 2-3 inch wide barrier around plants",
                        "Reapply after rain or watering",
                        "Avoid applying directly on flowers (harms beneficial insects)",
                        "Keep DE dry for maximum effectiveness"
                    ],
                    targets: "Slugs, snails, and crawling insects",
                    timing: "Apply when pests are active, reapply after rain"
                }
            ];
        }

        function getPreventiveMeasures() {
            return [
                {
                    name: "Healthy Plant Maintenance",
                    ingredients: [
                        "Balanced fertilizer",
                        "Proper watering equipment",
                        "Pruning shears",
                        "Mulch materials"
                    ],
                    instructions: [
                        "Maintain proper soil fertility and pH",
                        "Water at base of plants to keep foliage dry",
                        "Prune to improve air circulation",
                        "Apply mulch to suppress weeds and retain moisture",
                        "Rotate crops annually to break pest cycles",
                        "Monitor plants regularly for early pest detection"
                    ],
                    targets: "Prevention of pest and disease problems",
                    timing: "Ongoing throughout growing season"
                },
                {
                    name: "Beneficial Insect Habitat",
                    ingredients: [
                        "Native flowering plants",
                        "Shallow water source",
                        "Shelter areas (rocks, logs)",
                        "Avoid broad-spectrum pesticides"
                    ],
                    instructions: [
                        "Plant flowers that attract beneficial insects",
                        "Provide shallow water sources for beneficial insects",
                        "Create habitat with rocks and logs for shelter",
                        "Avoid using pesticides that harm beneficial insects",
                        "Plant diverse crop varieties",
                        "Maintain healthy soil ecosystem"
                    ],
                    targets: "Natural pest control through beneficial insects",
                    timing: "Establish habitat before pest season begins"
                }
            ];
        }

        // Weeding recommendation functions - Optimized for performance
        function generateWeedingRecommendations(crop, daysSincePlanted) {
            const suggestions = [];
            const weatherConditions = getWeatherConditions();
            const cropName = (crop.name || '').toLowerCase();
            
            // Determine weeding urgency based on weather
            let weedingUrgency = 'normal';
            if (weatherConditions.temperature > 30 || (weatherConditions.temperature > 25 && weatherConditions.humidity > 60)) {
                weedingUrgency = 'high';
            } else if (weatherConditions.rainfall > 50) {
                weedingUrgency = 'high';
            }
            
            // Single comprehensive weeding suggestion based on growth stage and weather
            let title, description, actions, treatments;
            
            if (daysSincePlanted < 14) {
                title = 'Early Stage Weeding';
                description = `Crop is ${daysSincePlanted} days old. Weeds compete heavily with young plants. Weather: ${weatherConditions.temperature}¬∞C, ${weatherConditions.humidity}% humidity.`;
                actions = ['Light Hand Weeding', 'Mulch Application', 'Monitor Daily'];
                treatments = getEarlyStageWeedingTreatments();
            } else if (daysSincePlanted < 45) {
                title = 'Active Growth Weeding';
                description = `Crop is ${daysSincePlanted} days old. Regular weeding crucial. ${weedingUrgency === 'high' ? 'High weed pressure due to weather conditions.' : 'Normal weeding schedule recommended.'}`;
                actions = ['Regular Weeding', 'Mulch Maintenance', 'Hoe Cultivation'];
                treatments = getActiveGrowthWeedingTreatments();
            } else {
                title = 'Mature Stage Weeding';
                description = `Crop is ${daysSincePlanted} days old. Focus on maintaining clean rows and preventing weed seed production.`;
                actions = ['Row Maintenance', 'Seed Prevention', 'Final Cleanup'];
                treatments = getMatureStageWeedingTreatments();
            }
            
            // Add weather-specific actions if needed
            if (weatherConditions.temperature > 25) {
                actions.push('Morning Weeding', 'Extra Mulch');
            }
            if (weatherConditions.humidity > 70) {
                actions.push('Improve Air Circulation');
            }
            if (weatherConditions.rainfall > 30) {
                actions.push('Post-Rain Cultivation');
            }
            
            // Add crop-specific treatment if applicable
            if (cropName.includes('corn') || cropName.includes('maize')) {
                treatments = treatments.concat(getCornWeedingTreatments());
                actions.push('Between-Row Cultivation');
            } else if (cropName.includes('tomato') || cropName.includes('pepper')) {
                treatments = treatments.concat(getVegetableWeedingTreatments());
                actions.push('Careful Hand Weeding');
            }
            
            suggestions.push({
                type: weedingUrgency === 'high' ? 'warning' : 'success',
                title: title,
                description: description,
                actions: actions.slice(0, 5), // Limit to 5 actions to prevent UI overload
                treatments: treatments.slice(0, 3), // Limit to 3 treatments to prevent UI overload
                urgency: weedingUrgency
            });
            
            return suggestions;
        }

        function getCurrentSeason() {
            const month = new Date().getMonth();
            if (month >= 2 && month <= 4) return 'spring';
            if (month >= 5 && month <= 7) return 'summer';
            if (month >= 8 && month <= 10) return 'autumn';
            return 'winter';
        }

        // Cache weather conditions to prevent repeated calculations
        let weatherCache = null;
        let weatherCacheTime = 0;
        
        function getWeatherConditions() {
            const now = Date.now();
            // Cache weather for 5 minutes to prevent repeated calculations
            if (weatherCache && (now - weatherCacheTime) < 300000) {
                return weatherCache;
            }
            
            // Simulate weather conditions (in a real app, this would come from a weather API)
            const currentHour = new Date().getHours();
            const month = new Date().getMonth();
            
            // Simulate seasonal and daily variations
            let baseTemp = 20 + (month * 2); // Seasonal variation
            baseTemp += Math.sin(currentHour * 0.261) * 5; // Daily variation
            
            let humidity = 50 + Math.sin(currentHour * 0.261) * 20;
            // Use deterministic "random" based on date to avoid UI freezing
            let rainfall = ((currentHour * 17 + month * 31) % 100);
            
            weatherCache = {
                temperature: Math.round(baseTemp),
                humidity: Math.round(humidity),
                rainfall: Math.round(rainfall),
                season: getCurrentSeason()
            };
            weatherCacheTime = now;
            
            return weatherCache;
        }

        // Weeding treatment functions
        function getEarlyStageWeedingTreatments() {
            return [
                {
                    name: "Hand Weeding (Gentle)",
                    ingredients: [
                        "Small hand tools (hand hoe, weeder)",
                        "Gloves",
                        "Knee pad or small stool",
                        "Bucket for weeds"
                    ],
                    instructions: [
                        "Weed early in the morning when soil is moist",
                        "Use gentle pulling motion to avoid disturbing crop roots",
                        "Remove weeds when they are small (2-3 inches)",
                        "Focus on weeds within 6 inches of crop plants",
                        "Dispose of weeds away from field to prevent reseeding"
                    ],
                    targets: "Small annual weeds, grass seedlings"
                },
                {
                    name: "Organic Mulch Application",
                    ingredients: [
                        "Straw or hay (2-3 inches thick)",
                        "Newspaper or cardboard (optional base layer)",
                        "Water for settling mulch"
                    ],
                    instructions: [
                        "Lay newspaper/cardboard around plants first",
                        "Apply 2-3 inches of straw mulch",
                        "Keep mulch 2 inches away from plant stems",
                        "Water mulch to settle it in place",
                        "Replenish mulch as it decomposes"
                    ],
                    targets: "Weed seed germination, soil moisture retention"
                },
                {
                    name: "Pre-Emergent Herbicide Application",
                    ingredients: [
                        "Pre-emergent herbicide (Trifluralin, Pendimethalin)",
                        "Spray equipment (backpack or boom sprayer)",
                        "Protective equipment (gloves, goggles, respirator)",
                        "Calibration tools"
                    ],
                    instructions: [
                        "Apply 2-3 days before planting or immediately after",
                        "Calibrate sprayer for uniform coverage",
                        "Apply at recommended rate (check label)",
                        "Ensure soil incorporation if required",
                        "Avoid application before heavy rainfall",
                        "Wear full protective equipment during application"
                    ],
                    targets: "Annual weed seeds before germination",
                    safety: "HIGH - Follow all label instructions and safety precautions"
                }
            ];
        }

        function getActiveGrowthWeedingTreatments() {
            return [
                {
                    name: "Hoe Cultivation",
                    ingredients: [
                        "Sharp garden hoe",
                        "Cultivator or stirrup hoe",
                        "Gloves and protective clothing"
                    ],
                    instructions: [
                        "Cultivate when soil is slightly moist, not wet",
                        "Work between rows, 4-6 inches from crop plants",
                        "Use shallow cultivation (1-2 inches deep)",
                        "Cultivate in one direction to avoid soil compaction",
                        "Repeat every 7-10 days during active growth"
                    ],
                    targets: "Established annual weeds, soil crust breaking"
                },
                {
                    name: "Vinegar Weed Spray",
                    ingredients: [
                        "1 gallon white vinegar (5% acidity)",
                        "1 cup salt",
                        "1 tablespoon liquid dish soap",
                        "Spray bottle or garden sprayer"
                    ],
                    instructions: [
                        "Mix vinegar and salt until salt dissolves",
                        "Add dish soap and mix well",
                        "Apply on sunny day with no rain forecast",
                        "Spray directly on weed leaves",
                        "Avoid contact with crop plants",
                        "Reapply in 3-5 days for stubborn weeds"
                    ],
                    targets: "Broadleaf weeds, young grass weeds"
                },
                {
                    name: "Post-Emergent Herbicide Application",
                    ingredients: [
                        "Post-emergent herbicide (Glyphosate, 2,4-D, Dicamba)",
                        "Selective herbicide for specific crops",
                        "Spray equipment with proper nozzles",
                        "Protective equipment (coveralls, gloves, goggles, respirator)",
                        "Shield or wick applicator for precision"
                    ],
                    instructions: [
                        "Apply when weeds are actively growing (2-4 inches tall)",
                        "Use selective herbicides for broadleaf or grass control",
                        "Apply during calm conditions (wind < 5 mph)",
                        "Use shields to protect crop plants",
                        "Follow label rates and timing restrictions",
                        "Ensure 24-48 hour rain-free period after application"
                    ],
                    targets: "Established broadleaf and grass weeds",
                    safety: "HIGH - Use protective equipment and follow label exactly"
                },
                {
                    name: "Directed Spray Application",
                    ingredients: [
                        "Non-selective herbicide (Glyphosate)",
                        "Directed spray equipment or wick applicator",
                        "Protective equipment and shields",
                        "Calibration tools"
                    ],
                    instructions: [
                        "Apply only to weed foliage, avoid crop contact",
                        "Use low pressure and large droplet size",
                        "Apply when weeds are 2-6 inches tall",
                        "Use shields or wick applicators for precision",
                        "Apply during optimal weather conditions",
                        "Monitor for crop injury symptoms"
                    ],
                    targets: "Weeds between crop rows, spot treatments",
                    safety: "CRITICAL - Precision application required to avoid crop damage"
                }
            ];
        }

        function getMatureStageWeedingTreatments() {
            return [
                {
                    name: "Final Weeding and Mulching",
                    ingredients: [
                        "Heavy mulch (straw, wood chips)",
                        "Hand tools for spot weeding",
                        "Weed barrier fabric (optional)"
                    ],
                    instructions: [
                        "Remove any remaining large weeds by hand",
                        "Apply heavy mulch layer (4-6 inches)",
                        "Install weed barrier fabric between rows if needed",
                        "Focus on preventing weed seed production",
                        "Maintain clean harvest paths"
                    ],
                    targets: "Mature weeds, weed seed prevention"
                }
            ];
        }

        function getHotWeatherWeedingTreatments() {
            return [
                {
                    name: "Morning Weeding Schedule",
                    ingredients: [
                        "Early morning timing (6-8 AM)",
                        "Extra mulch materials",
                        "Shade cloth or row covers"
                    ],
                    instructions: [
                        "Weed early morning to avoid heat stress",
                        "Apply extra mulch to reduce soil temperature",
                        "Use shade cloth over sensitive crops",
                        "Increase watering frequency",
                        "Consider drip irrigation to reduce humidity"
                    ],
                    targets: "Heat-stressed weeds, soil cooling"
                },
                {
                    name: "Hot Weather Herbicide Application",
                    ingredients: [
                        "Systemic herbicide (Glyphosate)",
                        "Early morning application timing",
                        "Protective equipment for hot conditions",
                        "Extra water for mixing and cleanup"
                    ],
                    instructions: [
                        "Apply early morning (6-8 AM) before temperatures exceed 85¬∞F",
                        "Increase water volume to reduce herbicide concentration",
                        "Use larger droplet sizes to minimize drift",
                        "Wear lightweight protective equipment",
                        "Take frequent breaks and stay hydrated",
                        "Monitor for herbicide volatility in extreme heat"
                    ],
                    targets: "Heat-stressed weeds, reduced herbicide effectiveness",
                    safety: "HIGH - Extreme heat increases herbicide volatility and drift risk"
                }
            ];
        }

        function getHighHumidityWeedingTreatments() {
            return [
                {
                    name: "Humidity Control Weeding",
                    ingredients: [
                        "Air circulation fans (if in greenhouse)",
                        "Drip irrigation system",
                        "Extra mulch for moisture control"
                    ],
                    instructions: [
                        "Improve air circulation around plants",
                        "Switch to drip irrigation to reduce humidity",
                        "Apply mulch to prevent soil moisture evaporation",
                        "Weed more frequently during humid periods",
                        "Consider spacing plants further apart"
                    ],
                    targets: "Humidity-promoted weed growth"
                }
            ];
        }

        function getPostRainWeedingTreatments() {
            return [
                {
                    name: "Post-Rain Cultivation",
                    ingredients: [
                        "Cultivation tools",
                        "Fresh mulch materials",
                        "Soil amendments if needed"
                    ],
                    instructions: [
                        "Wait until soil is workable (not too wet)",
                        "Cultivate soil to disrupt weed germination",
                        "Apply fresh mulch immediately after cultivation",
                        "Check for soil compaction and aerate if needed",
                        "Monitor for new weed growth in following days"
                    ],
                    targets: "Post-rain weed germination, soil aeration"
                }
            ];
        }

        function getCornWeedingTreatments() {
            return [
                {
                    name: "Corn Row Cultivation",
                    ingredients: [
                        "Row crop cultivator or hoe",
                        "Pre-emergent herbicide (optional)",
                        "Hand tools for close weeding"
                    ],
                    instructions: [
                        "Cultivate between rows when corn is 4-6 inches tall",
                        "Use shields to protect corn plants from soil",
                        "Apply pre-emergent herbicide if using",
                        "Hand weed within 6 inches of corn plants",
                        "Repeat cultivation every 10-14 days until corn is 3 feet tall"
                    ],
                    targets: "Annual weeds, grass competition in corn"
                },
                {
                    name: "Corn Selective Herbicide Program",
                    ingredients: [
                        "Atrazine + S-metolachlor (pre-emergent)",
                        "Nicosulfuron + Mesotrione (post-emergent)",
                        "Spray equipment with corn shields",
                        "Protective equipment and calibration tools"
                    ],
                    instructions: [
                        "Apply pre-emergent within 3 days of planting",
                        "Apply post-emergent when corn is 4-12 inches tall",
                        "Use proper spray shields to protect corn plants",
                        "Follow label rates and timing restrictions",
                        "Monitor for crop injury and weed control",
                        "Apply during optimal weather conditions"
                    ],
                    targets: "Annual broadleaf and grass weeds in corn",
                    safety: "HIGH - Corn-specific herbicides with proper application"
                }
            ];
        }

        function getVegetableWeedingTreatments() {
            return [
                {
                    name: "Vegetable Care Weeding",
                    ingredients: [
                        "Small hand tools",
                        "Straw mulch",
                        "Organic weed control spray"
                    ],
                    instructions: [
                        "Hand weed carefully to avoid damaging vegetable roots",
                        "Apply thick straw mulch around plants",
                        "Use organic sprays only as last resort",
                        "Weed regularly to prevent competition",
                        "Support plants with stakes or cages to improve access"
                    ],
                    targets: "Vegetable garden weeds, shallow root protection"
                },
                {
                    name: "Vegetable Herbicide Program",
                    ingredients: [
                        "DCPA (Dacthal) - pre-emergent for vegetables",
                        "Clethodim - post-emergent for grass control",
                        "Spray equipment with fine nozzles",
                        "Protective equipment and calibration tools"
                    ],
                    instructions: [
                        "Apply DCPA before vegetable emergence",
                        "Use Clethodim for grass control in established crops",
                        "Apply at recommended rates for specific vegetables",
                        "Use proper spray shields and timing",
                        "Follow pre-harvest intervals (PHI) on labels",
                        "Monitor for crop tolerance and weed control"
                    ],
                    targets: "Grass weeds in vegetable crops",
                    safety: "MODERATE - Follow vegetable-specific label instructions"
                }
            ];
        }

        // Treatment recipe functions
        function getPestTreatments(pestText) {
            const treatments = [];
            
            if ((pestText && pestText.includes('aphid')) || (pestText && pestText.includes('bug'))) {
                treatments.push({
                    name: "Neem Oil Spray",
                    ingredients: [
                        "2 teaspoons neem oil (cold-pressed)",
                        "1 teaspoon liquid dish soap (unscented)",
                        "1 gallon warm water",
                        "1 teaspoon baking soda (optional)"
                    ],
                    instructions: [
                        "Mix neem oil and dish soap in small container",
                        "Add to 1 gallon of warm water",
                        "Stir well and pour into spray bottle",
                        "Shake before each use",
                        "Apply early morning or evening"
                    ],
                    targets: "Aphids, whiteflies, spider mites, thrips, mealybugs"
                });
                
                treatments.push({
                    name: "Insecticidal Soap Spray",
                    ingredients: [
                        "2 tablespoons liquid dish soap (unscented, biodegradable)",
                        "1 gallon water",
                        "1 teaspoon vegetable oil (optional)"
                    ],
                    instructions: [
                        "Mix soap with water in spray bottle",
                        "Add vegetable oil if desired",
                        "Shake well before use",
                        "Apply directly to pests",
                        "Reapply every 3-7 days"
                    ],
                    targets: "Aphids, spider mites, whiteflies, mealybugs, thrips"
                });
            }
            
            return treatments;
        }

        function getInsectTreatments() {
            return [
                {
                    name: "Garlic Spray (Natural Repellent)",
                    ingredients: [
                        "10-12 garlic cloves",
                        "1 tablespoon liquid dish soap",
                        "1 tablespoon mineral oil",
                        "1 quart water",
                        "1 tablespoon cayenne pepper (optional)"
                    ],
                    instructions: [
                        "Blend garlic cloves with 1 cup water",
                        "Let steep for 24 hours",
                        "Strain through cheesecloth",
                        "Mix with remaining water, soap, and oil",
                        "Add cayenne pepper for extra potency",
                        "Store in refrigerator for up to 1 week"
                    ],
                    targets: "Aphids, cabbage worms, Japanese beetles, repels many insects"
                },
                {
                    name: "Hot Pepper Spray",
                    ingredients: [
                        "6-10 hot peppers (jalape√±o, habanero, or cayenne)",
                        "2 tablespoons liquid dish soap",
                        "1 tablespoon vegetable oil",
                        "1 quart water",
                        "1 tablespoon cayenne powder (optional)"
                    ],
                    instructions: [
                        "Blend peppers with 1 cup water",
                        "Let steep for 24 hours",
                        "Strain through cheesecloth",
                        "Mix with remaining ingredients",
                        "Wear gloves when handling",
                        "Test on small area first"
                    ],
                    targets: "Aphids, caterpillars, beetles, repels rabbits and deer"
                }
            ];
        }

        function getFungalTreatments() {
            return [
                {
                    name: "Baking Soda Fungicide",
                    ingredients: [
                        "1 tablespoon baking soda",
                        "1 teaspoon liquid dish soap",
                        "1 gallon water",
                        "2 tablespoons vegetable oil (optional)"
                    ],
                    instructions: [
                        "Mix all ingredients in spray bottle",
                        "Shake well before use",
                        "Apply every 7-10 days",
                        "Avoid applying in hot sun",
                        "Test on small area first"
                    ],
                    targets: "Powdery mildew, black spot, rust, anthracnose"
                },
                {
                    name: "Milk Spray (Fungal Prevention)",
                    ingredients: [
                        "1 part milk (whole or skim)",
                        "9 parts water",
                        "1 teaspoon baking soda (optional)"
                    ],
                    instructions: [
                        "Mix milk with water",
                        "Add baking soda if desired",
                        "Apply every 7-10 days",
                        "Use in morning",
                        "Avoid applying in hot sun"
                    ],
                    targets: "Powdery mildew, mosaic viruses"
                }
            ];
        }

        function getSlugTreatments() {
            return [
                {
                    name: "Beer Trap",
                    ingredients: [
                        "1 cup beer (cheap beer works best)",
                        "Shallow container (yogurt cup, tuna can)",
                        "1 tablespoon sugar (optional)"
                    ],
                    instructions: [
                        "Pour beer into shallow container",
                        "Add sugar if desired",
                        "Bury container so rim is level with soil",
                        "Replace beer every 2-3 days",
                        "Place multiple traps around garden"
                    ],
                    targets: "Slugs, snails, earwigs"
                },
                {
                    name: "Diatomaceous Earth Dust",
                    ingredients: [
                        "Food-grade diatomaceous earth",
                        "Dust applicator or shaker",
                        "Protective mask (for application)"
                    ],
                    instructions: [
                        "Apply dry powder to plant surfaces",
                        "Focus on undersides of leaves",
                        "Reapply after rain or watering",
                        "Use protective equipment",
                        "Avoid breathing dust"
                    ],
                    targets: "Ants, beetles, caterpillars, slugs, soft-bodied insects"
                }
            ];
        }

        function getCaterpillarTreatments() {
            return [
                {
                    name: "Bt (Bacillus Thuringiensis) Spray",
                    ingredients: [
                        "1-2 teaspoons Bt powder",
                        "1 gallon water",
                        "1 teaspoon liquid dish soap",
                        "Spray bottle"
                    ],
                    instructions: [
                        "Mix Bt powder with small amount of water",
                        "Add to remaining water in spray bottle",
                        "Add dish soap for better adhesion",
                        "Apply to leaves where caterpillars feed",
                        "Reapply every 7-10 days or after rain"
                    ],
                    targets: "Caterpillars, cabbage worms, tomato hornworms"
                },
                {
                    name: "Hand Picking Method",
                    ingredients: [
                        "Bucket of soapy water",
                        "Gloves (optional)",
                        "Flashlight (for night picking)"
                    ],
                    instructions: [
                        "Inspect plants daily for caterpillars",
                        "Wear gloves if handling stinging caterpillars",
                        "Drop caterpillars into soapy water",
                        "Check undersides of leaves",
                        "Best done early morning or evening"
                    ],
                    targets: "Large caterpillars, hornworms, cabbage worms"
                }
            ];
        }

        function getMiteTreatments() {
            return [
                {
                    name: "Water Spray Treatment",
                    ingredients: [
                        "Strong water stream (hose or spray bottle)",
                        "Water",
                        "1 teaspoon liquid dish soap (optional)"
                    ],
                    instructions: [
                        "Use strong water stream to dislodge mites",
                        "Focus on undersides of leaves",
                        "Apply every 2-3 days",
                        "Increase humidity around plants",
                        "Remove heavily infested leaves"
                    ],
                    targets: "Spider mites, aphids, small insects"
                },
                {
                    name: "Essential Oil Spray",
                    ingredients: [
                        "10 drops peppermint oil",
                        "10 drops eucalyptus oil",
                        "5 drops tea tree oil",
                        "1 tablespoon liquid dish soap",
                        "1 gallon water"
                    ],
                    instructions: [
                        "Mix essential oils with soap",
                        "Add to water gradually",
                        "Shake well before use",
                        "Apply early morning or evening",
                        "Store in cool place"
                    ],
                    targets: "Spider mites, aphids, ants, repels many insects"
                }
            ];
        }

        function getPreventiveTreatments() {
            return [
                {
                    name: "General Preventive Spray",
                    ingredients: [
                        "1 tablespoon liquid dish soap",
                        "1 tablespoon vegetable oil",
                        "1 gallon water",
                        "1 teaspoon baking soda (optional)"
                    ],
                    instructions: [
                        "Mix soap and oil in small container",
                        "Add to water gradually",
                        "Add baking soda for fungal prevention",
                        "Apply every 2 weeks",
                        "Shake well before each use"
                    ],
                    targets: "General pest prevention, fungal prevention"
                },
                {
                    name: "Companion Planting Guide",
                    ingredients: [
                        "Marigold seeds",
                        "Garlic bulbs",
                        "Chive plants",
                        "Basil plants"
                    ],
                    instructions: [
                        "Plant marigolds around vegetable beds",
                        "Interplant garlic and chives",
                        "Add basil near tomatoes",
                        "Rotate companion plants annually",
                        "Maintain good spacing for air circulation"
                    ],
                    targets: "Natural pest repellent, beneficial insect attraction"
                }
            ];
        }

        function executeSuggestion(action, cropId) {
            showSuccessMessage(`Executing: ${action}`);
            
            // Here you could implement specific actions
            switch(action) {
                case 'Test Soil pH':
                    showSuccessMessage('Soil pH testing kit recommended. Test multiple locations in the field.');
                    break;
                case 'Add Lime':
                    showSuccessMessage('Apply 50-100 lbs of lime per 1000 sq ft for acidic soil correction.');
                    break;
                case 'Apply Treatment':
                    showSuccessMessage('Consult with agricultural expert for appropriate treatment recommendations.');
                    break;
                case 'Monitor Regularly':
                    showSuccessMessage('Set up regular monitoring schedule for optimal crop health.');
                    break;
                default:
                    showSuccessMessage(`Action "${action}" logged for implementation.`);
            }
        }

        function updateCropFromSuggestions(cropId) {
            const crop = crops.find(c => c.id === cropId);
            if (crop) {
                // Update last updated timestamp
                crop.lastUpdated = new Date().toLocaleDateString();
                saveCropsData();
                renderCropsTable();
                showSuccessMessage('Crop data updated with AI suggestions!');
            }
        }

        // ===== URL ROUTING AND STATE PERSISTENCE =====

        function initializeURLRouting() {
            // Check if there's a hash in the URL
            const hash = window.location.hash.substring(1);
            
            if (hash) {
                // Navigate to the specified view
                navigateToView(hash);
            } else {
                // Check localStorage for last viewed page
                const lastView = localStorage.getItem('smartfarm_lastView');
                if (lastView && lastView !== 'dashboardView') {
                    navigateToView(lastView);
                } else {
                    // Default to dashboard
                    showDashboard();
                }
            }
            
            // Listen for hash changes
            window.addEventListener('hashchange', function() {
                const newHash = window.location.hash.substring(1);
                navigateToView(newHash);
            });
        }

        function navigateToView(viewName) {
            // Update URL hash
            window.location.hash = viewName;
            
            // Save current view to localStorage
            localStorage.setItem('smartfarm_lastView', viewName);
            
            // Navigate to the appropriate view
            switch(viewName) {
                case 'farmManagementView':
                    showFarmManagement();
                    break;
                case 'cropManagementView':
                    showCropManagement();
                    break;
                case 'livestockManagementView':
                    showLivestockManagement();
                    break;
                case 'petsManagementView':
                    showPetsManagement();
                    break;
                case 'inventoryManagementView':
                    showInventoryManagement();
                    break;
                case 'analyticsView':
                    showAnalytics();
                    break;
                case 'reportsView':
                    showReports();
                    break;
                case 'tasksView':
                    showTasks();
                    break;
                default:
                    showDashboard();
            }
        }

        // Duplicate updateURL function removed - using the main one above

        // User functions
        function editProfile() {
            showEditProfileModal();
        }

        function showEditProfileModal() {
            const user = JSON.parse(localStorage.getItem('smartfarm_user') || '{}');
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-user-edit me-2"></i>Edit Profile
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editProfileForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="profileFirstName" class="form-label">First Name *</label>
                                            <input type="text" class="form-control" id="profileFirstName" value="${user.firstName || ''}" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="profileLastName" class="form-label">Last Name *</label>
                                            <input type="text" class="form-control" id="profileLastName" value="${user.lastName || ''}" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="profileEmail" class="form-label">Email Address *</label>
                                    <input type="email" class="form-control" id="profileEmail" value="${user.email || ''}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="profilePhone" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="profilePhone" value="${user.phone || ''}">
                                </div>
                                <div class="mb-3">
                                    <label for="profileFarmName" class="form-label">Farm Name</label>
                                    <input type="text" class="form-control" id="profileFarmName" value="${user.farmName || ''}">
                                </div>
                                <div class="mb-3">
                                    <label for="profileLocation" class="form-label">Location</label>
                                    <input type="text" class="form-control" id="profileLocation" value="${user.location || ''}">
                                </div>
                                <div class="mb-3">
                                    <label for="profileBio" class="form-label">Bio</label>
                                    <textarea class="form-control" id="profileBio" rows="3" placeholder="Tell us about yourself and your farming experience">${user.bio || ''}</textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveProfile()">
                                <i class="fas fa-save me-2"></i>Save Profile
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function saveProfile() {
            const firstName = document.getElementById('profileFirstName').value.trim();
            const lastName = document.getElementById('profileLastName').value.trim();
            const email = document.getElementById('profileEmail').value.trim();
            const phone = document.getElementById('profilePhone').value.trim();
            const farmName = document.getElementById('profileFarmName').value.trim();
            const location = document.getElementById('profileLocation').value.trim();
            const bio = document.getElementById('profileBio').value.trim();

            if (!firstName || !lastName || !email) {
                showErrorDialog('Validation Error', 'Please fill in all required fields (First Name, Last Name, Email).');
                return;
            }

            // Update user data
            const updatedUser = {
                firstName: firstName,
                lastName: lastName,
                email: email,
                phone: phone,
                farmName: farmName,
                location: location,
                bio: bio,
                updatedAt: new Date().toISOString()
            };

            localStorage.setItem('smartfarm_user', JSON.stringify(updatedUser));

            // Close modal
            const modal = document.querySelector('.modal');
            if (modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                    bsModal.hide();
                }
            }

            showSuccessDialog(
                '‚úÖ Profile Updated Successfully',
                `Your profile has been updated successfully.\n\nName: ${firstName} ${lastName}\nEmail: ${email}\nFarm: ${farmName || 'Not specified'}`
            );
        }

        function showSettings() {
            showSettingsModal();
        }

        function showSettingsModal() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-cog me-2"></i>Settings
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary mb-3">General Settings</h6>
                                    <div class="mb-3">
                                        <label for="currencySelect" class="form-label">Currency</label>
                                        <select class="form-select" id="currencySelect">
                                            <option value="USD">USD - US Dollar</option>
                                            <option value="EUR">EUR - Euro</option>
                                            <option value="GBP">GBP - British Pound</option>
                                            <option value="JPY">JPY - Japanese Yen</option>
                                            <option value="CAD">CAD - Canadian Dollar</option>
                                            <option value="AUD">AUD - Australian Dollar</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="languageSelect" class="form-label">Language</label>
                                        <select class="form-select" id="languageSelect">
                                            <option value="en">English</option>
                                            <option value="es">Spanish</option>
                                            <option value="fr">French</option>
                                            <option value="de">German</option>
                                            <option value="it">Italian</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="timezoneSelect" class="form-label">Timezone</label>
                                        <select class="form-select" id="timezoneSelect">
                                            <option value="UTC">UTC</option>
                                            <option value="EST">EST - Eastern Time</option>
                                            <option value="PST">PST - Pacific Time</option>
                                            <option value="CST">CST - Central Time</option>
                                            <option value="MST">MST - Mountain Time</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-primary mb-3">Notification Settings</h6>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                                        <label class="form-check-label" for="emailNotifications">
                                            Email Notifications
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="taskReminders" checked>
                                        <label class="form-check-label" for="taskReminders">
                                            Task Reminders
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="notificationWeatherAlerts" checked>
                                        <label class="form-check-label" for="notificationWeatherAlerts">
                                            Weather Alerts
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="harvestAlerts" checked>
                                        <label class="form-check-label" for="harvestAlerts">
                                            Harvest Alerts
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h6 class="text-primary mb-3">Data Management</h6>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-primary" onclick="exportData()">
                                            <i class="fas fa-download me-2"></i>Export All Data
                                        </button>
                                        <button class="btn btn-outline-warning" onclick="importData()">
                                            <i class="fas fa-upload me-2"></i>Import Data
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="clearAllData()">
                                            <i class="fas fa-trash me-2"></i>Clear All Data
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-info" onclick="saveSettings()">
                                <i class="fas fa-save me-2"></i>Save Settings
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function saveSettings() {
            const currency = document.getElementById('currencySelect').value;
            const language = document.getElementById('languageSelect').value;
            const timezone = document.getElementById('timezoneSelect').value;
            const emailNotifications = document.getElementById('emailNotifications').checked;
            const taskReminders = document.getElementById('taskReminders').checked;
            const weatherAlerts = document.getElementById('weatherAlerts').checked;
            const harvestAlerts = document.getElementById('harvestAlerts').checked;

            const settings = {
                currency: currency,
                language: language,
                timezone: timezone,
                notifications: {
                    email: emailNotifications,
                    taskReminders: taskReminders,
                    weatherAlerts: weatherAlerts,
                    harvestAlerts: harvestAlerts
                },
                updatedAt: new Date().toISOString()
            };

            localStorage.setItem('smartfarm_settings', JSON.stringify(settings));

            // Close modal
            const modal = document.querySelector('.modal');
            if (modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                    bsModal.hide();
                }
            }

            showSuccessDialog(
                '‚úÖ Settings Saved Successfully',
                `Your settings have been saved successfully.\n\nCurrency: ${currency}\nLanguage: ${language}\nTimezone: ${timezone}\n\nAll notification preferences have been updated.`
            );
        }

        function logout() {
            console.log('=== LOGOUT DEBUG START ===');
            console.log('Before logout - localStorage user:', localStorage.getItem('smartfarm_user'));
            console.log('Before logout - localStorage token:', localStorage.getItem('smartfarm_token'));
            console.log('Before logout - sessionStorage user:', sessionStorage.getItem('smartfarm_user'));
            console.log('Before logout - sessionStorage token:', sessionStorage.getItem('smartfarm_token'));
            
            showConfirmDialog(
                'Logout',
                'Are you sure you want to logout?',
                'Yes, Logout',
                'Cancel',
                () => {
                    console.log('Logout confirmed, clearing data...');
                    
                    // Clear all authentication data from localStorage
                    localStorage.removeItem('smartfarm_user');
                    localStorage.removeItem('smartfarm_token');
                    localStorage.removeItem('smartfarm_userData');
                    localStorage.removeItem('smartfarm_loginTime');
                    localStorage.removeItem('smartfarm_remember');
                    
                    // Clear all authentication data from sessionStorage
                    sessionStorage.removeItem('smartfarm_user');
                    sessionStorage.removeItem('smartfarm_token');
                    sessionStorage.removeItem('smartfarm_userData');
                    sessionStorage.removeItem('smartfarm_loginTime');
                    
                    // Clear any other app-specific data
                    localStorage.removeItem('farmData');
                    localStorage.removeItem('crops');
                    localStorage.removeItem('livestock');
                    localStorage.removeItem('inventory');
                    localStorage.removeItem('financialData');
                    localStorage.removeItem('farmTasks');
                    
                    console.log('After logout - localStorage user:', localStorage.getItem('smartfarm_user'));
                    console.log('After logout - localStorage token:', localStorage.getItem('smartfarm_token'));
                    console.log('After logout - sessionStorage user:', sessionStorage.getItem('smartfarm_user'));
                    console.log('After logout - sessionStorage token:', sessionStorage.getItem('smartfarm_token'));
                    console.log('=== LOGOUT DEBUG END ===');
                    
                    // Show logout confirmation
                    showAlert('You have been logged out successfully.', 'success');
                    
                    // Redirect to login page
                    setTimeout(() => {
                        console.log('Redirecting to login page...');
                        window.location.href = 'login.html';
                    }, 1000);
                }
            );
        }

        // Mobile sidebar toggle
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('show');
        });

        // System status check
        function checkSystemStatus() {
            const statusIndicator = document.getElementById('systemStatus');
            const statusText = document.getElementById('statusText');
            
            if (!statusIndicator || !statusText) return;
            
            // Check API status
            fetch('https://smartfarm-app-production.up.railway.app/api/health')
                .then(response => {
                    if (response.ok) {
                        statusIndicator.className = 'status-indicator online';
                        statusText.textContent = 'Online';
                    } else {
                        throw new Error('API not responding');
                    }
                })
                .catch(error => {
                    statusIndicator.className = 'status-indicator offline';
                    statusText.textContent = 'Offline';
                });
        }

        // Quick action functions
        function addNewCrop() {
            if (typeof showCropManagement === 'function') {
                showCropManagement();
            } else {
                alert('Crop management will be available soon!');
            }
        }

        // Note: addNewLivestock() function is defined earlier in the file (around line 8150)
        // Removed duplicate function here to prevent override

        function createTask() {
            if (typeof showTasks === 'function') {
                showTasks();
            } else {
                alert('Task management will be available soon!');
            }
        }

        // Initialize system status check
        checkSystemStatus();
        // Check status every 30 seconds
        setInterval(checkSystemStatus, 30000);

        // Add debug panel for authentication issues (only in development)
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            document.addEventListener('DOMContentLoaded', function() {
                createDashboardDebugPanel();
            });
        }

        function createDashboardDebugPanel() {
            const debugPanel = document.createElement('div');
            debugPanel.id = 'dashboardDebugPanel';
            debugPanel.style.cssText = `
                position: fixed;
                bottom: 10px;
                right: 10px;
                background: #f8f9fa;
                border: 2px solid #dee2e6;
                border-radius: 8px;
                padding: 10px;
                z-index: 9999;
                max-width: 250px;
                font-size: 11px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            `;
            
            debugPanel.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Auth Debug</h6>
                    <button class="btn btn-sm btn-outline-danger" onclick="clearDashboardDebugPanel()">√ó</button>
                </div>
                <button class="btn btn-warning btn-sm w-100 mb-1" onclick="debugDashboardAuth()">Check Auth</button>
                <button class="btn btn-danger btn-sm w-100 mb-1" onclick="testLogout()">Test Logout</button>
                <div id="dashboardDebugOutput" style="background: #e9ecef; padding: 5px; border-radius: 4px; margin-top: 5px; max-height: 150px; overflow-y: auto; font-size: 10px;"></div>
            `;
            
            document.body.appendChild(debugPanel);
            debugDashboardAuth(); // Initial check
        }

        function clearDashboardDebugPanel() {
            const panel = document.getElementById('dashboardDebugPanel');
            if (panel) {
                panel.remove();
            }
        }

        function debugDashboardAuth() {
            const debugOutput = document.getElementById('dashboardDebugOutput');
            const timestamp = new Date().toLocaleTimeString();
            
            const authData = {
                localStorage: {
                    user: localStorage.getItem('smartfarm_user'),
                    token: localStorage.getItem('smartfarm_token'),
                    remember: localStorage.getItem('smartfarm_remember')
                },
                sessionStorage: {
                    user: sessionStorage.getItem('smartfarm_user'),
                    token: sessionStorage.getItem('smartfarm_token')
                }
            };
            
            let debugInfo = `<strong>Dashboard Auth (${timestamp}):</strong><br>`;
            debugInfo += `User: ${authData.localStorage.user || authData.sessionStorage.user || '‚ùå None'}<br>`;
            debugInfo += `Token: ${authData.localStorage.token || authData.sessionStorage.token ? '‚úÖ Present' : '‚ùå None'}<br>`;
            debugInfo += `Remember: ${authData.localStorage.remember || '‚ùå None'}<br>`;
            
            if (debugOutput) {
                debugOutput.innerHTML = debugInfo;
            }
            
            console.log('Dashboard Auth Debug:', authData);
        }

        function testLogout() {
            console.log('Testing logout from dashboard...');
            logout();
        }

        // Feed Mix Management System
        let feedMixDatabase = [];
        let feedMixHistory = [];
        let feedMixSettings = {
            costOptimization: true,
            nutritionalFocus: 'balanced'
        };

        // Initialize feed mix system
        function initializeFeedMixSystem() {
            loadFeedMixDatabaseFromStorage();
            loadFeedMixHistory();
            loadFeedMixSettings();
            updateFeedMixTabCount();
        }

        // Feed mix database with nutritional requirements
        function loadFeedMixDatabase() {
            feedMixDatabase = [
                // Cattle feed mixes
                {
                    id: 1,
                    livestockType: 'cattle',
                    growthStage: 'calf',
                    weightRange: '50-150kg',
                    feedComponents: {
                        'Corn': 40,
                        'Soybean Meal': 25,
                        'Alfalfa Hay': 20,
                        'Wheat Bran': 10,
                        'Mineral Mix': 3,
                        'Salt': 2
                    },
                    dailyIntake: 2.5,
                    costPerKg: 0.45,
                    protein: 16,
                    energy: 2800,
                    fiber: 12
                },
                {
                    id: 2,
                    livestockType: 'cattle',
                    growthStage: 'growing',
                    weightRange: '150-400kg',
                    feedComponents: {
                        'Corn': 35,
                        'Soybean Meal': 20,
                        'Alfalfa Hay': 25,
                        'Wheat Bran': 15,
                        'Mineral Mix': 3,
                        'Salt': 2
                    },
                    dailyIntake: 4.0,
                    costPerKg: 0.42,
                    protein: 14,
                    energy: 2600,
                    fiber: 15
                },
                {
                    id: 3,
                    livestockType: 'cattle',
                    growthStage: 'adult',
                    weightRange: '400kg+',
                    feedComponents: {
                        'Corn': 30,
                        'Soybean Meal': 15,
                        'Alfalfa Hay': 30,
                        'Wheat Bran': 20,
                        'Mineral Mix': 3,
                        'Salt': 2
                    },
                    dailyIntake: 6.0,
                    costPerKg: 0.38,
                    protein: 12,
                    energy: 2400,
                    fiber: 18
                },
                // Pig feed mixes
                {
                    id: 4,
                    livestockType: 'pigs',
                    growthStage: 'piglet',
                    weightRange: '5-25kg',
                    feedComponents: {
                        'Corn': 50,
                        'Soybean Meal': 30,
                        'Wheat': 10,
                        'Fish Meal': 5,
                        'Mineral Mix': 3,
                        'Salt': 2
                    },
                    dailyIntake: 0.8,
                    costPerKg: 0.65,
                    protein: 18,
                    energy: 3200,
                    fiber: 8
                },
                {
                    id: 5,
                    livestockType: 'pigs',
                    growthStage: 'growing',
                    weightRange: '25-60kg',
                    feedComponents: {
                        'Corn': 45,
                        'Soybean Meal': 25,
                        'Wheat': 15,
                        'Fish Meal': 3,
                        'Mineral Mix': 3,
                        'Salt': 2
                    },
                    dailyIntake: 1.5,
                    costPerKg: 0.58,
                    protein: 16,
                    energy: 3000,
                    fiber: 10
                },
                {
                    id: 6,
                    livestockType: 'pigs',
                    growthStage: 'finishing',
                    weightRange: '60-100kg',
                    feedComponents: {
                        'Corn': 40,
                        'Soybean Meal': 20,
                        'Wheat': 20,
                        'Barley': 15,
                        'Mineral Mix': 3,
                        'Salt': 2
                    },
                    dailyIntake: 2.5,
                    costPerKg: 0.52,
                    protein: 14,
                    energy: 2800,
                    fiber: 12
                },
                // Poultry feed mixes
                {
                    id: 7,
                    livestockType: 'poultry',
                    growthStage: 'chick',
                    weightRange: '0-6 weeks',
                    feedComponents: {
                        'Corn': 55,
                        'Soybean Meal': 35,
                        'Wheat': 5,
                        'Fish Meal': 3,
                        'Mineral Mix': 1.5,
                        'Salt': 0.5
                    },
                    dailyIntake: 0.1,
                    costPerKg: 0.75,
                    protein: 20,
                    energy: 3000,
                    fiber: 6
                },
                {
                    id: 8,
                    livestockType: 'poultry',
                    growthStage: 'growing',
                    weightRange: '6-18 weeks',
                    feedComponents: {
                        'Corn': 50,
                        'Soybean Meal': 30,
                        'Wheat': 10,
                        'Barley': 5,
                        'Mineral Mix': 3,
                        'Salt': 2
                    },
                    dailyIntake: 0.15,
                    costPerKg: 0.68,
                    protein: 16,
                    energy: 2800,
                    fiber: 8
                },
                {
                    id: 9,
                    livestockType: 'poultry',
                    growthStage: 'laying',
                    weightRange: '18+ weeks',
                    feedComponents: {
                        'Corn': 45,
                        'Soybean Meal': 25,
                        'Wheat': 15,
                        'Oyster Shell': 8,
                        'Mineral Mix': 5,
                        'Salt': 2
                    },
                    dailyIntake: 0.12,
                    costPerKg: 0.62,
                    protein: 15,
                    energy: 2600,
                    fiber: 10
                },
                // Sheep feed mixes
                {
                    id: 10,
                    livestockType: 'sheep',
                    growthStage: 'lamb',
                    weightRange: '10-40kg',
                    feedComponents: {
                        'Corn': 30,
                        'Soybean Meal': 20,
                        'Alfalfa Hay': 35,
                        'Wheat Bran': 10,
                        'Mineral Mix': 3,
                        'Salt': 2
                    },
                    dailyIntake: 1.0,
                    costPerKg: 0.48,
                    protein: 15,
                    energy: 2700,
                    fiber: 16
                },
                {
                    id: 11,
                    livestockType: 'sheep',
                    growthStage: 'adult',
                    weightRange: '40kg+',
                    feedComponents: {
                        'Corn': 25,
                        'Soybean Meal': 15,
                        'Alfalfa Hay': 40,
                        'Wheat Bran': 15,
                        'Mineral Mix': 3,
                        'Salt': 2
                    },
                    dailyIntake: 1.5,
                    costPerKg: 0.42,
                    protein: 13,
                    energy: 2500,
                    fiber: 18
                },
                // Goat feed mixes
                {
                    id: 12,
                    livestockType: 'goats',
                    growthStage: 'kid',
                    weightRange: '5-30kg',
                    feedComponents: {
                        'Corn': 35,
                        'Soybean Meal': 25,
                        'Alfalfa Hay': 25,
                        'Wheat Bran': 10,
                        'Mineral Mix': 3,
                        'Salt': 2
                    },
                    dailyIntake: 0.8,
                    costPerKg: 0.52,
                    protein: 16,
                    energy: 2800,
                    fiber: 14
                },
                {
                    id: 13,
                    livestockType: 'goats',
                    growthStage: 'adult',
                    weightRange: '30kg+',
                    feedComponents: {
                        'Corn': 30,
                        'Soybean Meal': 20,
                        'Alfalfa Hay': 30,
                        'Wheat Bran': 15,
                        'Mineral Mix': 3,
                        'Salt': 2
                    },
                    dailyIntake: 1.2,
                    costPerKg: 0.46,
                    protein: 14,
                    energy: 2600,
                    fiber: 16
                },
                // Horse feed mixes
                {
                    id: 14,
                    livestockType: 'horses',
                    growthStage: 'foal',
                    weightRange: '50-200kg',
                    feedComponents: {
                        'Oats': 40,
                        'Corn': 25,
                        'Alfalfa Hay': 20,
                        'Soybean Meal': 10,
                        'Mineral Mix': 3,
                        'Salt': 2
                    },
                    dailyIntake: 2.0,
                    costPerKg: 0.55,
                    protein: 15,
                    energy: 2900,
                    fiber: 14
                },
                {
                    id: 15,
                    livestockType: 'horses',
                    growthStage: 'adult',
                    weightRange: '200kg+',
                    feedComponents: {
                        'Oats': 35,
                        'Corn': 20,
                        'Alfalfa Hay': 30,
                        'Barley': 10,
                        'Mineral Mix': 3,
                        'Salt': 2
                    },
                    dailyIntake: 3.5,
                    costPerKg: 0.48,
                    protein: 13,
                    energy: 2700,
                    fiber: 16
                }
            ];
            
            saveFeedMixDatabase();
            renderFeedMixDatabase();
        }

        // Update growth stages based on livestock type
        function updateGrowthStages() {
            const livestockType = document.getElementById('feedMixLivestockType').value;
            const growthStageSelect = document.getElementById('growthStage');
            
            // Clear existing options
            growthStageSelect.innerHTML = '<option value="">Select Stage</option>';
            
            const stages = {
                'cattle': ['calf', 'growing', 'adult'],
                'pigs': ['piglet', 'growing', 'finishing'],
                'poultry': ['chick', 'growing', 'laying'],
                'sheep': ['lamb', 'adult'],
                'goats': ['kid', 'adult'],
                'horses': ['foal', 'adult']
            };
            
            if (stages[livestockType]) {
                stages[livestockType].forEach(stage => {
                    const option = document.createElement('option');
                    option.value = stage;
                    option.textContent = stage.charAt(0).toUpperCase() + stage.slice(1);
                    growthStageSelect.appendChild(option);
                });
            }
        }

        // Calculate feed mix based on inputs
        function calculateFeedMix() {
            console.log('üåæ calculateFeedMix called');
            
            const livestockType = document.getElementById('feedMixLivestockType').value;
            const growthStage = document.getElementById('growthStage').value;
            const animalWeight = parseFloat(document.getElementById('animalWeight').value);
            const animalCount = parseInt(document.getElementById('animalCount').value);
            const feedingDays = parseInt(document.getElementById('feedingDays').value);
            
            console.log('Form values:', { livestockType, growthStage, animalWeight, animalCount, feedingDays });
            
            if (!livestockType || !growthStage || !animalWeight || !animalCount || !feedingDays) {
                showInfoDialog('Validation Error', 'Please fill in all fields', 'OK');
                return;
            }
            
            try {
                // Use the FeedMixCalculator class
                if (typeof window.FeedMixCalculator === 'undefined') {
                    console.error('FeedMixCalculator not loaded');
                    showInfoDialog('Error', 'Feed mix calculator not available. Please refresh the page.', 'OK');
                    return;
                }
                
                console.log('Using FeedMixCalculator for calculation');
                
                // Prepare animal data for the calculator
                const animalData = {
                    species: livestockType,
                    weight: animalWeight,
                    age: 0, // Not used in current calculation
                    lifecycle: growthStage,
                    purpose: 'General', // Default purpose
                    productionStage: growthStage
                };
                
                console.log('Animal data for calculator:', animalData);
                
                // Calculate feed mix using the calculator
                const result = window.FeedMixCalculator.calculateFeedMix(animalData);
                
                console.log('Feed mix calculation result:', result);
                
                if (!result || !result.feedMix) {
                    console.error('Invalid result from FeedMixCalculator');
                    showInfoDialog('Calculation Error', 'Failed to calculate feed mix. Please try again.', 'OK');
                    return;
                }
                
                // Convert calculator result to our display format
                const feedMix = {
                    livestockType: livestockType,
                    growthStage: growthStage,
                    feedComponents: result.feedMix,
                    protein: result.requirements.protein.min, // Use min protein requirement
                    energy: result.requirements.energy.min * 1000, // Convert Mcal to kcal
                    fiber: result.requirements.fiber.min,
                    dailyIntake: result.dailyIntake.recommended,
                    costPerKg: result.totalCost.costPerKg
                };
                
                console.log('Converted feed mix:', feedMix);
                
                // Calculate requirements for display
                const dailyIntakePerAnimal = result.dailyIntake.recommended;
                const totalDailyIntake = dailyIntakePerAnimal * animalCount;
                const totalFeedNeeded = totalDailyIntake * feedingDays;
                const totalCost = totalFeedNeeded * result.totalCost.costPerKg;
                
                console.log('Calculations:', {
                    dailyIntakePerAnimal,
                    totalDailyIntake,
                    totalFeedNeeded,
                    totalCost
                });
                
                // Display results
                displayFeedMixResults(feedMix, {
                    animalWeight,
                    animalCount,
                    feedingDays,
                    dailyIntakePerAnimal,
                    totalDailyIntake,
                    totalFeedNeeded,
                    totalCost
                });
                
                // Save to history
                saveFeedMixToHistory(feedMix, {
                    animalWeight,
                    animalCount,
                    feedingDays,
                    totalCost
                });
                
                console.log('‚úÖ Feed mix calculation completed successfully');
                
            } catch (error) {
                console.error('Error calculating feed mix:', error);
                showInfoDialog('Calculation Error', `Error calculating feed mix: ${error.message}`, 'OK');
            }
        }

        // Display feed mix results
        function displayFeedMixResults(feedMix, calculations) {
            const resultsDiv = document.getElementById('feedMixResults');
            const contentDiv = document.getElementById('feedMixContent');
            
            let componentsHtml = '';
            Object.entries(feedMix.feedComponents).forEach(([component, percentage]) => {
                const amount = (calculations.totalFeedNeeded * percentage / 100).toFixed(2);
                componentsHtml += `
                    <div class="row mb-2">
                        <div class="col-6">${component}</div>
                        <div class="col-3">${percentage}%</div>
                        <div class="col-3">${amount} kg</div>
                    </div>
                `;
            });
            
            contentDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <h6>Feed Components</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Component</th>
                                        <th>Percentage</th>
                                        <th>Total Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(feedMix.feedComponents).map(([component, percentage]) => `
                                        <tr>
                                            <td>${component}</td>
                                            <td>${percentage}%</td>
                                            <td>${(calculations.totalFeedNeeded * percentage / 100).toFixed(2)} kg</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>Nutritional Information</h6>
                        <div class="mb-2">
                            <strong>Protein:</strong> ${feedMix.protein}%
                        </div>
                        <div class="mb-2">
                            <strong>Energy:</strong> ${feedMix.energy} kcal/kg
                        </div>
                        <div class="mb-2">
                            <strong>Fiber:</strong> ${feedMix.fiber}%
                        </div>
                        <hr>
                        <h6>Calculations</h6>
                        <div class="mb-2">
                            <strong>Daily Intake per Animal:</strong> ${calculations.dailyIntakePerAnimal.toFixed(2)} kg
                        </div>
                        <div class="mb-2">
                            <strong>Total Daily Intake:</strong> ${calculations.totalDailyIntake.toFixed(2)} kg
                        </div>
                        <div class="mb-2">
                            <strong>Total Feed Needed:</strong> ${calculations.totalFeedNeeded.toFixed(2)} kg
                        </div>
                        <div class="mb-2">
                            <strong>Total Cost:</strong> $${calculations.totalCost.toFixed(2)}
                        </div>
                        <div class="mb-2">
                            <strong>Cost per Animal per Day:</strong> $${(calculations.totalCost / calculations.animalCount / calculations.feedingDays).toFixed(2)}
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary me-2" onclick="saveFeedMixPlan()">
                        <i class="fas fa-save me-1"></i>Save Plan
                    </button>
                    <button class="btn btn-outline-primary" onclick="printFeedMixPlan()">
                        <i class="fas fa-print me-1"></i>Print Plan
                    </button>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
        }

        // Save feed mix to history
        function saveFeedMixToHistory(feedMix, calculations) {
            const historyItem = {
                id: Date.now(),
                date: new Date().toISOString(),
                livestockType: feedMix.livestockType,
                growthStage: feedMix.growthStage,
                animalWeight: calculations.animalWeight,
                animalCount: calculations.animalCount,
                feedingDays: calculations.feedingDays,
                totalCost: calculations.totalCost,
                feedMixId: feedMix.id
            };
            
            feedMixHistory.unshift(historyItem);
            if (feedMixHistory.length > 10) {
                feedMixHistory = feedMixHistory.slice(0, 10);
            }
            
            saveFeedMixHistory();
            renderFeedMixHistory();
        }

        // Render feed mix history
        function renderFeedMixHistory() {
            const historyDiv = document.getElementById('feedMixHistory');
            
            if (feedMixHistory.length === 0) {
                historyDiv.innerHTML = '<p class="text-muted">No recent feed mixes</p>';
                return;
            }
            
            historyDiv.innerHTML = feedMixHistory.map(item => `
                <div class="activity-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${item.livestockType.charAt(0).toUpperCase() + item.livestockType.slice(1)} - ${item.growthStage}</strong>
                            <br>
                            <small class="text-muted">${item.animalCount} animals, ${item.animalWeight}kg each</small>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">$${item.totalCost.toFixed(2)}</div>
                            <small class="text-muted">${new Date(item.date).toLocaleDateString()}</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Render feed mix database table
        function renderFeedMixDatabase() {
            const tbody = document.getElementById('feedMixDatabaseTable');
            
            tbody.innerHTML = feedMixDatabase.map(mix => `
                <tr>
                    <td>${mix.livestockType.charAt(0).toUpperCase() + mix.livestockType.slice(1)}</td>
                    <td>${mix.growthStage.charAt(0).toUpperCase() + mix.growthStage.slice(1)}</td>
                    <td>${mix.weightRange}</td>
                    <td>
                        <div class="small">
                            ${Object.entries(mix.feedComponents).map(([component, percentage]) => 
                                `${component}: ${percentage}%`
                            ).join(', ')}
                        </div>
                    </td>
                    <td>${mix.dailyIntake} kg</td>
                    <td>$${mix.costPerKg.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editFeedMix(${mix.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteFeedMix(${mix.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Update feed mix tab count
        function updateFeedMixTabCount() {
            const count = feedMixDatabase.length;
            document.getElementById('feed-mix-count').textContent = count;
        }

        // Save feed mix database to localStorage
        function saveFeedMixDatabase() {
            localStorage.setItem('feedMixDatabase', JSON.stringify(feedMixDatabase));
        }

        // Load feed mix database from localStorage
        function loadFeedMixDatabaseFromStorage() {
            const saved = localStorage.getItem('feedMixDatabase');
            if (saved) {
                try {
                    feedMixDatabase = JSON.parse(saved);
                    console.log('Loaded feed mix database from localStorage:', feedMixDatabase.length, 'items');
                } catch (e) {
                    console.error('Error loading feed mix database:', e);
                    loadFeedMixDatabase(); // Load default database
                }
            } else {
                console.log('No saved feed mix database found, loading default...');
                loadFeedMixDatabase(); // Load default database
            }
        }

        // Save feed mix history to localStorage
        function saveFeedMixHistory() {
            localStorage.setItem('feedMixHistory', JSON.stringify(feedMixHistory));
        }

        // Load feed mix history from localStorage
        function loadFeedMixHistory() {
            const saved = localStorage.getItem('feedMixHistory');
            if (saved) {
                try {
                    feedMixHistory = JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading feed mix history:', e);
                    feedMixHistory = [];
                }
            }
        }

        // Save feed mix settings
        function saveFeedMixSettings() {
            feedMixSettings.costOptimization = document.getElementById('costOptimization').checked;
            feedMixSettings.nutritionalFocus = document.getElementById('nutritionalFocus').value;
            localStorage.setItem('feedMixSettings', JSON.stringify(feedMixSettings));
            showNotification('Settings saved successfully!', 'success');
        }

        // Load feed mix settings
        function loadFeedMixSettings() {
            const saved = localStorage.getItem('feedMixSettings');
            if (saved) {
                try {
                    feedMixSettings = JSON.parse(saved);
                    document.getElementById('costOptimization').checked = feedMixSettings.costOptimization;
                    document.getElementById('nutritionalFocus').value = feedMixSettings.nutritionalFocus;
                } catch (e) {
                    console.error('Error loading feed mix settings:', e);
                }
            }
        }

        // Add custom feed mix
        function addCustomFeedMix() {
            // This would open a modal for adding custom feed mixes
            showInfoDialog('Coming Soon', 'Custom feed mix feature coming soon!', 'OK');
        }

        // Edit feed mix
        function editFeedMix(id) {
            showInfoDialog('Coming Soon', 'Edit feed mix feature coming soon!', 'OK');
        }

        // Delete feed mix
        function deleteFeedMix(id) {
            showConfirmDialog(
                'Delete Feed Mix',
                'Are you sure you want to delete this feed mix?',
                'Yes, Delete',
                'Cancel',
                () => {
                    feedMixDatabase = feedMixDatabase.filter(mix => mix.id !== id);
                    saveFeedMixDatabase();
                    renderFeedMixDatabase();
                    updateFeedMixTabCount();
                }
            );
        }

        // Save feed mix plan
        async function saveFeedMixPlan() {
            console.log('üåæ saveFeedMixPlan called');
            
            // Get current form values
            const livestockType = document.getElementById('feedMixLivestockType').value;
            const growthStage = document.getElementById('growthStage').value;
            const animalWeight = parseFloat(document.getElementById('animalWeight').value);
            const animalCount = parseInt(document.getElementById('animalCount').value);
            const feedingDays = parseInt(document.getElementById('feedingDays').value);
            
            // Validation
            if (!livestockType || !growthStage || !animalWeight || !animalCount || !feedingDays) {
                showInfoDialog('Validation Error', 'Please complete the feed mix calculation before saving', 'OK');
                return;
            }
            
            // Find matching feed mix from database
            const feedMix = feedMixDatabase.find(mix => 
                mix.livestockType === livestockType && 
                mix.growthStage === growthStage
            );
            
            if (!feedMix) {
                showInfoDialog('Error', 'Feed mix data not found. Please recalculate.', 'OK');
                return;
            }
            
            // Calculate values
            const dailyIntakePerAnimal = feedMix.dailyIntake * (animalWeight / 100);
            const totalDailyIntake = dailyIntakePerAnimal * animalCount;
            const totalFeedNeeded = totalDailyIntake * feedingDays;
            const totalCost = totalFeedNeeded * feedMix.costPerKg;
            
            // Prepare data to save
            const feedMixPlanData = {
                livestockType: livestockType,
                growthStage: growthStage,
                animalWeight: animalWeight,
                animalCount: animalCount,
                feedingDays: feedingDays,
                feedComponents: feedMix.feedComponents,
                protein: feedMix.protein,
                energy: feedMix.energy,
                fiber: feedMix.fiber,
                dailyIntake: feedMix.dailyIntake,
                costPerKg: feedMix.costPerKg,
                calculations: {
                    dailyIntakePerAnimal: dailyIntakePerAnimal,
                    totalDailyIntake: totalDailyIntake,
                    totalFeedNeeded: totalFeedNeeded,
                    totalCost: totalCost
                },
                createdDate: new Date().toISOString()
            };
            
            console.log('Feed mix plan data:', feedMixPlanData);
            
            try {
                // Check if API is available
                if (typeof window.SmartFarmAPI !== 'undefined') {
                    console.log('üåê Using API to save feed mix plan');
                    
                    const response = await window.SmartFarmAPI.createFeedMix(feedMixPlanData);
                    
                    if (response.success) {
                        console.log('‚úÖ Feed mix plan saved to API successfully');
                        showNotification('Feed mix plan saved successfully!', 'success');
                        
                        // Save to history as well
                        saveFeedMixToHistory(feedMix, {
                            animalWeight,
                            animalCount,
                            feedingDays,
                            totalCost
                        });
                    } else {
                        console.error('‚ùå Failed to save feed mix plan:', response.error);
                        showErrorMessage(response.error || 'Failed to save feed mix plan');
                        
                        // Fallback to localStorage
                        saveFeedMixToHistory(feedMix, {
                            animalWeight,
                            animalCount,
                            feedingDays,
                            totalCost
                        });
                        showNotification('Feed mix plan saved locally (server unavailable)', 'warning');
                    }
                } else {
                    console.log('üíæ Using localStorage fallback to save feed mix plan');
                    
                    // Fallback to localStorage only
                    saveFeedMixToHistory(feedMix, {
                        animalWeight,
                        animalCount,
                        feedingDays,
                        totalCost
                    });
                    showNotification('Feed mix plan saved locally!', 'success');
                }
            } catch (error) {
                console.error('Error saving feed mix plan:', error);
                showErrorMessage('An error occurred while saving feed mix plan: ' + error.message);
                
                // Fallback to localStorage
                saveFeedMixToHistory(feedMix, {
                    animalWeight,
                    animalCount,
                    feedingDays,
                    totalCost
                });
            }
        }

        // Print feed mix plan
        function printFeedMixPlan() {
            window.print();
        }

        // Initialize feed mix system when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeFeedMixSystem();
        });

        // Global Crop Database Functions
        function showGlobalCropDatabase() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-primary text-white border-0">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="fas fa-globe fa-2x"></i>
                                </div>
                                <div>
                                    <h4 class="modal-title mb-0 fw-bold">Global Crop Database</h4>
                                    <small class="opacity-75">Comprehensive agricultural species from around the world</small>
                                </div>
                            </div>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" class="form-control" id="cropSearchFilterModal" placeholder="Search crops..." onkeyup="filterCrops()" aria-label="Search crops in modal">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <select class="form-select" id="categoryFilter" onchange="filterCrops()">
                                        <option value="">All Categories</option>
                                        ${Object.keys(globalCropDatabase).map(key => 
                                            `<option value="${key}">${globalCropDatabase[key].icon} ${globalCropDatabase[key].name}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div id="cropCategories">
                                ${Object.keys(globalCropDatabase).map(categoryKey => {
                                    const category = globalCropDatabase[categoryKey];
                                    return `
                                        <div class="crop-category mb-4" data-category="${categoryKey}">
                                            <div class="category-header mb-3">
                                                <h5 class="text-primary">
                                                    ${category.icon} ${category.name}
                                                </h5>
                                                <p class="text-muted mb-0">${category.description}</p>
                                            </div>
                                            <div class="row">
                                                ${category.crops.map(crop => `
                                                    <div class="col-md-4 col-lg-3 mb-3">
                                                        <div class="crop-card" data-crop="${crop.name.toLowerCase()}" data-category="${categoryKey}">
                                                            <div class="card h-100 border-0 shadow-sm">
                                                                <div class="card-body p-3">
                                                                    <h6 class="card-title mb-1">${crop.name}</h6>
                                                                    <small class="text-muted">${crop.scientific}</small>
                                                                    <div class="mt-2">
                                                                        <button class="btn btn-sm btn-outline-primary" onclick="addCropFromDatabase('${crop.name}', '${crop.scientific}', '${categoryKey}')">
                                                                            <i class="fas fa-plus me-1"></i>Add to Farm
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        <div class="modal-footer bg-light border-0">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>Close
                            </button>
                            <button type="button" class="btn btn-primary" onclick="exportCropDatabase()">
                                <i class="fas fa-download me-1"></i>Export Database
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add custom styles
            const style = document.createElement('style');
            style.textContent = `
                .crop-card {
                    transition: transform 0.2s ease, box-shadow 0.2s ease;
                }
                .crop-card:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
                }
                .category-header {
                    border-bottom: 2px solid #e9ecef;
                    padding-bottom: 0.5rem;
                }
                .crop-category.hidden {
                    display: none;
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
                document.head.removeChild(style);
            });
        }

        function filterCrops() {
            const searchTerm = document.getElementById('cropSearchFilter').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const categories = document.querySelectorAll('.crop-category');
            
            categories.forEach(category => {
                const categoryKey = category.getAttribute('data-category');
                const shouldShowCategory = !categoryFilter || categoryKey === categoryFilter;
                
                if (!shouldShowCategory) {
                    category.classList.add('hidden');
                    return;
                }
                
                const cropCards = category.querySelectorAll('.crop-card');
                let hasVisibleCrops = false;
                
                cropCards.forEach(card => {
                    const cropName = card.getAttribute('data-crop');
                    const shouldShowCrop = !searchTerm || cropName.includes(searchTerm);
                    
                    if (shouldShowCrop) {
                        card.parentElement.style.display = 'block';
                        hasVisibleCrops = true;
                    } else {
                        card.parentElement.style.display = 'none';
                    }
                });
                
                if (hasVisibleCrops) {
                    category.classList.remove('hidden');
                } else {
                    category.classList.add('hidden');
                }
            });
        }

        function addCropFromDatabase(cropName, scientificName, category) {
            console.log('Adding crop from database:', { cropName, scientificName, category });
            console.log('Global crop database available:', !!globalCropDatabase);
            console.log('Crops array available:', !!crops);
            console.log('saveCropsData function available:', typeof saveCropsData);
            console.log('renderCropsTable function available:', typeof renderCropsTable);
            console.log('updateAnalyticsCharts function available:', typeof updateAnalyticsCharts);
            
            // Close the modal first
            const modal = document.querySelector('.modal');
            if (modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                    bsModal.hide();
                }
            }
            
            // Add crop directly to the farm
            addNewCropWithData(cropName, scientificName, category);
        }

        async function addNewCropWithData(cropName, scientificName, category) {
            console.log('Adding new crop with data:', { cropName, scientificName, category });
            
            try {
                // Get the first farm ID (in a real app, user would select farm)
                const farmsResponse = await window.SmartFarmAPI.getFarms();
                if (!farmsResponse.success || !farmsResponse.data.length) {
                    showNotification('Please create a farm first before adding crops', 'warning');
                    return;
                }

                const farmId = farmsResponse.data[0].id;
                const today = new Date().toISOString().split('T')[0];
                const harvestDate = new Date();
                harvestDate.setMonth(harvestDate.getMonth() + 3); // Default 3 months harvest
                const expectedHarvest = harvestDate.toISOString().split('T')[0];

                const cropData = {
                    name: cropName,
                    type: category,
                    farmId: farmId,
                    plantedDate: today,
                    expectedHarvestDate: expectedHarvest,
                    area: 1,
                    description: `Added from global database - ${globalCropDatabase[category] ? globalCropDatabase[category].name : category}`
                };

                const response = await window.SmartFarmAPI.createCrop(cropData);

                if (response.success) {
                    // Show success notification
                    showNotification(`Successfully added ${cropName} to your farm!`, 'success');
                    
                    // Refresh crop data
                    await loadCropsData();
                } else {
                    showNotification(`Error adding ${cropName}: ${response.error}`, 'danger');
                }
            } catch (error) {
                console.error('Error adding crop:', error);
                showNotification(`Error adding ${cropName}: ${error.message}`, 'danger');
            }
        }

        // Load crops data from API
        async function loadCropsData() {
            try {
                // Check if API is available
                if (typeof window.SmartFarmAPI === 'undefined') {
                    console.warn('‚ö†Ô∏è SmartFarmAPI not available, using localStorage fallback');
                    loadCropsDataFromStorage();
                    return;
                }

                const response = await window.SmartFarmAPI.getCrops();
                if (response.success) {
                    // Update crops array for backward compatibility
                    crops = response.data.map(crop => ({
                        id: crop.id,
                        name: crop.name,
                        type: crop.type,
                        plantedDate: crop.plantedDate,
                        harvestDate: crop.expectedHarvestDate,
                        area: crop.area,
                        status: crop.status,
                        createdAt: crop.createdAt
                    }));
                    
                    // Update UI
                    renderCropsTable();
                    updateAnalyticsCharts();
                } else {
                    console.error('Failed to load crops data from API:', response.error);
                    // Fallback to localStorage
                    loadCropsDataFromStorage();
                }
            } catch (error) {
                console.error('Error loading crops data from API:', error);
                // Fallback to localStorage
                loadCropsDataFromStorage();
            }
        }

        function loadCropsDataFromStorage() {
            const savedCrops = localStorage.getItem('cropsData');
            if (savedCrops) {
                try {
                    crops = JSON.parse(savedCrops);
                    console.log('‚úÖ Crops data loaded from localStorage:', crops.length, 'crops');
                    renderCropsTable();
                    updateAnalyticsCharts();
                } catch (e) {
                    console.error('Error loading crops data from localStorage:', e);
                    crops = [];
                }
            }
        }

        // Load livestock data from API
        async function loadLivestockData() {
            console.log('üêÑ Loading livestock data...');
            try {
                // Check if API is available
                if (typeof window.SmartFarmAPI === 'undefined') {
                    console.warn('‚ö†Ô∏è SmartFarmAPI not available, using localStorage fallback');
                    
                    // Load from localStorage
                    const savedLivestock = localStorage.getItem('livestockData');
                    if (savedLivestock) {
                        try {
                            livestock = JSON.parse(savedLivestock);
                            console.log('‚úÖ Livestock data loaded from localStorage:', livestock.length, 'animals');
                        } catch (e) {
                            console.error('Error loading livestock data from localStorage:', e);
                            livestock = [];
                        }
                    } else {
                        // Initialize with sample data
                        livestock = [
                            {
                                id: 1,
                                name: 'Angus Bull #001',
                                type: 'Cattle',
                                breed: 'Angus Cattle',
                                quantity: 1,
                                location: 'Pasture A',
                                healthStatus: 'Healthy',
                                birthDate: '2020-03-15',
                                weight: '650 kg',
                                value: 2500,
                                earTags: ['AB001'],
                                gpsLat: -18.1416,
                                gpsLng: 178.4419,
                                healthNotes: 'Excellent breeding bull',
                                lastUpdated: new Date().toISOString()
                            },
                            {
                                id: 2,
                                name: 'Holstein Cow #002',
                                type: 'Cattle',
                                breed: 'Holstein Dairy',
                                quantity: 1,
                                location: 'Barn B',
                                healthStatus: 'Pregnant',
                                birthDate: '2019-07-20',
                                weight: '550 kg',
                                value: 1800,
                                earTags: ['HC002'],
                                gpsLat: -18.1416,
                                gpsLng: 178.4419,
                                healthNotes: 'Due to calve in 3 months',
                                lastUpdated: new Date().toISOString()
                            }
                        ];
                        saveLivestockData();
                        console.log('‚úÖ Initialized with sample livestock data');
                    }
                    
                    renderLivestockGrid();
                    renderLivestockTable();
                    updateLivestockStatistics();
                    return;
                }

                const response = await window.SmartFarmAPI.getLivestock();
                if (!response || response.success === false || !response.data) {
                    console.warn('Livestock data unavailable; skipping render');
                    safeText('#livestock-count', '0');
                    return;
                }
                
                console.log('‚úÖ Livestock data loaded successfully:', response.data.length, 'items');
                
                // Update livestock array for backward compatibility
                livestock = response.data.map(item => ({
                    id: item.id,
                    name: item.name,
                    type: item.type,
                    breed: item.breed,
                    quantity: 1,
                    location: 'Barn A',
                    healthStatus: item.status || 'Unknown',
                    birthDate: item.createdAt,
                    weight: 'Unknown',
                    value: 0,
                    earTags: [`ET${item.id.slice(-6)}`],
                    gpsLat: -18.1416,
                    gpsLng: 178.4419,
                    weightRecords: [],
                    immunizations: [],
                    healthNotes: item.description || 'No notes',
                    createdAt: item.createdAt
                }));
                
                // Update UI safely
                renderLivestockGrid();
                renderLivestockTable();
                updateLivestockStatistics();
                updateAnalyticsCharts();
            } catch (error) {
                console.error('‚ùå Error loading livestock data:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                
                // Fallback: initialize with empty array
                livestock = [];
                renderLivestockGrid();
                renderLivestockTable();
                updateLivestockStatistics();
                
                // Show user-friendly message
                if (error.message.includes('Failed to fetch')) {
                    console.warn('üåê Network error - backend may be unavailable');
                }
            }
        }

        function updateLivestockStatistics() {
            try {
                if (!Array.isArray(livestock)) {
                    livestock = [];
                }
                
                safeText('#livestock-count', livestock.length.toString());
                safeText('#healthyAnimals', livestock.filter(l => l.healthStatus === 'Healthy').length.toString());
                safeText('#totalValue', livestock.reduce((sum, l) => sum + (l.value || 0), 0).toString());
                
                console.log('‚úÖ Livestock statistics updated');
            } catch (error) {
                console.error('Error updating livestock statistics:', error);
                safeText('#livestock-count', '0');
                safeText('#healthyAnimals', '0');
                safeText('#totalValue', '0');
            }
        }

        function exportCropDatabase() {
            const dataStr = JSON.stringify(globalCropDatabase, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'global-crop-database.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // Professional Dialog System
        function showAlert(message, type = 'info', duration = 3000) {
            // Remove any existing alerts
            const existingAlerts = document.querySelectorAll('.custom-alert');
            existingAlerts.forEach(alert => alert.remove());
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `custom-alert alert alert-${type} alert-dismissible fade show`;
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                border: none;
                border-radius: 8px;
            `;
            
            alertDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${getAlertIcon(type)} me-2"></i>
                    <span>${message}</span>
                    <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto remove after duration
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, duration);
        }

        function getAlertIcon(type) {
            const icons = {
                'success': 'check-circle',
                'danger': 'exclamation-triangle',
                'warning': 'exclamation-circle',
                'info': 'info-circle',
                'primary': 'info-circle'
            };
            return icons[type] || 'info-circle';
        }

        function showErrorMessage(message, duration = 5000) {
            showAlert(message, 'danger', duration);
        }

        function showSuccessMessage(message, duration = 3000) {
            showAlert(message, 'success', duration);
        }

        /**
         * Show error dialog modal
         * @param {string} title - Dialog title
         * @param {string} message - Error message
         * @param {Function} callback - Optional callback after dialog closes
         */
        function showErrorDialog(title, message, callback = null) {
            // Fallback to alert if Bootstrap is not available
            if (typeof bootstrap === 'undefined') {
                alert(`${title}\n\n${message}`);
                if (callback && typeof callback === 'function') {
                    callback();
                }
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.setAttribute('tabindex', '-1');
            modal.setAttribute('aria-labelledby', 'errorDialogLabel');
            modal.setAttribute('aria-hidden', 'true');
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title" id="errorDialogLabel">
                                <i class="fas fa-exclamation-triangle me-2"></i>${title}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p class="mb-0">${message}</p>
                        </div>
                        <div class="modal-footer border-top">
                            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
                                <i class="fas fa-times me-2"></i>Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper if available
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            
            // Handle callback when modal is hidden
            if (callback && typeof callback === 'function') {
                modal.addEventListener('hidden.bs.modal', () => {
                    callback();
                });
            }
            
            // Clean up modal when hidden
            modal.addEventListener('hidden.bs.modal', () => {
                if (modal.parentNode) {
                    document.body.removeChild(modal);
                }
            });
            
            bsModal.show();
        }

        function showConfirmDialog(title, message, confirmText = 'Yes', cancelText = 'No', confirmCallback, cancelCallback = null) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-warning text-dark">
                            <h5 class="modal-title">
                                <i class="fas fa-exclamation-triangle me-2"></i>${title}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p class="mb-0">${message}</p>
                        </div>
                        <div class="modal-footer border-top">
                            <button type="button" class="btn btn-secondary" id="cancelConfirmBtn">
                                <i class="fas fa-times me-2"></i>${cancelText}
                            </button>
                            <button type="button" class="btn btn-warning" id="confirmConfirmBtn">
                                <i class="fas fa-check me-2"></i>${confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Get button references from the modal element - wait for modal to be shown
            setTimeout(() => {
                const confirmBtn = modal.querySelector('#confirmConfirmBtn');
                const cancelBtn = modal.querySelector('#cancelConfirmBtn');
                
                if (!confirmBtn || !cancelBtn) {
                    console.error('Confirm dialog buttons not found');
                    return;
                }
                
                // Handle confirm button click (Yes)
                confirmBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Close modal first
                    bsModal.hide();
                    
                    // Execute callback after modal starts hiding
                    if (confirmCallback && typeof confirmCallback === 'function') {
                        setTimeout(() => {
                            try {
                                confirmCallback();
                            } catch (error) {
                                console.error('Error in confirm callback:', error);
                                showSuccessMessage('An error occurred. Please try again.', 'error');
                            }
                        }, 200);
                    }
                });
                
                // Handle cancel button click (No)
                cancelBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    bsModal.hide();
                    if (cancelCallback && typeof cancelCallback === 'function') {
                        setTimeout(() => {
                            cancelCallback();
                        }, 100);
                    }
                });
            }, 100);
            
            // Clean up modal when hidden
            modal.addEventListener('hidden.bs.modal', () => {
                if (modal.parentNode) {
                    document.body.removeChild(modal);
                }
            });
            
            // Show the modal
            bsModal.show();
        }

        function showPromptDialog(title, message, inputType = 'text', placeholder = '', confirmText = 'OK', cancelText = 'Cancel', confirmCallback, cancelCallback = null) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-edit me-2"></i>${title}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p class="mb-3">${message}</p>
                            <div class="mb-3">
                                <input type="${inputType}" class="form-control" id="promptInput" placeholder="${placeholder}" autofocus>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${cancelText}</button>
                            <button type="button" class="btn btn-primary" id="promptConfirmBtn">${confirmText}</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Focus on input
            setTimeout(() => {
                document.getElementById('promptInput').focus();
            }, 500);
            
            // Handle confirm button click
            document.getElementById('promptConfirmBtn').addEventListener('click', () => {
                const value = document.getElementById('promptInput').value;
                bsModal.hide();
                if (confirmCallback) confirmCallback(value);
            });
            
            // Handle Enter key
            document.getElementById('promptInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const value = document.getElementById('promptInput').value;
                    bsModal.hide();
                    if (confirmCallback) confirmCallback(value);
                }
            });
            
            // Handle cancel
            if (cancelCallback) {
                modal.addEventListener('hidden.bs.modal', () => {
                    cancelCallback();
                });
            }
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function showInfoDialog(title, message, buttonText = 'OK', callback = null) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-info-circle me-2"></i>${title}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p class="mb-0">${message}</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-info" data-bs-dismiss="modal">${buttonText}</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
                if (callback) callback();
            });
        }

        // Global Livestock Database Functions
        function showGlobalLivestockDatabase() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-success text-white border-0">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="fas fa-paw fa-2x"></i>
                                </div>
                                <div>
                                    <h4 class="modal-title mb-0 fw-bold">Global Livestock Database</h4>
                                    <small class="opacity-75">Comprehensive livestock and aquaculture species worldwide</small>
                                </div>
                            </div>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" class="form-control" id="livestockSearchFilterModal" placeholder="Search livestock..." onkeyup="filterLivestock()" aria-label="Search livestock in modal">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <select class="form-select" id="livestockCategoryFilter" onchange="filterLivestock()">
                                        <option value="">All Categories</option>
                                        ${Object.keys(globalLivestockDatabase).map(key => 
                                            `<option value="${key}">${globalLivestockDatabase[key].icon} ${globalLivestockDatabase[key].name}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div id="livestockCategories">
                                ${Object.keys(globalLivestockDatabase).map(categoryKey => {
                                    const category = globalLivestockDatabase[categoryKey];
                                    return `
                                        <div class="livestock-category mb-4" data-category="${categoryKey}">
                                            <div class="category-header mb-3">
                                                <h5 class="text-success">
                                                    ${category.icon} ${category.name}
                                                </h5>
                                            </div>
                                            <div class="row">
                                                ${category.breeds ? category.breeds.map(breed => `
                                                    <div class="col-md-4 col-lg-3 mb-3">
                                                        <div class="livestock-card" data-livestock="${breed.toLowerCase()}" data-category="${categoryKey}">
                                                            <div class="card h-100 border-0 shadow-sm">
                                                                <div class="card-body p-3">
                                                                    <h6 class="card-title mb-1">${breed}</h6>
                                                                    <small class="text-muted">${category.name}</small>
                                                                    <div class="mt-2">
                                                                        <button class="btn btn-sm btn-outline-success" onclick="addLivestockFromDatabase('${breed}', '${categoryKey}')">
                                                                            <i class="fas fa-plus me-1"></i>Add to Farm
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                `).join('') : category.species ? category.species.map(species => `
                                                    <div class="col-md-4 col-lg-3 mb-3">
                                                        <div class="livestock-card" data-livestock="${species.toLowerCase()}" data-category="${categoryKey}">
                                                            <div class="card h-100 border-0 shadow-sm">
                                                                <div class="card-body p-3">
                                                                    <h6 class="card-title mb-1">${species}</h6>
                                                                    <small class="text-muted">${category.name}</small>
                                                                    <div class="mt-2">
                                                                        <button class="btn btn-sm btn-outline-success" onclick="addLivestockFromDatabase('${species}', '${categoryKey}')">
                                                                            <i class="fas fa-plus me-1"></i>Add to Farm
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                `).join('') : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        <div class="modal-footer bg-light border-0">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>Close
                            </button>
                            <button type="button" class="btn btn-success" onclick="exportLivestockDatabase()">
                                <i class="fas fa-download me-1"></i>Export Database
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function filterLivestock() {
            const searchTerm = document.getElementById('livestockSearchFilter').value.toLowerCase();
            const categoryFilter = document.getElementById('livestockCategoryFilter').value;
            const categories = document.querySelectorAll('.livestock-category');
            
            categories.forEach(category => {
                const categoryKey = category.getAttribute('data-category');
                const shouldShowCategory = !categoryFilter || categoryKey === categoryFilter;
                
                if (!shouldShowCategory) {
                    category.classList.add('hidden');
                    return;
                }
                
                const livestockCards = category.querySelectorAll('.livestock-card');
                let hasVisibleLivestock = false;
                
                livestockCards.forEach(card => {
                    const livestockName = card.getAttribute('data-livestock');
                    const shouldShowLivestock = !searchTerm || livestockName.includes(searchTerm);
                    
                    if (shouldShowLivestock) {
                        card.parentElement.style.display = 'block';
                        hasVisibleLivestock = true;
                    } else {
                        card.parentElement.style.display = 'none';
                    }
                });
                
                if (hasVisibleLivestock) {
                    category.classList.remove('hidden');
                } else {
                    category.classList.add('hidden');
                }
            });
        }

        async function addLivestockFromDatabase(livestockName, category) {
            console.log('Adding livestock from database:', { livestockName, category });
            console.log('Global livestock database available:', !!globalLivestockDatabase);
            console.log('Livestock array available:', !!livestock);
            console.log('saveLivestockData function available:', typeof saveLivestockData);
            console.log('renderLivestockTable function available:', typeof renderLivestockTable);
            console.log('updateAnalyticsCharts function available:', typeof updateAnalyticsCharts);
            
            try {
                // Close the modal first
                const modal = document.querySelector('.modal');
                if (modal) {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    if (bsModal) {
                        bsModal.hide();
                    }
                }
                
                // Add livestock via API
                const farmsResponse = await window.SmartFarmAPI.getFarms();
                if (!farmsResponse.success || !farmsResponse.data.length) {
                    showNotification('Please create a farm first before adding livestock', 'warning');
                    return;
                }

                const farmId = farmsResponse.data[0].id;
                const today = new Date().toISOString().split('T')[0];

                const livestockData = {
                    name: livestockName,
                    type: category,
                    farmId: farmId,
                    breed: livestockName,
                    birthDate: today,
                    weight: null,
                    description: `Added from global database - ${globalLivestockDatabase[category] ? globalLivestockDatabase[category].name : category}`
                };

                const response = await window.SmartFarmAPI.createLivestock(livestockData);

                if (response.success) {
                    showNotification(`Successfully added ${livestockName} to your farm!`, 'success');
                    
                    // Refresh livestock data
                    await loadLivestockData();
                } else {
                    showNotification(`Error adding ${livestockName}: ${response.error}`, 'danger');
                }
            } catch (error) {
                console.error('Error adding livestock:', error);
                showNotification(`Error adding ${livestockName}: ${error.message}`, 'danger');
            }
        }

        function exportLivestockDatabase() {
            const dataStr = JSON.stringify(globalLivestockDatabase, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'global-livestock-database.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        // Global Pets Database Functions
        function showGlobalPetsDatabase() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-paw me-2"></i>Global Pets Database
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-search"></i>
                                        </span>
                                        <input type="text" class="form-control" id="petsSearchInput" placeholder="Search pets by name, breed, or species..." onkeyup="filterPets()" aria-label="Search pets in modal">
                                    </div>
                                </div>
                                <div class="col-md-6 text-end">
                                    <button class="btn btn-outline-success" onclick="exportPetsDatabase()">
                                        <i class="fas fa-download me-2"></i>Export Database
                                    </button>
                                </div>
                            </div>
                            
                            <div class="row" id="petsDatabaseContent">
                                ${Object.keys(globalPetsDatabase).map(category => `
                                    <div class="col-md-6 col-lg-4 mb-4 pets-category" data-category="${category}">
                                        <div class="card h-100 border-0 shadow-sm">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0">
                                                    <span class="me-2">${globalPetsDatabase[category].icon}</span>
                                                    ${globalPetsDatabase[category].name}
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    ${(globalPetsDatabase[category].breeds || globalPetsDatabase[category].species).map(pet => `
                                                        <div class="col-12 mb-2">
                                                            <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                                                                <div>
                                                                    <strong>${pet.name}</strong>
                                                                    <br>
                                                                    <small class="text-muted">${pet.size} ‚Ä¢ ${pet.temperament}</small>
                                                                    <br>
                                                                    <small class="text-info">Lifespan: ${pet.lifespan}</small>
                                                                </div>
                                                                <button class="btn btn-sm btn-outline-primary" onclick="addPetFromDatabase('${pet.name}', '${category}')">
                                                                    <i class="fas fa-plus"></i> Add to Farm
                                                                </button>
                                                            </div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up modal with accessibility helper
            if (window.ModalAccessibility) {
                window.ModalAccessibility.setupDynamicModal(modal);
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function filterPets() {
            const searchTerm = document.getElementById('petsSearchInput').value.toLowerCase();
            const categories = document.querySelectorAll('.pets-category');
            
            categories.forEach(category => {
                const categoryName = category.dataset.category;
                const categoryData = globalPetsDatabase[categoryName];
                const pets = categoryData.breeds || categoryData.species;
                
                const hasMatch = pets.some(pet => 
                    pet.name.toLowerCase().includes(searchTerm) ||
                    pet.temperament.toLowerCase().includes(searchTerm) ||
                    pet.size.toLowerCase().includes(searchTerm)
                );
                
                if (hasMatch || searchTerm === '') {
                    category.style.display = 'block';
                } else {
                    category.style.display = 'none';
                }
            });
        }

        function addPetFromDatabase(petName, category) {
            console.log('Adding pet from database:', { petName, category });
            console.log('Global pets database available:', !!globalPetsDatabase);
            console.log('Pets array available:', !!pets);
            console.log('savePetsData function available:', typeof savePetsData);
            console.log('renderPetsTable function available:', typeof renderPetsTable);
            console.log('updateAnalyticsCharts function available:', typeof updateAnalyticsCharts);
            
            try {
                // Close the modal first
                const modal = document.querySelector('.modal');
                if (modal) {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    if (bsModal) {
                        bsModal.hide();
                    }
                }
                
                // Add pet directly to the farm
                addNewPetWithData(petName, category);
            } catch (error) {
                console.error('Error adding pet from database:', error);
                showNotification(`Error adding ${petName}: ${error.message}`, 'danger');
            }
        }

        function addNewPetWithData(petName, category) {
            console.log('Adding new pet with data:', { petName, category });
            
            try {
                // Find the pet in the global database
                const categoryData = globalPetsDatabase[category];
                const petData = (categoryData.breeds || categoryData.species).find(pet => pet.name === petName);
                
                if (!petData) {
                    throw new Error('Pet not found in global database');
                }
                
                // Create new pet object
                const newPet = {
                    id: Date.now(),
                    species: categoryData.name,
                    breed: petName,
                    name: petName,
                    age: 1,
                    gender: 'Unknown',
                    healthStatus: 'Healthy',
                    vaccination: 'Not vaccinated',
                    lastVetVisit: null,
                    notes: `Added from global database - ${categoryData.name}`,
                    dateAdded: new Date().toISOString()
                };
                
                pets.push(newPet);
                savePetsData();
                renderPetsGrid();
                renderPetsTable();
                updatePetsStatistics();
                updateAnalyticsCharts();
                
                showNotification(`Successfully added ${petName} to your farm!`, 'success');
            } catch (error) {
                console.error('Error adding pet:', error);
                showNotification(`Error adding ${petName}: ${error.message}`, 'danger');
            }
        }

        function exportPetsDatabase() {
            const dataStr = JSON.stringify(globalPetsDatabase, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'global-pets-database.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        // Make functions globally accessible after they are defined
        window.addCropFromDatabase = addCropFromDatabase;
        window.addLivestockFromDatabase = addLivestockFromDatabase;
        window.addPetFromDatabase = addPetFromDatabase;
        window.addNewCropWithData = addNewCropWithData;
        window.addNewPetWithData = addNewPetWithData;
        window.showGlobalCropDatabase = showGlobalCropDatabase;
        
        // Statistics update functions
        function updateCropStatistics() {
            const totalCrops = document.querySelectorAll('.crop-card').length;
            const activeCrops = document.querySelectorAll('.status-badge.status-growing, .status-badge.status-flowering').length;
            const readyForHarvest = document.querySelectorAll('.status-badge.status-harvesting').length;
            
            // Calculate total yield from sample data
            // Note: :contains() is not a valid CSS selector, using filter instead
            const yieldElements = Array.from(document.querySelectorAll('.detail-row span')).filter(span => 
                span.textContent.includes('Yield:')
            );
            let totalYield = 45.5; // From sample data
            
            document.getElementById('totalCrops').textContent = totalCrops;
            document.getElementById('activeCrops').textContent = activeCrops;
            document.getElementById('readyForHarvest').textContent = readyForHarvest;
            document.getElementById('totalYield').textContent = totalYield;
        }

        function updateLivestockStatistics() {
            const totalAnimals = document.querySelectorAll('.livestock-card').length;
            const healthyAnimals = document.querySelectorAll('.status-badge.status-healthy').length;
            const pregnantAnimals = document.querySelectorAll('.status-badge.status-pregnant').length;
            
            // Calculate total value from sample data
            let totalValue = 0;
            document.querySelectorAll('.livestock-card').forEach(card => {
                // Find the weight span by filtering spans that contain "Weight:"
                // Note: :contains() is not a valid CSS selector
                const spans = Array.from(card.querySelectorAll('.detail-row span'));
                const weightText = spans.find(span => span.textContent.includes('Weight:'));
                if (weightText) {
                    const weightMatch = weightText.textContent.match(/[\d.]+/);
                    if (weightMatch) {
                        const weight = parseFloat(weightMatch[0]);
                        // Estimate value based on weight (rough calculation)
                        totalValue += weight * 15; // FJD per kg
                    }
                }
            });
            
            document.getElementById('totalAnimals').textContent = totalAnimals;
            document.getElementById('healthyAnimals').textContent = healthyAnimals;
            document.getElementById('pregnantAnimals').textContent = pregnantAnimals;
            document.getElementById('totalValue').textContent = totalValue.toFixed(0);
        }

        // Filter functions
        function filterCrops() {
            const searchTerm = document.getElementById('cropSearch').value.toLowerCase();
            const statusFilter = document.getElementById('cropStatusFilter').value;
            const fieldFilter = document.getElementById('fieldFilter').value;
            
            document.querySelectorAll('.crop-card').forEach(card => {
                const cropName = card.querySelector('.crop-name').textContent.toLowerCase();
                const cropVariety = card.querySelector('.crop-variety').textContent.toLowerCase();
                const status = card.querySelector('.status-badge').textContent.toLowerCase();
                const field = card.querySelector('.detail-row span').textContent.toLowerCase();
                
                const matchesSearch = cropName.includes(searchTerm) || cropVariety.includes(searchTerm);
                const matchesStatus = !statusFilter || status.includes(statusFilter);
                const matchesField = !fieldFilter || field.includes(fieldFilter.toLowerCase());
                
                if (matchesSearch && matchesStatus && matchesField) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function filterLivestock() {
            const searchTerm = document.getElementById('livestockSearch').value.toLowerCase();
            const speciesFilter = document.getElementById('speciesFilter').value;
            const statusFilter = document.getElementById('livestockStatusFilter').value;
            
            document.querySelectorAll('.livestock-card').forEach(card => {
                const animalName = card.querySelector('.livestock-name').textContent.toLowerCase();
                const breed = card.querySelector('.livestock-breed').textContent.toLowerCase();
                const status = card.querySelector('.status-badge').textContent.toLowerCase();
                
                const matchesSearch = animalName.includes(searchTerm) || breed.includes(searchTerm);
                const matchesSpecies = !speciesFilter || breed.includes(speciesFilter.toLowerCase());
                const matchesStatus = !statusFilter || status.includes(statusFilter.toLowerCase());
                
                if (matchesSearch && matchesSpecies && matchesStatus) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Action functions for new card layouts
        function addYield(cropId) {
            console.log('Adding yield for crop:', cropId);
            // Implementation for adding yield
            showAlert('Yield added successfully!', 'success');
        }

        function viewCropDetails(cropId) {
            console.log('Viewing crop details:', cropId);
            // Implementation for viewing crop details
            showAlert('Opening crop details...', 'info');
        }

        function addHealthRecord(animalId) {
            console.log('Adding health record for animal:', animalId);
            // Implementation for adding health record
            showAlert('Health record added successfully!', 'success');
        }

        function viewLivestockDetails(animalId) {
            console.log('Viewing livestock details:', animalId);
            // Implementation for viewing livestock details
            showAlert('Opening livestock details...', 'info');
        }

        // Make navigation functions globally accessible
        window.showFarmManagement = showFarmManagement;
        window.showReports = showReports;
        window.showDashboard = showDashboard;
        window.showCropManagement = showCropManagement;
        window.showLivestockManagement = showLivestockManagement;
        window.showPetsManagement = showPetsManagement;
        window.showInventoryManagement = showInventoryManagement;
        window.showAnalytics = showAnalytics;
        window.showTasks = showTasks;
        
        // Make new card functions globally accessible
        window.filterCrops = filterCrops;
        window.filterLivestock = filterLivestock;
        window.addYield = addYield;
        window.viewCropDetails = viewCropDetails;
        window.addHealthRecord = addHealthRecord;
        window.viewLivestockDetails = viewLivestockDetails;
        window.updateCropStatistics = updateCropStatistics;
        window.updateLivestockStatistics = updateLivestockStatistics;
        
        // Test navigation functions
        function testNavigationFunctions() {
            console.log('üß™ Testing navigation functions...');
            const functions = [
                'showDashboard',
                'showFarmManagement', 
                'showCropManagement',
                'showLivestockManagement',
                'showPetsManagement',
                'showInventoryManagement',
                'showAnalytics',
                'showTasks',
                'showReports'
            ];
            
            functions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    console.log(`‚úÖ ${funcName} is available`);
                } else {
                    console.error(`‚ùå ${funcName} is NOT available`);
                }
            });
            
            // Test DOM elements
            const views = [
                'dashboardView',
                'farmManagementView',
                'cropManagementView',
                'livestockManagementView',
                'petsManagementView',
                'inventoryManagementView',
                'analyticsView',
                'tasksView',
                'reportsView'
            ];
            
            views.forEach(viewId => {
                const element = document.getElementById(viewId);
                if (element) {
                    console.log(`‚úÖ ${viewId} element found`);
                } else {
                    console.error(`‚ùå ${viewId} element NOT found`);
                }
            });
        }
        
        // Make test function globally accessible
        window.testNavigationFunctions = testNavigationFunctions;
        window.showGlobalLivestockDatabase = showGlobalLivestockDatabase;
        window.showGlobalPetsDatabase = showGlobalPetsDatabase;
        window.filterCrops = filterCrops;
        window.filterLivestock = filterLivestock;
        window.filterPets = filterPets;
        window.exportCropDatabase = exportCropDatabase;
        window.exportLivestockDatabase = exportLivestockDatabase;
        window.exportPetsDatabase = exportPetsDatabase;
        window.showNotification = showNotification;
    </script>

    <!-- Dashboard Add Livestock Modal -->
    <div class="modal fade" id="dashboardAddLivestockModal" tabindex="-1" aria-labelledby="dashboardAddLivestockModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="dashboardAddLivestockModalLabel">
                        <i class="fas fa-plus me-2"></i>Add New Livestock
                    </h5>
                    <button type="button" class="btn-close btn-close-white" onclick="confirmCancelLivestockForm()" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="dashboardAddLivestockForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="dashboardLivestockSpecies" class="form-label">Species</label>
                                    <select class="form-select" id="dashboardLivestockSpecies" data-catalog-group="pets" required>
                                        <option value="">Select Species</option>
                                        <option value="Cattle">Cattle</option>
                                        <option value="Pigs">Pigs</option>
                                        <option value="Chickens">Chickens</option>
                                        <option value="Sheep">Sheep</option>
                                        <option value="Goats">Goats</option>
                                        <option value="Horses">Horses</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="dashboardLivestockTag" class="form-label">Tag/ID Number</label>
                                    <input type="text" class="form-control" id="dashboardLivestockTag" required placeholder="Enter tag/ID number">
                                </div>
                                <div class="mb-3">
                                    <label for="dashboardLivestockBirthDate" class="form-label">Birth Date</label>
                                    <input type="date" class="form-control" id="dashboardLivestockBirthDate" required>
                                </div>
                                <div class="mb-3">
                                    <label for="dashboardLivestockPurpose" class="form-label">Production Purpose</label>
                                    <select class="form-select" id="dashboardLivestockPurpose" required>
                                        <option value="">Select Purpose</option>
                                        <option value="Dairy">Dairy</option>
                                        <option value="Beef">Beef</option>
                                        <option value="Breeding">Breeding</option>
                                        <option value="Meat">Meat</option>
                                        <option value="Eggs">Eggs</option>
                                        <option value="Wool">Wool</option>
                                        <option value="Dual Purpose">Dual Purpose</option>
                                        <option value="Pets">Pets</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="dashboardLivestockLocation" class="form-label">Location/Pen</label>
                                    <input type="text" class="form-control" id="dashboardLivestockLocation" required placeholder="Enter location or pen number">
                                </div>
                                <div class="mb-3">
                                    <label for="dashboardLivestockSireTag" class="form-label">Sire Tag (if known)</label>
                                    <input type="text" class="form-control" id="dashboardLivestockSireTag" placeholder="Enter sire tag">
                                </div>
                                <div class="mb-3">
                                    <label for="dashboardLivestockHealthNotes" class="form-label">Health Notes</label>
                                    <textarea class="form-control" id="dashboardLivestockHealthNotes" rows="3" placeholder="Any health observations or notes..."></textarea>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="dashboardLivestockBreed" class="form-label">Breed</label>
                                    <input type="text" class="form-control" id="dashboardLivestockBreed" required placeholder="Type to search breeds...">
                                </div>
                                <div class="mb-3">
                                    <label for="dashboardLivestockSex" class="form-label">Sex</label>
                                    <select class="form-select" id="dashboardLivestockSex" required>
                                        <option value="">Select Sex</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="dashboardLivestockWeight" class="form-label">Current Weight (kg)</label>
                                    <input type="number" class="form-control" id="dashboardLivestockWeight" step="0.1" placeholder="Enter weight in kg">
                                </div>
                                <div class="mb-3">
                                    <label for="dashboardLivestockLifecycle" class="form-label">Lifecycle Stage</label>
                                    <input type="text" class="form-control" id="dashboardLivestockLifecycle" readonly style="background-color: #e9ecef; cursor: not-allowed;">
                                    <small class="text-muted"><i class="fas fa-info-circle me-1"></i>Auto-calculated based on birth date, species, and sex</small>
                                </div>
                                <div class="mb-3">
                                    <label for="dashboardLivestockValue" class="form-label">Estimated Value (FJD)</label>
                                    <input type="number" class="form-control" id="dashboardLivestockValue" step="0.01" placeholder="Enter estimated value">
                                </div>
                                <div class="mb-3">
                                    <label for="dashboardLivestockDamTag" class="form-label">Dam Tag (if known)</label>
                                    <input type="text" class="form-control" id="dashboardLivestockDamTag" placeholder="Enter dam tag">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="confirmCancelLivestockForm()">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="saveDashboardNewLivestock()">
                        <i class="fas fa-save me-2"></i>Add Livestock
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Feed Mix Calculator -->
    <script src="js/feed-mix-calculator.js"></script>
    
    <!-- SmartFarm Core Scripts (duplicates removed) -->
    <link rel="stylesheet" href="css/utilities.css">
    <script src="js/ux-enhancer.js"></script>
    <script src="/js/catalog-picker.js"></script>
    <script src="/js/catalog-popovers.js"></script>
    <script>
        async function refreshSmartFarmInsights() {
            const insightsContainer = document.getElementById('smartFarmInsights');
            if (!insightsContainer) return;

            insightsContainer.innerHTML = '<div class="col-12 text-center text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Loading personalized recommendations...</div>';

            try {
                const response = await fetch('/api/recommend?goal=high-yield&limit=3');
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`Request failed with status ${response.status}: ${errorData.error || 'Unknown error'}`);
                }
                const data = await response.json();
                const items = data.results || [];

                if (!items.length) {
                    // Fallback to local insights when API returns no results
                    showLocalInsights(insightsContainer);
                    return;
                }

                insightsContainer.innerHTML = items.slice(0, 3).map(result => createInsightCard(result)).join('');
            } catch (error) {
                console.warn('API unavailable, showing local insights:', error.message);
                // Fallback to local insights when API fails
                showLocalInsights(insightsContainer);
            }
        }

        function showLocalInsights(container) {
            // Get existing farm data from localStorage or global variables
            const savedCrops = localStorage.getItem('crops') || '[]';
            const savedLivestock = localStorage.getItem('livestockData') || '[]';
            
            let crops = [];
            let livestock = [];
            
            try {
                crops = JSON.parse(savedCrops);
            } catch (e) {
                // Try using global crops variable if available
                if (typeof window.crops !== 'undefined' && Array.isArray(window.crops)) {
                    crops = window.crops;
                }
            }
            
            try {
                livestock = JSON.parse(savedLivestock);
            } catch (e) {
                // Try using global livestock variable if available
                if (typeof window.livestock !== 'undefined' && Array.isArray(window.livestock)) {
                    livestock = window.livestock;
                }
            }

            const insights = [];

            // Insight 1: Crop recommendations based on existing crops
            if (crops.length > 0) {
                const activeCrops = crops.filter(c => c.status === 'growing' || c.status === 'planted' || !c.status);
                if (activeCrops.length > 0) {
                    const crop = activeCrops[0];
                    const daysSincePlanted = crop.plantedDate ? 
                        Math.floor((new Date() - new Date(crop.plantedDate)) / (1000 * 60 * 60 * 24)) : 0;
                    
                    insights.push({
                        type: 'crop',
                        title: `${crop.name} Growth Update`,
                        message: `Your ${crop.name} ${daysSincePlanted > 0 ? `has been growing for ${daysSincePlanted} days` : 'is growing'}. Monitor soil moisture and check for pests regularly.`,
                        icon: 'fas fa-seedling',
                        color: 'success'
                    });
                }
            }

            // Insight 2: Livestock health
            if (livestock.length > 0) {
                const healthyCount = livestock.filter(l => !l.healthIssues || l.healthIssues.length === 0).length;
                const healthPercentage = Math.round((healthyCount / livestock.length) * 100);
                
                insights.push({
                    type: 'livestock',
                    title: `Livestock Health: ${healthPercentage}% Healthy`,
                    message: `${healthyCount} out of ${livestock.length} animals are healthy. ${healthPercentage >= 80 ? 'Excellent!' : 'Consider scheduling health checks.'}`,
                    icon: 'fas fa-heart',
                    color: healthPercentage >= 80 ? 'success' : 'warning'
                });
            }

            // Insight 3: Farm-to-Table opportunity
            if (crops.length > 0 || livestock.length > 0) {
                insights.push({
                    type: 'processing',
                    title: 'Farm-to-Table Opportunity',
                    message: `You have ${crops.length} crops and ${livestock.length} livestock. Consider processing raw products into value-added items for export.`,
                    icon: 'fas fa-industry',
                    color: 'info',
                    action: '<a href="farm-to-table.html" class="btn btn-sm btn-info mt-2">Explore Processing Plans</a>'
                });
            }

            // If no insights available, show helpful message
            if (insights.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>Get Started with SmartFarm</h6>
                            <p class="mb-2">Start by adding crops or livestock to your farm to receive personalized insights and recommendations.</p>
                            <div class="mt-3">
                                <a href="crop-management.html" class="btn btn-sm btn-success me-2">
                                    <i class="fas fa-seedling me-1"></i>Add Crops
                                </a>
                                <a href="livestock-management.html" class="btn btn-sm btn-primary">
                                    <i class="fas fa-cow me-1"></i>Add Livestock
                                </a>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // Display insights
            container.innerHTML = insights.slice(0, 3).map(insight => `
                <div class="col-md-4">
                    <div class="card border-${insight.color} h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <i class="${insight.icon} text-${insight.color} fa-2x me-3"></i>
                                <h6 class="mb-0">${insight.title}</h6>
                            </div>
                            <p class="text-muted mb-2">${insight.message}</p>
                            ${insight.action || ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function createInsightCard(result) {
            const { item, plan, score } = result;
            const cropIcon = item.group === 'fish' ? 'fas fa-fish' :
                item.group === 'bivalves' ? 'fas fa-water' :
                item.group === 'crustaceans' ? 'fas fa-drumstick-bite' :
                item.group === 'trees' ? 'fas fa-tree' :
                item.group === 'flowers' ? 'fas fa-spa' :
                item.group === 'pets' ? 'fas fa-paw' :
                'fas fa-seedling';

            return `
                <div class="col-md-4">
                    <div class="border rounded p-3 h-100">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0"><i class="${cropIcon} text-success me-2"></i>${item.name}</h5>
                            <span class="badge bg-light text-success">Score ${score}</span>
                        </div>
                        <p class="text-muted mb-2">${item.category || ''}${item.subCategory ? ` ‚Ä¢ ${item.subCategory}` : ''}</p>
                        ${plan.estimatedYieldKg ? `<div><strong>Projected Yield:</strong> ${Number(plan.estimatedYieldKg).toLocaleString()} kg</div>` : ''}
                        ${plan.estimatedValueFJD ? `<div><strong>Projected Value:</strong> FJD ${Number(plan.estimatedValueFJD).toLocaleString()}</div>` : ''}
                        ${plan.timelineDays ? `<div><strong>Growth Duration:</strong> ${plan.timelineDays} days</div>` : ''}
                        ${plan.inputs.fertilizerOrFeed ? `<div class="mt-2"><strong>Input Tip:</strong> ${plan.inputs.fertilizerOrFeed}</div>` : ''}
                        ${plan.warnings && plan.warnings.length ? `<div class="mt-2 text-warning"><strong>Risk:</strong> ${plan.warnings.slice(0, 2).join(', ')}</div>` : ''}
                        ${plan.preventiveActions && plan.preventiveActions.length ? `<div class="mt-2 text-muted"><strong>Prevention:</strong> ${plan.preventiveActions.slice(0, 2).join(', ')}</div>` : ''}
                    </div>
                </div>
            `;
        }

        document.addEventListener('DOMContentLoaded', refreshSmartFarmInsights);
    </script>

    <!-- Feed Mix Calculator Modal -->
    <div class="modal fade modal-custom" id="feedMixCalculatorModal" tabindex="-1" aria-labelledby="feedMixCalculatorModalLabel" aria-modal="true" role="dialog">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="feedMixCalculatorModalLabel">
                        <i class="fas fa-calculator me-2"></i>Feed Mix Calculator
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Animal Selection -->
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6><i class="fas fa-paw me-2"></i>Animal Information</h6>
                                </div>
                                <div class="card-body">
                                    <form id="feedMixForm">
                                        <div class="mb-3">
                                            <label for="feedMixSpecies" class="form-label">Species</label>
                                            <select class="form-select" id="feedMixSpecies" required onchange="updateFeedMixLifecycleOptions()">
                                                <option value="">Select Species</option>
                                                <option value="cattle">Cattle</option>
                                                <option value="pigs">Pigs</option>
                                                <option value="chickens">Chickens</option>
                                                <option value="sheep">Sheep</option>
                                                <option value="goats">Goats</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="feedMixLifecycle" class="form-label">Lifecycle Stage</label>
                                            <select class="form-select" id="feedMixLifecycle" required>
                                                <option value="">Select Lifecycle Stage</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="feedMixWeight" class="form-label">Current Weight (kg)</label>
                                            <input type="number" class="form-control" id="feedMixWeight" step="0.1" required placeholder="Enter weight">
                                        </div>
                                        <div class="mb-3">
                                            <label for="feedMixAge" class="form-label">Age (months)</label>
                                            <input type="number" class="form-control" id="feedMixAge" step="0.1" placeholder="Enter age (optional)">
                                        </div>
                                        <div class="mb-3">
                                            <label for="feedMixPurpose" class="form-label">Production Purpose</label>
                                            <select class="form-select" id="feedMixPurpose">
                                                <option value="">Select Purpose (Optional)</option>
                                                <option value="dairy">Dairy</option>
                                                <option value="beef">Beef</option>
                                                <option value="breeding">Breeding</option>
                                                <option value="meat">Meat</option>
                                                <option value="eggs">Eggs</option>
                                                <option value="wool">Wool</option>
                                            </select>
                                        </div>
                                        <button type="button" class="btn btn-success w-100" onclick="calculateFeedMix()">
                                            <i class="fas fa-calculator me-2"></i>Calculate Feed Mix
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Results -->
                        <div class="col-md-8">
                            <div id="feedMixResults" style="display: none;">
                                <!-- Nutritional Requirements -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6><i class="fas fa-chart-bar me-2"></i>Nutritional Requirements</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row" id="nutritionalRequirements">
                                            <!-- Requirements will be populated here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Feed Mix Composition -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6><i class="fas fa-seedling me-2"></i>Recommended Feed Mix</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6>Composition (%)</h6>
                                                <div id="feedMixComposition">
                                                    <!-- Feed mix will be populated here -->
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <h6>Daily Intake & Costs</h6>
                                                <div id="feedMixCosts">
                                                    <!-- Costs will be populated here -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Recommendations -->
                                <div class="card">
                                    <div class="card-header">
                                        <h6><i class="fas fa-lightbulb me-2"></i>Recommendations</h6>
                                    </div>
                                    <div class="card-body" id="feedMixRecommendations">
                                        <!-- Recommendations will be populated here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Instructions -->
                            <div id="feedMixInstructions" class="text-center text-muted">
                                <i class="fas fa-info-circle fa-3x mb-3"></i>
                                <h5>Feed Mix Calculator</h5>
                                <p>Enter your animal's information to get personalized feed mix recommendations based on:</p>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-weight me-2"></i>Weight and age</li>
                                    <li><i class="fas fa-leaf me-2"></i>Nutritional requirements</li>
                                    <li><i class="fas fa-chart-line me-2"></i>Production purpose</li>
                                    <li><i class="fas fa-dollar-sign me-2"></i>Cost optimization</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" onclick="printFeedMixReport()">
                        <i class="fas fa-print me-2"></i>Print Report
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
