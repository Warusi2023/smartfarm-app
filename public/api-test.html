<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Test - SmartFarm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1><i class="fas fa-flask me-2"></i>SmartFarm API Test</h1>
        <p class="text-muted">Test API endpoints and connectivity</p>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-server me-2"></i>API Connectivity Test</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="testAPI()">
                            <i class="fas fa-play me-1"></i>Test API Connection
                        </button>
                        <div id="api-results" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-file me-2"></i>Static File Test</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success" onclick="testStaticFiles()">
                            <i class="fas fa-file me-1"></i>Test Static Files
                        </button>
                        <div id="static-results" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cogs me-2"></i>Configuration Info</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Current URL:</h6>
                                <code id="current-url"></code>
                                
                                <h6 class="mt-3">Authentication Token:</h6>
                                <code id="auth-token"></code>
                            </div>
                            <div class="col-md-6">
                                <h6>API Base URLs:</h6>
                                <ul>
                                    <li><code>/api/auth/profile</code></li>
                                    <li><code>/api/user-management/users</code></li>
                                    <li><code>/api/user-management/my-farms</code></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Display current configuration
        document.getElementById('current-url').textContent = window.location.href;
        const token = localStorage.getItem('jwtToken') || sessionStorage.getItem('jwtToken');
        document.getElementById('auth-token').textContent = token ? token.substring(0, 20) + '...' : 'No token found';

        async function testAPI() {
            const resultsDiv = document.getElementById('api-results');
            resultsDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Testing API...';
            
            const tests = [
                { name: 'Health Check', url: '/api/health', method: 'GET' },
                { name: 'Auth Profile', url: '/api/auth/profile', method: 'GET', auth: true },
                { name: 'User Management', url: '/api/user-management/my-farms', method: 'GET', auth: true }
            ];
            
            let results = '<div class="list-group">';
            
            for (const test of tests) {
                try {
                    const headers = { 'Content-Type': 'application/json' };
                    if (test.auth && token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                    
                    const response = await fetch(test.url, { method: test.method, headers });
                    const contentType = response.headers.get('content-type');
                    
                    let result = '✅ Success';
                    let resultClass = 'success';
                    
                    if (!response.ok) {
                        result = `❌ HTTP ${response.status}`;
                        resultClass = 'danger';
                    } else if (!contentType || !contentType.includes('application/json')) {
                        result = '⚠️ Non-JSON response';
                        resultClass = 'warning';
                    }
                    
                    results += `
                        <div class="list-group-item list-group-item-${resultClass}">
                            <strong>${test.name}:</strong> ${result}
                            <br><small class="text-muted">${test.url}</small>
                        </div>
                    `;
                } catch (error) {
                    results += `
                        <div class="list-group-item list-group-item-danger">
                            <strong>${test.name}:</strong> ❌ Error: ${error.message}
                            <br><small class="text-muted">${test.url}</small>
                        </div>
                    `;
                }
            }
            
            results += '</div>';
            resultsDiv.innerHTML = results;
        }

        async function testStaticFiles() {
            const resultsDiv = document.getElementById('static-results');
            resultsDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Testing static files...';
            
            const files = [
                { name: 'Dashboard CSS', url: '/css/dashboard.css' },
                { name: 'Utilities CSS', url: '/css/utilities.css' },
                { name: 'User Management JS', url: '/js/user-management.js' },
                { name: 'API Service JS', url: '/js/api-service.js' }
            ];
            
            let results = '<div class="list-group">';
            
            for (const file of files) {
                try {
                    const response = await fetch(file.url);
                    const contentType = response.headers.get('content-type');
                    
                    let result = '✅ Success';
                    let resultClass = 'success';
                    
                    if (!response.ok) {
                        result = `❌ HTTP ${response.status}`;
                        resultClass = 'danger';
                    } else if (file.url.endsWith('.css') && (!contentType || !contentType.includes('text/css'))) {
                        result = '⚠️ Wrong MIME type';
                        resultClass = 'warning';
                    }
                    
                    results += `
                        <div class="list-group-item list-group-item-${resultClass}">
                            <strong>${file.name}:</strong> ${result}
                            <br><small class="text-muted">${file.url} (${contentType})</small>
                        </div>
                    `;
                } catch (error) {
                    results += `
                        <div class="list-group-item list-group-item-danger">
                            <strong>${file.name}:</strong> ❌ Error: ${error.message}
                            <br><small class="text-muted">${file.url}</small>
                        </div>
                    `;
                }
            }
            
            results += '</div>';
            resultsDiv.innerHTML = results;
        }
    </script>
</body>
</html>
